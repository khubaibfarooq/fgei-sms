var Ne=Object.defineProperty;var ve=(d,m,h)=>m in d?Ne(d,m,{enumerable:!0,configurable:!0,writable:!0,value:h}):d[m]=h;var le=(d,m,h)=>ve(d,typeof m!="symbol"?m+"":m,h);import{r as o,j as t,L as Ee}from"./app-BOiyQv0t.js";import{A as Ce}from"./app-layout-Dv_yMrei.js";import{B as D}from"./button-4ncMh_Hk.js";import{C as Fe,a as Re,b as Ae,c as Ie}from"./card-4BvP-gGE.js";import{I as ie}from"./input-BdvK0slL.js";import{t as i}from"./index-B28K9C3C.js";import{l as Le}from"./lodash-DcO-x7oD.js";import{E as Be,F as ze,a as De,b as Pe}from"./jspdf.plugin.autotable-Ck5L2T51.js";import{C as R}from"./combobox-C1nihPoA.js";import"./index-CzAmmnzZ.js";import"./createLucideIcon-CsRv7B2H.js";import"./index-Dq8_xdj9.js";import"./index-BrnITXtc.js";import"./index-DRDVaDhK.js";import"./index-F0TRDaNb.js";import"./app-logo-icon-eFoPT30r.js";import"./circle-x-C5j3MxBP.js";import"./folder-root-DV9kRalP.js";import"./grip-vertical-DBV98OfK.js";import"./popover-BPPq6-B3.js";const $e=[{title:"Reports",href:"/reports"},{title:"Assets",href:"/reports/assets"}];class Me extends o.Component{constructor(){super(...arguments);le(this,"state",{hasError:!1,error:null})}static getDerivedStateFromError(h){return{hasError:!0,error:h.message}}componentDidCatch(h,A){console.error("ErrorBoundary caught:",h,A),i.error("An error occurred while rendering the component. Please try again or contact support.")}render(){return this.state.hasError?t.jsxs("div",{className:"p-4",children:[t.jsxs("p",{className:"text-red-600",children:["Error: ",this.state.error]}),t.jsx(D,{onClick:()=>window.location.reload(),className:"mt-2",children:"Retry"})]}):this.props.children}}const a=d=>{const m=d!=null&&typeof d.id=="number"&&d.id>0&&typeof d.name=="string"&&d.name.trim()!=="";return m||console.warn("Invalid item detected:",d),m};function mt({instituteAssets:d,institutes:m,blocks:h,rooms:A,assetCategories:P,assets:$,regions:M,filters:w}){var re,oe,ae;const[N,ce]=o.useState(w.search||""),[x,U]=o.useState(w.institute_id||""),[u,W]=o.useState(w.block_id||""),[k,I]=o.useState(w.room_id||""),[f,de]=o.useState(w.asset_category_id||""),[v,Q]=o.useState(w.asset_id||""),[_,me]=o.useState(w.region_id||""),[V,T]=o.useState(h.filter(a)),[H,E]=o.useState(A.filter(a)),[J,O]=o.useState($.filter(a)),[Te,K]=o.useState(!1),[Oe,Y]=o.useState(!1),[he,G]=o.useState(!1),[qe,X]=o.useState(!1),[q,L]=o.useState(d),[S,Z]=o.useState(m||[]),[Qe,xe]=o.useState([]),[c,ee]=o.useState(!1),ue=async e=>{try{const s=new URLSearchParams({region_id:e||""}).toString(),r=await fetch(`/reports/getInstitutes?${s}`);if(!r.ok)throw new Error("Failed to fetch institutes");const p=await r.json();Z(p),x&&e!=="0"&&!p.some(n=>n.id.toString()===x)&&U("")}catch(s){console.error("Error fetching institutes:",s),i.error("Failed to load institutes"),Z([])}},fe=e=>{me(e),ue(e)},te=async()=>{try{const e=new URLSearchParams({search:N||"",institute_id:x||"",block_id:u||"",room_id:k||"",asset_category_id:f||"",asset_id:v||"",region_id:_||"",details:c?"true":"false",all:"true"}),s=await fetch(`/reports/assets/institute-assets?${e.toString()}`);if(!s.ok)throw new Error("Failed to fetch all assets for export");const r=await s.json();return xe(r),r}catch(e){return console.error("Error fetching all assets for export:",e),i.error("Failed to fetch assets for export"),[]}};o.useEffect(()=>{const e={institutes:Array.isArray(S)?S.filter(s=>!a(s)):[],blocks:h.filter(s=>!a(s)),rooms:A.filter(s=>!a(s)),assetCategories:P.filter(s=>!a(s)),assets:$.filter(s=>!a(s)),regions:M.filter(s=>!a(s))};Object.entries(e).forEach(([s,r])=>{r.length>0&&console.warn(`Invalid ${s}:`,r)})},[m,h,A,P,$,M,S]),o.useEffect(()=>{x?(K(!0),fetch(`/reports/blocks/getBlocks?institute_id=${x}&all=true`).then(e=>e.json()).then(e=>{if(Array.isArray(e)){const s=e.filter(a);s.length<e.length&&console.warn("Filtered out invalid blocks:",e.filter(r=>!a(r))),T(s)}else console.warn("Blocks response is not an array:",e),i.error("Invalid blocks data received"),T([])}).catch(e=>{console.error("Error fetching blocks:",e),i.error("Failed to fetch blocks"),T([])}).finally(()=>K(!1)),W(""),E([]),I("")):(T([]),E([]),I(""))},[x]),o.useEffect(()=>{u?(Y(!0),fetch(`/reports/rooms/getRoomsReport?block_id=${u}&all=true`).then(e=>e.json()).then(e=>{if(Array.isArray(e)){const s=e.filter(a);s.length<e.length&&console.warn("Filtered out invalid rooms:",e.filter(r=>!a(r))),E(s)}else console.warn("Rooms response is not an array:",e),i.error("Invalid rooms data received"),E([])}).catch(e=>{console.error("Error fetching rooms:",e),i.error("Failed to fetch rooms"),E([])}).finally(()=>Y(!1)),I("")):(E([]),I(""))},[u]),o.useEffect(()=>{f?(X(!0),fetch(`/reports/assets/list?asset_category_id=${f}`).then(e=>e.json()).then(e=>{if(Array.isArray(e)){const s=e.filter(a);s.length<e.length&&console.warn("Filtered out invalid assets:",e.filter(r=>!a(r))),O(s)}else console.warn("Assets response is not an array:",e),i.error("Invalid assets data received"),O([])}).catch(e=>{console.error("Error fetching assets:",e),i.error("Failed to fetch assets"),O([])}).finally(()=>X(!1)),Q("")):(O($.filter(a)),Q(""))},[f]),o.useEffect(()=>{if(he)return;const e=new URLSearchParams({search:N||"",institute_id:x||"",block_id:u||"",room_id:k||"",asset_category_id:f||"",asset_id:v||"",region_id:_||"",details:c?"true":"false"});fetch(`/reports/assets/institute-assets?${e.toString()}`).then(s=>s.json()).then(s=>{L(s)}).catch(s=>{console.error("Error fetching assets after details toggle:",s),i.error("Failed to fetch assets")})},[c]);const pe=async()=>{try{const e=await te(),s=new Be.Workbook,r=s.addWorksheet("Assets");r.mergeCells("A1:F1");const p=r.getCell("A1");p.font={size:16,bold:!0},p.alignment={horizontal:"center"},r.mergeCells("A2:F2");const n=r.getCell("A2");n.value="Assets Report",n.font={size:14,bold:!0},n.alignment={horizontal:"center"},r.addRow([]);const C=c?["Institute","Details","Quantity","Block","Room","Category","Asset"]:["Asset","Total Quantity","Rooms"],b=r.addRow(C);b.font={bold:!0},b.fill={type:"pattern",pattern:"solid",fgColor:{argb:"FF428BCA"}},b.alignment={horizontal:"center"},e.forEach(l=>{var y,j,B,z,ne;c?r.addRow([((y=l.institute)==null?void 0:y.name)||"N/A",l.details||"N/A",l.current_qty||0,((j=l.room.block)==null?void 0:j.name)||"N/A",((B=l.room)==null?void 0:B.name)||"N/A",((z=l.asset.category)==null?void 0:z.name)||"N/A",((ne=l.asset)==null?void 0:ne.name)||"N/A"]):r.addRow([l.name||"—",l.total_qty||0,l.locations_count||0])}),r.columns.forEach(l=>{var j;let y=0;(j=l.eachCell)==null||j.call(l,{includeEmpty:!0},B=>{const z=B.value?B.value.toString().length:10;z>y&&(y=z)}),l.width=Math.min(y+2,50)});const F=await s.xlsx.writeBuffer(),g=new Blob([F],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"});ze.saveAs(g,"Assets_Report.xlsx"),i.success("Excel exported successfully")}catch(e){console.error("Error exporting to Excel:",e),i.error("Failed to export Excel")}},ge=async()=>{try{const e=await te(),s=new De;s.setFontSize(16),s.setFont("helvetica","bold"),s.setFontSize(14),s.text("Assets Report",14,25);const r=c?["Institute","Details","Qty","Block","Room","Category","Asset"]:["Asset","Total Quantity","Rooms"],p=e.map(n=>{var C,b,F,g,l,y,j;return c?[((C=n.institute)==null?void 0:C.name)||"N/A",n.details||"N/A",((b=n.current_qty)==null?void 0:b.toString())||"0",((F=n.room)==null?void 0:F.block.name)||"N/A",((g=n.room)==null?void 0:g.name)||"N/A",((y=(l=n.asset)==null?void 0:l.category)==null?void 0:y.name)||"N/A",((j=n.asset)==null?void 0:j.name)||"N/A"]:[n.name||"—",(n.total_qty||0).toString(),(n.locations_count||0).toString()]});Pe(s,{head:[r],body:p,startY:35,styles:{fontSize:9,cellPadding:2},headStyles:{fillColor:[66,139,202],textColor:255,fontStyle:"bold"},alternateRowStyles:{fillColor:[240,240,240]},columnStyles:c?{0:{cellWidth:50},1:{halign:"center",cellWidth:20},5:{cellWidth:50}}:{0:{cellWidth:80},1:{halign:"center"},2:{halign:"center"}}}),s.save("Assets_Report.pdf"),i.success("PDF exported successfully")}catch(e){console.error("Error exporting to PDF:",e),i.error("Failed to export PDF")}},ye=()=>{const e=new URLSearchParams({search:N||"",institute_id:x||"",block_id:u||"",room_id:k||"",asset_category_id:f||"",asset_id:v||"",region_id:_||"",details:c?"true":"false"});fetch(`/reports/assets/institute-assets?${e.toString()}`).then(s=>s.json()).then(s=>{L(s)}).catch(s=>{console.error("Error fetching filtered assets:",s),i.error("Failed to fetch filtered assets")})},be=o.useMemo(()=>Le.debounce(()=>{const e=new URLSearchParams({search:N||"",institute_id:x||"",block_id:u||"",room_id:k||"",asset_category_id:f||"",asset_id:v||"",region_id:_||"",details:c?"true":"false"});console.log(e.toString()),fetch(`/reports/assets/institute-assets?${e.toString()}`).then(s=>s.json()).then(s=>{L(s)}).catch(s=>{console.error("Error fetching filtered assets:",s),i.error("Failed to fetch filtered assets")})},300),[x,u,k,f,v,_,c]),je=o.useMemo(()=>Array.isArray(S)?S.filter(a):(console.warn("filteredInstitutes is not an array or is null:",S),[]),[S]),we=o.useMemo(()=>V.filter(a),[V]),ke=o.useMemo(()=>H.filter(a),[H]),_e=o.useMemo(()=>P.filter(a),[P]),Se=o.useMemo(()=>J.filter(a),[J]),se=o.useMemo(()=>M.filter(a),[M]);return t.jsx(Me,{children:t.jsxs(Ce,{breadcrumbs:$e,children:[t.jsx(Ee,{title:"Assets Report"}),t.jsx("div",{className:"flex-1 p-2 md:p-4 w-full overflow-x-hidden",children:t.jsxs(Fe,{className:"w-full shadow-lg",children:[t.jsxs(Re,{children:[t.jsx(Ae,{className:"text-xl font-bold",children:"Filters"}),t.jsx("p",{className:"text-muted-foreground text-sm",children:"Refine your assets search"})]}),t.jsxs(Ie,{className:"space-y-4",children:[t.jsxs("div",{className:"grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-2",children:[se.length>0&&t.jsx(R,{entity:"region",value:_,onChange:e=>fe(e),options:se.map(e=>({id:e.id.toString(),name:e.name.split(" ").pop()||e.name})),includeAllOption:!0}),t.jsx(R,{entity:"institute",value:x,onChange:e=>U(e),options:je.map(e=>({id:e.id.toString(),name:e.name})),includeAllOption:!0}),t.jsx(R,{entity:"block",value:u,onChange:e=>W(e),options:we.map(e=>({id:e.id.toString(),name:e.name})),includeAllOption:!0}),t.jsx(R,{entity:"room",value:k,onChange:e=>I(e),options:ke.map(e=>({id:e.id.toString(),name:e.name})),includeAllOption:!0}),t.jsx(R,{entity:"asset_category",value:f,onChange:e=>de(e),options:_e.map(e=>({id:e.id.toString(),name:e.name})),includeAllOption:!0}),t.jsx(R,{entity:"asset",value:v,onChange:e=>Q(e),options:Se.map(e=>({id:e.id.toString(),name:e.name})),includeAllOption:!0})]}),t.jsxs("div",{className:"flex flex-col sm:flex-row flex-wrap gap-2",children:[t.jsxs("div",{className:"flex items-center gap-3 py-2",children:[t.jsx(ie,{type:"checkbox",id:"details-mode",checked:c,onChange:e=>{G(!1),ee(e.target.checked)}}),t.jsxs("label",{htmlFor:"details-mode",className:"cursor-pointer select-none font-medium text-sm",children:[c?"Detailed View":"Summary View"," — Show individual entries"]})]}),t.jsx(D,{onClick:be,className:"w-full md:w-auto",children:"Apply Filters"}),t.jsx(D,{onClick:ge,className:"w-full md:w-auto",children:"Export PDF"}),t.jsx(D,{onClick:pe,className:"w-full md:w-auto",children:"Export Excel"})]}),t.jsx(ie,{type:"text",placeholder:"Search assets... (press Enter)",value:N,onChange:e=>ce(e.target.value),onKeyDown:ye}),t.jsx("div",{className:" overflow-x-auto mx-2 sm:mx-0",children:t.jsxs("table",{className:" w-full border-collapse border-1 rounded-md overflow-hidden shadow-sm  text-xs sm:text-sm",children:[t.jsx("thead",{children:t.jsx("tr",{className:"bg-primary dark:bg-gray-800",children:c?t.jsxs(t.Fragment,{children:[t.jsx("th",{className:"border p-2 text-left text-xs sm:text-sm font-medium text-white dark:text-gray-200",children:"Institute"}),t.jsx("th",{className:"border p-2 text-left text-xs sm:text-sm font-medium text-white dark:text-gray-200",children:"Category"}),t.jsx("th",{className:"border p-2 text-left text-xs sm:text-sm font-medium text-white dark:text-gray-200",children:"Asset"}),t.jsx("th",{className:"border p-2 text-center text-xs sm:text-sm font-medium text-white dark:text-gray-200",children:"Quantity"}),t.jsx("th",{className:"border p-2 text-left text-xs sm:text-sm font-medium text-white dark:text-gray-200",children:"Room / Block"}),t.jsx("th",{className:"border p-2 text-left text-xs sm:text-sm font-medium text-white dark:text-gray-200",children:"Added Date"})]}):t.jsxs(t.Fragment,{children:["   ",t.jsx("th",{className:"border p-2 text-left text-xs sm:text-sm font-medium text-white dark:text-gray-200",children:"Asset"}),t.jsx("th",{className:"border p-2 text-center text-xs sm:text-sm font-medium text-white dark:text-gray-200",children:"Total Quantity"}),t.jsx("th",{className:"border p-2 text-center text-xs sm:text-sm font-medium text-white dark:text-gray-200",children:"Rooms"})]})})}),t.jsx("tbody",{children:((re=q.data)==null?void 0:re.length)===0?t.jsx("tr",{children:t.jsx("td",{colSpan:c?5:3,className:"border p-2 text-center text-xs sm:text-sm text-gray-900 dark:text-gray-100",children:"No assets found."})}):(oe=q.data)==null?void 0:oe.map((e,s)=>{var r,p,n;if(!c){const C=b=>{G(!0),ee(!0),setTimeout(()=>{const F=new URLSearchParams({search:N||"",institute_id:x||"",block_id:u||"",room_id:k||"",asset_category_id:f||"",asset_id:b.toString(),region_id:_||"",details:"true"});fetch(`/reports/assets/institute-assets?${F.toString()}`).then(g=>g.json()).then(g=>{L(g)}).catch(g=>{console.error("Error fetching asset details:",g),i.error("Failed to fetch asset details")})},0)};return t.jsxs("tr",{className:"hover:bg-primary/10 dark:hover:bg-gray-700 cursor-pointer",onClick:()=>C(e.id),children:[t.jsx("td",{className:"border p-2 text-left font-bold dark:text-gray-100",children:e.name}),t.jsx("td",{className:"border p-1 sm:p-2 text-center text-sm sm:text-base font-bold text-green-600",children:e.total_qty}),t.jsx("td",{className:"border p-2 text-center text-amber-600",children:e.locations_count||"-"})]},`${e.name}-${s}`)}return e.asset?t.jsxs("tr",{className:"hover:bg-primary/10 dark:hover:bg-gray-700",children:[t.jsx("td",{className:"border p-2 text-left font-bold dark:text-gray-100",children:(r=e.institute)==null?void 0:r.name}),t.jsx("td",{className:"border p-2 text-left font-bold dark:text-gray-100",children:(p=e.asset)==null?void 0:p.category.name}),t.jsx("td",{className:"border p-2 text-left font-bold dark:text-gray-100",children:(n=e.asset)==null?void 0:n.name}),t.jsx("td",{className:"border p-1 sm:p-2 text-center font-bold text-sm sm:text-base text-green-600",children:e.current_qty}),t.jsx("td",{className:"border p-1 sm:p-2 text-xs sm:text-sm text-gray-900 dark:text-gray-100",children:e.room?t.jsxs(t.Fragment,{children:[e.room.name,e.room.block&&t.jsxs("span",{className:"text-muted-foreground",children:[" (",e.room.block.name,")"]})]}):"—"}),t.jsx("td",{className:"border p-1 sm:p-2 text-xs sm:text-sm text-gray-900 dark:text-gray-100",children:e.added_date?new Date(e.added_date).toLocaleDateString():"—"})]},e.id):t.jsx("tr",{children:t.jsx("td",{colSpan:5,className:"text-center text-muted-foreground py-4",children:"Loading details..."})},s)})})]})}),((ae=q.links)==null?void 0:ae.length)>1&&t.jsx("div",{className:"flex justify-center pt-6 flex-wrap gap-2",children:q.links.map((e,s)=>t.jsx(D,{disabled:!e.url,variant:e.active?"default":"outline",size:"sm",onClick:()=>{e.url&&fetch(e.url).then(r=>r.json()).then(r=>{L(r)}).catch(r=>{console.error("Error:",r)})},className:e.active?"bg-blue-600 hover:bg-blue-700":"",children:t.jsx("span",{dangerouslySetInnerHTML:{__html:e.label}})},s))})]})]})})]})})}export{mt as default};
