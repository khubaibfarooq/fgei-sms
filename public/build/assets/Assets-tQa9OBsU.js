var Be=Object.defineProperty;var ze=(d,m,h)=>m in d?Be(d,m,{enumerable:!0,configurable:!0,writable:!0,value:h}):d[m]=h;var pe=(d,m,h)=>ze(d,typeof m!="symbol"?m+"":m,h);import{r as o,j as t,L as De}from"./app-Bp3xZFTz.js";import{t as i,A as Pe,S as $e}from"./app-layout-Cm9YJvB3.js";import{B as D}from"./button-BVMsv47p.js";import{C as ge,a as je,b as ye,c as be}from"./card-DSYbCj3W.js";import{I as we}from"./input-B_qi6_-I.js";import{S as Q,a as U,b as W,c as O,d as w}from"./select-DuHDK-4v.js";import{l as Te}from"./lodash-BvTbtHGk.js";import{E as Me,F as Ve,a as qe,b as Qe}from"./jspdf.plugin.autotable-BZXEgV05.js";import{C as Se}from"./combobox-CT_tW2kt.js";import"./index-BYbhhJN5.js";import"./createLucideIcon-DvVpzaEa.js";import"./index-DpTJBrF_.js";import"./app-logo-icon-D-J4w13j.js";import"./folder-root-fa1bFMbH.js";import"./grip-vertical-CI21YM0F.js";import"./index-Dk8mEDAI.js";import"./index-C3tBI6mF.js";import"./popover-BOjS7o12.js";const Ue=[{title:"Reports",href:"/reports"},{title:"Assets",href:"/reports/assets"}];class We extends o.Component{constructor(){super(...arguments);pe(this,"state",{hasError:!1,error:null})}static getDerivedStateFromError(h){return{hasError:!0,error:h.message}}componentDidCatch(h,R){console.error("ErrorBoundary caught:",h,R),i.error("An error occurred while rendering the component. Please try again or contact support.")}render(){return this.state.hasError?t.jsxs("div",{className:"p-4",children:[t.jsxs("p",{className:"text-red-600",children:["Error: ",this.state.error]}),t.jsx(D,{onClick:()=>window.location.reload(),className:"mt-2",children:"Retry"})]}):this.props.children}}const a=d=>{const m=d!=null&&typeof d.id=="number"&&d.id>0&&typeof d.name=="string"&&d.name.trim()!=="";return m||console.warn("Invalid item detected:",d),m};function xt({instituteAssets:d,institutes:m,blocks:h,rooms:R,assetCategories:P,assets:$,regions:T,filters:S}){var he,xe,ue;const[_,Ne]=o.useState(S.search||""),[x,J]=o.useState(S.institute_id||""),[u,K]=o.useState(S.block_id||""),[N,I]=o.useState(S.room_id||""),[f,ve]=o.useState(S.asset_category_id||""),[E,H]=o.useState(S.asset_id||""),[v,ke]=o.useState(S.region_id||""),[Y,M]=o.useState(h.filter(a)),[G,C]=o.useState(R.filter(a)),[X,V]=o.useState($.filter(a)),[Z,ee]=o.useState(!1),[te,se]=o.useState(!1),[Oe,re]=o.useState(!1),[q,L]=o.useState(d),[k,oe]=o.useState(m||[]),[He,_e]=o.useState([]),[c,ae]=o.useState(!1),Ee=async e=>{try{const s=new URLSearchParams({region_id:e||""}).toString(),r=await fetch(`/reports/getInstitutes?${s}`);if(!r.ok)throw new Error("Failed to fetch institutes");const p=await r.json();oe(p),x&&e!=="0"&&!p.some(l=>l.id.toString()===x)&&J("")}catch(s){console.error("Error fetching institutes:",s),i.error("Failed to load institutes"),oe([])}},Ce=e=>{ke(e),Ee(e)},le=async()=>{try{const e=new URLSearchParams({search:_||"",institute_id:x||"",block_id:u||"",room_id:N||"",asset_category_id:f||"",asset_id:E||"",region_id:v||"",details:c?"true":"false",all:"true"}),s=await fetch(`/reports/assets/institute-assets?${e.toString()}`);if(!s.ok)throw new Error("Failed to fetch all assets for export");const r=await s.json();return _e(r),r}catch(e){return console.error("Error fetching all assets for export:",e),i.error("Failed to fetch assets for export"),[]}};o.useEffect(()=>{const e={institutes:Array.isArray(k)?k.filter(s=>!a(s)):[],blocks:h.filter(s=>!a(s)),rooms:R.filter(s=>!a(s)),assetCategories:P.filter(s=>!a(s)),assets:$.filter(s=>!a(s)),regions:T.filter(s=>!a(s))};Object.entries(e).forEach(([s,r])=>{r.length>0&&console.warn(`Invalid ${s}:`,r)})},[m,h,R,P,$,T,k]),o.useEffect(()=>{x?(ee(!0),fetch(`/reports/blocks?institute_id=${x}`).then(e=>e.json()).then(e=>{if(Array.isArray(e)){const s=e.filter(a);s.length<e.length&&console.warn("Filtered out invalid blocks:",e.filter(r=>!a(r))),M(s)}else console.warn("Blocks response is not an array:",e),i.error("Invalid blocks data received"),M([])}).catch(e=>{console.error("Error fetching blocks:",e),i.error("Failed to fetch blocks"),M([])}).finally(()=>ee(!1)),K(""),C([]),I("")):(M([]),C([]),I(""))},[x]),o.useEffect(()=>{u?(se(!0),fetch(`/reports/rooms?block_id=${u}`).then(e=>e.json()).then(e=>{if(Array.isArray(e)){const s=e.filter(a);s.length<e.length&&console.warn("Filtered out invalid rooms:",e.filter(r=>!a(r))),C(s)}else console.warn("Rooms response is not an array:",e),i.error("Invalid rooms data received"),C([])}).catch(e=>{console.error("Error fetching rooms:",e),i.error("Failed to fetch rooms"),C([])}).finally(()=>se(!1)),I("")):(C([]),I(""))},[u]),o.useEffect(()=>{f?(re(!0),fetch(`/reports/assets/list?asset_category_id=${f}`).then(e=>e.json()).then(e=>{if(Array.isArray(e)){const s=e.filter(a);s.length<e.length&&console.warn("Filtered out invalid assets:",e.filter(r=>!a(r))),V(s)}else console.warn("Assets response is not an array:",e),i.error("Invalid assets data received"),V([])}).catch(e=>{console.error("Error fetching assets:",e),i.error("Failed to fetch assets"),V([])}).finally(()=>re(!1)),H("")):(V($.filter(a)),H(""))},[f]),o.useEffect(()=>{const e=new URLSearchParams({search:_||"",institute_id:x||"",block_id:u||"",room_id:N||"",asset_category_id:f||"",asset_id:E||"",region_id:v||"",details:c?"true":"false"});fetch(`/reports/assets/institute-assets?${e.toString()}`).then(s=>s.json()).then(s=>{L(s)}).catch(s=>{console.error("Error fetching assets after details toggle:",s),i.error("Failed to fetch assets")})},[c]);const Fe=async()=>{try{const e=await le(),s=new Me.Workbook,r=s.addWorksheet("Assets");r.mergeCells("A1:F1");const p=r.getCell("A1");p.font={size:16,bold:!0},p.alignment={horizontal:"center"},r.mergeCells("A2:F2");const l=r.getCell("A2");l.value="Assets Report",l.font={size:14,bold:!0},l.alignment={horizontal:"center"},r.addRow([]);const F=c?["Institute","Details","Quantity","Block","Room","Category","Asset"]:["Asset","Total Quantity","Rooms"],y=r.addRow(F);y.font={bold:!0},y.fill={type:"pattern",pattern:"solid",fgColor:{argb:"FF428BCA"}},y.alignment={horizontal:"center"},e.forEach(n=>{var j,b,B,z,fe;c?r.addRow([((j=n.institute)==null?void 0:j.name)||"N/A",n.details||"N/A",n.current_qty||0,((b=n.room.block)==null?void 0:b.name)||"N/A",((B=n.room)==null?void 0:B.name)||"N/A",((z=n.asset.category)==null?void 0:z.name)||"N/A",((fe=n.asset)==null?void 0:fe.name)||"N/A"]):r.addRow([n.name||"—",n.total_qty||0,n.locations_count||0])}),r.columns.forEach(n=>{var b;let j=0;(b=n.eachCell)==null||b.call(n,{includeEmpty:!0},B=>{const z=B.value?B.value.toString().length:10;z>j&&(j=z)}),n.width=Math.min(j+2,50)});const A=await s.xlsx.writeBuffer(),g=new Blob([A],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"});Ve.saveAs(g,"Assets_Report.xlsx"),i.success("Excel exported successfully")}catch(e){console.error("Error exporting to Excel:",e),i.error("Failed to export Excel")}},Ae=async()=>{try{const e=await le(),s=new qe;s.setFontSize(16),s.setFont("helvetica","bold"),s.setFontSize(14),s.text("Assets Report",14,25);const r=c?["Institute","Details","Qty","Block","Room","Category","Asset"]:["Asset","Total Quantity","Rooms"],p=e.map(l=>{var F,y,A,g,n,j,b;return c?[((F=l.institute)==null?void 0:F.name)||"N/A",l.details||"N/A",((y=l.current_qty)==null?void 0:y.toString())||"0",((A=l.room)==null?void 0:A.block.name)||"N/A",((g=l.room)==null?void 0:g.name)||"N/A",((j=(n=l.asset)==null?void 0:n.category)==null?void 0:j.name)||"N/A",((b=l.asset)==null?void 0:b.name)||"N/A"]:[l.name||"—",(l.total_qty||0).toString(),(l.locations_count||0).toString()]});Qe(s,{head:[r],body:p,startY:35,styles:{fontSize:9,cellPadding:2},headStyles:{fillColor:[66,139,202],textColor:255,fontStyle:"bold"},alternateRowStyles:{fillColor:[240,240,240]},columnStyles:c?{0:{cellWidth:50},1:{halign:"center",cellWidth:20},5:{cellWidth:50}}:{0:{cellWidth:80},1:{halign:"center"},2:{halign:"center"}}}),s.save("Assets_Report.pdf"),i.success("PDF exported successfully")}catch(e){console.error("Error exporting to PDF:",e),i.error("Failed to export PDF")}},Re=()=>{const e=new URLSearchParams({search:_||"",institute_id:x||"",block_id:u||"",room_id:N||"",asset_category_id:f||"",asset_id:E||"",region_id:v||"",details:c?"true":"false"});fetch(`/reports/assets/institute-assets?${e.toString()}`).then(s=>s.json()).then(s=>{L(s)}).catch(s=>{console.error("Error fetching filtered assets:",s),i.error("Failed to fetch filtered assets")})},Ie=o.useMemo(()=>Te.debounce(()=>{const e=new URLSearchParams({search:_||"",institute_id:x||"",block_id:u||"",room_id:N||"",asset_category_id:f||"",asset_id:E||"",region_id:v||"",details:c?"true":"false"});console.log(e.toString()),fetch(`/reports/assets/institute-assets?${e.toString()}`).then(s=>s.json()).then(s=>{L(s)}).catch(s=>{console.error("Error fetching filtered assets:",s),i.error("Failed to fetch filtered assets")})},300),[x,u,N,f,E,v,c]),Le=o.useMemo(()=>Array.isArray(k)?k.filter(a):(console.warn("filteredInstitutes is not an array or is null:",k),[]),[k]),ne=o.useMemo(()=>Y.filter(a),[Y]),ie=o.useMemo(()=>G.filter(a),[G]),ce=o.useMemo(()=>P.filter(a),[P]),de=o.useMemo(()=>X.filter(a),[X]),me=o.useMemo(()=>T.filter(a),[T]);return t.jsx(We,{children:t.jsxs(Pe,{breadcrumbs:Ue,children:[t.jsx(De,{title:"Assets Report"}),t.jsx("div",{className:"flex-1 p-2 md:p-2",children:t.jsxs("div",{className:"flex flex-col md:flex-row gap-3",children:[t.jsx("div",{className:"w-full md:w-1/3",children:t.jsxs(ge,{children:[t.jsxs(je,{children:[t.jsx(ye,{className:"text-xl font-bold",children:"Filters"}),t.jsx("p",{className:"text-muted-foreground text-sm",children:"Refine your assets search"})]}),t.jsxs(be,{className:"space-y-4",children:[me.length>0&&t.jsx(Se,{entity:"region",value:v,onChange:e=>Ce(e),options:me.map(e=>({id:e.id.toString(),name:e.name.split(" ").pop()||e.name})),includeAllOption:!0}),t.jsx(Se,{entity:"institute",value:x,onChange:e=>J(e),options:Le.map(e=>({id:e.id.toString(),name:e.name})),includeAllOption:!0}),t.jsxs(Q,{value:u,onValueChange:e=>{K(e)},disabled:Z,children:[t.jsx(U,{children:t.jsx(W,{placeholder:"Select Block"})}),t.jsxs(O,{children:[t.jsx(w,{value:"0",children:"All Blocks"}),Z?t.jsx("div",{className:"text-muted-foreground text-sm p-2",children:"Loading blocks..."}):ne.length>0?ne.map(e=>t.jsx(w,{value:e.id.toString(),children:e.name},e.id)):t.jsx("div",{className:"text-muted-foreground text-sm p-2",children:"No blocks available"})]})]}),t.jsxs(Q,{value:N,onValueChange:e=>{I(e)},disabled:te,children:[t.jsx(U,{children:t.jsx(W,{placeholder:"Select Room"})}),t.jsxs(O,{children:[t.jsx(w,{value:"0",children:"All Rooms"}),te?t.jsx("div",{className:"text-muted-foreground text-sm p-2",children:"Loading rooms..."}):ie.length>0?ie.map(e=>t.jsx(w,{value:e.id.toString(),children:e.name.split(" ").pop()||e.name},e.id)):t.jsx("div",{className:"text-muted-foreground text-sm p-2",children:"No rooms available"})]})]}),t.jsxs(Q,{value:f,onValueChange:e=>{ve(e)},children:[t.jsx(U,{children:t.jsx(W,{placeholder:"Select Asset Category"})}),t.jsxs(O,{children:[t.jsx(w,{value:"0",children:"All Asset Categories"}),ce.length>0?ce.map(e=>t.jsx(w,{value:e.id.toString(),children:e.name},e.id)):t.jsx("div",{className:"text-muted-foreground text-sm p-2",children:"No asset categories available"})]})]}),t.jsxs(Q,{value:E,onValueChange:e=>{H(e)},children:[t.jsx(U,{children:t.jsx(W,{placeholder:"Select Asset"})}),t.jsxs(O,{children:[t.jsx(w,{value:"0",children:"All Assets"}),de.length>0?de.map(e=>t.jsx(w,{value:e.id.toString(),children:e.name},e.id)):t.jsx("div",{className:"text-muted-foreground text-sm p-2",children:"No assets available"})]})]}),t.jsxs("div",{className:"flex items-center gap-3 py-2",children:[t.jsx(we,{type:"checkbox",id:"details-mode",checked:c,onChange:e=>ae(e.target.checked)}),t.jsxs("label",{htmlFor:"details-mode",className:"cursor-pointer select-none font-medium text-sm",children:[c?"Detailed View":"Summary View"," — Show individual entries"]})]}),t.jsx(D,{onClick:Ie,className:"w-full",children:"Apply Filters"})]})]})}),t.jsx("div",{className:"w-full md:w-2/3",children:t.jsxs(ge,{children:[t.jsxs(je,{className:"pb-3 flex flex-col md:flex-row md:items-center md:justify-between gap-4",children:[t.jsx("div",{children:t.jsx(ye,{className:"text-2xl font-bold",children:"Assets Report"})}),t.jsxs("div",{className:"flex gap-2",children:[t.jsx(D,{onClick:Ae,className:"w-full md:w-auto",children:"Export PDF"}),t.jsx(D,{onClick:Fe,className:"w-full md:w-auto",children:"Export Excel"})]})]}),t.jsx($e,{}),t.jsx(we,{type:"text",placeholder:"Search projects... (press Enter)",value:_,onChange:e=>Ne(e.target.value),onKeyDown:Re}),t.jsxs(be,{className:"pt-6 space-y-6",children:[t.jsxs("table",{className:"w-full border-collapse border-1 rounded-md overflow-hidden shadow-sm",children:[t.jsx("thead",{children:t.jsx("tr",{className:"bg-primary dark:bg-gray-800",children:c?t.jsxs(t.Fragment,{children:[t.jsx("th",{className:"border p-2 text-left text-sm font-medium text-white dark:text-gray-200",children:"Institute"}),t.jsx("th",{className:"border p-2 text-left text-sm font-medium text-white dark:text-gray-200",children:"Category"}),t.jsx("th",{className:"border p-2 text-left text-sm font-medium text-white dark:text-gray-200",children:"Asset"}),t.jsx("th",{className:"border p-2 text-center text-sm font-medium text-white dark:text-gray-200",children:"Quantity"}),t.jsx("th",{className:"border p-2 text-left text-sm font-medium text-white dark:text-gray-200",children:"Room / Block"}),t.jsx("th",{className:"border p-2 text-left text-sm font-medium text-white dark:text-gray-200",children:"Added Date"})]}):t.jsxs(t.Fragment,{children:["   ",t.jsx("th",{className:"border p-2 text-left text-sm font-medium text-white dark:text-gray-200",children:"Asset"}),t.jsx("th",{className:"border p-2 text-center text-sm font-medium text-white dark:text-gray-200",children:"Total Quantity"}),t.jsx("th",{className:"border p-2 text-center text-sm font-medium text-white dark:text-gray-200",children:"Rooms"})]})})}),t.jsx("tbody",{children:((he=q.data)==null?void 0:he.length)===0?t.jsx("tr",{children:t.jsx("td",{colSpan:c?5:3,className:"border p-2 text-center text-sm text-gray-900 dark:text-gray-100",children:"No assets found."})}):(xe=q.data)==null?void 0:xe.map((e,s)=>{var r,p,l;if(!c){const F=y=>{ae(!0),setTimeout(()=>{const A=new URLSearchParams({search:_||"",institute_id:x||"",block_id:u||"",room_id:N||"",asset_category_id:f||"",asset_id:y.toString(),region_id:v||"",details:"true"});fetch(`/reports/assets/institute-assets?${A.toString()}`).then(g=>g.json()).then(g=>{L(g)}).catch(g=>{console.error("Error fetching asset details:",g),i.error("Failed to fetch asset details")})},0)};return t.jsxs("tr",{className:"hover:bg-primary/10 dark:hover:bg-gray-700 cursor-pointer",onClick:()=>F(e.id),children:[t.jsx("td",{className:"border p-2 text-left font-bold dark:text-gray-100",children:e.name}),t.jsx("td",{className:"border p-2 text-center text-lg font-bold text-green-600",children:e.total_qty}),t.jsx("td",{className:"border p-2 text-center text-amber-600",children:e.locations_count||"-"})]},`${e.name}-${s}`)}return e.asset?t.jsxs("tr",{className:"hover:bg-primary/10 dark:hover:bg-gray-700",children:[t.jsx("td",{className:"border p-2 text-left font-bold dark:text-gray-100",children:(r=e.institute)==null?void 0:r.name}),t.jsx("td",{className:"border p-2 text-left font-bold dark:text-gray-100",children:(p=e.asset)==null?void 0:p.category.name}),t.jsx("td",{className:"border p-2 text-left font-bold dark:text-gray-100",children:(l=e.asset)==null?void 0:l.name}),t.jsx("td",{className:"border p-2 text-center font-bold text-lg text-green-600",children:e.current_qty}),t.jsx("td",{className:"border p-2 text-sm text-gray-900 dark:text-gray-100",children:e.room?t.jsxs(t.Fragment,{children:[e.room.name,e.room.block&&t.jsxs("span",{className:"text-muted-foreground",children:[" (",e.room.block.name,")"]})]}):"—"}),t.jsx("td",{className:"border p-2 text-sm text-gray-900 dark:text-gray-100",children:e.added_date?new Date(e.added_date).toLocaleDateString():"—"})]},e.id):t.jsx("tr",{children:t.jsx("td",{colSpan:5,className:"text-center text-muted-foreground py-4",children:"Loading details..."})},s)})})]}),((ue=q.links)==null?void 0:ue.length)>1&&t.jsx("div",{className:"flex justify-center pt-6 flex-wrap gap-2",children:q.links.map((e,s)=>t.jsx(D,{disabled:!e.url,variant:e.active?"default":"outline",size:"sm",onClick:()=>{e.url&&fetch(e.url).then(r=>r.json()).then(r=>{L(r)}).catch(r=>{console.error("Error:",r)})},className:e.active?"bg-blue-600 hover:bg-blue-700":"",children:t.jsx("span",{dangerouslySetInnerHTML:{__html:e.label}})},s))})]})]})})]})})]})})}export{xt as default};
