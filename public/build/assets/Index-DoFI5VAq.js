var ne=Object.defineProperty;var le=(i,l,o)=>l in i?ne(i,l,{enumerable:!0,configurable:!0,writable:!0,value:o}):i[l]=o;var P=(i,l,o)=>le(i,typeof l!="symbol"?l+"":l,o);import{r as d,j as e,L as de,S as oe}from"./app-BK6rJmXu.js";import{t as _,A as ce,F as M,S as H,c as ie,b as me,E as pe}from"./app-layout-l2ehg8M-.js";import{B as h}from"./button-DQRWskQe.js";import{C as $,a as z,b as V,c as q}from"./card-CFozJfSo.js";import{I as S}from"./input-BhmyGZ1i.js";import{S as O,a as W,b as X,c as J,d as m}from"./select-CTUAKAeR.js";import{D as he,a as xe,b as ue,c as je}from"./dialog-DTFzqGfy.js";import{l as ye}from"./lodash-DumSy8ZN.js";import{E as fe,F as Ne,a as be,b as ge}from"./jspdf.plugin.autotable-C0fZQcKl.js";import{f}from"./dateFormatter-Cn65gwBN.js";import{L as ve}from"./app-logo-icon-B_1bd3yx.js";import"./index-Dz8p6-mA.js";import"./createLucideIcon-CPp4hRCG.js";import"./index-Bu8RmbGK.js";import"./folder-root-DNnhk5Gq.js";import"./grip-vertical-tnNTqh0H.js";import"./index-CNgE_rBi.js";import"./index-Pry_Nrkz.js";const we=[{title:"Transactions",href:"/transactions"},{title:"Transactions",href:"/transactions"}];class Ae extends d.Component{constructor(){super(...arguments);P(this,"state",{hasError:!1,error:null})}static getDerivedStateFromError(o){return{hasError:!0,error:o.message}}componentDidCatch(o,N){console.error("ErrorBoundary:",o,N),_.error("An error occurred. Please try again.")}render(){return this.state.hasError?e.jsxs("div",{className:"p-4",children:[e.jsxs("p",{className:"text-red-600",children:["Error: ",this.state.error]}),e.jsx(h,{onClick:()=>window.location.reload(),className:"mt-2",children:"Retry"})]}):this.props.children}}function qe({transactions:i,filters:l}){var E,R,B,U,I;const[o,N]=d.useState(l.search||""),[b,Q]=d.useState(l.type||""),[g,Y]=d.useState(l.status||""),[v,G]=d.useState(l.date_from||""),[w,K]=d.useState(l.date_to||""),[p,Z]=d.useState(i),[ee,A]=d.useState(!1),[n,C]=d.useState(null),[T,D]=d.useState([]),[F,k]=d.useState(!1),se=async()=>{const s=new fe.Workbook,a=s.addWorksheet("Transactions");a.columns=[{header:"ID",key:"id",width:10},{header:"Amount",key:"amount",width:15},{header:"Type",key:"type",width:20},{header:"Sub Type",key:"sub_type",width:20},{header:"Description",key:"description",width:30},{header:"Status",key:"status",width:12},{header:"Institute",key:"institute",width:30},{header:"Added By",key:"added_by",width:25},{header:"Approved By",key:"approved_by",width:25},{header:"Date",key:"date",width:18}],p.data.forEach(r=>{var x,u,j,y,L;a.addRow({id:r.id,amount:`${parseFloat(r.total_amount.toString()).toFixed(2)}`,type:(x=r.type)!=null&&x.name?r.type.name.charAt(0).toUpperCase()+r.type.name.slice(1):"N/A",sub_type:(u=r.sub_type)!=null&&u.name?r.sub_type.name.charAt(0).toUpperCase()+r.sub_type.name.slice(1):"N/A",description:r.description||"N/A",status:r.status.charAt(0).toUpperCase()+r.status.slice(1),institute:((j=r.institute)==null?void 0:j.name)||"N/A",added_by:((y=r.added_by)==null?void 0:y.name)||"N/A",approved_by:((L=r.approved_by)==null?void 0:L.name)||"N/A",date:f(r.created_at)})});const c=await s.xlsx.writeBuffer(),t=new Blob([c],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"});Ne.saveAs(t,"Transactions_Report.xlsx")},ae=()=>{const s=new be;s.setFontSize(16),s.text("Transactions Report",14,15);const a=["ID","Amount","Type","Sub Type","Description","Status","Institute","Added By","Approved By","Date"],c=p.data.map(t=>{var r,x,u,j,y;return[t.id.toString(),`${parseFloat(t.total_amount.toString()).toFixed(2)}`,(r=t.type)!=null&&r.name?t.type.name.charAt(0).toUpperCase()+t.type.name.slice(1):"N/A",(x=t.sub_type)!=null&&x.name?t.sub_type.name.charAt(0).toUpperCase()+t.sub_type.name.slice(1):"N/A",t.description||"N/A",t.status.charAt(0).toUpperCase()+t.status.slice(1),((u=t.institute)==null?void 0:u.name)||"N/A",((j=t.added_by)==null?void 0:j.name)||"N/A",((y=t.approved_by)==null?void 0:y.name)||"N/A",f(t.created_at)]});ge(s,{head:[a],body:c,startY:25,styles:{fontSize:9,cellPadding:2},headStyles:{fillColor:[46,124,196],textColor:255,fontStyle:"bold"},alternateRowStyles:{fillColor:[240,240,240]}}),s.save("Transactions_Report.pdf")},te=d.useMemo(()=>ye.debounce(()=>{const s=new URLSearchParams({search:o.trim(),type:b||"",status:g||"",date_from:v||"",date_to:w||""});fetch(`/transactions/gettransactions?${s.toString()}`,{headers:{"X-Requested-With":"XMLHttpRequest",Accept:"application/json"}}).then(a=>{if(!a.ok)throw new Error("Network error");return a.json()}).then(a=>{Z(a)}).catch(a=>{console.error("Fetch error:",a),_.error("Failed to load transactions")})},400),[o,,b,g,v,w]),re=async s=>{k(!0);try{const a=await fetch(`/transactions/getbytid?tid=${s}`);if(!a.ok)throw new Error("Failed to load details");const{transaction:c,transdetails:t}=await a.json();C(c),console.log("Transaction Details:",t),D(t),A(!0)}catch(a){_.error("Could not load transaction details"),console.error(a)}finally{k(!1)}};return d.useEffect(()=>()=>{A(!1),C(null),D([])},[]),e.jsx(Ae,{children:e.jsxs(ce,{breadcrumbs:we,children:[e.jsx(de,{title:"Transactions Report"}),e.jsx("div",{className:"flex-1 p-1 md:p-1",children:e.jsxs("div",{className:"flex flex-col md:flex-row gap-3",children:[e.jsx("div",{className:"w-full md:w-1/4",children:e.jsxs($,{children:[e.jsxs(z,{children:[e.jsx(V,{className:"text-xl font-bold flex items-center gap-2",children:"Filters"}),e.jsx("p",{className:"text-muted-foreground text-sm",children:"Refine transaction search"})]}),e.jsxs(q,{className:"space-y-4",children:[e.jsx(S,{placeholder:"Search by ID, amount, type...",value:o,onChange:s=>N(s.target.value)}),e.jsxs(O,{value:b,onValueChange:Q,children:[e.jsx(W,{children:e.jsx(X,{placeholder:"Select Type"})}),e.jsxs(J,{children:[e.jsx(m,{value:"0",children:"All Types"}),e.jsx(m,{value:"purchase",children:"Purchase"}),e.jsx(m,{value:"maintenance",children:"Maintenance"}),e.jsx(m,{value:"condemned",children:"Condemned"})]})]}),e.jsxs(O,{value:g,onValueChange:Y,children:[e.jsx(W,{children:e.jsx(X,{placeholder:"Select Status"})}),e.jsxs(J,{children:[e.jsx(m,{value:"0",children:"All Status"}),e.jsx(m,{value:"pending",children:"Pending"}),e.jsx(m,{value:"approved",children:"Approved"}),e.jsx(m,{value:"rejected",children:"Rejected"})]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(S,{type:"date",value:v,onChange:s=>G(s.target.value),className:"flex-1"}),e.jsx(S,{type:"date",value:w,onChange:s=>K(s.target.value),className:"flex-1"})]}),e.jsx(h,{onClick:te,className:"w-full",children:"Apply Filters"})]})]})}),e.jsx("div",{className:"w-full md:w-full",children:e.jsxs($,{children:[e.jsxs(z,{className:"pb-3 flex flex-col md:flex-row md:items-center md:justify-between gap-4",children:[e.jsx("div",{children:e.jsxs(V,{className:"text-2xl font-bold flex items-center gap-2",children:[e.jsx(M,{className:"w-6 h-6"}),"Transactions Report"]})}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(h,{onClick:ae,className:"w-full md:w-auto",children:"Export PDF"}),e.jsx(h,{onClick:se,className:"w-full md:w-auto",children:"Export Excel"})]})]}),e.jsx(H,{}),e.jsxs(q,{className:"pt-6 space-y-6",children:[e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full border-collapse text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-primary text-white text-center",children:[e.jsx("th",{className:"border p-2 font-medium",children:"ID"}),e.jsx("th",{className:"border p-2 font-medium",children:"Amount"}),e.jsx("th",{className:"border p-2 font-medium",children:"Type"}),e.jsx("th",{className:"border p-2 font-medium",children:"Sub Type"}),e.jsx("th",{className:"border p-2 font-medium",children:"Status"}),e.jsx("th",{className:"border p-2 font-medium",children:"Added By"}),e.jsx("th",{className:"border p-2 font-medium",children:"Approved By"}),e.jsx("th",{className:"border p-2 font-medium",children:"Date"}),e.jsx("th",{className:"border p-2 font-medium",children:"Actions"})]})}),e.jsx("tbody",{children:p.data.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:10,className:"text-center p-4 text-muted-foreground",children:"No transactions found."})}):p.data.map(s=>{var a,c,t,r;return e.jsxs("tr",{className:"hover:bg-gray-50 dark:hover:bg-gray-700 text-center",children:[e.jsxs("td",{className:"border p-2",children:["#",s.id]}),e.jsx("td",{className:"border p-2 font-medium",children:parseFloat(s.total_amount.toString()).toFixed(2)}),e.jsx("td",{className:"border p-2",children:e.jsx("span",{className:"px-2 py-1 rounded text-xs font-medium bg-blue-100 text-blue-800",children:(a=s.type)!=null&&a.name?s.type.name.charAt(0).toUpperCase()+s.type.name.slice(1):"N/A"})}),e.jsx("td",{className:"border p-2",children:e.jsx("span",{className:"px-2 py-1 rounded text-xs font-medium bg-purple-100 text-purple-800",children:(c=s.sub_type)!=null&&c.name?s.sub_type.name.charAt(0).toUpperCase()+s.sub_type.name.slice(1):"N/A"})}),e.jsx("td",{className:"border p-2",children:e.jsxs("span",{className:`px-2 py-1 rounded text-xs font-medium flex items-center justify-center gap-1 ${s.status==="approved"?"bg-green-100 text-green-800":s.status==="rejected"?"bg-red-100 text-red-800":"bg-yellow-100 text-yellow-800"}`,children:[s.status==="approved"&&e.jsx(ie,{className:"w-3 h-3"}),s.status==="rejected"&&e.jsx(me,{className:"w-3 h-3"}),s.status.charAt(0).toUpperCase()+s.status.slice(1)]})}),e.jsx("td",{className:"border p-2",children:((t=s.added_by)==null?void 0:t.name)||"N/A"}),e.jsx("td",{className:"border p-2",children:((r=s.approved_by)==null?void 0:r.name)||"N/A"}),e.jsx("td",{className:"border p-2 text-xs",children:f(s.created_at)}),e.jsx("td",{className:"border p-2",children:e.jsx("div",{className:"flex items-center justify-center gap-2",children:e.jsx(h,{size:"icon",variant:"ghost",className:"h-8 w-8",onClick:()=>re(s.id),disabled:F,title:"View details",children:F?e.jsx(ve,{className:"h-4 w-4 animate-spin"}):e.jsx(pe,{className:"h-4 w-4"})})})})]},s.id)})})]})}),e.jsx(he,{open:ee,onOpenChange:A,children:e.jsxs(xe,{className:"max-w-4xl max-h-[90vh] overflow-y-auto",children:[e.jsx(ue,{children:e.jsxs(je,{className:"flex items-center gap-2",children:[e.jsx(M,{className:"w-5 h-5"}),"Transaction #",n==null?void 0:n.id]})}),n&&e.jsxs("div",{className:"mt-4 space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Amount:"})," RS ",parseFloat(n.total_amount.toString()).toFixed(2)]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Type:"})," ",(E=n.type)!=null&&E.name?n.type.name.charAt(0).toUpperCase()+n.type.name.slice(1):"N/A"]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Sub Type:"})," ",(R=n.sub_type)!=null&&R.name?n.sub_type.name.charAt(0).toUpperCase()+n.sub_type.name.slice(1):"N/A"]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Status:"})," ",n.status.charAt(0).toUpperCase()+n.status.slice(1)]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Institute:"})," ",((B=n.institute)==null?void 0:B.name)||"N/A"]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Added By:"})," ",((U=n.added_by)==null?void 0:U.name)||"N/A"]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Approved By:"})," ",((I=n.approved_by)==null?void 0:I.name)||"N/A"]}),e.jsxs("div",{className:"col-span-2",children:[e.jsx("span",{className:"font-medium",children:"Date:"})," ",f(n.created_at)]}),n.description&&e.jsxs("div",{className:"col-span-2",children:[e.jsx("span",{className:"font-medium",children:"Description:"}),e.jsx("p",{className:"mt-1 text-muted-foreground",children:n.description})]})]}),e.jsx(H,{}),T.length?e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full text-sm border",children:[e.jsx("thead",{className:"bg-muted",children:e.jsxs("tr",{children:[e.jsx("th",{className:"border p-2 text-left",children:"Asset"}),e.jsx("th",{className:"border p-2 text-left",children:"Room"}),e.jsx("th",{className:"border p-2 text-left",children:"Fund Head"}),e.jsx("th",{className:"border p-2 text-left",children:"Qty"}),e.jsx("th",{className:"border p-2 text-left",children:"Amount"})]})}),e.jsx("tbody",{children:T.map((s,a)=>{var c;return e.jsxs("tr",{className:"hover:bg-muted/50",children:[e.jsx("td",{className:"border p-2",children:s.asset_name||"-"}),e.jsx("td",{className:"border p-2",children:s.room_name||"-"}),e.jsx("td",{className:"border p-2",children:s.fund_head_name||"-"}),e.jsx("td",{className:"border p-2",children:s.qty??"-"}),e.jsxs("td",{className:"border p-2",children:["RS ",parseFloat(((c=s.amount)==null?void 0:c.toString())??"0").toFixed(2)]})]},a)})})]})}):e.jsx("p",{className:"text-muted-foreground",children:"No line items."})]})]})}),p.links.length>1&&e.jsx("div",{className:"flex justify-center pt-6 flex-wrap gap-2",children:p.links.map((s,a)=>e.jsx(h,{disabled:!s.url,variant:s.active?"default":"outline",size:"sm",onClick:()=>oe.visit(s.url||"",{preserveScroll:!0}),children:e.jsx("span",{dangerouslySetInnerHTML:{__html:s.label}})},a))})]})]})})]})})]})})}export{qe as default};
