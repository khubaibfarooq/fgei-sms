var ne=Object.defineProperty;var le=(n,i,c)=>i in n?ne(n,i,{enumerable:!0,configurable:!0,writable:!0,value:c}):n[i]=c;var Y=(n,i,c)=>le(n,typeof i!="symbol"?i+"":i,c);import{r as s,j as t,L as ie}from"./app-DbMN_pDU.js";import{A as ce}from"./app-layout-Cbt6S9Lt.js";import{B as b}from"./button-Dewi3Yoy.js";import{C as de,a as me,b as pe,c as he}from"./card-BYHvoBi2.js";import{I as xe}from"./input-CmjssZCr.js";import{t as m}from"./index-BLaHgm17.js";import{l as ue}from"./lodash-DoP9nXJ7.js";import{E as fe,F as ge,a as ye,b as be}from"./jspdf.plugin.autotable-DTEprAvM.js";import{C as I}from"./combobox-FkfERhcG.js";import{I as je}from"./image-preview-LndnkB9l.js";import"./index-5V5msJx7.js";import"./createLucideIcon-rRfuV1Qo.js";import"./index-DFkdK2sn.js";import"./index-D8ZpsMFG.js";import"./index-CkZoLfaC.js";import"./index-8NxINPJX.js";import"./app-logo-icon-AIaIiUUJ.js";import"./circle-x-BJIo3qi4.js";import"./clsx-B-dksMZM.js";import"./folder-root-BPE4WJcn.js";import"./grip-vertical-CzfqgQ7Z.js";import"./popover-Du26dFKX.js";const ke=[{title:"Reports",href:"/reports"},{title:"Rooms",href:"/reports/rooms"}];class we extends s.Component{constructor(){super(...arguments);Y(this,"state",{hasError:!1,error:null})}static getDerivedStateFromError(c){return{hasError:!0,error:c.message}}componentDidCatch(c,f){console.error("ErrorBoundary caught:",c,f),m.error("An error occurred while rendering the component. Please try again or contact support.")}render(){return this.state.hasError?t.jsxs("div",{className:"p-4",children:[t.jsxs("p",{className:"text-red-600",children:["Error: ",this.state.error]}),t.jsx(b,{onClick:()=>window.location.reload(),className:"mt-2",children:"Retry"})]}):this.props.children}}const x=n=>{const i=n!=null&&typeof n.id=="number"&&n.id>0&&typeof n.name=="string"&&n.name.trim()!=="";return i||console.warn("Invalid item detected:",n),i};function qe({rooms:n,institutes:i,roomtypes:c,regions:f,filters:j}){var U,H,V;const[k,z]=s.useState(j.search||""),[p,_]=s.useState(j.institute_id||""),[N,E]=s.useState(j.block_id||""),[C,P]=s.useState(j.roomtype_id||""),[v,q]=s.useState(j.region_id||""),[A,L]=s.useState(n),[u,T]=s.useState(i||[]),[D,S]=s.useState([]),[Re,M]=s.useState(!1),[Ne,G]=s.useState([]),K=async e=>{try{const r=new URLSearchParams({region_id:e||""}).toString(),o=await fetch(`/reports/getInstitutes?${r}`);if(!o.ok)throw new Error("Failed to fetch institutes");const a=await o.json();console.log("Fetched institutes:",a),T(a),p&&e!=="0"&&!a.some(l=>l.id.toString()===p)&&_("")}catch(r){console.error("Error fetching institutes:",r),m.error("Failed to load institutes"),T([])}},Q=e=>{q(e),_(""),E(""),P(""),K(e)};s.useEffect(()=>{p?(M(!0),fetch(`/reports/rooms/getInstituteBlocks?institute_id=${p}`).then(e=>e.json()).then(e=>{if(console.log("Fetched blocks:",e),Array.isArray(e)){const r=e.filter(x);S(r)}else console.warn("Blocks response is not an array:",e),m.error("Invalid blocks data received"),S([])}).catch(e=>{console.error("Error fetching blocks:",e),m.error("Failed to fetch blocks"),S([])}).finally(()=>M(!1)),E("")):(S([]),E(""))},[p]);const $=async()=>{try{const e=new URLSearchParams({search:k||"",institute_id:p||"",block_id:N||"",roomtype_id:C||"",region_id:v||"",all:"true"}),r=await fetch(`/reports/rooms/getRoomsReport?${e.toString()}`);if(!r.ok)throw new Error("Failed to fetch all rooms for export");const o=await r.json();return G(o),o}catch(e){return console.error("Error fetching all rooms for export:",e),m.error("Failed to fetch rooms for export"),[]}};s.useEffect(()=>{const e={institutes:Array.isArray(u)?u.filter(r=>!x(r)):[],roomtypes:c.filter(r=>!x(r)),regions:f.filter(r=>!x(r))};Object.entries(e).forEach(([r,o])=>{o.length>0&&console.warn(`Invalid ${r}:`,o)})},[i,c,f,u]);const X=async()=>{var e,r;try{const o=await $(),a=new fe.Workbook,l=a.addWorksheet("Rooms"),B=o.length>0&&((r=(e=o[0].block)==null?void 0:e.institute)!=null&&r.name)?o[0].block.institute.name:"All Institutes";l.mergeCells("A1:E1");const w=l.getCell("A1");w.value=`Institute: ${B}`,w.font={size:16,bold:!0},w.alignment={horizontal:"center"},l.mergeCells("A2:E2");const h=l.getCell("A2");h.value="Rooms Report",h.font={size:14,bold:!0},h.alignment={horizontal:"center"},l.addRow([]);const F=["Room Name","Room Type","Block","Area","Capacity"],g=l.addRow(F);g.font={bold:!0},g.fill={type:"pattern",pattern:"solid",fgColor:{argb:"FF428BCA"}},g.alignment={horizontal:"center"},o.forEach(d=>{var y,R;l.addRow([d.name||"—",((y=d.room_type)==null?void 0:y.name)||"N/A",((R=d.block)==null?void 0:R.name)||"N/A",d.area||"N/A",d.capacity||"N/A"])}),l.columns.forEach(d=>{var R;let y=0;(R=d.eachCell)==null||R.call(d,{includeEmpty:!0},W=>{const J=W.value?W.value.toString().length:10;J>y&&(y=J)}),d.width=Math.min(y+2,50)});const se=await a.xlsx.writeBuffer(),ae=new Blob([se],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"});ge.saveAs(ae,"Rooms_Report.xlsx"),m.success("Excel exported successfully")}catch(o){console.error("Error exporting to Excel:",o),m.error("Failed to export Excel")}},Z=async()=>{var e,r;try{const o=await $(),a=new ye,l=o.length>0&&((r=(e=o[0].block)==null?void 0:e.institute)!=null&&r.name)?o[0].block.institute.name:"All Institutes";a.setFontSize(16),a.setFont("helvetica","bold"),a.text(`Institute: ${l}`,14,15),a.setFontSize(14),a.text("Rooms Report",14,25);const B=["Room Name","Room Type","Block","Area","Capacity"],w=o.map(h=>{var F,g;return[h.name||"—",((F=h.room_type)==null?void 0:F.name)||"N/A",((g=h.block)==null?void 0:g.name)||"N/A",h.area||"N/A",h.capacity||"N/A"]});be(a,{head:[B],body:w,startY:35,styles:{fontSize:9,cellPadding:2},headStyles:{fillColor:[66,139,202],textColor:255,fontStyle:"bold"},alternateRowStyles:{fillColor:[240,240,240]}}),a.save("Rooms_Report.pdf"),m.success("PDF exported successfully")}catch(o){console.error("Error exporting to PDF:",o),m.error("Failed to export PDF")}},ee=s.useMemo(()=>ue.debounce(()=>{const e=new URLSearchParams({search:k||"",institute_id:p||"",block_id:N||"",roomtype_id:C||"",region_id:v||""});fetch(`/reports/rooms/getRoomsReport?${e.toString()}`).then(r=>r.json()).then(r=>{console.log("Fetched filtered rooms:",r),L(r)}).catch(r=>{console.error("Error fetching filtered rooms:",r),m.error("Failed to fetch filtered rooms")})},300),[k,p,N,C,v]),te=s.useMemo(()=>Array.isArray(u)?u.filter(x):(console.warn("filteredInstitutes is not an array or is null:",u),[]),[u]),re=s.useMemo(()=>D.filter(x),[D]),oe=s.useMemo(()=>c.filter(x),[c]),O=s.useMemo(()=>f.filter(x),[f]);return t.jsx(we,{children:t.jsxs(ce,{breadcrumbs:ke,children:[t.jsx(ie,{title:"Rooms Report"}),t.jsx("div",{className:"flex-1 p-2 md:p-2",children:t.jsxs(de,{children:[t.jsxs(me,{children:[t.jsx(pe,{className:"text-xl font-bold",children:"Filters"}),t.jsx("p",{className:"text-muted-foreground text-sm",children:"Refine your rooms search"})]}),t.jsxs(he,{className:"space-y-4",children:[t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx(xe,{placeholder:"Search rooms...",value:k,onChange:e=>z(e.target.value)}),t.jsx(b,{variant:"outline",onClick:()=>z(""),disabled:!k,children:"Clear"})]}),t.jsxs("div",{className:"flex items-center space-x-2",children:[O.length>0&&t.jsx(I,{entity:"region",value:v,onChange:e=>Q(e),options:O.map(e=>({id:e.id.toString(),name:e.name.split(" ").pop()||e.name})),includeAllOption:!0}),t.jsx(I,{entity:"institute",value:p,onChange:e=>_(e),options:te.map(e=>({id:e.id.toString(),name:e.name})),includeAllOption:!0}),t.jsx(I,{entity:"block",value:N,onChange:e=>E(e),options:re.map(e=>({id:e.id.toString(),name:e.name})),includeAllOption:!0}),t.jsx(I,{entity:"roomtype",value:C,onChange:e=>P(e),options:oe.map(e=>({id:e.id.toString(),name:e.name})),includeAllOption:!0}),t.jsx(b,{onClick:ee,className:"w-fit",children:"Apply Filters"}),t.jsx(b,{onClick:Z,className:"w-full md:w-auto",children:"Export PDF"}),t.jsx(b,{onClick:X,className:"w-full md:w-auto",children:"Export Excel"})]}),t.jsxs("table",{className:"w-full border-collapse border-1 rounded-md overflow-hidden shadow-sm",children:[t.jsx("thead",{children:t.jsxs("tr",{className:"bg-primary dark:bg-gray-800",children:[t.jsx("th",{className:"border p-2 text-left text-sm font-medium text-white dark:text-gray-200",children:"Institute"}),t.jsx("th",{className:"border p-2 text-left text-sm font-medium text-white dark:text-gray-200",children:"Block"}),t.jsx("th",{className:"border p-2 text-left text-sm font-medium text-white dark:text-gray-200",children:"Room Type"}),t.jsx("th",{className:"border p-2 text-left text-sm font-medium text-white dark:text-gray-200",children:"Room Name"}),t.jsx("th",{className:"border p-2 text-left text-sm font-medium text-white dark:text-gray-200",children:"Area"})]})}),t.jsx("tbody",{children:((U=A.data)==null?void 0:U.length)===0?t.jsx("tr",{children:t.jsx("td",{colSpan:5,className:"border p-2 text-center text-sm text-gray-900 dark:text-gray-100",children:"No rooms found."})}):(H=A.data)==null?void 0:H.map(e=>{var r,o,a,l;return t.jsxs("tr",{className:"hover:bg-primary/10 dark:hover:bg-gray-700",children:[t.jsx("td",{className:"border p-2 text-left text-gray-900 dark:text-gray-100",children:((o=(r=e.block)==null?void 0:r.institute)==null?void 0:o.name)||"—"}),t.jsx("td",{className:"border p-2 text-left text-gray-900 dark:text-gray-100",children:((a=e.block)==null?void 0:a.name)||"—"}),t.jsx("td",{className:"border p-2 text-left text-gray-900 dark:text-gray-100",children:((l=e.type)==null?void 0:l.name)||"—"}),t.jsx("td",{className:"border p-2 text-left font-bold dark:text-gray-100",children:t.jsxs("div",{className:"flex flex-column gap-2 align-middle",children:[" ",t.jsx(je,{dataImg:e.img,size:"h-20 w-20 object-contain"}),"  ",t.jsx("span",{className:"font-bold",children:e.name})]})}),t.jsx("td",{className:"border p-2 text-left text-gray-900 dark:text-gray-100",children:e.area||"—"})]},e.id)})})]}),((V=A.links)==null?void 0:V.length)>1&&t.jsx("div",{className:"flex justify-center pt-6 flex-wrap gap-2",children:A.links.map((e,r)=>t.jsx(b,{disabled:!e.url,variant:e.active?"default":"outline",size:"sm",onClick:()=>{e.url&&fetch(e.url).then(o=>o.json()).then(o=>{L(o)}).catch(o=>{console.error("Error:",o)})},className:e.active?"bg-blue-600 hover:bg-blue-700":"",children:t.jsx("span",{dangerouslySetInnerHTML:{__html:e.label}})},r))})]})]})})]})})}export{qe as default};
