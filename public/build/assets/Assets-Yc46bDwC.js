var Ae=Object.defineProperty;var Ee=(l,n,c)=>n in l?Ae(l,n,{enumerable:!0,configurable:!0,writable:!0,value:c}):l[n]=c;var xe=(l,n,c)=>Ee(l,typeof n!="symbol"?n+"":n,c);import{r as o,j as t,L as Fe}from"./app-DQOnOCji.js";import{t as i,A as _e,S as Ce,B as Re}from"./app-layout-D7f4rM7y.js";import{B as R}from"./button-DxaTv_LC.js";import{C as ue,a as fe,b as pe,c as ge}from"./card-CZaQtEmO.js";import{S as b,a as v,b as N,c as w,d as h}from"./select-DYyFmtGj.js";import{l as Ie}from"./lodash-Cr0OLHlw.js";import{E as Be,F as Le,a as De,b as Pe}from"./jspdf.plugin.autotable-Cy-uFL-w.js";import"./index-DzwLc95r.js";import"./index-DYdBfOMc.js";import"./createLucideIcon-COe4Dzom.js";import"./index-CU3ww6-I.js";import"./app-logo-icon-DHsOh_Xq.js";import"./index-Cj4ik10W.js";import"./index-DPkm_vAq.js";const ze=[{title:"Reports",href:"/reports"},{title:"Assets",href:"/reports/assets"}];class Ve extends o.Component{constructor(){super(...arguments);xe(this,"state",{hasError:!1,error:null})}static getDerivedStateFromError(c){return{hasError:!0,error:c.message}}componentDidCatch(c,k){console.error("ErrorBoundary caught:",c,k),i.error("An error occurred while rendering the component. Please try again or contact support.")}render(){return this.state.hasError?t.jsxs("div",{className:"p-4",children:[t.jsxs("p",{className:"text-red-600",children:["Error: ",this.state.error]}),t.jsx(R,{onClick:()=>window.location.reload(),className:"mt-2",children:"Retry"})]}):this.props.children}}const a=l=>{const n=l!=null&&typeof l.id=="number"&&l.id>0&&typeof l.name=="string"&&l.name.trim()!=="";return n||console.warn("Invalid item detected:",l),n};function st({instituteAssets:l,institutes:n,blocks:c,rooms:k,assetCategories:I,assets:$,regions:B,filters:u}){var ce,de,he;const[T,Me]=o.useState(u.search||""),[x,U]=o.useState(u.institute_id||""),[f,H]=o.useState(u.block_id||""),[L,S]=o.useState(u.room_id||""),[p,je]=o.useState(u.asset_category_id||""),[D,q]=o.useState(u.asset_id||""),[P,ye]=o.useState(u.region_id||""),[W,z]=o.useState(c.filter(a)),[J,y]=o.useState(k.filter(a)),[O,V]=o.useState($.filter(a)),[Y,G]=o.useState(!1),[K,X]=o.useState(!1),[Z,ee]=o.useState(!1),[M,te]=o.useState(l),[g,se]=o.useState(n||[]),[$e,be]=o.useState([]),ve=async e=>{try{const s=new URLSearchParams({region_id:e||""}).toString(),r=await fetch(`/reports/getInstitutes?${s}`);if(!r.ok)throw new Error("Failed to fetch institutes");const j=await r.json();console.log("Fetched institutes:",j),se(j),x&&e!=="0"&&!j.some(d=>d.id.toString()===x)&&U("")}catch(s){console.error("Error fetching institutes:",s),i.error("Failed to load institutes"),se([])}},Ne=e=>{ye(e),ve(e)},re=async()=>{try{const e=new URLSearchParams({search:T||"",institute_id:x||"",block_id:f||"",room_id:L||"",asset_category_id:p||"",asset_id:D||"",region_id:P||"",all:"true"}),s=await fetch(`/reports/assets/institute-assets?${e.toString()}`);if(!s.ok)throw new Error("Failed to fetch all assets for export");const r=await s.json();return be(r),r}catch(e){return console.error("Error fetching all assets for export:",e),i.error("Failed to fetch assets for export"),[]}};o.useEffect(()=>{const e={institutes:Array.isArray(g)?g.filter(s=>!a(s)):[],blocks:c.filter(s=>!a(s)),rooms:k.filter(s=>!a(s)),assetCategories:I.filter(s=>!a(s)),assets:$.filter(s=>!a(s)),regions:B.filter(s=>!a(s))};Object.entries(e).forEach(([s,r])=>{r.length>0&&console.warn(`Invalid ${s}:`,r)})},[n,c,k,I,$,B,g]),o.useEffect(()=>{x?(G(!0),fetch(`/reports/blocks?institute_id=${x}`).then(e=>e.json()).then(e=>{if(console.log("Fetched blocks:",e),Array.isArray(e)){const s=e.filter(a);s.length<e.length&&console.warn("Filtered out invalid blocks:",e.filter(r=>!a(r))),z(s)}else console.warn("Blocks response is not an array:",e),i.error("Invalid blocks data received"),z([])}).catch(e=>{console.error("Error fetching blocks:",e),i.error("Failed to fetch blocks"),z([])}).finally(()=>G(!1)),H(""),y([]),S("")):(z([]),y([]),S(""))},[x]),o.useEffect(()=>{f?(X(!0),fetch(`/reports/rooms?block_id=${f}`).then(e=>e.json()).then(e=>{if(console.log("Fetched rooms:",e),Array.isArray(e)){const s=e.filter(a);s.length<e.length&&console.warn("Filtered out invalid rooms:",e.filter(r=>!a(r))),y(s)}else console.warn("Rooms response is not an array:",e),i.error("Invalid rooms data received"),y([])}).catch(e=>{console.error("Error fetching rooms:",e),i.error("Failed to fetch rooms"),y([])}).finally(()=>X(!1)),S("")):(y([]),S(""))},[f]),o.useEffect(()=>{p?(ee(!0),fetch(`/reports/assets/list?asset_category_id=${p}`).then(e=>e.json()).then(e=>{if(console.log("Fetched assets:",e),Array.isArray(e)){const s=e.filter(a);s.length<e.length&&console.warn("Filtered out invalid assets:",e.filter(r=>!a(r))),V(s)}else console.warn("Assets response is not an array:",e),i.error("Invalid assets data received"),V([])}).catch(e=>{console.error("Error fetching assets:",e),i.error("Failed to fetch assets"),V([])}).finally(()=>ee(!1)),q("")):(V([]),q(""))},[p]);const we=async()=>{try{const e=await re(),s=new Be.Workbook,r=s.addWorksheet("Assets");r.columns=[{header:"Details",key:"details",width:30},{header:"Quantity",key:"qty",width:10},{header:"Institute",key:"institute",width:20},{header:"Block",key:"block",width:20},{header:"Room",key:"room",width:20},{header:"Category",key:"category",width:20},{header:"Asset",key:"asset",width:20},{header:"Region",key:"region",width:20}],e.forEach(m=>{var A,E,F,_,C,me;r.addRow({details:m.details,qty:m.current_qty,institute:((A=m.institute)==null?void 0:A.name)||"N/A",block:((E=m.block)==null?void 0:E.name)||"N/A",room:((F=m.room)==null?void 0:F.name)||"N/A",category:((_=m.assetCategory)==null?void 0:_.name)||"N/A",asset:((C=m.asset)==null?void 0:C.name)||"N/A",region:((me=m.region)==null?void 0:me.name)||"N/A"})});const j=await s.xlsx.writeBuffer(),d=new Blob([j],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"});Le.saveAs(d,"Assets_Report.xlsx"),i.success("Excel exported successfully")}catch(e){console.error("Error exporting to Excel:",e),i.error("Failed to export Excel")}},ke=async()=>{try{const e=await re(),s=new De;s.setFontSize(16),s.text("Assets Report",14,15);const r=["Details","Qty","Institute","Block","Room","Category","Asset","Region"],j=e.map(d=>{var m,A,E,F,_,C;return[d.details||"N/A",d.current_qty.toString(),((m=d.institute)==null?void 0:m.name)||"N/A",((A=d.block)==null?void 0:A.name)||"N/A",((E=d.room)==null?void 0:E.name)||"N/A",((F=d.assetCategory)==null?void 0:F.name)||"N/A",((_=d.asset)==null?void 0:_.name)||"N/A",((C=d.region)==null?void 0:C.name)||"N/A"]});Pe(s,{head:[r],body:j,startY:25,styles:{fontSize:9,cellPadding:2},headStyles:{fillColor:[66,139,202],textColor:255,fontStyle:"bold"},alternateRowStyles:{fillColor:[240,240,240]}}),s.save("Assets_Report.pdf"),i.success("PDF exported successfully")}catch(e){console.error("Error exporting to PDF:",e),i.error("Failed to export PDF")}},Se=o.useMemo(()=>Ie.debounce(()=>{const e=new URLSearchParams({search:T||"",institute_id:x||"",block_id:f||"",room_id:L||"",asset_category_id:p||"",asset_id:D||"",region_id:P||""});fetch(`/reports/assets/institute-assets?${e.toString()}`).then(s=>s.json()).then(s=>{console.log("Fetched filtered institute assets:",s),te(s)}).catch(s=>{console.error("Error fetching filtered assets:",s),i.error("Failed to fetch filtered assets")})},300),[T,x,f,L,p,D,P]),oe=o.useMemo(()=>Array.isArray(g)?g.filter(a):(console.warn("filteredInstitutes is not an array or is null:",g),[]),[g]),ae=o.useMemo(()=>W.filter(a),[W]),le=o.useMemo(()=>J.filter(a),[J]),ne=o.useMemo(()=>I.filter(a),[I]),ie=o.useMemo(()=>O.filter(a),[O]),Q=o.useMemo(()=>B.filter(a),[B]);return t.jsx(Ve,{children:t.jsxs(_e,{breadcrumbs:ze,children:[t.jsx(Fe,{title:"Assets Report"}),t.jsx("div",{className:"flex-1 p-2 md:p-2",children:t.jsxs("div",{className:"flex flex-col md:flex-row gap-3",children:[t.jsx("div",{className:"w-full md:w-1/3",children:t.jsxs(ue,{children:[t.jsxs(fe,{children:[t.jsx(pe,{className:"text-xl font-bold",children:"Filters"}),t.jsx("p",{className:"text-muted-foreground text-sm",children:"Refine your assets search"})]}),t.jsxs(ge,{className:"space-y-4",children:[Q.length>0&&t.jsxs(b,{value:P,onValueChange:Ne,children:[t.jsx(v,{children:t.jsx(N,{placeholder:"Select Region"})}),t.jsxs(w,{children:[t.jsx(h,{value:"0",children:"All Regions"}),Q.length>0?Q.map(e=>t.jsx(h,{value:e.id.toString(),children:e.name},e.id)):t.jsx("div",{className:"text-muted-foreground text-sm p-2",children:"No regions available"})]})]}),t.jsxs(b,{value:x,onValueChange:e=>{U(e)},children:[t.jsx(v,{children:t.jsx(N,{placeholder:"Select Institute"})}),t.jsxs(w,{children:[t.jsx(h,{value:"0",children:"All Institutes"}),oe.length>0?oe.map(e=>t.jsx(h,{value:e.id.toString(),children:e.name},e.id)):t.jsx("div",{className:"text-muted-foreground text-sm p-2",children:"No institutes available"})]})]}),t.jsxs(b,{value:f,onValueChange:e=>{H(e)},disabled:Y,children:[t.jsx(v,{children:t.jsx(N,{placeholder:"Select Block"})}),t.jsxs(w,{children:[t.jsx(h,{value:"0",children:"All Blocks"}),Y?t.jsx("div",{className:"text-muted-foreground text-sm p-2",children:"Loading blocks..."}):ae.length>0?ae.map(e=>t.jsx(h,{value:e.id.toString(),children:e.name},e.id)):t.jsx("div",{className:"text-muted-foreground text-sm p-2",children:"No blocks available"})]})]}),t.jsxs(b,{value:L,onValueChange:e=>{S(e)},disabled:K,children:[t.jsx(v,{children:t.jsx(N,{placeholder:"Select Room"})}),t.jsxs(w,{children:[t.jsx(h,{value:"0",children:"All Rooms"}),K?t.jsx("div",{className:"text-muted-foreground text-sm p-2",children:"Loading rooms..."}):le.length>0?le.map(e=>t.jsx(h,{value:e.id.toString(),children:e.name},e.id)):t.jsx("div",{className:"text-muted-foreground text-sm p-2",children:"No rooms available"})]})]}),t.jsxs(b,{value:p,onValueChange:e=>{je(e)},children:[t.jsx(v,{children:t.jsx(N,{placeholder:"Select Asset Category"})}),t.jsxs(w,{children:[t.jsx(h,{value:"0",children:"All Asset Categories"}),ne.length>0?ne.map(e=>t.jsx(h,{value:e.id.toString(),children:e.name},e.id)):t.jsx("div",{className:"text-muted-foreground text-sm p-2",children:"No asset categories available"})]})]}),t.jsxs(b,{value:D,onValueChange:e=>{q(e)},disabled:Z,children:[t.jsx(v,{children:t.jsx(N,{placeholder:"Select Asset"})}),t.jsxs(w,{children:[t.jsx(h,{value:"0",children:"All Assets"}),Z?t.jsx("div",{className:"text-muted-foreground text-sm p-2",children:"Loading assets..."}):ie.length>0?ie.map(e=>t.jsx(h,{value:e.id.toString(),children:e.name},e.id)):t.jsx("div",{className:"text-muted-foreground text-sm p-2",children:"No assets available"})]})]}),t.jsx(R,{onClick:Se,className:"w-full",children:"Apply Filters"})]})]})}),t.jsx("div",{className:"w-full md:w-2/3",children:t.jsxs(ue,{children:[t.jsxs(fe,{className:"pb-3 flex flex-col md:flex-row md:items-center md:justify-between gap-4",children:[t.jsx("div",{children:t.jsx(pe,{className:"text-2xl font-bold",children:"Assets Report"})}),t.jsxs("div",{className:"flex gap-2",children:[t.jsx(R,{onClick:ke,className:"w-full md:w-auto",children:"Export PDF"}),t.jsx(R,{onClick:we,className:"w-full md:w-auto",children:"Export Excel"})]})]}),t.jsx(Ce,{}),t.jsxs(ge,{className:"pt-6 space-y-6",children:[t.jsxs("table",{className:"w-full border-collapse",children:[t.jsx("thead",{children:t.jsxs("tr",{className:"bg-primary dark:bg-gray-800",children:[t.jsx("th",{className:"border p-2 text-left text-sm font-medium text-white dark:text-gray-200",children:"Asset"}),t.jsx("th",{className:"border p-2 text-left text-sm font-medium text-white dark:text-gray-200",children:"Quantity"}),t.jsx("th",{className:"border p-2 text-left text-sm font-medium text-white dark:text-gray-200",children:"Room"}),t.jsx("th",{className:"border p-2 text-left text-sm font-medium text-white dark:text-gray-200",children:"Description"})]})}),t.jsx("tbody",{children:((ce=M.data)==null?void 0:ce.length)===0?t.jsx("tr",{children:t.jsx("td",{colSpan:4,className:"border p-2 text-center text-sm text-gray-900 dark:text-gray-100",children:"No assets found."})}):(de=M.data)==null?void 0:de.map(e=>{var s,r;return t.jsxs("tr",{className:"hover:bg-gray-50 dark:hover:bg-gray-700",children:[t.jsx("td",{className:"border p-2 text-sm text-gray-900 dark:text-gray-100",children:t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx(Re,{className:"h-5 w-5 text-blue-600"}),t.jsx("div",{className:"space-y-1",children:t.jsx("div",{className:"font-medium",children:(s=e.asset)==null?void 0:s.name})})]})}),t.jsx("td",{className:"border p-2 text-sm text-gray-900 dark:text-gray-100",children:e.current_qty}),t.jsx("td",{className:"border p-2 text-sm text-gray-900 dark:text-gray-100",children:((r=e.room)==null?void 0:r.name)||"N/A"}),t.jsx("td",{className:"border p-2 text-sm text-gray-900 dark:text-gray-100",children:e.details||"N/A"})]},e.id)})})]}),((he=M.links)==null?void 0:he.length)>1&&t.jsx("div",{className:"flex justify-center pt-6 flex-wrap gap-2",children:M.links.map((e,s)=>t.jsx(R,{disabled:!e.url,variant:e.active?"default":"outline",size:"sm",onClick:()=>{e.url&&fetch(e.url).then(r=>r.json()).then(r=>{te(r)}).catch(r=>{console.error("Error:",r)})},className:e.active?"bg-blue-600 hover:bg-blue-700":"",children:t.jsx("span",{dangerouslySetInnerHTML:{__html:e.label}})},s))})]})]})})]})})]})})}export{st as default};
