var je=Object.defineProperty;var fe=(o,i,c)=>i in o?je(o,i,{enumerable:!0,configurable:!0,writable:!0,value:c}):o[i]=c;var W=(o,i,c)=>fe(o,typeof i!="symbol"?i+"":i,c);import{r as l,K as ge,j as e,L as ve,a as X}from"./app-D6lyKCb0.js";import{A as be,c as J}from"./app-layout-BJ6RDFjC.js";import{B as u}from"./button-CCPkYfcN.js";import{C as v,a as E,b as Ne,c as b,d as ye}from"./card-DPyw2mDh.js";import{S as K,a as Y,b as q,c as G,d as h}from"./select-pSh8MoHv.js";import{t as y,X as we,C as Se,e as Ce}from"./index-C2dM8uf0.js";import{l as ke}from"./lodash-BtLwiZ51.js";import{E as Ae,F as Pe,a as _e,b as Ee}from"./jspdf.plugin.autotable-MzdrFSpS.js";import{C as Q}from"./combobox-AjIbH7SF.js";import{T as Re,a as Le,b as Z,c as ee}from"./tabs-SBtKKh9g.js";import{B as N}from"./badge-Bg4iMUN6.js";import Te from"./ApprovalModal-D1lP7mdj.js";import"./index-BTiWGghc.js";import"./createLucideIcon-zTYlLHSb.js";import"./index-DTjwdlGq.js";import"./index-PyfYCCz6.js";import"./input-BekdTFNy.js";import"./app-logo-icon-DREUhacY.js";import"./folder-root-DLhWLZqd.js";import"./grip-vertical-Czs-UF6q.js";import"./index-BsLD0GjN.js";import"./index-pfB5R6qP.js";import"./popover-DmvYne6F.js";import"./textarea-B4fRdAHP.js";import"./label-BNivIVyg.js";const Fe=[{title:"Reports",href:"/reports"},{title:"Projects",href:"/reports/projects"}];class ze extends l.Component{constructor(){super(...arguments);W(this,"state",{hasError:!1,error:null})}static getDerivedStateFromError(c){return{hasError:!0,error:c.message}}componentDidCatch(c,j){console.error("ErrorBoundary caught:",c,j),y.error("An error occurred. Please try again or contact support.")}render(){return this.state.hasError?e.jsxs("div",{className:"p-4",children:[e.jsxs("p",{className:"text-red-600",children:["Error: ",this.state.error]}),e.jsx(u,{onClick:()=>window.location.reload(),className:"mt-2",children:"Retry"})]}):this.props.children}}const R=o=>{const i=o!=null&&typeof o.id=="number"&&o.id>0&&typeof o.name=="string"&&o.name.trim()!=="";return i||console.warn("Invalid item:",o),i};function ct({projects:o,institutes:i,regions:c,projectTypes:j,filters:f}){var H;const[L,De]=l.useState(f.search||""),[x,w]=l.useState(f.institute_id||""),[S,te]=l.useState(f.project_type_id||""),[C,se]=l.useState(f.status||""),[p,T]=l.useState(o),[k,A]=l.useState(i||[]),[P,re]=l.useState(f.region_id||""),{auth:ae}=ge().props,F=ae.user,le=t=>{var m;const s=(m=t.current_stage)==null?void 0:m.level,r=t.overall_status;if(console.log("user",F),console.log("stageLevel",s),!s)return!1;const a=(F.roles[0].name||"").toLowerCase(),n=s.toLowerCase();return console.log("user",a),console.log("stageLevel",n),n==="regional"&&a==="region"&&r!=="approved"||n==="dte"&&(a==="dirhrm"||a==="directorate")&&r!=="approved"},[oe,z]=l.useState(!1),[ne,ie]=l.useState(null),[d,_]=l.useState(null),[D,I]=l.useState([]),[B,M]=l.useState([]),[V,$]=l.useState(!1),ce=l.useMemo(()=>Array.isArray(k)?k.filter(R):[],[k]),O=l.useMemo(()=>Array.isArray(c)?c.filter(R):[],[c]),de=l.useMemo(()=>Array.isArray(j)?j.filter(R):[],[j]);l.useEffect(()=>{d?($(!0),(async()=>{try{const[s,r]=await Promise.all([X.get(`/projects/${d.id}/history`),X.get(`/projects/${d.id}/milestones`)]);I(s.data),M(r.data)}catch(s){console.error("Failed to fetch project details",s),y.error("Failed to load project details.")}finally{$(!1)}})()):(I([]),M([]))},[d]);const me=async t=>{if(!t||t==="0"){A(i||[]),x&&w("");return}try{const s=new URLSearchParams({region_id:t}).toString(),r=await fetch(`/reports/getInstitutes?${s}`);if(!r.ok)throw new Error("Failed to fetch institutes");const a=await r.json();A(a),x&&!a.some(n=>n.id.toString()===x)&&w("")}catch(s){console.error("Error fetching institutes:",s),y.error("Failed to load institutes"),A([])}},ue=t=>{re(t),me(t)},xe=async()=>{const t=new Ae.Workbook,s=t.addWorksheet("Projects");s.columns=[{header:"Name",key:"name",width:30},{header:"Budget",key:"budget",width:15},{header:"Status",key:"status",width:15},{header:"Project Type",key:"project_type",width:25},{header:"Institute",key:"institute",width:30},{header:"Region",key:"region",width:25}],p.data.forEach(n=>{var m,g,U;s.addRow({name:n.name,budget:n.budget,status:n.status,project_type:((m=n.projecttype)==null?void 0:m.name)||"N/A",institute:((g=n.institute)==null?void 0:g.name)||"N/A",region:((U=n.region)==null?void 0:U.name)||"N/A"})});const r=await t.xlsx.writeBuffer(),a=new Blob([r],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"});Pe.saveAs(a,"Projects_Report.xlsx")},pe=()=>{const t=new _e;t.setFontSize(16),t.text("Projects Report",14,15);const s=["Name","Budget","Status","Project Type","Institute","Region"],r=p.data.map(a=>{var n,m,g;return[a.name,a.budget,a.status,((n=a.projecttype)==null?void 0:n.name)||"N/A",((m=a.institute)==null?void 0:m.name)||"N/A",((g=a.region)==null?void 0:g.name)||"N/A"]});Ee(t,{head:[s],body:r,startY:25,styles:{fontSize:9,cellPadding:2},headStyles:{fillColor:[66,139,202],textColor:255,fontStyle:"bold"},alternateRowStyles:{fillColor:[240,240,240]}}),t.save("Projects_Report.pdf")},he=l.useMemo(()=>ke.debounce(()=>{const t=new URLSearchParams({search:L.trim(),institute_id:x||"",region_id:P||"",project_type_id:S||"",status:C||""});fetch(`/reports/projects/getprojects?${t.toString()}`).then(s=>s.json()).then(s=>{console.log("Filtered projects:",s),T(s)}).catch(s=>{console.error("Fetch error:",s),y.error("Failed to load projects")})},300),[L,x,P,S,C]);return e.jsx(ze,{children:e.jsxs(be,{breadcrumbs:Fe,children:[e.jsx(ve,{title:"Projects Report"}),e.jsxs("div",{className:"flex flex-col lg:flex-row h-[calc(100vh-65px)] overflow-hidden",children:[e.jsx("div",{className:`flex-1 p-2 md:p-4 overflow-y-auto ${d?"lg:w-2/3":"w-full"}`,children:e.jsxs("div",{className:"flex flex-col gap-3 h-full",children:[e.jsxs(v,{className:"shrink-0",children:[e.jsx(E,{className:"py-3",children:e.jsx(Ne,{className:"text-xl font-bold",children:"Filters"})}),e.jsxs(b,{className:"py-2 space-y-4",children:[e.jsxs("div",{className:"flex flex-col md:flex-row gap-2",children:[O.length>0&&e.jsx("div",{className:"w-full md:w-1/4",children:e.jsx(Q,{entity:"region",value:P,onChange:t=>ue(t),options:O.map(t=>({id:t.id.toString(),name:t.name.split(" ").pop()||t.name})),includeAllOption:!0})}),e.jsx("div",{className:"w-full md:w-1/4",children:e.jsx(Q,{entity:"institute",value:x,onChange:w,options:ce.map(t=>({id:t.id.toString(),name:t.name})),includeAllOption:!1,placeholder:"Select Institute"})}),e.jsx("div",{className:"w-full md:w-1/4",children:e.jsxs(K,{value:S,onValueChange:t=>te(t),children:[e.jsx(Y,{children:e.jsx(q,{placeholder:"Select Project Type"})}),e.jsxs(G,{children:[e.jsx(h,{value:"0",children:"All Project Types"}),de.map(t=>e.jsx(h,{value:t.id.toString(),children:t.name},t.id))]})]})}),e.jsx("div",{className:"w-full md:w-1/4",children:e.jsxs(K,{value:C,onValueChange:t=>se(t),children:[e.jsx(Y,{children:e.jsx(q,{placeholder:"Select Status"})}),e.jsxs(G,{children:[e.jsx(h,{value:"all",children:"All Status"}),e.jsx(h,{value:"planned",children:"Planned"}),e.jsx(h,{value:"inprogress",children:"In Progress"}),e.jsx(h,{value:"completed",children:"Completed"})]})]})})]}),e.jsxs("div",{className:"flex gap-2 justify-end",children:[e.jsx(u,{onClick:he,size:"sm",children:"Apply Filters"}),e.jsx(u,{onClick:pe,size:"sm",variant:"outline",children:"Export PDF"}),e.jsx(u,{onClick:xe,size:"sm",variant:"outline",children:"Export Excel"})]})]})]}),e.jsxs(v,{className:"flex-1 min-h-0 flex flex-col",children:[e.jsx(b,{className:"p-0 flex-1 overflow-auto",children:e.jsxs("table",{className:"w-full border-collapse text-sm",children:[e.jsx("thead",{className:"sticky top-0 z-10",children:e.jsxs("tr",{className:"bg-primary text-white text-center",children:[e.jsx("th",{className:"border p-2 font-medium",children:"Name"}),e.jsx("th",{className:"border p-2 font-medium",children:"Budget"}),e.jsx("th",{className:"border p-2 font-medium",children:"Status"}),e.jsx("th",{className:"border p-2 font-medium",children:"Type"}),e.jsx("th",{className:"border p-2 font-medium",children:"Institute"}),e.jsx("th",{className:"border p-2 font-medium",children:"Action"})]})}),e.jsx("tbody",{children:p.data.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:6,className:"text-center p-4 text-muted-foreground",children:"No projects found."})}):p.data.map(t=>{var s,r;return e.jsxs("tr",{className:`hover:bg-primary/10 dark:hover:bg-gray-700 cursor-pointer transition-colors ${(d==null?void 0:d.id)===t.id?"bg-primary/5 dark:bg-gray-700 border-l-4 border-l-primary":""}`,onClick:()=>_(t),children:[e.jsx("td",{className:"border p-2 font-medium",children:t.name}),e.jsx("td",{className:"border p-2 text-right",children:t.budget}),e.jsx("td",{className:"border p-2 text-center",children:e.jsx("span",{className:`px-2 py-1 rounded-full text-xs font-medium ${t.status==="completed"?"bg-green-100 text-green-800":t.status==="inprogress"?"bg-yellow-100 text-yellow-800":"bg-blue-100 text-blue-800"}`,children:t.status.charAt(0).toUpperCase()+t.status.slice(1)})}),e.jsx("td",{className:"border p-2 text-center",children:((s=t.projecttype)==null?void 0:s.name)||"-"}),e.jsx("td",{className:"border p-2",children:((r=t.institute)==null?void 0:r.name)||"-"}),e.jsx("td",{className:"border p-2 text-center",onClick:a=>a.stopPropagation(),children:le(t)&&e.jsx(u,{variant:"ghost",size:"icon",title:"View/Approve",className:"text-blue-600 hover:text-blue-700",onClick:a=>{a.stopPropagation(),ie(t),z(!0)},children:e.jsx(ye,{className:"h-4 w-4"})})})]},t.id)})})]})}),p.links.length>1&&e.jsx("div",{className:"p-4 border-t flex justify-center flex-wrap gap-2 shrink-0",children:p.links.map((t,s)=>e.jsx(u,{disabled:!t.url,variant:t.active?"default":"outline",size:"sm",onClick:()=>{t.url&&fetch(t.url).then(r=>r.json()).then(r=>{T(r)}).catch(r=>{console.error("Error:",r)})},children:e.jsx("span",{dangerouslySetInnerHTML:{__html:t.label}})},s))})]})]})}),d&&e.jsxs("div",{className:"w-full lg:w-1/3 border-l bg-background p-4 md:p-6 shadow-xl overflow-y-auto flex flex-col h-full transition-all duration-300 ease-in-out z-20 absolute lg:relative right-0 top-0 lg:top-auto bottom-0 lg:bottom-auto",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-bold",children:d.name}),e.jsx("p",{className:"text-sm text-muted-foreground",children:(H=d.institute)==null?void 0:H.name})]}),e.jsx(u,{variant:"ghost",size:"icon",onClick:()=>_(null),children:e.jsx(we,{className:"h-5 w-5"})})]}),e.jsxs(Re,{defaultValue:"approvals",className:"w-full flex-1 flex flex-col",children:[e.jsxs(Le,{className:"grid w-full grid-cols-2",children:[e.jsx(Z,{value:"approvals",children:"Approvals"}),e.jsx(Z,{value:"milestones",children:"Milestones"})]}),e.jsxs("div",{className:"flex-1 overflow-y-auto mt-4 px-1",children:[e.jsx(ee,{value:"approvals",className:"space-y-4 m-0 h-full",children:V?e.jsx("div",{className:"flex justify-center py-8 text-muted-foreground",children:"Loading history..."}):D.length===0?e.jsx("div",{className:"text-center py-8 text-muted-foreground border rounded-lg border-dashed",children:"No approval history found."}):e.jsx("div",{className:"space-y-4",children:D.map(t=>{var s,r;return e.jsxs(v,{className:"overflow-hidden",children:[e.jsx(E,{className:"p-3 bg-muted/50 pb-2",children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsx("div",{className:"font-semibold text-sm",children:((s=t.stage)==null?void 0:s.stage_name)||"Stage"}),t.status==="approved"?e.jsxs(N,{variant:"outline",className:"border-green-500 text-green-600 bg-green-50 gap-1",children:[e.jsx(Se,{className:"w-3 h-3"})," Approved"]}):t.status==="rejected"?e.jsxs(N,{variant:"outline",className:"border-red-500 text-red-600 bg-red-50 gap-1",children:[e.jsx(Ce,{className:"w-3 h-3"})," Rejected"]}):e.jsxs(N,{variant:"outline",className:"border-yellow-500 text-yellow-600 bg-yellow-50 gap-1",children:[e.jsx(J,{className:"w-3 h-3"})," Pending"]})]})}),e.jsxs(b,{className:"p-3 text-sm",children:[e.jsxs("div",{className:"flex items-center text-xs text-muted-foreground mb-2",children:[e.jsx(J,{className:"w-3 h-3 mr-1"}),t.action_date?new Date(t.action_date).toLocaleString():""]}),e.jsxs("div",{className:"mb-2",children:[e.jsx("span",{className:"font-medium text-xs",children:"Approver: "}),(r=t.approver)==null?void 0:r.name]}),t.comments&&e.jsxs("div",{className:"bg-muted/30 p-2 rounded text-xs italic border",children:['"',t.comments,'"']})]})]},t.id)})})}),e.jsx(ee,{value:"milestones",className:"space-y-4 m-0 h-full",children:V?e.jsx("div",{className:"flex justify-center py-8 text-muted-foreground",children:"Loading milestones..."}):B.length===0?e.jsx("div",{className:"text-center py-8 text-muted-foreground border rounded-lg border-dashed",children:"No milestones found."}):e.jsx("div",{className:"space-y-4",children:B.map(t=>e.jsxs(v,{children:[e.jsx(E,{className:"p-3 pb-1",children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsx("div",{className:"font-semibold text-sm",children:t.name}),e.jsx(N,{variant:t.status==="completed"?"default":t.status==="inprogress"?"secondary":"outline",className:"capitalize text-xs",children:t.status})]})}),e.jsxs(b,{className:"p-3 text-sm space-y-2",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-2 text-xs",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-muted-foreground",children:"Due: "}),new Date(t.due_date).toLocaleDateString()]}),t.completed_date&&e.jsxs("div",{children:[e.jsx("span",{className:"text-muted-foreground",children:"Completed: "}),e.jsx("span",{className:"text-green-600 dark:text-green-400",children:new Date(t.completed_date).toLocaleDateString()})]})]}),t.description&&e.jsx("p",{className:"text-muted-foreground text-xs mt-1",children:t.description})]})]},t.id))})})]})]})]})]}),e.jsx(Te,{isOpen:oe,onClose:()=>z(!1),project:ne}),d&&e.jsx("div",{className:"fixed inset-0 bg-black/20 lg:hidden z-10",onClick:()=>_(null)})]})})}export{ct as default};
