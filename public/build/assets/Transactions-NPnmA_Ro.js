var le=Object.defineProperty;var ie=(n,d,l)=>d in n?le(n,d,{enumerable:!0,configurable:!0,writable:!0,value:l}):n[d]=l;var M=(n,d,l)=>ie(n,typeof d!="symbol"?d+"":d,l);import{r,j as e,L as ce,S as pe}from"./app-fkWOkd0g.js";import{t as L,A as me,F as he,S as ue,C as xe,b as je}from"./app-layout-CqCecIGY.js";import{B as j}from"./button-0lHC1wr-.js";import{C as V,a as H,b as W,c as J}from"./card-DbKUerQs.js";import{I as T}from"./index-Bh0qyi3B.js";import{S as k,a as E,b as R,c as B,d as i}from"./select-OvztCmAc.js";import{l as ye}from"./lodash-B0tah78K.js";import{E as fe,F as ge,a as be,b as ve}from"./jspdf.plugin.autotable-B96VL8oR.js";import{f as I}from"./dateFormatter-Cn65gwBN.js";import{C as D}from"./combobox-DbAFJ-Fy.js";import"./index-D3O8HH8y.js";import"./createLucideIcon-Dck14qNA.js";import"./index-BJwb7vsp.js";import"./app-logo-icon-t5uTmq4G.js";import"./index-B5IA_FAV.js";import"./index-fSToPTAj.js";import"./popover-CLp_ks8d.js";const Ne=[{title:"Reports",href:"/reports"},{title:"Transactions",href:"/reports/transactions"}];class Se extends r.Component{constructor(){super(...arguments);M(this,"state",{hasError:!1,error:null})}static getDerivedStateFromError(l){return{hasError:!0,error:l.message}}componentDidCatch(l,y){console.error("ErrorBoundary:",l,y),L.error("An error occurred. Please try again.")}render(){return this.state.hasError?e.jsxs("div",{className:"p-4",children:[e.jsxs("p",{className:"text-red-600",children:["Error: ",this.state.error]}),e.jsx(j,{onClick:()=>window.location.reload(),className:"mt-2",children:"Retry"})]}):this.props.children}}const U=n=>n!=null&&typeof n.id=="number"&&n.id>0&&typeof n.name=="string"&&n.name.trim()!=="";function Me({transactions:n,institutes:d,regions:l,users:y,filters:c,user_type:X}){const[g,Y]=r.useState(c.search||""),[m,b]=r.useState(c.institute_id||""),[v,q]=r.useState(c.region_id||""),[N,G]=r.useState(c.added_by||""),[S,K]=r.useState(c.approved_by||""),[w,Q]=r.useState(c.type||""),[A,Z]=r.useState(c.status||""),[C,ee]=r.useState(c.date_from||""),[_,te]=r.useState(c.date_to||""),[h,se]=r.useState(n),[P,F]=r.useState(d||[]),ae=r.useMemo(()=>P.filter(U),[P]),$=r.useMemo(()=>l.filter(U),[l]),O=r.useMemo(()=>y.filter(U),[y]),re=async t=>{if(!t||t==="0"){F(d||[]),m&&b("");return}try{const s=new URLSearchParams({region_id:t}).toString(),p=await fetch(`/reports/transactions/getinstitutes?${s}`);if(!p.ok)throw new Error("Failed to fetch institutes");const a=await p.json();F(a),m&&!a.some(o=>o.id.toString()===m)&&b("")}catch(s){console.error("Error fetching institutes:",s),L.error("Failed to load institutes"),F([])}},oe=t=>{q(t),re(t)},ne=async()=>{const t=new fe.Workbook,s=t.addWorksheet("Transactions");s.columns=[{header:"ID",key:"id",width:10},{header:"Amount",key:"amount",width:15},{header:"Type",key:"type",width:12},{header:"Status",key:"status",width:12},{header:"Institute",key:"institute",width:30},{header:"Added By",key:"added_by",width:25},{header:"Approved By",key:"approved_by",width:25},{header:"Date",key:"date",width:18}],h.data.forEach(o=>{var u,x,z;s.addRow({id:o.id,amount:`$${parseFloat(o.total_amount.toString()).toFixed(2)}`,type:o.type.charAt(0).toUpperCase()+o.type.slice(1),status:o.status.charAt(0).toUpperCase()+o.status.slice(1),institute:((u=o.institute)==null?void 0:u.name)||"N/A",added_by:((x=o.added_by)==null?void 0:x.name)||"N/A",approved_by:((z=o.approved_by)==null?void 0:z.name)||"N/A",date:I(o.created_at)})});const p=await t.xlsx.writeBuffer(),a=new Blob([p],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"});ge.saveAs(a,"Transactions_Report.xlsx")},de=()=>{const t=new be;t.setFontSize(16),t.text("Transactions Report",14,15);const s=["ID","Amount","Type","Status","Institute","Added By","Approved By","Date"],p=h.data.map(a=>{var o,u,x;return[a.id.toString(),`$${parseFloat(a.total_amount.toString()).toFixed(2)}`,a.type.charAt(0).toUpperCase()+a.type.slice(1),a.status.charAt(0).toUpperCase()+a.status.slice(1),((o=a.institute)==null?void 0:o.name)||"N/A",((u=a.added_by)==null?void 0:u.name)||"N/A",((x=a.approved_by)==null?void 0:x.name)||"N/A",I(a.created_at)]});ve(t,{head:[s],body:p,startY:25,styles:{fontSize:9,cellPadding:2},headStyles:{fillColor:[46,124,196],textColor:255,fontStyle:"bold"},alternateRowStyles:{fillColor:[240,240,240]}}),t.save("Transactions_Report.pdf")},f=r.useMemo(()=>ye.debounce(()=>{const t=new URLSearchParams({search:g.trim(),institute_id:m||"",region_id:v||"",added_by:N||"",approved_by:S||"",type:w||"",status:A||"",date_from:C||"",date_to:_||""});fetch(`/reports/transactions/gettransactions?${t.toString()}`).then(s=>{if(!s.ok)throw new Error("Network error");return s.json()}).then(s=>{console.log("Filtered transactions:",s),se(s)}).catch(s=>{console.error("Fetch error:",s),L.error("Failed to load transactions")})},400),[g,m,v,N,S,w,A,C,_]);return r.useEffect(()=>(f(),()=>{f.cancel()}),[f]),e.jsx(Se,{children:e.jsxs(me,{breadcrumbs:Ne,children:[e.jsx(ce,{title:"Transactions Report"}),e.jsx("div",{className:"flex-1 p-1 md:p-1",children:e.jsxs("div",{className:"flex flex-col md:flex-row gap-3",children:[e.jsx("div",{className:"w-full md:w-1/3",children:e.jsxs(V,{children:[e.jsxs(H,{children:[e.jsx(W,{className:"text-xl font-bold flex items-center gap-2",children:"Filters"}),e.jsx("p",{className:"text-muted-foreground text-sm",children:"Refine transaction search"})]}),e.jsxs(J,{className:"space-y-4",children:[e.jsx(T,{placeholder:"Search by ID, amount, type...",value:g,onChange:t=>Y(t.target.value)}),X!=="Regional Office"&&$.length>0&&e.jsxs(k,{value:v,onValueChange:oe,children:[e.jsx(E,{children:e.jsx(R,{placeholder:"Select Region"})}),e.jsxs(B,{children:[e.jsx(i,{value:"0",children:"All Regions"}),$.map(t=>e.jsx(i,{value:t.id.toString(),children:t.name},t.id))]})]}),e.jsx(D,{entity:"institute",value:m,onChange:b,options:ae.map(t=>({id:t.id.toString(),name:t.name})),includeAllOption:!0,allOptionLabel:"All Institutes",placeholder:"Select Institute"}),e.jsx(D,{entity:"user",value:N,onChange:G,options:O.map(t=>({id:t.id.toString(),name:t.name})),includeAllOption:!0,allOptionLabel:"All Users",placeholder:"Added By"}),e.jsx(D,{entity:"user",value:S,onChange:K,options:O.map(t=>({id:t.id.toString(),name:t.name})),includeAllOption:!0,allOptionLabel:"All Users",placeholder:"Approved By"}),e.jsxs(k,{value:w,onValueChange:Q,children:[e.jsx(E,{children:e.jsx(R,{placeholder:"Select Type"})}),e.jsxs(B,{children:[e.jsx(i,{value:"0",children:"All Types"}),e.jsx(i,{value:"purchase",children:"Purchase"}),e.jsx(i,{value:"maintenance",children:"Maintenance"}),e.jsx(i,{value:"condemned",children:"Condemned"})]})]}),e.jsxs(k,{value:A,onValueChange:Z,children:[e.jsx(E,{children:e.jsx(R,{placeholder:"Select Status"})}),e.jsxs(B,{children:[e.jsx(i,{value:"0",children:"All Status"}),e.jsx(i,{value:"pending",children:"Pending"}),e.jsx(i,{value:"approved",children:"Approved"}),e.jsx(i,{value:"rejected",children:"Rejected"})]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(T,{type:"date",value:C,onChange:t=>ee(t.target.value),className:"flex-1"}),e.jsx(T,{type:"date",value:_,onChange:t=>te(t.target.value),className:"flex-1"})]}),e.jsx(j,{onClick:f,className:"w-full",children:"Apply Filters"})]})]})}),e.jsx("div",{className:"w-full md:w-2/3",children:e.jsxs(V,{children:[e.jsxs(H,{className:"pb-3 flex flex-col md:flex-row md:items-center md:justify-between gap-4",children:[e.jsx("div",{children:e.jsxs(W,{className:"text-2xl font-bold flex items-center gap-2",children:[e.jsx(he,{className:"w-6 h-6"}),"Transactions Report"]})}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(j,{onClick:de,className:"w-full md:w-auto",children:"Export PDF"}),e.jsx(j,{onClick:ne,className:"w-full md:w-auto",children:"Export Excel"})]})]}),e.jsx(ue,{}),e.jsxs(J,{className:"pt-6 space-y-6",children:[e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full border-collapse text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-primary text-white text-center",children:[e.jsx("th",{className:"border p-2 font-medium",children:"ID"}),e.jsx("th",{className:"border p-2 font-medium",children:"Amount"}),e.jsx("th",{className:"border p-2 font-medium",children:"Type"}),e.jsx("th",{className:"border p-2 font-medium",children:"Status"}),e.jsx("th",{className:"border p-2 font-medium",children:"Institute"}),e.jsx("th",{className:"border p-2 font-medium",children:"Added By"}),e.jsx("th",{className:"border p-2 font-medium",children:"Approved By"}),e.jsx("th",{className:"border p-2 font-medium",children:"Date"})]})}),e.jsx("tbody",{children:h.data.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:8,className:"text-center p-4 text-muted-foreground",children:"No transactions found."})}):h.data.map(t=>{var s,p,a;return e.jsxs("tr",{className:"hover:bg-gray-50 dark:hover:bg-gray-700 text-center",children:[e.jsxs("td",{className:"border p-2",children:["#",t.id]}),e.jsx("td",{className:"border p-2 font-medium",children:parseFloat(t.total_amount.toString()).toFixed(2)}),e.jsx("td",{className:"border p-2",children:e.jsx("span",{className:`px-2 py-1 rounded text-xs font-medium ${t.type==="income"?"bg-green-100 text-green-800":"bg-red-100 text-red-800"}`,children:t.type.charAt(0).toUpperCase()+t.type.slice(1)})}),e.jsx("td",{className:"border p-2",children:e.jsxs("span",{className:`px-2 py-1 rounded text-xs font-medium flex items-center justify-center gap-1 ${t.status==="approved"?"bg-green-100 text-green-800":t.status==="rejected"?"bg-red-100 text-red-800":"bg-yellow-100 text-yellow-800"}`,children:[t.status==="approved"&&e.jsx(xe,{className:"w-3 h-3"}),t.status==="rejected"&&e.jsx(je,{className:"w-3 h-3"}),t.status.charAt(0).toUpperCase()+t.status.slice(1)]})}),e.jsx("td",{className:"border p-2",children:((s=t.institute)==null?void 0:s.name)||"N/A"}),e.jsx("td",{className:"border p-2",children:((p=t.added_by)==null?void 0:p.name)||"N/A"}),e.jsx("td",{className:"border p-2",children:((a=t.approved_by)==null?void 0:a.name)||"N/A"}),e.jsx("td",{className:"border p-2 text-xs",children:I(t.created_at)})]},t.id)})})]})}),h.links.length>1&&e.jsx("div",{className:"flex justify-center pt-6 flex-wrap gap-2",children:h.links.map((t,s)=>e.jsx(j,{disabled:!t.url,variant:t.active?"default":"outline",size:"sm",onClick:()=>pe.visit(t.url||"",{preserveScroll:!0}),children:e.jsx("span",{dangerouslySetInnerHTML:{__html:t.label}})},s))})]})]})})]})})]})})}export{Me as default};
