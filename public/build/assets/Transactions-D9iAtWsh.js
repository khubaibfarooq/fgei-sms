var De=Object.defineProperty;var Ee=(l,c,m)=>c in l?De(l,c,{enumerable:!0,configurable:!0,writable:!0,value:m}):l[c]=m;var de=(l,c,m)=>Ee(l,typeof c!="symbol"?c+"":c,m);import{r as o,j as e,L as Be,S as Ie}from"./app-AMw4d0jo.js";import{t as j,A as Ue,F as le,S as ie,C as $e,b as Le,E as ze,D as Oe}from"./app-layout-xVR0HG7k.js";import{B as x}from"./button-CBBkZbku.js";import{C as ce,a as me,b as pe,c as he}from"./card-Ce_yGYCw.js";import{I as ue}from"./index-BM97PwfR.js";import{S as I,a as U,b as $,c as L,d as p}from"./select-CliEBdfx.js";import{D as Pe,a as Me,b as Ve,c as He}from"./dialog-CaTGmyBs.js";import{l as Ye}from"./lodash-DE1xTI77.js";import{E as qe,F as Qe,a as xe,b as z}from"./jspdf.plugin.autotable-CHEQJJFK.js";import{f as b}from"./dateFormatter-Cn65gwBN.js";import{C as O}from"./combobox-CgOBLNPE.js";import{L as We}from"./app-logo-icon-BcSA-fp9.js";import"./index-CJVIO9s5.js";import"./createLucideIcon-BmtFQ3DZ.js";import"./index-BKHzmLIA.js";import"./folder-root-DSVSEtOY.js";import"./grip-vertical-r_HSfAoN.js";import"./index-OhXTDPm3.js";import"./index-Cmojq-fk.js";import"./popover-CY9zeH1B.js";const Xe=[{title:"Reports",href:"/reports"},{title:"Transactions",href:"/reports/transactions"}];class Ge extends o.Component{constructor(){super(...arguments);de(this,"state",{hasError:!1,error:null})}static getDerivedStateFromError(m){return{hasError:!0,error:m.message}}componentDidCatch(m,N){console.error("ErrorBoundary:",m,N),j.error("An error occurred. Please try again.")}render(){return this.state.hasError?e.jsxs("div",{className:"p-4",children:[e.jsxs("p",{className:"text-red-600",children:["Error: ",this.state.error]}),e.jsx(x,{onClick:()=>window.location.reload(),className:"mt-2",children:"Retry"})]}):this.props.children}}const P=l=>l!=null&&typeof l.id=="number"&&l.id>0&&typeof l.name=="string"&&l.name.trim()!=="";function gt({transactions:l,institutes:c,regions:m,users:N,filters:h,user_type:je}){var ee,te,se;const[M,Je]=o.useState(h.search||""),[f,S]=o.useState(h.institute_id||""),[w,fe]=o.useState(h.region_id||""),[A,ye]=o.useState(h.added_by||""),[C,ge]=o.useState(h.approved_by||""),[_,be]=o.useState(h.type||""),[F,Ne]=o.useState(h.status||""),[T,ve]=o.useState(h.date_from||""),[k,Se]=o.useState(h.date_to||""),[y,we]=o.useState(l),[V,R]=o.useState(c||[]),[D,H]=o.useState(!1),[Y,E]=o.useState(!1),[d,q]=o.useState(null),[B,Q]=o.useState([]),[W,X]=o.useState(!1),Ae=async t=>{var s;if(!D){H(!0);try{if(!(await fetch(`/reports/transactions/approve?tid=${t}`,{method:"GET",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":((s=document.querySelector('meta[name="csrf-token"]'))==null?void 0:s.getAttribute("content"))||""}})).ok)throw new Error("Failed to approve");j.success("Transaction approved successfully"),K()}catch{j.error("Failed to approve transaction")}finally{H(!1)}}},Ce=o.useMemo(()=>V.filter(P),[V]),G=o.useMemo(()=>m.filter(P),[m]),J=o.useMemo(()=>N.filter(P),[N]),_e=async t=>{if(!t||t==="0"){R(c||[]),f&&S("");return}try{const s=new URLSearchParams({region_id:t}).toString(),n=await fetch(`/reports/transactions/getinstitutes?${s}`);if(!n.ok)throw new Error("Failed to fetch institutes");const a=await n.json();R(a),f&&!a.some(r=>r.id.toString()===f)&&S("")}catch(s){console.error("Error fetching institutes:",s),j.error("Failed to load institutes"),R([])}},Fe=t=>{fe(t),_e(t)},Te=async()=>{const t=new qe.Workbook,s=t.addWorksheet("Transactions");s.columns=[{header:"ID",key:"id",width:10},{header:"Amount",key:"amount",width:15},{header:"Type",key:"type",width:12},{header:"Status",key:"status",width:12},{header:"Institute",key:"institute",width:30},{header:"Added By",key:"added_by",width:25},{header:"Approved By",key:"approved_by",width:25},{header:"Date",key:"date",width:18}],y.data.forEach(r=>{var i,u,v;s.addRow({id:r.id,amount:`$${parseFloat(r.total_amount.toString()).toFixed(2)}`,type:r.type.charAt(0).toUpperCase()+r.type.slice(1),status:r.status.charAt(0).toUpperCase()+r.status.slice(1),institute:((i=r.institute)==null?void 0:i.name)||"N/A",added_by:((u=r.added_by)==null?void 0:u.name)||"N/A",approved_by:((v=r.approved_by)==null?void 0:v.name)||"N/A",date:b(r.created_at)})});const n=await t.xlsx.writeBuffer(),a=new Blob([n],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"});Qe.saveAs(a,"Transactions_Report.xlsx")},ke=()=>{const t=new xe;t.setFontSize(16),t.text("Transactions Report",14,15);const s=["ID","Amount","Type","Status","Institute","Added By","Approved By","Date"],n=y.data.map(a=>{var r,i,u;return[a.id.toString(),`$${parseFloat(a.total_amount.toString()).toFixed(2)}`,a.type.charAt(0).toUpperCase()+a.type.slice(1),a.status.charAt(0).toUpperCase()+a.status.slice(1),((r=a.institute)==null?void 0:r.name)||"N/A",((i=a.added_by)==null?void 0:i.name)||"N/A",((u=a.approved_by)==null?void 0:u.name)||"N/A",b(a.created_at)]});z(t,{head:[s],body:n,startY:25,styles:{fontSize:9,cellPadding:2},headStyles:{fillColor:[46,124,196],textColor:255,fontStyle:"bold"},alternateRowStyles:{fillColor:[240,240,240]}}),t.save("Transactions_Report.pdf")},K=o.useMemo(()=>Ye.debounce(()=>{const t=new URLSearchParams({search:M.trim(),institute_id:f||"",region_id:w||"",added_by:A||"",approved_by:C||"",type:_||"",status:F||"",date_from:T||"",date_to:k||""});fetch(`/reports/transactions/gettransactions?${t.toString()}`).then(s=>{if(!s.ok)throw new Error("Network error");return s.json()}).then(s=>{we(s)}).catch(s=>{console.error("Fetch error:",s),j.error("Failed to load transactions")})},400),[M,f,w,A,C,_,F,T,k]),Re=async t=>{X(!0);try{const s=await fetch(`/reports/transactions/getbytid?tid=${t}`);if(!s.ok)throw new Error("Failed to load details");const{transaction:n,transdetails:a}=await s.json();q(n),Q(a),E(!0)}catch(s){j.error("Could not load transaction details"),console.error(s)}finally{X(!1)}},Z=(t,s)=>{var r,i,u;const n=new xe;n.setFontSize(16),n.text(`Transaction #${t.id}`,14,15);const a=[["Amount",`RS ${parseFloat(t.total_amount.toString()).toFixed(2)}`],["Type",t.type.charAt(0).toUpperCase()+t.type.slice(1)],["Status",t.status.charAt(0).toUpperCase()+t.status.slice(1)],["Institute",((r=t.institute)==null?void 0:r.name)||"N/A"],["Added By",((i=t.added_by)==null?void 0:i.name)||"N/A"],["Approved By",((u=t.approved_by)==null?void 0:u.name)||"N/A"],["Date",b(t.created_at)]];if(z(n,{head:[["Field","Value"]],body:a,startY:25,styles:{fontSize:10},headStyles:{fillColor:[46,124,196]}}),s.length){const v=s.map(g=>{var ae,re,ne,oe;return[((ae=g.asset)==null?void 0:ae.name)||"-",((re=g.room)==null?void 0:re.name)||"-",((ne=g.fund_head)==null?void 0:ne.name)||"-",g.qty??"-",`RS ${parseFloat(((oe=g.amount)==null?void 0:oe.toString())??"0").toFixed(2)}`]});z(n,{head:[["Asset","Room","Fund Head","Qty","Amount"]],body:v,startY:n.lastAutoTable.finalY+10,styles:{fontSize:9}})}n.save(`Transaction_#${t.id}.pdf`)};return o.useEffect(()=>()=>{E(!1),q(null),Q([])},[]),e.jsx(Ge,{children:e.jsxs(Ue,{breadcrumbs:Xe,children:[e.jsx(Be,{title:"Transactions Report"}),e.jsx("div",{className:"flex-1 p-1 md:p-1",children:e.jsxs("div",{className:"flex flex-col md:flex-row gap-3",children:[e.jsx("div",{className:"w-full md:w-1/4",children:e.jsxs(ce,{children:[e.jsxs(me,{children:[e.jsx(pe,{className:"text-xl font-bold flex items-center gap-2",children:"Filters"}),e.jsx("p",{className:"text-muted-foreground text-sm",children:"Refine transaction search"})]}),e.jsxs(he,{className:"space-y-4",children:[je!=="Regional Office"&&G.length>0&&e.jsxs(I,{value:w,onValueChange:Fe,children:[e.jsx(U,{children:e.jsx($,{placeholder:"Select Region"})}),e.jsxs(L,{children:[e.jsx(p,{value:"0",children:"All Regions"}),G.map(t=>e.jsx(p,{value:t.id.toString(),children:t.name.split(" ").pop()||t.name},t.id))]})]}),e.jsx(O,{entity:"institute",value:f,onChange:S,options:Ce.map(t=>({id:t.id.toString(),name:t.name})),includeAllOption:!0,allOptionLabel:"All Institutes",placeholder:"Select Institute"}),e.jsx(O,{entity:"user",value:A,onChange:ye,options:J.map(t=>({id:t.id.toString(),name:t.name})),includeAllOption:!0,allOptionLabel:"All Users",placeholder:"Added By"}),e.jsx(O,{entity:"user",value:C,onChange:ge,options:J.map(t=>({id:t.id.toString(),name:t.name})),includeAllOption:!0,allOptionLabel:"All Users",placeholder:"Approved By"}),e.jsxs(I,{value:_,onValueChange:be,children:[e.jsx(U,{children:e.jsx($,{placeholder:"Select Type"})}),e.jsxs(L,{children:[e.jsx(p,{value:"0",children:"All Types"}),e.jsx(p,{value:"purchase",children:"Purchase"}),e.jsx(p,{value:"maintenance",children:"Maintenance"}),e.jsx(p,{value:"condemned",children:"Condemned"})]})]}),e.jsxs(I,{value:F,onValueChange:Ne,children:[e.jsx(U,{children:e.jsx($,{placeholder:"Select Status"})}),e.jsxs(L,{children:[e.jsx(p,{value:"0",children:"All Status"}),e.jsx(p,{value:"pending",children:"Pending"}),e.jsx(p,{value:"approved",children:"Approved"}),e.jsx(p,{value:"rejected",children:"Rejected"})]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(ue,{type:"date",value:T,onChange:t=>ve(t.target.value),className:"flex-1"}),e.jsx(ue,{type:"date",value:k,onChange:t=>Se(t.target.value),className:"flex-1"})]}),e.jsx(x,{onClick:K,className:"w-full",children:"Apply Filters"})]})]})}),e.jsx("div",{className:"w-full md:w-full",children:e.jsxs(ce,{children:[e.jsxs(me,{className:"pb-3 flex flex-col md:flex-row md:items-center md:justify-between gap-4",children:[e.jsx("div",{children:e.jsxs(pe,{className:"text-2xl font-bold flex items-center gap-2",children:[e.jsx(le,{className:"w-6 h-6"}),"Transactions Report"]})}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(x,{onClick:ke,className:"w-full md:w-auto",children:"Export PDF"}),e.jsx(x,{onClick:Te,className:"w-full md:w-auto",children:"Export Excel"})]})]}),e.jsx(ie,{}),e.jsxs(he,{className:"pt-6 space-y-6",children:[e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full border-collapse border-1 rounded-md overflow-hidden shadow-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-primary text-white text-center",children:[e.jsx("th",{className:"border p-2 font-medium",children:"ID"}),e.jsx("th",{className:"border p-2 font-medium",children:"Institute"}),e.jsx("th",{className:"border p-2 font-medium",children:"Amount"}),e.jsx("th",{className:"border p-2 font-medium",children:"Type"}),e.jsx("th",{className:"border p-2 font-medium",children:"Status"}),e.jsx("th",{className:"border p-2 font-medium",children:"Added By"}),e.jsx("th",{className:"border p-2 font-medium",children:"Approved By"}),e.jsx("th",{className:"border p-2 font-medium",children:"Date"}),e.jsx("th",{className:"border p-2 font-medium",children:"Action"})]})}),e.jsx("tbody",{children:y.data.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:9,className:"text-center p-4 text-muted-foreground",children:"No transactions found."})}):y.data.map(t=>{var s,n,a;return e.jsxs("tr",{className:"hover:bg-gray-50 dark:hover:bg-gray-700 text-center",children:[e.jsxs("td",{className:"border p-2",children:["#",t.id]}),e.jsx("td",{className:"border p-2 md:text-md lg:text-lg border-r-1 ",children:((s=t.institute)==null?void 0:s.name)||"N/A"}),e.jsx("td",{className:"border p-2 font-bold md:text-md lg:text-lg",children:parseFloat(t.total_amount.toString()).toFixed(2)}),e.jsx("td",{className:"border p-2",children:e.jsx("span",{className:`px-2 py-1 rounded text-xs font-medium ${t.type==="income"?"bg-green-100 text-green-800":"bg-red-100 text-red-800"}`,children:t.type.charAt(0).toUpperCase()+t.type.slice(1)})}),e.jsx("td",{className:"border p-2",children:e.jsxs("span",{className:`px-2 py-1 rounded text-xs font-medium flex items-center justify-center gap-1 ${t.status==="approved"?"bg-green-100 text-green-800":t.status==="rejected"?"bg-red-100 text-red-800":"bg-yellow-100 text-yellow-800"}`,children:[t.status==="approved"&&e.jsx($e,{className:"w-3 h-3"}),t.status==="rejected"&&e.jsx(Le,{className:"w-3 h-3"}),t.status.charAt(0).toUpperCase()+t.status.slice(1)]})}),e.jsx("td",{className:"border p-2 md:text-md lg:text-lg border-r-1 ",children:((n=t.added_by)==null?void 0:n.name)||"N/A"}),e.jsx("td",{className:"border p-2 md:text-md lg:text-lg border-r-1 ",children:((a=t.approved_by)==null?void 0:a.name)||"N/A"}),e.jsx("td",{className:"border p-2 md:text-md lg:text-lg border-r-1",children:b(t.created_at)}),e.jsx("td",{className:"border p-2",children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx(x,{size:"icon",variant:"ghost",className:"h-8 w-8",onClick:()=>Re(t.id),disabled:W,title:"View details",children:W?e.jsx(We,{className:"h-4 w-4 animate-spin"}):e.jsx(ze,{className:"h-4 w-4"})}),e.jsx(x,{size:"icon",variant:"ghost",className:"h-8 w-8",onClick:()=>{Y&&(d==null?void 0:d.id)===t.id?Z(d,B):fetch(`/reports/transactions/getbytid?tid=${t.id}`).then(r=>r.json()).then(({transaction:r,transdetails:i})=>{Z(r,i)}).catch(()=>j.error("Failed to generate PDF"))},title:"Download PDF",children:e.jsx(Oe,{className:"h-4 w-4"})}),t.status==="pending"&&e.jsx(x,{size:"sm",variant:"default",className:"bg-green-600 hover:bg-green-700",onClick:()=>Ae(t.id),disabled:D,children:D?"Approving...":"Approve"})]})})]},t.id)})})]})}),e.jsx(Pe,{open:Y,onOpenChange:E,children:e.jsxs(Me,{className:"max-w-4xl max-h-[90vh] overflow-y-auto",children:[e.jsx(Ve,{children:e.jsxs(He,{className:"flex items-center gap-2",children:[e.jsx(le,{className:"w-5 h-5"}),"Transaction #",d==null?void 0:d.id]})}),d&&e.jsxs("div",{className:"mt-4 space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Amount:"})," RS ",parseFloat(d.total_amount.toString()).toFixed(2)]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Type:"})," ",d.type.charAt(0).toUpperCase()+d.type.slice(1)]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Status:"})," ",d.status.charAt(0).toUpperCase()+d.status.slice(1)]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Institute:"})," ",((ee=d.institute)==null?void 0:ee.name)||"N/A"]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Added By:"})," ",((te=d.added_by)==null?void 0:te.name)||"N/A"]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Approved By:"})," ",((se=d.approved_by)==null?void 0:se.name)||"N/A"]}),e.jsxs("div",{className:"col-span-2",children:[e.jsx("span",{className:"font-medium",children:"Date:"})," ",b(d.created_at)]})]}),e.jsx(ie,{}),B.length?e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full text-sm border",children:[e.jsx("thead",{className:"bg-muted",children:e.jsxs("tr",{children:[e.jsx("th",{className:"border p-2 text-left",children:"Asset"}),e.jsx("th",{className:"border p-2 text-left",children:"Room"}),e.jsx("th",{className:"border p-2 text-left",children:"Fund Head"}),e.jsx("th",{className:"border p-2 text-left",children:"Qty"}),e.jsx("th",{className:"border p-2 text-left",children:"Amount"})]})}),e.jsx("tbody",{children:B.map((t,s)=>{var n,a,r,i;return e.jsxs("tr",{className:"hover:bg-muted/50",children:[e.jsx("td",{className:"border p-2",children:((n=t.asset)==null?void 0:n.name)||"-"}),e.jsx("td",{className:"border p-2",children:((a=t.room)==null?void 0:a.name)||"-"}),e.jsx("td",{className:"border p-2",children:((r=t.fund_head)==null?void 0:r.name)||"-"}),e.jsx("td",{className:"border p-2",children:t.qty??"-"}),e.jsxs("td",{className:"border p-2",children:["RS ",parseFloat(((i=t.amount)==null?void 0:i.toString())??"0").toFixed(2)]})]},s)})})]})}):e.jsx("p",{className:"text-muted-foreground",children:"No line items."})]})]})}),y.links.length>1&&e.jsx("div",{className:"flex justify-center pt-6 flex-wrap gap-2",children:y.links.map((t,s)=>e.jsx(x,{disabled:!t.url,variant:t.active?"default":"outline",size:"sm",onClick:()=>Ie.visit(t.url||"",{preserveScroll:!0}),children:e.jsx("span",{dangerouslySetInnerHTML:{__html:t.label}})},s))})]})]})})]})})]})})}export{gt as default};
