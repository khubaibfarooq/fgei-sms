import{r as x,j as r,L as J}from"./app-DnumDQL_.js";import{A as O,e as W,S as X,T as Y}from"./app-layout-BCsLwE8_.js";import{B as C}from"./button-W187GbT8.js";import{C as Z,a as ee,b as te,c as re}from"./card-z2W_NHdW.js";import{t as c}from"./index-BM8RsdCP.js";import"./index-Bn5-amje.js";import"./createLucideIcon-BnM6t9vF.js";import"./index-Kxh7Oxci.js";import"./index-x0URM9An.js";import"./index-GLmHMXCU.js";import"./index-7ivnv9TP.js";import"./input-CO7fgi0N.js";import"./app-logo-icon-eYuW_fi8.js";import"./circle-x-MZP0Slub.js";import"./clsx-B-dksMZM.js";import"./folder-root-Brtx0bBf.js";import"./grip-vertical-CtabzVOR.js";const se=[{title:"Asset Transactions",href:"/asset-transactions"}],T=i=>{const b=i!=null&&typeof i.id=="number"&&i.id>0&&typeof i.name=="string"&&i.name.trim()!=="";return b||console.warn("Invalid item detected:",i),b};function ke({fundHeads:i=[],assetCategories:b=[],assets:w=[],blocks:D=[]}){const[l,f]=x.useState([]),[j,S]=x.useState(w.filter(T).reduce((t,e)=>{const a=e.asset_category_id.toString();return t[a]=[...t[a]||[],e],t},{})),[A,F]=x.useState({}),[H,_]=x.useState({});x.useMemo(()=>{const t={};return l.forEach(e=>{if(e.fundHeadId&&e.amount&&e.isValid){const a=parseFloat(e.amount)||0;t[e.fundHeadId]=(t[e.fundHeadId]||0)+a}}),t},[l]);const y=x.useMemo(()=>{const t=l.filter(n=>n.isValid).length,e=l.reduce((n,d)=>{if(!d.isValid)return n;const s=parseInt(d.purchaseQty)||0;return n+s},0),a=l.reduce((n,d)=>{if(!d.isValid)return n;const s=parseFloat(d.amount)||0;return n+s},0);return{totalItems:t,totalPurchaseQty:e,totalAmount:a}},[l]),N=x.useMemo(()=>l.length>0&&l.every(t=>t.isValid),[l]),R=()=>{const t={id:Date.now(),fundHeadId:"",balance:0,blockId:"",roomId:"",assetCategoryId:"",assetId:"",currentQty:0,purchaseQty:"",amount:"",error:"",isValid:!1};f([...l,t])},K=t=>{f(l.filter(e=>e.id!==t)),c.success("Row removed")},$=(t,e)=>{if(!e){o(t,"balance",0);return}fetch(`/asset-trans/getbalance?id=${e}`).then(a=>a.json()).then(a=>{const n=a.balance||0;_(d=>({...d,[e]:n})),o(t,"balance",n)}).catch(a=>{console.error("Error fetching balance:",a),c.error("Failed to fetch balance"),o(t,"balance",0)})},E=(t,e)=>{if(!e){o(t,"roomId","");return}if(A[e]){o(t,"roomId","");return}fetch(`/asset-trans/getrooms?block_id=${e}`).then(a=>a.json()).then(a=>{const n=(a??[]).filter(d=>d.id&&d.name);console.log("Fetched rooms for block",e,n),F(d=>({...d,[e]:n})),o(t,"roomId","")}).catch(a=>{console.error("Error fetching rooms:",a),c.error("Failed to load rooms"),F(n=>({...n,[e]:[]}))})},L=t=>{requestAnimationFrame(()=>{const e=document.querySelector(`tr[data-row-id="${t}"] select[name="roomId"]`);e&&(e.focus(),e.classList.add("border-red-500","ring-2","ring-red-500"),setTimeout(()=>{e.classList.remove("border-red-500","ring-2","ring-red-500")},2e3))})},P=(t,e)=>{if(!e){o(t,"assetId",""),o(t,"currentQty",0);return}if(j[e]){o(t,"assetId",""),o(t,"currentQty",0);return}const a=l.find(s=>s.id===t),n=(a==null?void 0:a.roomId)??"";if(!n){c.error("Please select a Room before choosing an Asset Category."),L(t);return}const d=new URLSearchParams({id:e,room_id:n});fetch(`/asset-trans/getassets?${d.toString()}`).then(s=>s.json()).then(s=>{const g=(s.assets??[]).filter(T);S(h=>({...h,[e]:g})),o(t,"assetId",""),o(t,"currentQty",0)}).catch(s=>{console.error("Error fetching assets:",s),c.error("Failed to load assets"),S(g=>({...g,[e]:[]}))})},o=(t,e,a)=>{f(n=>n.map(d=>{var g;if(d.id!==t)return d;const s={...d,[e]:a,error:""};if((e==="blockId"||e==="roomId")&&(s.assetCategoryId="",s.assetId="",s.currentQty=0),e==="blockId"&&a!==d.blockId&&(E(t,a),s.roomId=""),e==="fundHeadId"&&a!==d.fundHeadId&&$(t,a),e==="assetCategoryId"&&(P(t,a),s.assetId="",s.currentQty=0),e==="assetId"&&a){const u=(j[d.assetCategoryId]||[]).find(k=>k.id.toString()===a);u&&(s.currentQty=u.current_qty??0)}if(e==="amount"||e==="fundHeadId"){const h=s.amount,u=s.fundHeadId,k=parseFloat(h)||0,Q=Math.round(k*100);if(s.isValid=!0,s.error="",u&&Q>0){const z=H[u]||0,V=Math.round(z*100),B=l.filter(p=>p.id!==d.id&&p.fundHeadId===u&&p.isValid).reduce((p,I)=>{const v=parseFloat(I.amount)||0;return p+Math.round(v*100)},0)+Q;if(B>V){const I=((B-V)/100).toFixed(2);s.error=`Exceeds by Rs ${parseFloat(I).toLocaleString()}`,s.isValid=!1;const v=((g=i.find(G=>G.id.toString()===u))==null?void 0:g.name)||"Fund";c.error(`Insufficient balance in "${v}"`)}}h&&!/^\d+(\.\d{1,2})?$/.test(h)&&(s.error="Max 2 decimal places",s.isValid=!1)}return s.isValid=!!(s.fundHeadId&&s.blockId&&s.roomId&&s.assetCategoryId&&s.assetId&&parseInt(s.purchaseQty)>0&&parseFloat(s.amount)>0&&!s.error),s}))},m=(t,e)=>{t.key==="Enter"&&t.shiftKey&&(t.preventDefault(),R())},q=t=>t?j[t]||[]:[],M=t=>t?A[t]||[]:[],U=()=>{if(l.length===0){c.error("Add at least one row");return}if(!N){c.error("Fix all errors before submitting");return}const t={items:l.map(e=>({fund_head_id:parseInt(e.fundHeadId),block_id:parseInt(e.blockId),room_id:parseInt(e.roomId),asset_id:parseInt(e.assetId),purchase_qty:parseInt(e.purchaseQty),amount:parseFloat(e.amount)})),total_amount:y.totalAmount};console.log("Submitting:",t),c.success("Transaction created!"),f([])};return r.jsxs(O,{breadcrumbs:se,children:[r.jsx(J,{title:"Create Asset Transaction"}),r.jsx("div",{className:"flex-1 p-3",children:r.jsxs(Z,{children:[r.jsx(ee,{className:"pb-3",children:r.jsxs("div",{className:"flex justify-between items-center",children:[r.jsx(te,{children:"Create Asset Transaction"}),r.jsxs(C,{onClick:R,children:[r.jsx(W,{className:"w-4 h-4 mr-2"}),"New Row"]})]})}),r.jsx(X,{}),r.jsxs(re,{className:"py-6",children:[r.jsx("div",{className:"overflow-x-auto border rounded-lg",children:r.jsxs("table",{className:"w-full border-collapse",children:[r.jsx("thead",{children:r.jsxs("tr",{className:"bg-[#0b431b] dark:bg-gray-800",children:[r.jsx("th",{className:"border p-2 text-left text-sm font-medium text-white dark:text-gray-200 w-[150px]",children:"Fund Head"}),r.jsx("th",{className:"border p-2 text-left text-sm font-medium text-white dark:text-gray-200 w-[100px]",children:"Balance"}),r.jsx("th",{className:"border p-2 text-left text-sm font-medium text-white dark:text-gray-200 w-[120px]",children:"Block"}),r.jsx("th",{className:"border p-2 text-left text-sm font-medium text-white dark:text-gray-200 w-[120px]",children:"Room"}),r.jsx("th",{className:"border p-2 text-left text-sm font-medium text-white dark:text-gray-200 w-[140px]",children:"Asset Category"}),r.jsx("th",{className:"border p-2 text-left text-sm font-medium text-white dark:text-gray-200 w-[160px]",children:"Asset"}),r.jsx("th",{className:"border p-2 text-left text-sm font-medium text-white dark:text-gray-200 w-[90px]",children:"Current Qty"}),r.jsx("th",{className:"border p-2 text-left text-sm font-medium text-white dark:text-gray-200 w-[100px]",children:"Purchase Qty"}),r.jsx("th",{className:"border p-2 text-left text-sm font-medium text-white dark:text-gray-200 w-[110px]",children:"Amount"}),r.jsx("th",{className:"border p-2 text-center text-sm font-medium text-white dark:text-gray-200 w-[70px]",children:"Action"})]})}),r.jsx("tbody",{children:l.length===0?r.jsx("tr",{children:r.jsx("td",{colSpan:10,className:"border p-12 text-center text-gray-500 dark:text-gray-400",children:'No transactions added. Click "New Row" to start.'})}):l.map(t=>r.jsxs("tr",{className:"hover:bg-gray-50 dark:hover:bg-gray-700",children:[r.jsx("td",{className:"border p-2",children:r.jsxs("select",{value:t.fundHeadId,onChange:e=>o(t.id,"fundHeadId",e.target.value),onKeyDown:e=>m(e,t.id),className:"w-full px-2 py-1.5 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 text-sm dark:bg-gray-800 dark:border-gray-600 dark:text-white",children:[r.jsx("option",{value:"",children:"Select Fund"}),i.map(e=>r.jsx("option",{value:e.id,children:e.name},e.id))]})}),r.jsx("td",{className:"border p-2",children:r.jsx("input",{type:"text",value:t.balance>0?`Rs ${t.balance.toLocaleString()}`:"-",disabled:!0,className:"w-full px-2 py-1.5 border border-gray-300 rounded-md bg-gray-100 text-gray-700 text-sm dark:bg-gray-700 dark:border-gray-600 dark:text-gray-300"})}),r.jsx("td",{className:"border p-2",children:r.jsxs("select",{value:t.blockId,onChange:e=>o(t.id,"blockId",e.target.value),onKeyDown:e=>m(e,t.id),className:"w-full px-2 py-1.5 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 text-sm dark:bg-gray-800 dark:border-gray-600 dark:text-white",children:[r.jsx("option",{value:"",children:"Select Block"}),D.map(e=>r.jsx("option",{value:e.id,children:e.name},e.id))]})}),r.jsx("td",{className:"border p-2",children:r.jsxs("select",{value:t.roomId,onChange:e=>o(t.id,"roomId",e.target.value),onKeyDown:e=>m(e,t.id),className:"w-full px-2 py-1.5 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 text-sm dark:bg-gray-800 dark:border-gray-600 dark:text-white disabled:opacity-50",disabled:!t.blockId,children:[r.jsx("option",{value:"",children:"Select Room"}),M(t.blockId).map(e=>r.jsx("option",{value:e.id,children:e.name},e.id))]})}),r.jsx("td",{className:"border p-2",children:r.jsxs("select",{value:t.assetCategoryId,onChange:e=>o(t.id,"assetCategoryId",e.target.value),onKeyDown:e=>m(e,t.id),disabled:!t.roomId,className:`w-full px-2 py-1.5 border rounded-md focus:outline-none focus:ring-2 text-sm dark:bg-gray-800 dark:border-gray-600 dark:text-white disabled:opacity-50 disabled:cursor-not-allowed ${t.roomId?"border-gray-300 focus:ring-green-500":"border-gray-300"}`,children:[r.jsx("option",{value:"",children:"Select Category"}),b.map(e=>r.jsx("option",{value:e.id,children:e.name},e.id))]})}),r.jsx("td",{className:"border p-2",children:r.jsxs("select",{value:t.assetId,onChange:e=>o(t.id,"assetId",e.target.value),onKeyDown:e=>m(e,t.id),className:"w-full px-2 py-1.5 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 text-sm dark:bg-gray-800 dark:border-gray-600 dark:text-white disabled:opacity-50",disabled:!t.assetCategoryId,children:[r.jsx("option",{value:"",children:"Select Asset"}),q(t.assetCategoryId).map(e=>r.jsx("option",{value:e.id,children:e.name},e.id))]})}),r.jsx("td",{className:"border p-2",children:r.jsx("input",{type:"text",value:t.currentQty,disabled:!0,className:"w-full px-2 py-1.5 border border-gray-300 rounded-md bg-gray-100 text-gray-700 text-sm dark:bg-gray-700 dark:border-gray-600 dark:text-gray-300"})}),r.jsx("td",{className:"border p-2",children:r.jsx("input",{type:"number",value:t.purchaseQty,onChange:e=>o(t.id,"purchaseQty",e.target.value),onKeyDown:e=>m(e,t.id),placeholder:"0",min:"0",className:"w-full px-2 py-1.5 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 text-sm dark:bg-gray-800 dark:border-gray-600 dark:text-white"})}),r.jsx("td",{className:"border p-2",children:r.jsxs("div",{className:"relative",children:[r.jsx("input",{type:"number",value:t.amount,onChange:e=>o(t.id,"amount",e.target.value),onKeyDown:e=>m(e,t.id),placeholder:"0.00",min:"0",step:"0.01",className:`w-full px-2 py-1.5 border rounded-md focus:outline-none focus:ring-2 text-sm dark:bg-gray-800 dark:border-gray-600 dark:text-white ${t.error?"border-red-500 focus:ring-red-500":"border-gray-300 focus:ring-green-500"}`}),t.error&&r.jsx("p",{className:"absolute left-0 -bottom-5 text-xs text-red-600 font-medium",children:t.error})]})}),r.jsx("td",{className:"border p-2 text-center",children:r.jsx(C,{variant:"destructive",size:"sm",onClick:()=>K(t.id),children:r.jsx(Y,{className:"w-4 h-4"})})})]},t.id))})]})}),l.length>0&&r.jsxs("div",{className:"mt-10 space-y-4",children:[r.jsxs("div",{className:"flex justify-end gap-8 p-4 bg-muted/50 rounded-lg",children:[r.jsxs("div",{className:"text-right",children:[r.jsx("p",{className:"text-sm text-muted-foreground",children:"Valid Items"}),r.jsx("p",{className:"text-lg font-bold",children:y.totalItems})]}),r.jsxs("div",{className:"text-right",children:[r.jsx("p",{className:"text-sm text-muted-foreground",children:"Total Qty"}),r.jsx("p",{className:"text-lg font-bold",children:y.totalPurchaseQty})]}),r.jsxs("div",{className:"text-right",children:[r.jsx("p",{className:"text-sm text-muted-foreground",children:"Total Amount"}),r.jsxs("p",{className:"text-lg font-bold text-green-600",children:["Rs ",y.totalAmount.toLocaleString("en-PK",{minimumFractionDigits:2})]})]})]}),r.jsx("div",{className:"flex justify-end",children:r.jsx(C,{onClick:U,size:"lg",disabled:!N,className:N?"":"opacity-50 cursor-not-allowed",children:"Create Transaction"})})]}),r.jsx("div",{className:"mt-4 p-3 bg-blue-50 dark:bg-blue-950 border border-blue-200 dark:border-blue-800 rounded-lg",children:r.jsxs("p",{className:"text-sm text-blue-800 dark:text-blue-200",children:["Tip: Press ",r.jsx("kbd",{className:"px-2 py-1 bg-white dark:bg-gray-800 border border-blue-300 dark:border-blue-700 rounded text-xs",children:"Shift"})," +"," ",r.jsx("kbd",{className:"px-2 py-1 bg-white dark:bg-gray-800 border border-blue-300 dark:border-blue-700 rounded text-xs",children:"Enter"})," to add a new row"]})})]})]})})]})}export{ke as default};
