var Ie=Object.defineProperty;var Le=(d,m,h)=>m in d?Ie(d,m,{enumerable:!0,configurable:!0,writable:!0,value:h}):d[m]=h;var ge=(d,m,h)=>Le(d,typeof m!="symbol"?m+"":m,h);import{r as o,j as t,L as Be}from"./app-C7DUuL6r.js";import{A as ze}from"./app-layout-DZsH4-pg.js";import{B as D}from"./button-DGc7c4jP.js";import{C as De,a as Pe,b as $e,c as Te}from"./card-CAoAfNNU.js";import{I as ye}from"./input-D0y_1agO.js";import{S as Q,a as U,b as W,c as O,d as w}from"./select-Cy1Hf74Y.js";import{t as i}from"./index-D8jCY7fd.js";import{l as Me}from"./lodash-DJTdiEVK.js";import{E as Ve,F as qe,a as Qe,b as Ue}from"./jspdf.plugin.autotable-DvLV5JYd.js";import{C as je}from"./combobox-COD2805O.js";import"./index-BpLD23Qr.js";import"./createLucideIcon-Dg93ZW-b.js";import"./index-BoT77qT9.js";import"./index-Bj3x-1Pu.js";import"./index-xz36ILgE.js";import"./index-Dh4LUeDX.js";import"./app-logo-icon-ByQfbhm1.js";import"./circle-x-9eGDQHK6.js";import"./folder-root-BOp9gTCc.js";import"./grip-vertical-DBdg7hAj.js";import"./index-3QW-ArKj.js";import"./index-C8ddnhR4.js";import"./popover-DAACbC3l.js";const We=[{title:"Reports",href:"/reports"},{title:"Assets",href:"/reports/assets"}];class Oe extends o.Component{constructor(){super(...arguments);ge(this,"state",{hasError:!1,error:null})}static getDerivedStateFromError(h){return{hasError:!0,error:h.message}}componentDidCatch(h,A){console.error("ErrorBoundary caught:",h,A),i.error("An error occurred while rendering the component. Please try again or contact support.")}render(){return this.state.hasError?t.jsxs("div",{className:"p-4",children:[t.jsxs("p",{className:"text-red-600",children:["Error: ",this.state.error]}),t.jsx(D,{onClick:()=>window.location.reload(),className:"mt-2",children:"Retry"})]}):this.props.children}}const a=d=>{const m=d!=null&&typeof d.id=="number"&&d.id>0&&typeof d.name=="string"&&d.name.trim()!=="";return m||console.warn("Invalid item detected:",d),m};function jt({instituteAssets:d,institutes:m,blocks:h,rooms:A,assetCategories:P,assets:$,regions:T,filters:S}){var ue,xe,fe;const[_,be]=o.useState(S.search||""),[u,J]=o.useState(S.institute_id||""),[x,K]=o.useState(S.block_id||""),[k,I]=o.useState(S.room_id||""),[f,we]=o.useState(S.asset_category_id||""),[C,H]=o.useState(S.asset_id||""),[v,Se]=o.useState(S.region_id||""),[Y,M]=o.useState(h.filter(a)),[G,E]=o.useState(A.filter(a)),[X,V]=o.useState($.filter(a)),[Z,ee]=o.useState(!1),[te,re]=o.useState(!1),[ke,se]=o.useState(!1),[He,oe]=o.useState(!1),[q,L]=o.useState(d),[N,ae]=o.useState(m||[]),[Je,ve]=o.useState([]),[c,le]=o.useState(!1),Ne=async e=>{try{const r=new URLSearchParams({region_id:e||""}).toString(),s=await fetch(`/reports/getInstitutes?${r}`);if(!s.ok)throw new Error("Failed to fetch institutes");const p=await s.json();ae(p),u&&e!=="0"&&!p.some(l=>l.id.toString()===u)&&J("")}catch(r){console.error("Error fetching institutes:",r),i.error("Failed to load institutes"),ae([])}},_e=e=>{Se(e),Ne(e)},ne=async()=>{try{const e=new URLSearchParams({search:_||"",institute_id:u||"",block_id:x||"",room_id:k||"",asset_category_id:f||"",asset_id:C||"",region_id:v||"",details:c?"true":"false",all:"true"}),r=await fetch(`/reports/assets/institute-assets?${e.toString()}`);if(!r.ok)throw new Error("Failed to fetch all assets for export");const s=await r.json();return ve(s),s}catch(e){return console.error("Error fetching all assets for export:",e),i.error("Failed to fetch assets for export"),[]}};o.useEffect(()=>{const e={institutes:Array.isArray(N)?N.filter(r=>!a(r)):[],blocks:h.filter(r=>!a(r)),rooms:A.filter(r=>!a(r)),assetCategories:P.filter(r=>!a(r)),assets:$.filter(r=>!a(r)),regions:T.filter(r=>!a(r))};Object.entries(e).forEach(([r,s])=>{s.length>0&&console.warn(`Invalid ${r}:`,s)})},[m,h,A,P,$,T,N]),o.useEffect(()=>{u?(ee(!0),fetch(`/reports/blocks?institute_id=${u}`).then(e=>e.json()).then(e=>{if(Array.isArray(e)){const r=e.filter(a);r.length<e.length&&console.warn("Filtered out invalid blocks:",e.filter(s=>!a(s))),M(r)}else console.warn("Blocks response is not an array:",e),i.error("Invalid blocks data received"),M([])}).catch(e=>{console.error("Error fetching blocks:",e),i.error("Failed to fetch blocks"),M([])}).finally(()=>ee(!1)),K(""),E([]),I("")):(M([]),E([]),I(""))},[u]),o.useEffect(()=>{x?(re(!0),fetch(`/reports/rooms?block_id=${x}`).then(e=>e.json()).then(e=>{if(Array.isArray(e)){const r=e.filter(a);r.length<e.length&&console.warn("Filtered out invalid rooms:",e.filter(s=>!a(s))),E(r)}else console.warn("Rooms response is not an array:",e),i.error("Invalid rooms data received"),E([])}).catch(e=>{console.error("Error fetching rooms:",e),i.error("Failed to fetch rooms"),E([])}).finally(()=>re(!1)),I("")):(E([]),I(""))},[x]),o.useEffect(()=>{f?(oe(!0),fetch(`/reports/assets/list?asset_category_id=${f}`).then(e=>e.json()).then(e=>{if(Array.isArray(e)){const r=e.filter(a);r.length<e.length&&console.warn("Filtered out invalid assets:",e.filter(s=>!a(s))),V(r)}else console.warn("Assets response is not an array:",e),i.error("Invalid assets data received"),V([])}).catch(e=>{console.error("Error fetching assets:",e),i.error("Failed to fetch assets"),V([])}).finally(()=>oe(!1)),H("")):(V($.filter(a)),H(""))},[f]),o.useEffect(()=>{if(ke)return;const e=new URLSearchParams({search:_||"",institute_id:u||"",block_id:x||"",room_id:k||"",asset_category_id:f||"",asset_id:C||"",region_id:v||"",details:c?"true":"false"});fetch(`/reports/assets/institute-assets?${e.toString()}`).then(r=>r.json()).then(r=>{L(r)}).catch(r=>{console.error("Error fetching assets after details toggle:",r),i.error("Failed to fetch assets")})},[c]);const Ce=async()=>{try{const e=await ne(),r=new Ve.Workbook,s=r.addWorksheet("Assets");s.mergeCells("A1:F1");const p=s.getCell("A1");p.font={size:16,bold:!0},p.alignment={horizontal:"center"},s.mergeCells("A2:F2");const l=s.getCell("A2");l.value="Assets Report",l.font={size:14,bold:!0},l.alignment={horizontal:"center"},s.addRow([]);const F=c?["Institute","Details","Quantity","Block","Room","Category","Asset"]:["Asset","Total Quantity","Rooms"],j=s.addRow(F);j.font={bold:!0},j.fill={type:"pattern",pattern:"solid",fgColor:{argb:"FF428BCA"}},j.alignment={horizontal:"center"},e.forEach(n=>{var y,b,B,z,pe;c?s.addRow([((y=n.institute)==null?void 0:y.name)||"N/A",n.details||"N/A",n.current_qty||0,((b=n.room.block)==null?void 0:b.name)||"N/A",((B=n.room)==null?void 0:B.name)||"N/A",((z=n.asset.category)==null?void 0:z.name)||"N/A",((pe=n.asset)==null?void 0:pe.name)||"N/A"]):s.addRow([n.name||"—",n.total_qty||0,n.locations_count||0])}),s.columns.forEach(n=>{var b;let y=0;(b=n.eachCell)==null||b.call(n,{includeEmpty:!0},B=>{const z=B.value?B.value.toString().length:10;z>y&&(y=z)}),n.width=Math.min(y+2,50)});const R=await r.xlsx.writeBuffer(),g=new Blob([R],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"});qe.saveAs(g,"Assets_Report.xlsx"),i.success("Excel exported successfully")}catch(e){console.error("Error exporting to Excel:",e),i.error("Failed to export Excel")}},Ee=async()=>{try{const e=await ne(),r=new Qe;r.setFontSize(16),r.setFont("helvetica","bold"),r.setFontSize(14),r.text("Assets Report",14,25);const s=c?["Institute","Details","Qty","Block","Room","Category","Asset"]:["Asset","Total Quantity","Rooms"],p=e.map(l=>{var F,j,R,g,n,y,b;return c?[((F=l.institute)==null?void 0:F.name)||"N/A",l.details||"N/A",((j=l.current_qty)==null?void 0:j.toString())||"0",((R=l.room)==null?void 0:R.block.name)||"N/A",((g=l.room)==null?void 0:g.name)||"N/A",((y=(n=l.asset)==null?void 0:n.category)==null?void 0:y.name)||"N/A",((b=l.asset)==null?void 0:b.name)||"N/A"]:[l.name||"—",(l.total_qty||0).toString(),(l.locations_count||0).toString()]});Ue(r,{head:[s],body:p,startY:35,styles:{fontSize:9,cellPadding:2},headStyles:{fillColor:[66,139,202],textColor:255,fontStyle:"bold"},alternateRowStyles:{fillColor:[240,240,240]},columnStyles:c?{0:{cellWidth:50},1:{halign:"center",cellWidth:20},5:{cellWidth:50}}:{0:{cellWidth:80},1:{halign:"center"},2:{halign:"center"}}}),r.save("Assets_Report.pdf"),i.success("PDF exported successfully")}catch(e){console.error("Error exporting to PDF:",e),i.error("Failed to export PDF")}},Fe=()=>{const e=new URLSearchParams({search:_||"",institute_id:u||"",block_id:x||"",room_id:k||"",asset_category_id:f||"",asset_id:C||"",region_id:v||"",details:c?"true":"false"});fetch(`/reports/assets/institute-assets?${e.toString()}`).then(r=>r.json()).then(r=>{L(r)}).catch(r=>{console.error("Error fetching filtered assets:",r),i.error("Failed to fetch filtered assets")})},Re=o.useMemo(()=>Me.debounce(()=>{const e=new URLSearchParams({search:_||"",institute_id:u||"",block_id:x||"",room_id:k||"",asset_category_id:f||"",asset_id:C||"",region_id:v||"",details:c?"true":"false"});console.log(e.toString()),fetch(`/reports/assets/institute-assets?${e.toString()}`).then(r=>r.json()).then(r=>{L(r)}).catch(r=>{console.error("Error fetching filtered assets:",r),i.error("Failed to fetch filtered assets")})},300),[u,x,k,f,C,v,c]),Ae=o.useMemo(()=>Array.isArray(N)?N.filter(a):(console.warn("filteredInstitutes is not an array or is null:",N),[]),[N]),ie=o.useMemo(()=>Y.filter(a),[Y]),ce=o.useMemo(()=>G.filter(a),[G]),de=o.useMemo(()=>P.filter(a),[P]),me=o.useMemo(()=>X.filter(a),[X]),he=o.useMemo(()=>T.filter(a),[T]);return t.jsx(Oe,{children:t.jsxs(ze,{breadcrumbs:We,children:[t.jsx(Be,{title:"Assets Report"}),t.jsx("div",{className:"flex-1 p-2 md:p-2",children:t.jsxs(De,{children:[t.jsxs(Pe,{children:[t.jsx($e,{className:"text-xl font-bold",children:"Filters"}),t.jsx("p",{className:"text-muted-foreground text-sm",children:"Refine your assets search"})]}),t.jsxs(Te,{className:"space-y-4",children:[t.jsxs("div",{className:"flex flex-row gap-2",children:[he.length>0&&t.jsx(je,{entity:"region",value:v,onChange:e=>_e(e),options:he.map(e=>({id:e.id.toString(),name:e.name.split(" ").pop()||e.name})),includeAllOption:!0}),t.jsx(je,{entity:"institute",value:u,onChange:e=>J(e),options:Ae.map(e=>({id:e.id.toString(),name:e.name})),includeAllOption:!0}),t.jsxs(Q,{value:x,onValueChange:e=>{K(e)},disabled:Z,children:[t.jsx(U,{children:t.jsx(W,{placeholder:"Select Block"})}),t.jsxs(O,{children:[t.jsx(w,{value:"0",children:"All Blocks"}),Z?t.jsx("div",{className:"text-muted-foreground text-sm p-2",children:"Loading blocks..."}):ie.length>0?ie.map(e=>t.jsx(w,{value:e.id.toString(),children:e.name},e.id)):t.jsx("div",{className:"text-muted-foreground text-sm p-2",children:"No blocks available"})]})]}),t.jsxs(Q,{value:k,onValueChange:e=>{I(e)},disabled:te,children:[t.jsx(U,{children:t.jsx(W,{placeholder:"Select Room"})}),t.jsxs(O,{children:[t.jsx(w,{value:"0",children:"All Rooms"}),te?t.jsx("div",{className:"text-muted-foreground text-sm p-2",children:"Loading rooms..."}):ce.length>0?ce.map(e=>t.jsx(w,{value:e.id.toString(),children:e.name.split(" ").pop()||e.name},e.id)):t.jsx("div",{className:"text-muted-foreground text-sm p-2",children:"No rooms available"})]})]}),t.jsxs(Q,{value:f,onValueChange:e=>{we(e)},children:[t.jsx(U,{children:t.jsx(W,{placeholder:"Select Asset Category"})}),t.jsxs(O,{children:[t.jsx(w,{value:"0",children:"All Asset Categories"}),de.length>0?de.map(e=>t.jsx(w,{value:e.id.toString(),children:e.name},e.id)):t.jsx("div",{className:"text-muted-foreground text-sm p-2",children:"No asset categories available"})]})]}),t.jsxs(Q,{value:C,onValueChange:e=>{H(e)},children:[t.jsx(U,{children:t.jsx(W,{placeholder:"Select Asset"})}),t.jsxs(O,{children:[t.jsx(w,{value:"0",children:"All Assets"}),me.length>0?me.map(e=>t.jsx(w,{value:e.id.toString(),children:e.name},e.id)):t.jsx("div",{className:"text-muted-foreground text-sm p-2",children:"No assets available"})]})]})]}),t.jsxs("div",{className:"flex gap-2",children:[t.jsxs("div",{className:"flex items-center gap-3 py-2",children:[t.jsx(ye,{type:"checkbox",id:"details-mode",checked:c,onChange:e=>{se(!1),le(e.target.checked)}}),t.jsxs("label",{htmlFor:"details-mode",className:"cursor-pointer select-none font-medium text-sm",children:[c?"Detailed View":"Summary View"," — Show individual entries"]})]}),t.jsx(D,{onClick:Re,className:"w-full md:w-auto",children:"Apply Filters"}),t.jsx(D,{onClick:Ee,className:"w-full md:w-auto",children:"Export PDF"}),t.jsx(D,{onClick:Ce,className:"w-full md:w-auto",children:"Export Excel"})]}),t.jsx(ye,{type:"text",placeholder:"Search assets... (press Enter)",value:_,onChange:e=>be(e.target.value),onKeyDown:Fe}),t.jsxs("table",{className:"w-full border-collapse border-1 rounded-md overflow-hidden shadow-sm",children:[t.jsx("thead",{children:t.jsx("tr",{className:"bg-primary dark:bg-gray-800",children:c?t.jsxs(t.Fragment,{children:[t.jsx("th",{className:"border p-2 text-left text-sm font-medium text-white dark:text-gray-200",children:"Institute"}),t.jsx("th",{className:"border p-2 text-left text-sm font-medium text-white dark:text-gray-200",children:"Category"}),t.jsx("th",{className:"border p-2 text-left text-sm font-medium text-white dark:text-gray-200",children:"Asset"}),t.jsx("th",{className:"border p-2 text-center text-sm font-medium text-white dark:text-gray-200",children:"Quantity"}),t.jsx("th",{className:"border p-2 text-left text-sm font-medium text-white dark:text-gray-200",children:"Room / Block"}),t.jsx("th",{className:"border p-2 text-left text-sm font-medium text-white dark:text-gray-200",children:"Added Date"})]}):t.jsxs(t.Fragment,{children:["   ",t.jsx("th",{className:"border p-2 text-left text-sm font-medium text-white dark:text-gray-200",children:"Asset"}),t.jsx("th",{className:"border p-2 text-center text-sm font-medium text-white dark:text-gray-200",children:"Total Quantity"}),t.jsx("th",{className:"border p-2 text-center text-sm font-medium text-white dark:text-gray-200",children:"Rooms"})]})})}),t.jsx("tbody",{children:((ue=q.data)==null?void 0:ue.length)===0?t.jsx("tr",{children:t.jsx("td",{colSpan:c?5:3,className:"border p-2 text-center text-sm text-gray-900 dark:text-gray-100",children:"No assets found."})}):(xe=q.data)==null?void 0:xe.map((e,r)=>{var s,p,l;if(!c){const F=j=>{se(!0),le(!0),setTimeout(()=>{const R=new URLSearchParams({search:_||"",institute_id:u||"",block_id:x||"",room_id:k||"",asset_category_id:f||"",asset_id:j.toString(),region_id:v||"",details:"true"});fetch(`/reports/assets/institute-assets?${R.toString()}`).then(g=>g.json()).then(g=>{L(g)}).catch(g=>{console.error("Error fetching asset details:",g),i.error("Failed to fetch asset details")})},0)};return t.jsxs("tr",{className:"hover:bg-primary/10 dark:hover:bg-gray-700 cursor-pointer",onClick:()=>F(e.id),children:[t.jsx("td",{className:"border p-2 text-left font-bold dark:text-gray-100",children:e.name}),t.jsx("td",{className:"border p-2 text-center text-lg font-bold text-green-600",children:e.total_qty}),t.jsx("td",{className:"border p-2 text-center text-amber-600",children:e.locations_count||"-"})]},`${e.name}-${r}`)}return e.asset?t.jsxs("tr",{className:"hover:bg-primary/10 dark:hover:bg-gray-700",children:[t.jsx("td",{className:"border p-2 text-left font-bold dark:text-gray-100",children:(s=e.institute)==null?void 0:s.name}),t.jsx("td",{className:"border p-2 text-left font-bold dark:text-gray-100",children:(p=e.asset)==null?void 0:p.category.name}),t.jsx("td",{className:"border p-2 text-left font-bold dark:text-gray-100",children:(l=e.asset)==null?void 0:l.name}),t.jsx("td",{className:"border p-2 text-center font-bold text-lg text-green-600",children:e.current_qty}),t.jsx("td",{className:"border p-2 text-sm text-gray-900 dark:text-gray-100",children:e.room?t.jsxs(t.Fragment,{children:[e.room.name,e.room.block&&t.jsxs("span",{className:"text-muted-foreground",children:[" (",e.room.block.name,")"]})]}):"—"}),t.jsx("td",{className:"border p-2 text-sm text-gray-900 dark:text-gray-100",children:e.added_date?new Date(e.added_date).toLocaleDateString():"—"})]},e.id):t.jsx("tr",{children:t.jsx("td",{colSpan:5,className:"text-center text-muted-foreground py-4",children:"Loading details..."})},r)})})]}),((fe=q.links)==null?void 0:fe.length)>1&&t.jsx("div",{className:"flex justify-center pt-6 flex-wrap gap-2",children:q.links.map((e,r)=>t.jsx(D,{disabled:!e.url,variant:e.active?"default":"outline",size:"sm",onClick:()=>{e.url&&fetch(e.url).then(s=>s.json()).then(s=>{L(s)}).catch(s=>{console.error("Error:",s)})},className:e.active?"bg-blue-600 hover:bg-blue-700":"",children:t.jsx("span",{dangerouslySetInnerHTML:{__html:e.label}})},r))})]})]})})]})})}export{jt as default};
