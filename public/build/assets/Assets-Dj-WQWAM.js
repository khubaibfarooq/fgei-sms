var Le=Object.defineProperty;var Be=(i,c,x)=>c in i?Le(i,c,{enumerable:!0,configurable:!0,writable:!0,value:x}):i[c]=x;var ge=(i,c,x)=>Be(i,typeof c!="symbol"?c+"":c,x);import{r as o,j as t,L as ze}from"./app-C5naZ0Xu.js";import{t as d,A as De,S as $e}from"./app-layout-CtdoAd8o.js";import{B as _}from"./button-jNbYH9-3.js";import{C as je,a as ye,b as be,c as Ne}from"./card-C37ELfMH.js";import{I as Pe}from"./input-CSka5UCN.js";import{S as q,a as Q,b as W,c as O,d as p}from"./select-BiMijox_.js";import{l as Me}from"./lodash-CgJ7HclS.js";import{E as Te,F as Ve,a as qe,b as Qe}from"./jspdf.plugin.autotable-BiyhqGFg.js";import{C as ve}from"./combobox-BBFvU0rh.js";import"./index-DxWWg5H9.js";import"./createLucideIcon-CmR2UCV9.js";import"./index-CrA-1fU4.js";import"./app-logo-icon-B-JspDvR.js";import"./folder-root-CJOfU33W.js";import"./grip-vertical-DGFerWM-.js";import"./index-cmxDaKRj.js";import"./index-523VM5Yc.js";import"./popover-DLMPxUjk.js";const We=[{title:"Reports",href:"/reports"},{title:"Assets",href:"/reports/assets"}];class Oe extends o.Component{constructor(){super(...arguments);ge(this,"state",{hasError:!1,error:null})}static getDerivedStateFromError(x){return{hasError:!0,error:x.message}}componentDidCatch(x,w){console.error("ErrorBoundary caught:",x,w),d.error("An error occurred while rendering the component. Please try again or contact support.")}render(){return this.state.hasError?t.jsxs("div",{className:"p-4",children:[t.jsxs("p",{className:"text-red-600",children:["Error: ",this.state.error]}),t.jsx(_,{onClick:()=>window.location.reload(),className:"mt-2",children:"Retry"})]}):this.props.children}}const a=i=>{const c=i!=null&&typeof i.id=="number"&&i.id>0&&typeof i.name=="string"&&i.name.trim()!=="";return c||console.warn("Invalid item detected:",i),c};function xt({instituteAssets:i,institutes:c,blocks:x,rooms:w,assetCategories:R,assets:U,regions:I,filters:g}){var ue,fe,pe;const[H,Ue]=o.useState(g.search||""),[u,Y]=o.useState(g.institute_id||""),[j,G]=o.useState(g.block_id||""),[L,S]=o.useState(g.room_id||""),[y,we]=o.useState(g.asset_category_id||""),[B,J]=o.useState(g.asset_id||""),[z,Se]=o.useState(g.region_id||""),[K,D]=o.useState(x.filter(a)),[X,N]=o.useState(w.filter(a)),[Z,$]=o.useState(U.filter(a)),[ee,te]=o.useState(!1),[se,re]=o.useState(!1),[oe,ae]=o.useState(!1),[P,le]=o.useState(i),[b,ne]=o.useState(c||[]),[He,ke]=o.useState([]),[m,Ae]=o.useState(!1),Fe=async e=>{try{const s=new URLSearchParams({region_id:e||""}).toString(),r=await fetch(`/reports/getInstitutes?${s}`);if(!r.ok)throw new Error("Failed to fetch institutes");const l=await r.json();console.log("Fetched institutes:",l),ne(l),u&&e!=="0"&&!l.some(k=>k.id.toString()===u)&&Y("")}catch(s){console.error("Error fetching institutes:",s),d.error("Failed to load institutes"),ne([])}},Ce=e=>{Se(e),Fe(e)},ie=async()=>{try{const e=new URLSearchParams({search:H||"",institute_id:u||"",block_id:j||"",room_id:L||"",asset_category_id:y||"",asset_id:B||"",region_id:z||"",details:m?"true":"false",all:"true"}),s=await fetch(`/reports/assets/institute-assets?${e.toString()}`);if(!s.ok)throw new Error("Failed to fetch all assets for export");const r=await s.json();return ke(r),r}catch(e){return console.error("Error fetching all assets for export:",e),d.error("Failed to fetch assets for export"),[]}};o.useEffect(()=>{const e={institutes:Array.isArray(b)?b.filter(s=>!a(s)):[],blocks:x.filter(s=>!a(s)),rooms:w.filter(s=>!a(s)),assetCategories:R.filter(s=>!a(s)),assets:U.filter(s=>!a(s)),regions:I.filter(s=>!a(s))};Object.entries(e).forEach(([s,r])=>{r.length>0&&console.warn(`Invalid ${s}:`,r)})},[c,x,w,R,U,I,b]),o.useEffect(()=>{u?(te(!0),fetch(`/reports/blocks?institute_id=${u}`).then(e=>e.json()).then(e=>{if(console.log("Fetched blocks:",e),Array.isArray(e)){const s=e.filter(a);s.length<e.length&&console.warn("Filtered out invalid blocks:",e.filter(r=>!a(r))),D(s)}else console.warn("Blocks response is not an array:",e),d.error("Invalid blocks data received"),D([])}).catch(e=>{console.error("Error fetching blocks:",e),d.error("Failed to fetch blocks"),D([])}).finally(()=>te(!1)),G(""),N([]),S("")):(D([]),N([]),S(""))},[u]),o.useEffect(()=>{j?(re(!0),fetch(`/reports/rooms?block_id=${j}`).then(e=>e.json()).then(e=>{if(console.log("Fetched rooms:",e),Array.isArray(e)){const s=e.filter(a);s.length<e.length&&console.warn("Filtered out invalid rooms:",e.filter(r=>!a(r))),N(s)}else console.warn("Rooms response is not an array:",e),d.error("Invalid rooms data received"),N([])}).catch(e=>{console.error("Error fetching rooms:",e),d.error("Failed to fetch rooms"),N([])}).finally(()=>re(!1)),S("")):(N([]),S(""))},[j]),o.useEffect(()=>{y?(ae(!0),fetch(`/reports/assets/list?asset_category_id=${y}`).then(e=>e.json()).then(e=>{if(console.log("Fetched assets:",e),Array.isArray(e)){const s=e.filter(a);s.length<e.length&&console.warn("Filtered out invalid assets:",e.filter(r=>!a(r))),$(s)}else console.warn("Assets response is not an array:",e),d.error("Invalid assets data received"),$([])}).catch(e=>{console.error("Error fetching assets:",e),d.error("Failed to fetch assets"),$([])}).finally(()=>ae(!1)),J("")):($([]),J(""))},[y]);const Ee=async()=>{var e;try{const s=await ie(),r=new Te.Workbook,l=r.addWorksheet("Assets"),k=s.length>0&&((e=s[0].institute)!=null&&e.name)?s[0].institute.name:"All Institutes";l.mergeCells("A1:F1");const A=l.getCell("A1");A.value=`Institute: ${k}`,A.font={size:16,bold:!0},A.alignment={horizontal:"center"},l.mergeCells("A2:F2");const h=l.getCell("A2");h.value="Assets Report",h.font={size:14,bold:!0},h.alignment={horizontal:"center"},l.addRow([]);const M=m?["Details","Quantity","Block","Room","Category","Asset"]:["Asset","Total Quantity","Locations"],v=l.addRow(M);v.font={bold:!0},v.fill={type:"pattern",pattern:"solid",fgColor:{argb:"FF428BCA"}},v.alignment={horizontal:"center"},s.forEach(n=>{var f,F,C,E;m?l.addRow([n.details||"N/A",n.current_qty||0,((f=n.room.block)==null?void 0:f.name)||"N/A",((F=n.room)==null?void 0:F.name)||"N/A",((C=n.asset.category)==null?void 0:C.name)||"N/A",((E=n.asset)==null?void 0:E.name)||"N/A"]):l.addRow([n.name||"—",n.total_qty||0,n.locations_count||0])}),l.columns.forEach(n=>{var F;let f=0;(F=n.eachCell)==null||F.call(n,{includeEmpty:!0},C=>{const E=C.value?C.value.toString().length:10;E>f&&(f=E)}),n.width=Math.min(f+2,50)});const T=await r.xlsx.writeBuffer(),V=new Blob([T],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"});Ve.saveAs(V,"Assets_Report.xlsx"),d.success("Excel exported successfully")}catch(s){console.error("Error exporting to Excel:",s),d.error("Failed to export Excel")}},_e=async()=>{var e;try{const s=await ie(),r=new qe,l=s.length>0&&((e=s[0].institute)!=null&&e.name)?s[0].institute.name:"All Institutes";r.setFontSize(16),r.setFont("helvetica","bold"),r.text(`Institute: ${l}`,14,15),r.setFontSize(14),r.text("Assets Report",14,25);const k=m?["Details","Qty","Block","Room","Category","Asset"]:["Asset","Total Quantity","Locations"],A=s.map(h=>{var M,v,T,V,n,f;return m?[h.details||"N/A",((M=h.current_qty)==null?void 0:M.toString())||"0",((v=h.room)==null?void 0:v.block.name)||"N/A",((T=h.room)==null?void 0:T.name)||"N/A",((n=(V=h.asset)==null?void 0:V.category)==null?void 0:n.name)||"N/A",((f=h.asset)==null?void 0:f.name)||"N/A"]:[h.name||"—",(h.total_qty||0).toString(),(h.locations_count||0).toString()]});Qe(r,{head:[k],body:A,startY:35,styles:{fontSize:9,cellPadding:2},headStyles:{fillColor:[66,139,202],textColor:255,fontStyle:"bold"},alternateRowStyles:{fillColor:[240,240,240]},columnStyles:m?{0:{cellWidth:50},1:{halign:"center",cellWidth:20},5:{cellWidth:50}}:{0:{cellWidth:80},1:{halign:"center"},2:{halign:"center"}}}),r.save("Assets_Report.pdf"),d.success("PDF exported successfully")}catch(s){console.error("Error exporting to PDF:",s),d.error("Failed to export PDF")}},Re=o.useMemo(()=>Me.debounce(()=>{const e=new URLSearchParams({search:H||"",institute_id:u||"",block_id:j||"",room_id:L||"",asset_category_id:y||"",asset_id:B||"",region_id:z||"",details:m?"true":"false"});fetch(`/reports/assets/institute-assets?${e.toString()}`).then(s=>s.json()).then(s=>{console.log("Fetched filtered institute assets:",s),le(s)}).catch(s=>{console.error("Error fetching filtered assets:",s),d.error("Failed to fetch filtered assets")})},300),[H,u,j,L,y,B,z,m]),Ie=o.useMemo(()=>Array.isArray(b)?b.filter(a):(console.warn("filteredInstitutes is not an array or is null:",b),[]),[b]),ce=o.useMemo(()=>K.filter(a),[K]),de=o.useMemo(()=>X.filter(a),[X]),me=o.useMemo(()=>R.filter(a),[R]),he=o.useMemo(()=>Z.filter(a),[Z]),xe=o.useMemo(()=>I.filter(a),[I]);return t.jsx(Oe,{children:t.jsxs(De,{breadcrumbs:We,children:[t.jsx(ze,{title:"Assets Report"}),t.jsx("div",{className:"flex-1 p-2 md:p-2",children:t.jsxs("div",{className:"flex flex-col md:flex-row gap-3",children:[t.jsx("div",{className:"w-full md:w-1/3",children:t.jsxs(je,{children:[t.jsxs(ye,{children:[t.jsx(be,{className:"text-xl font-bold",children:"Filters"}),t.jsx("p",{className:"text-muted-foreground text-sm",children:"Refine your assets search"})]}),t.jsxs(Ne,{className:"space-y-4",children:[xe.length>0&&t.jsx(ve,{entity:"region",value:z,onChange:e=>Ce(e),options:xe.map(e=>({id:e.id.toString(),name:e.name.split(" ").pop()||e.name})),includeAllOption:!0}),t.jsx(ve,{entity:"institute",value:u,onChange:e=>Y(e),options:Ie.map(e=>({id:e.id.toString(),name:e.name})),includeAllOption:!0}),t.jsxs(q,{value:j,onValueChange:e=>{G(e)},disabled:ee,children:[t.jsx(Q,{children:t.jsx(W,{placeholder:"Select Block"})}),t.jsxs(O,{children:[t.jsx(p,{value:"0",children:"All Blocks"}),ee?t.jsx("div",{className:"text-muted-foreground text-sm p-2",children:"Loading blocks..."}):ce.length>0?ce.map(e=>t.jsx(p,{value:e.id.toString(),children:e.name},e.id)):t.jsx("div",{className:"text-muted-foreground text-sm p-2",children:"No blocks available"})]})]}),t.jsxs(q,{value:L,onValueChange:e=>{S(e)},disabled:se,children:[t.jsx(Q,{children:t.jsx(W,{placeholder:"Select Room"})}),t.jsxs(O,{children:[t.jsx(p,{value:"0",children:"All Rooms"}),se?t.jsx("div",{className:"text-muted-foreground text-sm p-2",children:"Loading rooms..."}):de.length>0?de.map(e=>t.jsx(p,{value:e.id.toString(),children:e.name.split(" ").pop()||e.name},e.id)):t.jsx("div",{className:"text-muted-foreground text-sm p-2",children:"No rooms available"})]})]}),t.jsxs(q,{value:y,onValueChange:e=>{we(e)},children:[t.jsx(Q,{children:t.jsx(W,{placeholder:"Select Asset Category"})}),t.jsxs(O,{children:[t.jsx(p,{value:"0",children:"All Asset Categories"}),me.length>0?me.map(e=>t.jsx(p,{value:e.id.toString(),children:e.name},e.id)):t.jsx("div",{className:"text-muted-foreground text-sm p-2",children:"No asset categories available"})]})]}),t.jsxs(q,{value:B,onValueChange:e=>{J(e)},disabled:oe,children:[t.jsx(Q,{children:t.jsx(W,{placeholder:"Select Asset"})}),t.jsxs(O,{children:[t.jsx(p,{value:"0",children:"All Assets"}),oe?t.jsx("div",{className:"text-muted-foreground text-sm p-2",children:"Loading assets..."}):he.length>0?he.map(e=>t.jsx(p,{value:e.id.toString(),children:e.name},e.id)):t.jsx("div",{className:"text-muted-foreground text-sm p-2",children:"No assets available"})]})]}),t.jsxs("div",{className:"flex items-center gap-3 py-2",children:[t.jsx(Pe,{type:"checkbox",id:"details-mode",checked:m,onChange:e=>Ae(e.target.checked)}),t.jsxs("label",{htmlFor:"details-mode",className:"cursor-pointer select-none font-medium text-sm",children:[m?"Detailed View":"Summary View"," — Show individual entries"]})]}),t.jsx(_,{onClick:Re,className:"w-full",children:"Apply Filters"})]})]})}),t.jsx("div",{className:"w-full md:w-2/3",children:t.jsxs(je,{children:[t.jsxs(ye,{className:"pb-3 flex flex-col md:flex-row md:items-center md:justify-between gap-4",children:[t.jsx("div",{children:t.jsx(be,{className:"text-2xl font-bold",children:"Assets Report"})}),t.jsxs("div",{className:"flex gap-2",children:[t.jsx(_,{onClick:_e,className:"w-full md:w-auto",children:"Export PDF"}),t.jsx(_,{onClick:Ee,className:"w-full md:w-auto",children:"Export Excel"})]})]}),t.jsx($e,{}),t.jsxs(Ne,{className:"pt-6 space-y-6",children:[t.jsxs("table",{className:"w-full border-collapse border-1 rounded-md overflow-hidden shadow-sm",children:[t.jsx("thead",{children:t.jsxs("tr",{className:"bg-primary dark:bg-gray-800",children:[t.jsx("th",{className:"border p-2 text-left text-sm font-medium text-white dark:text-gray-200",children:"Asset"}),m?t.jsxs(t.Fragment,{children:[t.jsx("th",{className:"border p-2 text-left text-sm font-medium text-white dark:text-gray-200",children:"Description"}),t.jsx("th",{className:"border p-2 text-left text-sm font-medium text-white dark:text-gray-200",children:"Room / Block"}),t.jsx("th",{className:"border p-2 text-center text-sm font-medium text-white dark:text-gray-200",children:"Quantity"}),t.jsx("th",{className:"border p-2 text-left text-sm font-medium text-white dark:text-gray-200",children:"Category"}),t.jsx("th",{className:"border p-2 text-left text-sm font-medium text-white dark:text-gray-200",children:"Added Date"})]}):t.jsxs(t.Fragment,{children:[t.jsx("th",{className:"border p-2 text-center text-sm font-medium text-white dark:text-gray-200",children:"Total Quantity"}),t.jsx("th",{className:"border p-2 text-center text-sm font-medium text-white dark:text-gray-200",children:"Locations"})]})]})}),t.jsx("tbody",{children:((ue=P.data)==null?void 0:ue.length)===0?t.jsx("tr",{children:t.jsx("td",{colSpan:m?5:3,className:"border p-2 text-center text-sm text-gray-900 dark:text-gray-100",children:"No assets found."})}):(fe=P.data)==null?void 0:fe.map((e,s)=>{var r,l;return m?e.asset?t.jsxs("tr",{className:"hover:bg-primary/10 dark:hover:bg-gray-700",children:[t.jsx("td",{className:"border p-2 text-left font-bold dark:text-gray-100",children:(r=e.asset)==null?void 0:r.name}),t.jsx("td",{className:"border p-2 text-sm text-gray-900 dark:text-gray-100",children:e.details||"N/A"}),t.jsx("td",{className:"border p-2 text-sm text-gray-900 dark:text-gray-100",children:e.room?t.jsxs(t.Fragment,{children:[e.room.name,e.room.block&&t.jsxs("span",{className:"text-muted-foreground",children:[" (",e.room.block.name,")"]})]}):"—"}),t.jsx("td",{className:"border p-2 text-center font-bold text-lg text-green-600",children:e.current_qty}),t.jsx("td",{className:"border p-2 text-left font-bold dark:text-gray-100",children:(l=e.asset)==null?void 0:l.category.name}),t.jsx("td",{className:"border p-2 text-sm text-gray-900 dark:text-gray-100",children:e.added_date?new Date(e.added_date).toLocaleDateString():"—"})]},e.id):t.jsx("tr",{children:t.jsx("td",{colSpan:5,className:"text-center text-muted-foreground py-4",children:"Loading details..."})},s):t.jsxs("tr",{className:"hover:bg-primary/10 dark:hover:bg-gray-700",children:[t.jsx("td",{className:"border p-2 text-left font-bold dark:text-gray-100",children:e.name}),t.jsx("td",{className:"border p-2 text-center text-lg font-bold text-green-600",children:e.total_qty}),t.jsx("td",{className:"border p-2 text-center text-amber-600",children:e.locations_count||"-"})]},`${e.name}-${s}`)})})]}),((pe=P.links)==null?void 0:pe.length)>1&&t.jsx("div",{className:"flex justify-center pt-6 flex-wrap gap-2",children:P.links.map((e,s)=>t.jsx(_,{disabled:!e.url,variant:e.active?"default":"outline",size:"sm",onClick:()=>{e.url&&fetch(e.url).then(r=>r.json()).then(r=>{le(r)}).catch(r=>{console.error("Error:",r)})},className:e.active?"bg-blue-600 hover:bg-blue-700":"",children:t.jsx("span",{dangerouslySetInnerHTML:{__html:e.label}})},s))})]})]})})]})})]})})}export{xt as default};
