var he=Object.defineProperty;var xe=(l,i,c)=>i in l?he(l,i,{enumerable:!0,configurable:!0,writable:!0,value:c}):l[i]=c;var K=(l,i,c)=>xe(l,typeof i!="symbol"?i+"":i,c);import{r as s,j as t,L as pe}from"./app-CyWn1lGs.js";import{A as ue}from"./app-layout-DiCluG1e.js";import{B as b}from"./button-DEaq9HwV.js";import{C as fe,a as ge,b as ye,c as be}from"./card-C4_Bgv-J.js";import{I as je}from"./input-Dsii1Yfj.js";import{S as Q,a as X,b as Z,c as ee,d as I}from"./select-Bg9mJ4hL.js";import{t as m}from"./index-MQ3k8Z3F.js";import{l as ke}from"./lodash-DJgHjxiR.js";import{E as we,F as Ne,a as Re,b as ve}from"./jspdf.plugin.autotable-Clmfbm5q.js";import{C as te}from"./combobox-BkhhFDcy.js";import{I as Se}from"./image-preview-DvejoFx9.js";import"./index-C0lFZd38.js";import"./createLucideIcon-4GuWRGxM.js";import"./index-C7ni3JYd.js";import"./index-Fba5Dcyw.js";import"./index-BdnpVY-g.js";import"./index-BpP6GsNT.js";import"./app-logo-icon-DrA9nfm1.js";import"./circle-x-Dwwa9Z39.js";import"./folder-root-DB-2ly3i.js";import"./grip-vertical-CS9IAfGJ.js";import"./index-ChL5cW2f.js";import"./index-BcvOSBTm.js";import"./popover-Bqcbb87j.js";const Ee=[{title:"Reports",href:"/reports"},{title:"Rooms",href:"/reports/rooms"}];class Ce extends s.Component{constructor(){super(...arguments);K(this,"state",{hasError:!1,error:null})}static getDerivedStateFromError(c){return{hasError:!0,error:c.message}}componentDidCatch(c,f){console.error("ErrorBoundary caught:",c,f),m.error("An error occurred while rendering the component. Please try again or contact support.")}render(){return this.state.hasError?t.jsxs("div",{className:"p-4",children:[t.jsxs("p",{className:"text-red-600",children:["Error: ",this.state.error]}),t.jsx(b,{onClick:()=>window.location.reload(),className:"mt-2",children:"Retry"})]}):this.props.children}}const p=l=>{const i=l!=null&&typeof l.id=="number"&&l.id>0&&typeof l.name=="string"&&l.name.trim()!=="";return i||console.warn("Invalid item detected:",l),i};function tt({rooms:l,institutes:i,roomtypes:c,regions:f,filters:j}){var W,J,Y;const[k,z]=s.useState(j.search||""),[h,B]=s.useState(j.institute_id||""),[R,v]=s.useState(j.block_id||""),[S,L]=s.useState(j.roomtype_id||""),[E,re]=s.useState(j.region_id||""),[C,P]=s.useState(l),[u,T]=s.useState(i||[]),[D,A]=s.useState([]),[M,$]=s.useState(!1),[Ae,oe]=s.useState([]),se=async e=>{try{const r=new URLSearchParams({region_id:e||""}).toString(),o=await fetch(`/reports/getInstitutes?${r}`);if(!o.ok)throw new Error("Failed to fetch institutes");const a=await o.json();console.log("Fetched institutes:",a),T(a),h&&e!=="0"&&!a.some(n=>n.id.toString()===h)&&B("")}catch(r){console.error("Error fetching institutes:",r),m.error("Failed to load institutes"),T([])}},ae=e=>{re(e),B(""),v(""),L(""),se(e)};s.useEffect(()=>{h?($(!0),fetch(`/reports/rooms/getInstituteBlocks?institute_id=${h}`).then(e=>e.json()).then(e=>{if(console.log("Fetched blocks:",e),Array.isArray(e)){const r=e.filter(p);A(r)}else console.warn("Blocks response is not an array:",e),m.error("Invalid blocks data received"),A([])}).catch(e=>{console.error("Error fetching blocks:",e),m.error("Failed to fetch blocks"),A([])}).finally(()=>$(!1)),v("")):(A([]),v(""))},[h]);const V=async()=>{try{const e=new URLSearchParams({search:k||"",institute_id:h||"",block_id:R||"",roomtype_id:S||"",region_id:E||"",all:"true"}),r=await fetch(`/reports/rooms/getRoomsReport?${e.toString()}`);if(!r.ok)throw new Error("Failed to fetch all rooms for export");const o=await r.json();return oe(o),o}catch(e){return console.error("Error fetching all rooms for export:",e),m.error("Failed to fetch rooms for export"),[]}};s.useEffect(()=>{const e={institutes:Array.isArray(u)?u.filter(r=>!p(r)):[],roomtypes:c.filter(r=>!p(r)),regions:f.filter(r=>!p(r))};Object.entries(e).forEach(([r,o])=>{o.length>0&&console.warn(`Invalid ${r}:`,o)})},[i,c,f,u]);const le=async()=>{var e,r;try{const o=await V(),a=new we.Workbook,n=a.addWorksheet("Rooms"),_=o.length>0&&((r=(e=o[0].block)==null?void 0:e.institute)!=null&&r.name)?o[0].block.institute.name:"All Institutes";n.mergeCells("A1:E1");const w=n.getCell("A1");w.value=`Institute: ${_}`,w.font={size:16,bold:!0},w.alignment={horizontal:"center"},n.mergeCells("A2:E2");const x=n.getCell("A2");x.value="Rooms Report",x.font={size:14,bold:!0},x.alignment={horizontal:"center"},n.addRow([]);const F=["Room Name","Room Type","Block","Area","Capacity"],g=n.addRow(F);g.font={bold:!0},g.fill={type:"pattern",pattern:"solid",fgColor:{argb:"FF428BCA"}},g.alignment={horizontal:"center"},o.forEach(d=>{var y,N;n.addRow([d.name||"—",((y=d.room_type)==null?void 0:y.name)||"N/A",((N=d.block)==null?void 0:N.name)||"N/A",d.area||"N/A",d.capacity||"N/A"])}),n.columns.forEach(d=>{var N;let y=0;(N=d.eachCell)==null||N.call(d,{includeEmpty:!0},q=>{const G=q.value?q.value.toString().length:10;G>y&&(y=G)}),d.width=Math.min(y+2,50)});const de=await a.xlsx.writeBuffer(),me=new Blob([de],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"});Ne.saveAs(me,"Rooms_Report.xlsx"),m.success("Excel exported successfully")}catch(o){console.error("Error exporting to Excel:",o),m.error("Failed to export Excel")}},ne=async()=>{var e,r;try{const o=await V(),a=new Re,n=o.length>0&&((r=(e=o[0].block)==null?void 0:e.institute)!=null&&r.name)?o[0].block.institute.name:"All Institutes";a.setFontSize(16),a.setFont("helvetica","bold"),a.text(`Institute: ${n}`,14,15),a.setFontSize(14),a.text("Rooms Report",14,25);const _=["Room Name","Room Type","Block","Area","Capacity"],w=o.map(x=>{var F,g;return[x.name||"—",((F=x.room_type)==null?void 0:F.name)||"N/A",((g=x.block)==null?void 0:g.name)||"N/A",x.area||"N/A",x.capacity||"N/A"]});ve(a,{head:[_],body:w,startY:35,styles:{fontSize:9,cellPadding:2},headStyles:{fillColor:[66,139,202],textColor:255,fontStyle:"bold"},alternateRowStyles:{fillColor:[240,240,240]}}),a.save("Rooms_Report.pdf"),m.success("PDF exported successfully")}catch(o){console.error("Error exporting to PDF:",o),m.error("Failed to export PDF")}},ie=s.useMemo(()=>ke.debounce(()=>{const e=new URLSearchParams({search:k||"",institute_id:h||"",block_id:R||"",roomtype_id:S||"",region_id:E||""});fetch(`/reports/rooms/getRoomsReport?${e.toString()}`).then(r=>r.json()).then(r=>{console.log("Fetched filtered rooms:",r),P(r)}).catch(r=>{console.error("Error fetching filtered rooms:",r),m.error("Failed to fetch filtered rooms")})},300),[k,h,R,S,E]),ce=s.useMemo(()=>Array.isArray(u)?u.filter(p):(console.warn("filteredInstitutes is not an array or is null:",u),[]),[u]),O=s.useMemo(()=>D.filter(p),[D]),U=s.useMemo(()=>c.filter(p),[c]),H=s.useMemo(()=>f.filter(p),[f]);return t.jsx(Ce,{children:t.jsxs(ue,{breadcrumbs:Ee,children:[t.jsx(pe,{title:"Rooms Report"}),t.jsx("div",{className:"flex-1 p-2 md:p-2",children:t.jsxs(fe,{children:[t.jsxs(ge,{children:[t.jsx(ye,{className:"text-xl font-bold",children:"Filters"}),t.jsx("p",{className:"text-muted-foreground text-sm",children:"Refine your rooms search"})]}),t.jsxs(be,{className:"space-y-4",children:[t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx(je,{placeholder:"Search rooms...",value:k,onChange:e=>z(e.target.value)}),t.jsx(b,{variant:"outline",onClick:()=>z(""),disabled:!k,children:"Clear"})]}),t.jsxs("div",{className:"flex items-center space-x-2",children:[H.length>0&&t.jsx(te,{entity:"region",value:E,onChange:e=>ae(e),options:H.map(e=>({id:e.id.toString(),name:e.name.split(" ").pop()||e.name})),includeAllOption:!0}),t.jsx(te,{entity:"institute",value:h,onChange:e=>B(e),options:ce.map(e=>({id:e.id.toString(),name:e.name})),includeAllOption:!0}),t.jsxs(Q,{value:R,onValueChange:e=>{v(e)},disabled:M,children:[t.jsx(X,{children:t.jsx(Z,{placeholder:"Select Block"})}),t.jsxs(ee,{children:[t.jsx(I,{value:"0",children:"All Blocks"}),M?t.jsx("div",{className:"text-muted-foreground text-sm p-2",children:"Loading blocks..."}):O.length>0?O.map(e=>t.jsx(I,{value:e.id.toString(),children:e.name},e.id)):t.jsx("div",{className:"text-muted-foreground text-sm p-2",children:"No blocks available"})]})]}),t.jsxs(Q,{value:S,onValueChange:e=>{L(e)},children:[t.jsx(X,{children:t.jsx(Z,{placeholder:"Select Room Type"})}),t.jsxs(ee,{children:[t.jsx(I,{value:"0",children:"All Room Types"}),U.length>0?U.map(e=>t.jsx(I,{value:e.id.toString(),children:e.name},e.id)):t.jsx("div",{className:"text-muted-foreground text-sm p-2",children:"No room types available"})]})]}),t.jsx(b,{onClick:ie,className:"w-fit",children:"Apply Filters"}),t.jsx(b,{onClick:ne,className:"w-full md:w-auto",children:"Export PDF"}),t.jsx(b,{onClick:le,className:"w-full md:w-auto",children:"Export Excel"})]}),t.jsxs("table",{className:"w-full border-collapse border-1 rounded-md overflow-hidden shadow-sm",children:[t.jsx("thead",{children:t.jsxs("tr",{className:"bg-primary dark:bg-gray-800",children:[t.jsx("th",{className:"border p-2 text-left text-sm font-medium text-white dark:text-gray-200",children:"Room Name"}),t.jsx("th",{className:"border p-2 text-left text-sm font-medium text-white dark:text-gray-200",children:"Room Type"}),t.jsx("th",{className:"border p-2 text-left text-sm font-medium text-white dark:text-gray-200",children:"Block"}),t.jsx("th",{className:"border p-2 text-left text-sm font-medium text-white dark:text-gray-200",children:"Area"}),"  ",t.jsx("th",{className:"border p-2 text-left text-sm font-medium text-white dark:text-gray-200",children:"Institute"})]})}),t.jsx("tbody",{children:((W=C.data)==null?void 0:W.length)===0?t.jsx("tr",{children:t.jsx("td",{colSpan:5,className:"border p-2 text-center text-sm text-gray-900 dark:text-gray-100",children:"No rooms found."})}):(J=C.data)==null?void 0:J.map(e=>{var r,o,a,n;return t.jsxs("tr",{className:"hover:bg-primary/10 dark:hover:bg-gray-700",children:[t.jsx("td",{className:"border p-2 text-left font-bold dark:text-gray-100",children:t.jsxs("div",{className:"flex flex-column gap-2 align-middle",children:[" ",t.jsx(Se,{dataImg:e.img,size:"h-20"}),"  ",t.jsx("span",{className:"font-bold",children:e.name})]})}),t.jsx("td",{className:"border p-2 text-left text-gray-900 dark:text-gray-100",children:((r=e.type)==null?void 0:r.name)||"—"}),t.jsx("td",{className:"border p-2 text-left text-gray-900 dark:text-gray-100",children:((o=e.block)==null?void 0:o.name)||"—"}),t.jsx("td",{className:"border p-2 text-left text-gray-900 dark:text-gray-100",children:e.area||"—"}),t.jsx("td",{className:"border p-2 text-left text-gray-900 dark:text-gray-100",children:((n=(a=e.block)==null?void 0:a.institute)==null?void 0:n.name)||"—"})]},e.id)})})]}),((Y=C.links)==null?void 0:Y.length)>1&&t.jsx("div",{className:"flex justify-center pt-6 flex-wrap gap-2",children:C.links.map((e,r)=>t.jsx(b,{disabled:!e.url,variant:e.active?"default":"outline",size:"sm",onClick:()=>{e.url&&fetch(e.url).then(o=>o.json()).then(o=>{P(o)}).catch(o=>{console.error("Error:",o)})},className:e.active?"bg-blue-600 hover:bg-blue-700":"",children:t.jsx("span",{dangerouslySetInnerHTML:{__html:e.label}})},r))})]})]})})]})})}export{tt as default};
