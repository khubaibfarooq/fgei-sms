import{r as j,j as e,L as ve}from"./app-BYW6Hw5P.js";import{A as Fe,S as P,F as ne}from"./app-layout-CkBjm82r.js";import{B as v}from"./button-KEKpn40q.js";import{C as we,a as Re,b as Ce,c as $}from"./card-CcTa_Y2D.js";import{S as Pe,a as $e,b as Te,c as Ae,d as ae}from"./select-N3lherH0.js";import{C as re}from"./checkbox-DNmt08km.js";import{t as T}from"./index-CWqD-BQm.js";import{C as ie}from"./combobox-BmJjaiqj.js";import{E as ze,F as Ee,a as oe,b as D}from"./jspdf.plugin.autotable-XnPcMDto.js";import"./index-DIcbYQHf.js";import"./createLucideIcon-Cnghp3Q1.js";import"./index-7V5JbWTF.js";import"./index-VCqmnFKe.js";import"./index-C9cHz5j9.js";import"./index-CEvF1sNP.js";import"./input-BaKdq6-Q.js";import"./app-logo-icon-CBEaFWCe.js";import"./circle-x-BtCoKV9n.js";import"./clsx-B-dksMZM.js";import"./folder-root-DfL1t8fa.js";import"./grip-vertical-WAFKrZtD.js";import"./index-DLLX3RpQ.js";import"./index-BF6rfsle.js";import"./popover-OT_IhGFb.js";const De=[{title:"Reports",href:"/reports"},{title:"Funds",href:"/reports/funds"}];function ot({funds:le=[],fundheads:x=[],regions:g=[],institutes:de=[],balances:ce=[],filters:B}){var J,q;const[S,A]=j.useState(B.institute_id||""),[l,F]=j.useState(B.fund_head_id||""),[d,z]=j.useState(B.region_id||""),[y,me]=j.useState(le),[w,xe]=j.useState(ce),[pe,G]=j.useState(de),[_,H]=j.useState([]),[W,Y]=j.useState(!1),N=t=>t==null||t===""?0:typeof t=="number"?t:parseFloat(String(t).replace(/,/g,""))||0,h=t=>{const n=N(t);return n<1e6?`${n.toLocaleString()}`:`${(n/1e6).toFixed(2)} Mn`},O=j.useMemo(()=>w.reduce((t,n)=>t+N(n.balance),0),[w]),M=async t=>{if(!t||t==="0"){G([]);return}try{const n=await fetch(`/reports/getInstitutes?region_id=${t}`);if(!n.ok)throw new Error;const s=await n.json();G(s)}catch{T.error("Failed to load institutes")}},ue=t=>{z(t),M(t),A("")},k=async t=>{try{const n=new URLSearchParams({institute_id:S||"",region_id:d||"",fund_head_id:l||""}),s=t||`/reports/funds/getfunds?${n.toString()}`,a=await fetch(s);if(!a.ok)throw new Error;const i=await a.json();me(i.funds||i||[]),xe(i.balances||[])}catch(n){console.error(n),T.error("Failed to load data")}},ge=async()=>{const t=new ze.Workbook,n=t.addWorksheet("Funds");n.columns=[{header:"Institute",key:"institute",width:50},...x.map(a=>({header:a.name,key:a.name,width:18})),{header:"Total",key:"total",width:20}],y.forEach(a=>{const i={institute:a.institute_name??(a.region_name.split(" ").pop()||a.region_name)};x.forEach(m=>i[m.name]=N(a.fund_heads[m.name])),i.total=N(a.total_balance),n.addRow(i)});const s=await t.xlsx.writeBuffer();Ee.saveAs(new Blob([s]),"Funds_Report.xlsx")},he=()=>{const t=new oe("l","mm","a4");t.text("Institute Wise Fund Balances",14,15);const n=["Institute",...x.map(a=>a.name),"Total"],s=y.map(a=>[a.institute_name??(a.region_name.split(" ").pop()||a.region_name),...x.map(i=>N(a.fund_heads[i.name]).toFixed(2)),N(a.total_balance).toFixed(2)]);D(t,{head:[n],body:s,startY:25}),t.save("Funds_Report.pdf")},fe=t=>{H(n=>n.includes(t)?n.filter(s=>s!==t):[...n,t])},be=()=>{_.length===g.length?H([]):H(g.map(t=>t.id))},b=t=>t>=1e6?(t/1e6).toFixed(2)+" Mn":t.toLocaleString(),V=async t=>{const n=t||_;if(n.length===0){T.error("Please select at least one region");return}Y(!0);try{const s=new URLSearchParams;n.forEach(r=>s.append("region_ids[]",r.toString()));const a=await fetch(`/reports/funds/regional-pdf-data?${s.toString()}`);if(!a.ok)throw new Error("Failed to fetch data");const i=await a.json();console.log(i);const{fundHeads:m,table2FundHeads:E,table1:R,table2:K,table3:Q,reportDate:X}=i,o=new oe("l","mm","a4"),C=o.internal.pageSize.getWidth();let c=15;o.setFontSize(12),o.setFont("helvetica","bold"),o.text("Anx-A",C-20,c,{align:"right"}),o.text(`Present Balance Held With Regional Office as on ${X}`,C/2,c,{align:"center"}),c+=5;const je=["Detail",...m.map(r=>r.name),"Remarks"],Z=R.map(r=>[r.region_name,...m.map(p=>b(r.fund_heads[p.name]||0)),""]),I=["G. Total"];m.forEach(r=>{const p=R.reduce((f,u)=>f+(u.fund_heads[r.name]||0),0);I.push(b(p))}),I.push(""),Z.push(I),D(o,{head:[je],body:Z,startY:c,theme:"grid",styles:{fontSize:9,cellPadding:2},headStyles:{fillColor:[66,66,66],textColor:255},columnStyles:{0:{fontStyle:"bold"}}}),c=o.lastAutoTable.finalY+15,o.setFontSize(12),o.setFont("helvetica","bold"),o.text("Anx-B",C-20,c,{align:"right"}),o.text("Balance Held With Institutions (Still Not deposit to RO)",C/2,c,{align:"center"}),c+=5;const L=E||m,ye=["Detail",...L.map(r=>r.name)],ee=K.map(r=>[r.region_name,...L.map(p=>b(r.fund_heads[p.name]||0))]),te=["G.Total"];L.forEach(r=>{const p=K.reduce((f,u)=>f+(u.fund_heads[r.name]||0),0);te.push(b(p))}),ee.push(te),D(o,{head:[ye],body:ee,startY:c,theme:"grid",styles:{fontSize:9,cellPadding:2},headStyles:{fillColor:[66,66,66],textColor:255},columnStyles:{0:{fontStyle:"bold"}}}),c=o.lastAutoTable.finalY+15,c>o.internal.pageSize.getHeight()-60&&(o.addPage(),c=15),o.setFontSize(12),o.setFont("helvetica","bold"),o.text("Anx-C",C-20,c,{align:"right"}),c+=5;const _e=["Detail",...m.map(r=>r.name),"Exp Approved"],se=Q.map(r=>{const p=m.map(f=>{const u=r.exp_approved[f.name];if(!u||u.total===0)return"";const Ne=b(u.total),Se=b(u.paid),ke=b(u.remaining);return`${f.name}: Rs.${Ne} - Rs.${Se}= Rs.${ke}`}).filter(Boolean);return[r.region_name,...m.map(f=>b(r.fund_heads[f.name]||0)),p.join(`
`)||"-"]}),U=["G.Total"];m.forEach(r=>{const p=Q.reduce((f,u)=>f+(u.fund_heads[r.name]||0),0);U.push(b(p))}),U.push(""),se.push(U),D(o,{head:[_e],body:se,startY:c,theme:"grid",styles:{fontSize:9,cellPadding:2},headStyles:{fillColor:[66,66,66],textColor:255},columnStyles:{0:{fontStyle:"bold"}}}),o.save(`Regional_Fund_Report_${X.replace(/ /g,"_")}.pdf`),T.success("PDF report generated successfully")}catch(s){console.error(s),T.error("Failed to generate PDF report")}finally{Y(!1)}};return e.jsxs(Fe,{breadcrumbs:De,children:[e.jsx(ve,{title:"Funds Report"}),e.jsx("div",{className:"p-2 sm:p-4 lg:p-6 w-full overflow-x-hidden space-y-4 sm:space-y-6",children:e.jsxs(we,{className:" shadow-lg",children:[e.jsx(Re,{className:"pb-4",children:e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4",children:[e.jsxs("div",{children:[e.jsx(Ce,{className:"text-lg sm:text-2xl font-bold",children:"Funds Report"}),e.jsx("p",{className:"text-xs sm:text-sm text-muted-foreground mt-1",children:"View fund balances by institute / fund head"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(v,{onClick:he,variant:"outline",size:"sm",children:"PDF"}),e.jsx(v,{onClick:ge,variant:"outline",size:"sm",children:"Excel"})]})]})}),e.jsx(P,{}),e.jsx($,{className:"pt-6 pb-4",children:e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4",children:[g.length>0&&e.jsx(ie,{entity:"region",value:d,onChange:ue,options:g.map(t=>({id:t.id.toString(),name:t.name.split(" ").pop()||t.name})),includeAllOption:!0,placeholder:"Select Region"}),e.jsx(ie,{entity:"institute",value:S,onChange:A,options:pe.map(t=>({id:t.id.toString(),name:t.name})),includeAllOption:!0,placeholder:"Select Institute"}),e.jsxs(Pe,{value:l,onValueChange:F,children:[e.jsx($e,{children:e.jsx(Te,{placeholder:"Fund Head"})}),e.jsxs(Ae,{children:[e.jsx(ae,{value:"0",children:"All Fund Heads"}),x.map(t=>e.jsx(ae,{value:t.id.toString(),children:t.name},t.id))]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(v,{onClick:()=>k(),className:"flex-1",children:"Apply"}),e.jsx(v,{variant:"outline",onClick:()=>{z(""),A(""),F(""),k("/reports/funds")},className:"flex-1",children:"Reset"})]})]})}),e.jsx(P,{}),g.length>0&&e.jsxs(e.Fragment,{children:[e.jsx($,{className:"pt-6 pb-4",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("h3",{className:"text-sm sm:text-base lg:text-lg font-semibold flex items-center gap-2",children:[e.jsx(ne,{className:"h-4 w-4 sm:h-5 sm:w-5"}),"Generate Regional Fund Report",d&&d!=="0"&&e.jsxs("span",{className:"text-sm font-normal text-muted-foreground",children:["(",((J=g.find(t=>t.id.toString()===d))==null?void 0:J.name.split(" ").pop())||"Selected Region",")"]})]}),e.jsxs("div",{className:"flex items-center gap-4",children:[(!d||d==="0")&&e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[e.jsx(re,{checked:_.length===g.length&&g.length>0,onCheckedChange:be}),e.jsx("span",{className:"text-xs sm:text-sm font-medium",children:"Select All"})]}),e.jsxs(v,{onClick:()=>{d&&d!=="0"?V([parseInt(d)]):V()},disabled:(!d||d==="0")&&_.length===0||W,className:"gap-2",children:[e.jsx(ne,{className:"h-4 w-4"}),W?"Generating...":"Create Report"]})]})]}),(!d||d==="0")&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-3",children:g.map(t=>{const n=t.name.split(" ").pop()||t.name;return e.jsxs("label",{className:`flex items-center gap-2 p-3 rounded-lg border cursor-pointer transition-all ${_.includes(t.id)?"bg-primary/10 border-primary":"hover:bg-muted/50 border-border"}`,children:[e.jsx(re,{checked:_.includes(t.id),onCheckedChange:()=>fe(t.id)}),e.jsx("span",{className:"text-xs sm:text-sm font-medium",children:n})]},t.id)})}),_.length>0&&e.jsxs("p",{className:"text-xs sm:text-sm text-muted-foreground",children:[_.length," region(s) selected for report"]})]})]})}),e.jsx(P,{})]}),e.jsx($,{className:"bg-gradient-to-r from-blue-50 to-indigo-50 dark:from-gray-800 dark:to-gray-900 py-6",children:e.jsxs("div",{className:"flex flex-col sm:flex-row items-start sm:items-center justify-between gap-2 sm:gap-6",onClick:()=>{F("");const t=new URLSearchParams({institute_id:S||"",region_id:d||"",fund_head_id:""});k(`/reports/funds/getfunds?${t.toString()}`)},children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-xs sm:text-sm font-medium text-muted-foreground",children:"Total Balance"}),e.jsx("p",{className:"text-2xl sm:text-3xl lg:text-4xl font-bold text-primary mt-2",children:h(O)})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"text-xs sm:text-sm text-muted-foreground",children:"Active Fund Heads"}),e.jsx("p",{className:"text-xl sm:text-2xl lg:text-3xl font-bold text-muted-foreground mt-1",children:w.length})]})]})}),e.jsx(P,{}),w.length>0&&e.jsxs(e.Fragment,{children:[e.jsxs($,{className:"pt-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"text-base sm:text-lg font-semibold",children:"Fund Head Balances"}),e.jsx(v,{onClick:()=>{F("");const t=new URLSearchParams({institute_id:S||"",region_id:d||"",fund_head_id:""});k(`/reports/funds/getfunds?${t.toString()}`)},variant:"outline",size:"sm",children:"Show All"})]}),e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 xl:grid-cols-6 gap-4",children:w.map((t,n)=>{var s,a;return e.jsxs("div",{onClick:()=>{var E,R;const i=((R=(E=t.fund_head)==null?void 0:E.id)==null?void 0:R.toString())||"";F(i);const m=new URLSearchParams({institute_id:S||"",region_id:d||"",fund_head_id:i});k(`/reports/funds/getfunds?${m.toString()}`)},className:"bg-muted/50 dark:bg-gray-800 p-3 sm:p-4 rounded-lg border hover:shadow-md transition-shadow cursor-pointer",children:[e.jsx("p",{className:"text-xs sm:text-sm font-medium text-muted-foreground truncate",children:(s=t.fund_head)!=null&&s.name&&t.fund_head.name!=="N/A"?t.fund_head.name:(a=x.find(i=>i.id.toString()===l))==null?void 0:a.name}),e.jsx("p",{className:"text-base sm:text-lg lg:text-xl font-bold text-green-600 dark:text-green-400 mt-1 sm:mt-2",children:h(t.balance)})]},n)})})]}),e.jsx(P,{})]}),e.jsx($,{className:"p-0",children:e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("div",{className:"max-w-full",children:[y[0].institute_name&&g.length>0?e.jsx(v,{onClick:()=>{F(""),z("");const t=new URLSearchParams({institute_id:S||"",region_id:"",fund_head_id:""});k(`/reports/funds/getfunds?${t.toString()}`)},variant:"outline",size:"sm",children:"Show All"}):"",y.length===0?e.jsx("div",{className:"text-center py-16 text-muted-foreground ",children:"No institute data found. Try adjusting filters."}):e.jsx("div",{className:" overflow-x-auto mx-2 sm:mx-0",children:e.jsxs("table",{className:"w-full border-collapse text-xs sm:text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-primary text-white",children:[e.jsx("th",{className:"sticky left-0 z-20 bg-primary px-3 sm:px-6 py-3 sm:py-4 text-left font-semibold text-xs sm:text-sm",children:y[0].institute_name?"Institute":"Region"}),l&&l!=="0"?e.jsx("th",{className:"px-4 py-4 text-center font-medium whitespace-nowrap",children:(q=x.find(t=>t.id.toString()===l))==null?void 0:q.name}):x.map(t=>e.jsx("th",{className:"px-4 py-4 text-center font-medium whitespace-nowrap",children:t.name},t.id)),l=="0"||l==""?e.jsx("th",{className:"sticky right-0 z-20 bg-primary px-6 py-4 text-right font-bold",children:"Total"}):""]})}),e.jsx("tbody",{className:"divide-y divide-gray-200 dark:divide-gray-700",children:y.map(t=>{const n=!t.institute_name&&t.region_name;return e.jsxs("tr",{className:`hover:bg-muted/50 ${n?"cursor-pointer hover:bg-blue-50 dark:hover:bg-blue-900/20":""}`,onClick:()=>{if(n&&t.region_id){const s=t.region_id.toString();z(s),M(s),A("");const a=new URLSearchParams({institute_id:S||"",region_id:s,fund_head_id:l||""});k(`/reports/funds/getfunds?${a.toString()}`)}},children:[e.jsx("td",{className:"sticky left-0 z-10 bg-background text-wrap px-3 sm:px-6 py-3 sm:py-4 font-medium text-xs sm:text-sm border-r ",children:e.jsx("div",{className:"flex items-center gap-2",children:t.institute_name||e.jsx(e.Fragment,{children:e.jsx("span",{className:"text-blue-600 dark:text-blue-400 font-semibold text-xs sm:text-sm",children:t.region_name.split(" ").pop()||t.region_name})})})}),l&&l!=="0"?e.jsx("td",{className:"px-2 sm:px-4 py-2 sm:py-4 text-right font-medium text-xs sm:text-sm tabular-nums whitespace-nowrap",children:(()=>{const s=x.find(i=>i.id.toString()===l),a=t.fund_heads[(s==null?void 0:s.name)||""]||0;return n?h(a):e.jsx("a",{href:`/reports/fundstrans?institute_id=${t.institute_id}&fund_head_id=${s==null?void 0:s.id}&region_id=${d}`,className:"text-blue-600 hover:underline",target:"_blank",rel:"noopener noreferrer",onClick:i=>i.stopPropagation(),children:h(a)})})()}):e.jsx(e.Fragment,{children:x.map(s=>e.jsx("td",{className:"px-1 sm:px-2 py-2 text-right font-medium text-xs sm:text-sm tabular-nums whitespace-nowrap",children:n?h(t.fund_heads[s.name]):e.jsx("a",{href:`/reports/fundstrans?institute_id=${t.institute_id}&fund_head_id=${s.id}&region_id=${d}`,className:"text-blue-600 hover:underline",target:"_blank",rel:"noopener noreferrer",onClick:a=>a.stopPropagation(),children:h(t.fund_heads[s.name])})},s.id))}),l=="0"||l==""?e.jsx("td",{className:"sticky right-0 z-10 bg-green-50 dark:bg-green-900/30 px-2 sm:px-3 py-2 text-xs sm:text-sm text-right font-bold text-green-700 dark:text-green-400 tabular-nums border-l whitespace-nowrap",children:h(t.total_balance)}):""]},t.institute_id??t.region_id)})}),e.jsx("tfoot",{children:e.jsxs("tr",{className:"bg-gray-100 dark:bg-gray-800 font-bold",children:[e.jsx("td",{className:"sticky left-0 z-10 bg-gray-100 dark:bg-gray-800 px-3 sm:px-6 py-3 sm:py-4 text-xs sm:text-sm",children:"Grand Total"}),l&&l!=="0"?e.jsx("td",{className:"px-2 sm:px-4 py-3 sm:py-4 text-right font-mono text-xs sm:text-sm tabular-nums",children:(()=>{const t=x.find(s=>s.id.toString()===l),n=y.reduce((s,a)=>s+N(a.fund_heads[(t==null?void 0:t.name)||""]||0),0);return h(n)})()}):x.map(t=>{const n=y.reduce((s,a)=>s+N(a.fund_heads[t.name]),0);return e.jsx("td",{className:"px-2 sm:px-4 py-3 sm:py-4 text-right font-mono text-xs sm:text-sm tabular-nums",children:h(n)},t.id)}),l=="0"||l==""?e.jsx("td",{className:"sticky right-0 z-10 bg-emerald-100 dark:bg-emerald-900/50 px-3 sm:px-6 py-3 sm:py-4 text-right font-bold text-emerald-700 dark:text-emerald-400 font-mono tabular-nums border-l text-xs sm:text-sm",children:h(O)}):""]})})]})})]})})})]})})]})}export{ot as default};
