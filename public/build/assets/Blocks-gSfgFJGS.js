var Z=Object.defineProperty;var ee=(o,a,n)=>a in o?Z(o,a,{enumerable:!0,configurable:!0,writable:!0,value:n}):o[a]=n;var M=(o,a,n)=>ee(o,typeof a!="symbol"?a+"":a,n);import{r as i,j as t,L as te}from"./app-MbseafNW.js";import{A as re,S as se}from"./app-layout-C-z4v-3r.js";import{B as j}from"./button-CW94j1ZN.js";import{C as oe,a as ae,b as le,c as ne}from"./card-BjiSh9rK.js";import{I as ie}from"./input-BC1Nmb3o.js";import{t as d}from"./index-CoHqxKof.js";import{l as ce}from"./lodash-DNkjziCb.js";import{E as de,F as me,a as pe,b as he}from"./jspdf.plugin.autotable-6HEOJAba.js";import{C as B}from"./combobox-BNf3CyeV.js";import{I as xe}from"./image-preview-DIn-Hg4P.js";import{f as ue}from"./dateFormatter-Cn65gwBN.js";import"./index-DgnBVFfL.js";import"./createLucideIcon-bprR9CTr.js";import"./index-B1nl_7VU.js";import"./index-BxXlNLtQ.js";import"./index-Db17Cc0h.js";import"./index-CJiVLrhd.js";import"./app-logo-icon-TIuLmAHm.js";import"./circle-x-bPyv4ZZW.js";import"./clsx-B-dksMZM.js";import"./folder-root-8Q9Y8Dkp.js";import"./grip-vertical-BdUKDTBl.js";import"./popover-CP29Bn1i.js";const fe=[{title:"Reports",href:"/reports"},{title:"Blocks",href:"/reports/blocks"}];class ge extends i.Component{constructor(){super(...arguments);M(this,"state",{hasError:!1,error:null})}static getDerivedStateFromError(n){return{hasError:!0,error:n.message}}componentDidCatch(n,h){console.error("ErrorBoundary caught:",n,h),d.error("An error occurred while rendering the component. Please try again or contact support.")}render(){return this.state.hasError?t.jsxs("div",{className:"p-4",children:[t.jsxs("p",{className:"text-red-600",children:["Error: ",this.state.error]}),t.jsx(j,{onClick:()=>window.location.reload(),className:"mt-2",children:"Retry"})]}):this.props.children}}const g=o=>{const a=o!=null&&typeof o.id=="number"&&o.id>0&&typeof o.name=="string"&&o.name.trim()!=="";return a||console.warn("Invalid item detected:",o),a};function He({blocks:o,institutes:a,blocktypes:n,regions:h,filters:w}){var z,P,D;const[N,$]=i.useState(w.search||""),[x,F]=i.useState(w.institute_id||""),[E,O]=i.useState(w.blocktype_id||""),[C,U]=i.useState(w.region_id||""),[S,A]=i.useState(o),[m,I]=i.useState(a||[]),[ye,H]=i.useState([]),V=async e=>{try{const r=new URLSearchParams({region_id:e||""}).toString(),s=await fetch(`/reports/getInstitutes?${r}`);if(!s.ok)throw new Error("Failed to fetch institutes");const l=await s.json();console.log("Fetched institutes:",l),I(l),x&&e!=="0"&&!l.some(y=>y.id.toString()===x)&&F("")}catch(r){console.error("Error fetching institutes:",r),d.error("Failed to load institutes"),I([])}},W=e=>{U(e),V(e)},R=async()=>{try{const e=new URLSearchParams({search:N||"",institute_id:x||"",blocktype_id:E||"",region_id:C||"",all:"true"}),r=await fetch(`/reports/blocks/getBlocks?${e.toString()}`);if(!r.ok)throw new Error("Failed to fetch all blocks for export");const s=await r.json();return H(s),s}catch(e){return console.error("Error fetching all blocks for export:",e),d.error("Failed to fetch blocks for export"),[]}};i.useEffect(()=>{const e={institutes:Array.isArray(m)?m.filter(r=>!g(r)):[],blocktypes:n.filter(r=>!g(r)),regions:h.filter(r=>!g(r))};Object.entries(e).forEach(([r,s])=>{s.length>0&&console.warn(`Invalid ${r}:`,s)})},[a,n,h,m]);const J=async()=>{var e;try{const r=await R(),s=new de.Workbook,l=s.addWorksheet("Blocks"),y=r.length>0&&((e=r[0].institute)!=null&&e.name)?r[0].institute.name:"All Institutes";l.mergeCells("A1:C1");const b=l.getCell("A1");b.value=`Institute: ${y}`,b.font={size:16,bold:!0},b.alignment={horizontal:"center"},l.mergeCells("A2:C2");const p=l.getCell("A2");p.value="Blocks Report",p.font={size:14,bold:!0},p.alignment={horizontal:"center"},l.addRow([]);const v=["Block Name","Block Type","Institute"],u=l.addRow(v);u.font={bold:!0},u.fill={type:"pattern",pattern:"solid",fgColor:{argb:"FF428BCA"}},u.alignment={horizontal:"center"},r.forEach(c=>{var f,k;l.addRow([c.name||"—",((f=c.block_type)==null?void 0:f.name)||"N/A",((k=c.institute)==null?void 0:k.name)||"N/A"])}),l.columns.forEach(c=>{var k;let f=0;(k=c.eachCell)==null||k.call(c,{includeEmpty:!0},L=>{const T=L.value?L.value.toString().length:10;T>f&&(f=T)}),c.width=Math.min(f+2,50)});const Q=await s.xlsx.writeBuffer(),X=new Blob([Q],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"});me.saveAs(X,"Blocks_Report.xlsx"),d.success("Excel exported successfully")}catch(r){console.error("Error exporting to Excel:",r),d.error("Failed to export Excel")}},Y=async()=>{var e;try{const r=await R(),s=new pe,l=r.length>0&&((e=r[0].institute)!=null&&e.name)?r[0].institute.name:"All Institutes";s.setFontSize(16),s.setFont("helvetica","bold"),s.text(`Institute: ${l}`,14,15),s.setFontSize(14),s.text("Blocks Report",14,25);const y=["Block Name","Block Type","Institute"],b=r.map(p=>{var v,u;return[p.name||"—",((v=p.block_type)==null?void 0:v.name)||"N/A",((u=p.institute)==null?void 0:u.name)||"N/A"]});he(s,{head:[y],body:b,startY:35,styles:{fontSize:9,cellPadding:2},headStyles:{fillColor:[66,139,202],textColor:255,fontStyle:"bold"},alternateRowStyles:{fillColor:[240,240,240]}}),s.save("Blocks_Report.pdf"),d.success("PDF exported successfully")}catch(r){console.error("Error exporting to PDF:",r),d.error("Failed to export PDF")}},q=i.useMemo(()=>ce.debounce(()=>{const e=new URLSearchParams({search:N||"",institute_id:x||"",blocktype_id:E||"",region_id:C||""});fetch(`/reports/blocks/getBlocks?${e.toString()}`).then(r=>r.json()).then(r=>{console.log("Fetched filtered blocks:",r),A(r)}).catch(r=>{console.error("Error fetching filtered blocks:",r),d.error("Failed to fetch filtered blocks")})},300),[N,x,E,C]),G=i.useMemo(()=>Array.isArray(m)?m.filter(g):(console.warn("filteredInstitutes is not an array or is null:",m),[]),[m]),K=i.useMemo(()=>n.filter(g),[n]),_=i.useMemo(()=>h.filter(g),[h]);return t.jsx(ge,{children:t.jsxs(re,{breadcrumbs:fe,children:[t.jsx(te,{title:"Blocks Report"}),t.jsx("div",{className:"flex-1 p-2 md:p-2",children:t.jsxs(oe,{className:"w-full",children:[t.jsx(ae,{className:"flex flex-col md:flex-row md:items-center md:justify-between gap-4",children:t.jsx(le,{className:"text-2xl font-bold",children:"Blocks Report"})}),t.jsx(se,{}),t.jsxs(ne,{className:"space-y-6 pt-6",children:[t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4",children:[_.length>0&&t.jsx(B,{entity:"region",value:C,onChange:e=>W(e),options:_.map(e=>({id:e.id.toString(),name:e.name.split(" ").pop()||e.name})),includeAllOption:!0}),t.jsx(B,{entity:"institute",value:x,onChange:e=>F(e),options:G.map(e=>({id:e.id.toString(),name:e.name})),includeAllOption:!0}),t.jsx(B,{entity:"blocktype",value:E,onChange:e=>O(e),options:K.map(e=>({id:e.id.toString(),name:e.name})),includeAllOption:!0}),t.jsx(ie,{type:"text",placeholder:"Search blocks...",value:N,onChange:e=>$(e.target.value)})]}),t.jsxs("div",{className:"flex flex-col md:flex-row gap-2 justify-end",children:[t.jsx(j,{onClick:q,className:"w-full md:w-auto",children:"Apply Filters"}),t.jsx(j,{onClick:Y,className:"w-full md:w-auto",children:"Export PDF"}),t.jsx(j,{onClick:J,className:"w-full md:w-auto",children:"Export Excel"})]}),t.jsxs("div",{className:"space-y-3",children:[t.jsxs("table",{className:"w-full border-collapse border-1 rounded-md overflow-hidden shadow-sm",children:[t.jsx("thead",{children:t.jsxs("tr",{className:"bg-primary dark:bg-gray-800",children:[t.jsx("th",{className:"border p-2 text-left text-sm font-medium text-white dark:text-gray-200",children:"Institute"}),t.jsx("th",{className:"border p-2 text-left text-sm font-medium text-white dark:text-gray-200",children:"Block Name"}),t.jsx("th",{className:"border p-2 text-left text-sm font-medium text-white dark:text-gray-200",children:"Block Type"}),t.jsx("th",{className:"border p-2 text-left text-sm font-medium text-white dark:text-gray-200",children:"Area"}),t.jsx("th",{className:"border p-2 text-left text-sm font-medium text-white dark:text-gray-200",children:"Establish Date"})]})}),t.jsx("tbody",{children:((z=S.data)==null?void 0:z.length)===0?t.jsx("tr",{children:t.jsx("td",{colSpan:5,className:"border p-2 text-center text-sm text-gray-900 dark:text-gray-100",children:"No blocks found."})}):(P=S.data)==null?void 0:P.map(e=>{var r,s;return t.jsxs("tr",{className:"hover:bg-primary/10 dark:hover:bg-gray-700",children:[t.jsx("td",{className:"border p-2 text-left text-gray-900 dark:text-gray-100",children:((r=e.institute)==null?void 0:r.name)||"—"}),t.jsx("td",{className:"border p-2 text-left font-bold dark:text-gray-100",children:t.jsxs("div",{className:"flex flex-row gap-2 align-middle",children:[" ",t.jsx(xe,{dataImg:e.img,size:"h-20 w-20 object-contain"}),"  ",t.jsx("span",{className:"font-bold",children:e.name})]})}),t.jsx("td",{className:"border p-2 text-left text-gray-900 dark:text-gray-100",children:((s=e.block_type)==null?void 0:s.name)||"—"}),t.jsx("td",{className:"border p-2 text-left text-gray-900 dark:text-gray-100",children:e.area||"—"}),t.jsx("td",{className:"border p-2 text-left text-gray-900 dark:text-gray-100",children:ue(e.establish_date||"—")})]},e.id)})})]}),((D=S.links)==null?void 0:D.length)>1&&t.jsx("div",{className:"flex justify-center pt-6 flex-wrap gap-2",children:S.links.map((e,r)=>t.jsx(j,{disabled:!e.url,variant:e.active?"default":"outline",size:"sm",onClick:()=>{e.url&&fetch(e.url).then(s=>s.json()).then(s=>{A(s)}).catch(s=>{console.error("Error:",s)})},className:e.active?"bg-blue-600 hover:bg-blue-700":"",children:t.jsx("span",{dangerouslySetInnerHTML:{__html:e.label}})},r))})]})]})]})})]})})}export{He as default};
