import{r as p,j as e,L as W}from"./app-DHdKMC9z.js";import{A as M,S as y}from"./app-layout-BgzGtaT3.js";import{B as g}from"./button-oJg-GNou.js";import{C as O,a as G,b as J,c as N}from"./card-CLkkFpQS.js";import{S as Y,a as q,b as K,c as Q,d as A}from"./select-DRe8X4lf.js";import{t as E}from"./index-DkWJZa1O.js";import{C as I}from"./combobox-5giIijiu.js";import{E as X,F as Z,a as ee,b as te}from"./jspdf.plugin.autotable-B7IqX8F5.js";import"./index-BGbHz-m5.js";import"./createLucideIcon-Dw6zwASU.js";import"./index-BtZkKH-6.js";import"./index-B-GCn6Xj.js";import"./index-B4CtyJWo.js";import"./index-GcLo9Nrk.js";import"./input-C1k5JNJG.js";import"./app-logo-icon-BgYtderQ.js";import"./circle-x-B5zdh0An.js";import"./folder-root-hwAo6G2P.js";import"./grip-vertical-AsvalJKE.js";import"./index-jfBzwdkk.js";import"./index-aIJepLrt.js";import"./popover-BaDPO8Xu.js";const se=[{title:"Reports",href:"/reports"},{title:"Funds",href:"/reports/funds"}];function we({funds:T=[],fundheads:o=[],regions:k=[],institutes:z=[],balances:L=[],filters:S}){var F;const[m,j]=p.useState(S.institute_id||""),[r,h]=p.useState(S.fund_head_id||""),[u,b]=p.useState(S.region_id||""),[l,P]=p.useState(T),[f,B]=p.useState(L),[U,w]=p.useState(z),c=t=>t==null||t===""?0:typeof t=="number"?t:parseFloat(String(t).replace(/,/g,""))||0,d=t=>{const a=c(t);return a<1e6?`Rs ${a.toLocaleString()}`:`${(a/1e6).toFixed(2)}M`},v=p.useMemo(()=>f.reduce((t,a)=>t+c(a.balance),0),[f]),C=async t=>{if(!t||t==="0"){w([]);return}try{const a=await fetch(`/reports/getInstitutes?region_id=${t}`);if(!a.ok)throw new Error;const s=await a.json();w(s)}catch{E.error("Failed to load institutes")}},H=t=>{b(t),C(t),j("")},x=async t=>{try{const a=new URLSearchParams({institute_id:m||"",region_id:u||"",fund_head_id:r||""}),s=t||`/reports/funds/getfunds?${a.toString()}`,n=await fetch(s);if(!n.ok)throw new Error;const i=await n.json();P(i.funds||i||[]),B(i.balances||[])}catch(a){console.error(a),E.error("Failed to load data")}},D=async()=>{const t=new X.Workbook,a=t.addWorksheet("Funds");a.columns=[{header:"Institute",key:"institute",width:50},...o.map(n=>({header:n.name,key:n.name,width:18})),{header:"Total",key:"total",width:20}],l.forEach(n=>{const i={institute:n.institute_name??(n.region_name.split(" ").pop()||n.region_name)};o.forEach(_=>i[_.name]=c(n.fund_heads[_.name])),i.total=c(n.total_balance),a.addRow(i)});const s=await t.xlsx.writeBuffer();Z.saveAs(new Blob([s]),"Funds_Report.xlsx")},V=()=>{const t=new ee("l","mm","a4");t.text("Institute Wise Fund Balances",14,15);const a=["Institute",...o.map(n=>n.name),"Total"],s=l.map(n=>[n.institute_name??(n.region_name.split(" ").pop()||n.region_name),...o.map(i=>c(n.fund_heads[i.name]).toFixed(2)),c(n.total_balance).toFixed(2)]);te(t,{head:[a],body:s,startY:25}),t.save("Funds_Report.pdf")};return e.jsxs(M,{breadcrumbs:se,children:[e.jsx(W,{title:"Funds Report"}),e.jsx("div",{className:"p-4 lg:p-6 max-w-full",children:e.jsxs(O,{className:"w-full shadow-lg",children:[e.jsx(G,{className:"pb-4",children:e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4",children:[e.jsxs("div",{children:[e.jsx(J,{className:"text-2xl font-bold",children:"Funds Report"}),e.jsx("p",{className:"text-sm text-muted-foreground mt-1",children:"View fund balances by institute / fund head"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(g,{onClick:V,variant:"outline",size:"sm",children:"PDF"}),e.jsx(g,{onClick:D,variant:"outline",size:"sm",children:"Excel"})]})]})}),e.jsx(y,{}),e.jsx(N,{className:"pt-6 pb-4",children:e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4",children:[k.length>0&&e.jsx(I,{entity:"region",value:u,onChange:H,options:k.map(t=>({id:t.id.toString(),name:t.name.split(" ").pop()||t.name})),includeAllOption:!0,placeholder:"Select Region"}),e.jsx(I,{entity:"institute",value:m,onChange:j,options:U.map(t=>({id:t.id.toString(),name:t.name})),includeAllOption:!0,placeholder:"Select Institute"}),e.jsxs(Y,{value:r,onValueChange:h,children:[e.jsx(q,{children:e.jsx(K,{placeholder:"Fund Head"})}),e.jsxs(Q,{children:[e.jsx(A,{value:"0",children:"All Fund Heads"}),o.map(t=>e.jsx(A,{value:t.id.toString(),children:t.name},t.id))]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(g,{onClick:()=>x(),className:"flex-1",children:"Apply"}),e.jsx(g,{variant:"outline",onClick:()=>{b(""),j(""),h(""),x("/reports/funds")},className:"flex-1",children:"Reset"})]})]})}),e.jsx(y,{}),e.jsx(N,{className:"bg-gradient-to-r from-blue-50 to-indigo-50 dark:from-gray-800 dark:to-gray-900 py-6",children:e.jsxs("div",{className:"flex flex-col sm:flex-row items-start sm:items-center justify-between gap-6",onClick:()=>{h("");const t=new URLSearchParams({institute_id:m||"",region_id:u||"",fund_head_id:""});x(`/reports/funds/getfunds?${t.toString()}`)},children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-muted-foreground",children:"Total Balance"}),e.jsx("p",{className:"text-4xl font-bold text-primary mt-2",children:d(v)})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Active Fund Heads"}),e.jsx("p",{className:"text-3xl font-bold text-muted-foreground mt-1",children:f.length})]})]})}),e.jsx(y,{}),f.length>0&&e.jsxs(e.Fragment,{children:[e.jsxs(N,{className:"pt-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold",children:"Fund Head Balances"}),e.jsx(g,{onClick:()=>{h("");const t=new URLSearchParams({institute_id:m||"",region_id:u||"",fund_head_id:""});x(`/reports/funds/getfunds?${t.toString()}`)},variant:"outline",size:"sm",children:"Show All"})]}),e.jsx("div",{className:"grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 xl:grid-cols-6 gap-4",children:f.map((t,a)=>{var s,n;return e.jsxs("div",{onClick:()=>{var R,$;const i=(($=(R=t.fund_head)==null?void 0:R.id)==null?void 0:$.toString())||"";h(i);const _=new URLSearchParams({institute_id:m||"",region_id:u||"",fund_head_id:i});x(`/reports/funds/getfunds?${_.toString()}`)},className:"bg-muted/50 dark:bg-gray-800 p-4 rounded-lg border hover:shadow-md transition-shadow",children:[e.jsx("p",{className:"text-xs font-medium text-muted-foreground truncate",children:(s=t.fund_head)!=null&&s.name&&t.fund_head.name!=="N/A"?t.fund_head.name:(n=o.find(i=>i.id.toString()===r))==null?void 0:n.name}),e.jsx("p",{className:"text-xl font-bold text-green-600 dark:text-green-400 mt-2",children:d(t.balance)})]},a)})})]}),e.jsx(y,{})]}),e.jsx(N,{className:"p-0",children:e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("div",{className:"max-w-[800px] lg:min-w-0",children:[l[0].institute_name&&k.length>0?e.jsx(g,{onClick:()=>{h(""),b("");const t=new URLSearchParams({institute_id:m||"",region_id:"",fund_head_id:""});x(`/reports/funds/getfunds?${t.toString()}`)},variant:"outline",size:"sm",children:"Show All"}):"",l.length===0?e.jsx("div",{className:"text-center py-16 text-muted-foreground",children:"No institute data found. Try adjusting filters."}):e.jsxs("table",{className:"w-full  border-collapse text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-primary text-white",children:[e.jsx("th",{className:"sticky left-0 z-20 bg-primary px-6 py-4 text-left font-semibold",children:l[0].institute_name?"Institute":"Region"}),r&&r!=="0"?e.jsx("th",{className:"px-4 py-4 text-center font-medium whitespace-nowrap",children:(F=o.find(t=>t.id.toString()===r))==null?void 0:F.name}):o.map(t=>e.jsx("th",{className:"px-4 py-4 text-center font-medium whitespace-nowrap",children:t.name},t.id)),r=="0"||r==""?e.jsx("th",{className:"sticky right-0 z-20 bg-primary px-6 py-4 text-right font-bold",children:"Total"}):""]})}),e.jsx("tbody",{className:"divide-y divide-gray-200 dark:divide-gray-700",children:l.map(t=>{const a=!t.institute_name&&t.region_name;return e.jsxs("tr",{className:`hover:bg-muted/50 ${a?"cursor-pointer hover:bg-blue-50 dark:hover:bg-blue-900/20":""}`,onClick:()=>{if(a&&t.region_id){const s=t.region_id.toString();b(s),C(s),j("");const n=new URLSearchParams({institute_id:m||"",region_id:s,fund_head_id:r||""});x(`/reports/funds/getfunds?${n.toString()}`)}},children:[e.jsx("td",{className:"sticky left-0 z-10 bg-background text-wrap px-6 py-4 font-medium text-base border-r  min-w-[200px]",children:e.jsx("div",{className:"flex items-center gap-2",children:t.institute_name||e.jsx(e.Fragment,{children:e.jsx("span",{className:"text-blue-600 dark:text-blue-400 font-semibold text-base   ",children:t.region_name.split(" ").pop()||t.region_name})})})}),r&&r!=="0"?e.jsx("td",{className:"px-4 py-4 text-right font-medium tabular-nums  whitespace-nowrap",children:(()=>{const s=o.find(i=>i.id.toString()===r),n=t.fund_heads[(s==null?void 0:s.name)||""]||0;return a?d(n):e.jsx("a",{href:`/reports/fundstrans?institute_id=${t.institute_id}&fund_head_id=${s==null?void 0:s.id}&region_id=${u}`,className:"text-blue-600 hover:underline",target:"_blank",rel:"noopener noreferrer",onClick:i=>i.stopPropagation(),children:d(n)})})()}):e.jsx(e.Fragment,{children:o.map(s=>e.jsx("td",{className:"px-2 py-2 text-right font-medium tabular-nums whitespace-nowrap",children:a?d(t.fund_heads[s.name]):e.jsx("a",{href:`/reports/fundstrans?institute_id=${t.institute_id}&fund_head_id=${s.id}&region_id=${u}`,className:"text-blue-600 hover:underline",target:"_blank",rel:"noopener noreferrer",onClick:n=>n.stopPropagation(),children:d(t.fund_heads[s.name])})},s.id))}),r=="0"||r==""?e.jsx("td",{className:"sticky right-0 z-10 bg-green-50 dark:bg-green-900/30 px-3 py-2 text-right font-bold text-green-700 dark:text-green-400 tabular-nums border-l whitespace-nowrap",children:d(t.total_balance)}):""]},t.institute_id??t.region_id)})}),e.jsx("tfoot",{children:e.jsxs("tr",{className:"bg-gray-100 dark:bg-gray-800 font-bold",children:[e.jsx("td",{className:"sticky left-0 z-10 bg-gray-100 dark:bg-gray-800 px-6 py-4",children:"Grand Total"}),r&&r!=="0"?e.jsx("td",{className:"px-4 py-4 text-right font-mono tabular-nums",children:(()=>{const t=o.find(s=>s.id.toString()===r),a=l.reduce((s,n)=>s+c(n.fund_heads[(t==null?void 0:t.name)||""]||0),0);return d(a)})()}):o.map(t=>{const a=l.reduce((s,n)=>s+c(n.fund_heads[t.name]),0);return e.jsx("td",{className:"px-4 py-4 text-right font-mono tabular-nums",children:d(a)},t.id)}),r=="0"||r==""?e.jsx("td",{className:"sticky right-0 z-10 bg-emerald-100 dark:bg-emerald-900/50 px-6 py-4 text-right font-bold text-emerald-700 dark:text-emerald-400 font-mono tabular-nums border-l",children:d(v)}):""]})})]})]})})})]})})]})}export{we as default};
