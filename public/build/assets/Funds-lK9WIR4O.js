import{r as j,j as e,L as Fe}from"./app-DimJN_WS.js";import{A as ve,S as P,F as ne}from"./app-layout-DK0DdOkt.js";import{B as F}from"./button-BwXTY4S-.js";import{C as we,a as Re,b as Ce,c as $}from"./card-BKCo--uN.js";import{S as Pe,a as $e,b as Te,c as Ae,d as ae}from"./select-JZoKuH9l.js";import{C as re}from"./checkbox-BtAj3Kp9.js";import{t as T}from"./index-BVSErxBm.js";import{C as ie}from"./combobox-C8enO5_7.js";import{E as ze,F as Ee,a as le,b as D}from"./jspdf.plugin.autotable-Do88dWUL.js";import"./index-DtaU_tud.js";import"./createLucideIcon-BauaUMKI.js";import"./index-Dll_kG58.js";import"./index-DPYtuGH9.js";import"./index-D5HUFt8e.js";import"./index-CLMamIW4.js";import"./input-CdmvllK4.js";import"./app-logo-icon-DYfe2kzh.js";import"./circle-x-BcJA8Xk1.js";import"./folder-root-pkDpAmRA.js";import"./grip-vertical-BEMVS-6X.js";import"./index-DZT4mcNh.js";import"./index-Cg50APP6.js";import"./popover-8JECl8lU.js";const De=[{title:"Reports",href:"/reports"},{title:"Funds",href:"/reports/funds"}];function it({funds:oe=[],fundheads:u=[],regions:g=[],institutes:de=[],balances:ce=[],filters:B}){var J,q;const[S,A]=j.useState(B.institute_id||""),[o,v]=j.useState(B.fund_head_id||""),[d,z]=j.useState(B.region_id||""),[_,me]=j.useState(oe),[w,ue]=j.useState(ce),[pe,G]=j.useState(de),[y,H]=j.useState([]),[W,Y]=j.useState(!1),N=t=>t==null||t===""?0:typeof t=="number"?t:parseFloat(String(t).replace(/,/g,""))||0,h=t=>{const n=N(t);return n<1e6?`${n.toLocaleString()}`:`${(n/1e6).toFixed(2)} Mn`},O=j.useMemo(()=>w.reduce((t,n)=>t+N(n.balance),0),[w]),M=async t=>{if(!t||t==="0"){G([]);return}try{const n=await fetch(`/reports/getInstitutes?region_id=${t}`);if(!n.ok)throw new Error;const s=await n.json();G(s)}catch{T.error("Failed to load institutes")}},xe=t=>{z(t),M(t),A("")},k=async t=>{try{const n=new URLSearchParams({institute_id:S||"",region_id:d||"",fund_head_id:o||""}),s=t||`/reports/funds/getfunds?${n.toString()}`,a=await fetch(s);if(!a.ok)throw new Error;const i=await a.json();me(i.funds||i||[]),ue(i.balances||[])}catch(n){console.error(n),T.error("Failed to load data")}},ge=async()=>{const t=new ze.Workbook,n=t.addWorksheet("Funds");n.columns=[{header:"Institute",key:"institute",width:50},...u.map(a=>({header:a.name,key:a.name,width:18})),{header:"Total",key:"total",width:20}],_.forEach(a=>{const i={institute:a.institute_name??(a.region_name.split(" ").pop()||a.region_name)};u.forEach(m=>i[m.name]=N(a.fund_heads[m.name])),i.total=N(a.total_balance),n.addRow(i)});const s=await t.xlsx.writeBuffer();Ee.saveAs(new Blob([s]),"Funds_Report.xlsx")},he=()=>{const t=new le("l","mm","a4");t.text("Institute Wise Fund Balances",14,15);const n=["Institute",...u.map(a=>a.name),"Total"],s=_.map(a=>[a.institute_name??(a.region_name.split(" ").pop()||a.region_name),...u.map(i=>N(a.fund_heads[i.name]).toFixed(2)),N(a.total_balance).toFixed(2)]);D(t,{head:[n],body:s,startY:25}),t.save("Funds_Report.pdf")},fe=t=>{H(n=>n.includes(t)?n.filter(s=>s!==t):[...n,t])},be=()=>{y.length===g.length?H([]):H(g.map(t=>t.id))},b=t=>t>=1e6?(t/1e6).toFixed(2)+" Mn":t.toLocaleString(),V=async t=>{const n=t||y;if(n.length===0){T.error("Please select at least one region");return}Y(!0);try{const s=new URLSearchParams;n.forEach(r=>s.append("region_ids[]",r.toString()));const a=await fetch(`/reports/funds/regional-pdf-data?${s.toString()}`);if(!a.ok)throw new Error("Failed to fetch data");const i=await a.json();console.log(i);const{fundHeads:m,table2FundHeads:E,table1:R,table2:K,table3:Q,reportDate:X}=i,l=new le("l","mm","a4"),C=l.internal.pageSize.getWidth();let c=15;l.setFontSize(12),l.setFont("helvetica","bold"),l.text("Anx-A",C-20,c,{align:"right"}),l.text(`Present Balance Held With Regional Office as on ${X}`,C/2,c,{align:"center"}),c+=5;const je=["Detail",...m.map(r=>r.name),"Remarks"],Z=R.map(r=>[r.region_name,...m.map(p=>b(r.fund_heads[p.name]||0)),""]),I=["G. Total"];m.forEach(r=>{const p=R.reduce((f,x)=>f+(x.fund_heads[r.name]||0),0);I.push(b(p))}),I.push(""),Z.push(I),D(l,{head:[je],body:Z,startY:c,theme:"grid",styles:{fontSize:9,cellPadding:2},headStyles:{fillColor:[66,66,66],textColor:255},columnStyles:{0:{fontStyle:"bold"}}}),c=l.lastAutoTable.finalY+15,l.setFontSize(12),l.setFont("helvetica","bold"),l.text("Anx-B",C-20,c,{align:"right"}),l.text("Balance Held With Institutions (Still Not deposit to RO)",C/2,c,{align:"center"}),c+=5;const L=E||m,_e=["Detail",...L.map(r=>r.name)],ee=K.map(r=>[r.region_name,...L.map(p=>b(r.fund_heads[p.name]||0))]),te=["G.Total"];L.forEach(r=>{const p=K.reduce((f,x)=>f+(x.fund_heads[r.name]||0),0);te.push(b(p))}),ee.push(te),D(l,{head:[_e],body:ee,startY:c,theme:"grid",styles:{fontSize:9,cellPadding:2},headStyles:{fillColor:[66,66,66],textColor:255},columnStyles:{0:{fontStyle:"bold"}}}),c=l.lastAutoTable.finalY+15,c>l.internal.pageSize.getHeight()-60&&(l.addPage(),c=15),l.setFontSize(12),l.setFont("helvetica","bold"),l.text("Anx-C",C-20,c,{align:"right"}),c+=5;const ye=["Detail",...m.map(r=>r.name),"Exp Approved"],se=Q.map(r=>{const p=m.map(f=>{const x=r.exp_approved[f.name];if(!x||x.total===0)return"";const Ne=b(x.total),Se=b(x.paid),ke=b(x.remaining);return`${f.name}: Rs.${Ne} - Rs.${Se}= Rs.${ke}`}).filter(Boolean);return[r.region_name,...m.map(f=>b(r.fund_heads[f.name]||0)),p.join(`
`)||"-"]}),U=["G.Total"];m.forEach(r=>{const p=Q.reduce((f,x)=>f+(x.fund_heads[r.name]||0),0);U.push(b(p))}),U.push(""),se.push(U),D(l,{head:[ye],body:se,startY:c,theme:"grid",styles:{fontSize:9,cellPadding:2},headStyles:{fillColor:[66,66,66],textColor:255},columnStyles:{0:{fontStyle:"bold"}}}),l.save(`Regional_Fund_Report_${X.replace(/ /g,"_")}.pdf`),T.success("PDF report generated successfully")}catch(s){console.error(s),T.error("Failed to generate PDF report")}finally{Y(!1)}};return e.jsxs(ve,{breadcrumbs:De,children:[e.jsx(Fe,{title:"Funds Report"}),e.jsx("div",{className:"p-4 lg:p-6 max-w-full",children:e.jsxs(we,{className:"w-full shadow-lg",children:[e.jsx(Re,{className:"pb-4",children:e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4",children:[e.jsxs("div",{children:[e.jsx(Ce,{className:"text-2xl font-bold",children:"Funds Report"}),e.jsx("p",{className:"text-sm text-muted-foreground mt-1",children:"View fund balances by institute / fund head"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(F,{onClick:he,variant:"outline",size:"sm",children:"PDF"}),e.jsx(F,{onClick:ge,variant:"outline",size:"sm",children:"Excel"})]})]})}),e.jsx(P,{}),e.jsx($,{className:"pt-6 pb-4",children:e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4",children:[g.length>0&&e.jsx(ie,{entity:"region",value:d,onChange:xe,options:g.map(t=>({id:t.id.toString(),name:t.name.split(" ").pop()||t.name})),includeAllOption:!0,placeholder:"Select Region"}),e.jsx(ie,{entity:"institute",value:S,onChange:A,options:pe.map(t=>({id:t.id.toString(),name:t.name})),includeAllOption:!0,placeholder:"Select Institute"}),e.jsxs(Pe,{value:o,onValueChange:v,children:[e.jsx($e,{children:e.jsx(Te,{placeholder:"Fund Head"})}),e.jsxs(Ae,{children:[e.jsx(ae,{value:"0",children:"All Fund Heads"}),u.map(t=>e.jsx(ae,{value:t.id.toString(),children:t.name},t.id))]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(F,{onClick:()=>k(),className:"flex-1",children:"Apply"}),e.jsx(F,{variant:"outline",onClick:()=>{z(""),A(""),v(""),k("/reports/funds")},className:"flex-1",children:"Reset"})]})]})}),e.jsx(P,{}),g.length>0&&e.jsxs(e.Fragment,{children:[e.jsx($,{className:"pt-6 pb-4",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("h3",{className:"text-lg font-semibold flex items-center gap-2",children:[e.jsx(ne,{className:"h-5 w-5"}),"Generate Regional Fund Report",d&&d!=="0"&&e.jsxs("span",{className:"text-sm font-normal text-muted-foreground",children:["(",((J=g.find(t=>t.id.toString()===d))==null?void 0:J.name.split(" ").pop())||"Selected Region",")"]})]}),e.jsxs("div",{className:"flex items-center gap-4",children:[(!d||d==="0")&&e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[e.jsx(re,{checked:y.length===g.length&&g.length>0,onCheckedChange:be}),e.jsx("span",{className:"text-sm font-medium",children:"Select All"})]}),e.jsxs(F,{onClick:()=>{d&&d!=="0"?V([parseInt(d)]):V()},disabled:(!d||d==="0")&&y.length===0||W,className:"gap-2",children:[e.jsx(ne,{className:"h-4 w-4"}),W?"Generating...":"Create Report"]})]})]}),(!d||d==="0")&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-3",children:g.map(t=>{const n=t.name.split(" ").pop()||t.name;return e.jsxs("label",{className:`flex items-center gap-2 p-3 rounded-lg border cursor-pointer transition-all ${y.includes(t.id)?"bg-primary/10 border-primary":"hover:bg-muted/50 border-border"}`,children:[e.jsx(re,{checked:y.includes(t.id),onCheckedChange:()=>fe(t.id)}),e.jsx("span",{className:"text-sm font-medium",children:n})]},t.id)})}),y.length>0&&e.jsxs("p",{className:"text-sm text-muted-foreground",children:[y.length," region(s) selected for report"]})]})]})}),e.jsx(P,{})]}),e.jsx($,{className:"bg-gradient-to-r from-blue-50 to-indigo-50 dark:from-gray-800 dark:to-gray-900 py-6",children:e.jsxs("div",{className:"flex flex-col sm:flex-row items-start sm:items-center justify-between gap-6",onClick:()=>{v("");const t=new URLSearchParams({institute_id:S||"",region_id:d||"",fund_head_id:""});k(`/reports/funds/getfunds?${t.toString()}`)},children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-muted-foreground",children:"Total Balance"}),e.jsx("p",{className:"text-4xl font-bold text-primary mt-2",children:h(O)})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Active Fund Heads"}),e.jsx("p",{className:"text-3xl font-bold text-muted-foreground mt-1",children:w.length})]})]})}),e.jsx(P,{}),w.length>0&&e.jsxs(e.Fragment,{children:[e.jsxs($,{className:"pt-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold",children:"Fund Head Balances"}),e.jsx(F,{onClick:()=>{v("");const t=new URLSearchParams({institute_id:S||"",region_id:d||"",fund_head_id:""});k(`/reports/funds/getfunds?${t.toString()}`)},variant:"outline",size:"sm",children:"Show All"})]}),e.jsx("div",{className:"grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 xl:grid-cols-6 gap-4",children:w.map((t,n)=>{var s,a;return e.jsxs("div",{onClick:()=>{var E,R;const i=((R=(E=t.fund_head)==null?void 0:E.id)==null?void 0:R.toString())||"";v(i);const m=new URLSearchParams({institute_id:S||"",region_id:d||"",fund_head_id:i});k(`/reports/funds/getfunds?${m.toString()}`)},className:"bg-muted/50 dark:bg-gray-800 p-4 rounded-lg border hover:shadow-md transition-shadow",children:[e.jsx("p",{className:"text-xs font-medium text-muted-foreground lg:text-base text-sm truncate",children:(s=t.fund_head)!=null&&s.name&&t.fund_head.name!=="N/A"?t.fund_head.name:(a=u.find(i=>i.id.toString()===o))==null?void 0:a.name}),e.jsx("p",{className:"text-lg font-bold lg:text-xl text-green-600 dark:text-green-400 mt-2",children:h(t.balance)})]},n)})})]}),e.jsx(P,{})]}),e.jsx($,{className:"p-0",children:e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("div",{className:"max-w-[800px] lg:min-w-0",children:[_[0].institute_name&&g.length>0?e.jsx(F,{onClick:()=>{v(""),z("");const t=new URLSearchParams({institute_id:S||"",region_id:"",fund_head_id:""});k(`/reports/funds/getfunds?${t.toString()}`)},variant:"outline",size:"sm",children:"Show All"}):"",_.length===0?e.jsx("div",{className:"text-center py-16 text-muted-foreground",children:"No institute data found. Try adjusting filters."}):e.jsxs("table",{className:"w-full  border-collapse text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-primary text-white",children:[e.jsx("th",{className:"sticky left-0 z-20 bg-primary px-6 py-4 text-left font-semibold",children:_[0].institute_name?"Institute":"Region"}),o&&o!=="0"?e.jsx("th",{className:"px-4 py-4 text-center font-medium whitespace-nowrap",children:(q=u.find(t=>t.id.toString()===o))==null?void 0:q.name}):u.map(t=>e.jsx("th",{className:"px-4 py-4 text-center font-medium whitespace-nowrap",children:t.name},t.id)),o=="0"||o==""?e.jsx("th",{className:"sticky right-0 z-20 bg-primary px-6 py-4 text-right font-bold",children:"Total"}):""]})}),e.jsx("tbody",{className:"divide-y divide-gray-200 dark:divide-gray-700",children:_.map(t=>{const n=!t.institute_name&&t.region_name;return e.jsxs("tr",{className:`hover:bg-muted/50 ${n?"cursor-pointer hover:bg-blue-50 dark:hover:bg-blue-900/20":""}`,onClick:()=>{if(n&&t.region_id){const s=t.region_id.toString();z(s),M(s),A("");const a=new URLSearchParams({institute_id:S||"",region_id:s,fund_head_id:o||""});k(`/reports/funds/getfunds?${a.toString()}`)}},children:[e.jsx("td",{className:"sticky left-0 z-10 bg-background text-wrap px-6 py-4 font-medium lg:text-base   text-sm border-r  min-w-[200px]",children:e.jsx("div",{className:"flex items-center gap-2",children:t.institute_name||e.jsx(e.Fragment,{children:e.jsx("span",{className:"text-blue-600 dark:text-blue-400 font-semibold lg:text-base text-sm   ",children:t.region_name.split(" ").pop()||t.region_name})})})}),o&&o!=="0"?e.jsx("td",{className:"px-4 py-4 text-right font-medium lg:text-base text-sm tabular-nums  whitespace-nowrap",children:(()=>{const s=u.find(i=>i.id.toString()===o),a=t.fund_heads[(s==null?void 0:s.name)||""]||0;return n?h(a):e.jsx("a",{href:`/reports/fundstrans?institute_id=${t.institute_id}&fund_head_id=${s==null?void 0:s.id}&region_id=${d}`,className:"text-blue-600 hover:underline",target:"_blank",rel:"noopener noreferrer",onClick:i=>i.stopPropagation(),children:h(a)})})()}):e.jsx(e.Fragment,{children:u.map(s=>e.jsx("td",{className:"px-2 py-2 text-right font-medium lg:text-base text-sm tabular-nums whitespace-nowrap",children:n?h(t.fund_heads[s.name]):e.jsx("a",{href:`/reports/fundstrans?institute_id=${t.institute_id}&fund_head_id=${s.id}&region_id=${d}`,className:"text-blue-600 hover:underline",target:"_blank",rel:"noopener noreferrer",onClick:a=>a.stopPropagation(),children:h(t.fund_heads[s.name])})},s.id))}),o=="0"||o==""?e.jsx("td",{className:"sticky right-0 z-10 bg-green-50 dark:bg-green-900/30 px-3 py-2 lg:text-base text-sm text-right font-bold text-green-700 dark:text-green-400 tabular-nums border-l whitespace-nowrap",children:h(t.total_balance)}):""]},t.institute_id??t.region_id)})}),e.jsx("tfoot",{children:e.jsxs("tr",{className:"bg-gray-100 dark:bg-gray-800 font-bold",children:[e.jsx("td",{className:"sticky left-0 z-10 bg-gray-100 dark:bg-gray-800 px-6 py-4",children:"Grand Total"}),o&&o!=="0"?e.jsx("td",{className:"px-4 py-4 text-right font-mono lg:text-base text-sm tabular-nums",children:(()=>{const t=u.find(s=>s.id.toString()===o),n=_.reduce((s,a)=>s+N(a.fund_heads[(t==null?void 0:t.name)||""]||0),0);return h(n)})()}):u.map(t=>{const n=_.reduce((s,a)=>s+N(a.fund_heads[t.name]),0);return e.jsx("td",{className:"px-4 py-4 text-right font-mono lg:text-base text-sm tabular-nums",children:h(n)},t.id)}),o=="0"||o==""?e.jsx("td",{className:"sticky right-0 z-10 bg-emerald-100 dark:bg-emerald-900/50 px-6 py-4 text-right font-bold text-emerald-700 dark:text-emerald-400 font-mono tabular-nums border-l lg:text-base text-sm",children:h(O)}):""]})})]})]})})})]})})]})}export{it as default};
