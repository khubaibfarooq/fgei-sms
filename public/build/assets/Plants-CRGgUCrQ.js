var B=Object.defineProperty;var L=(a,n,s)=>n in a?B(a,n,{enumerable:!0,configurable:!0,writable:!0,value:s}):a[n]=s;var v=(a,n,s)=>L(a,typeof n!="symbol"?n+"":n,s);import{r as l,j as e,L as q}from"./app-B9SLT0V6.js";import{A as z}from"./app-layout-B6PoArKt.js";import{B as x}from"./button-BF5k_P3B.js";import{C as T,a as D,b as M,c as O}from"./card-Bgp0P5xJ.js";import{t as b}from"./index-cVD0HFXe.js";import{l as Q}from"./lodash-C-YYgS6U.js";import{E as $,F as H,a as U,b as V}from"./jspdf.plugin.autotable-DFm2LqM9.js";import{C as A}from"./combobox-4nvf2r-5.js";import"./index-WFzYa8P0.js";import"./createLucideIcon-B8-jA-Y4.js";import"./index-BCgo9dS5.js";import"./index-D1Worn79.js";import"./index-ChP2lZjH.js";import"./index-D0CFV24D.js";import"./input-B78jMLmf.js";import"./app-logo-icon-nbArkSr8.js";import"./circle-x-CcxXG3aJ.js";import"./clsx-B-dksMZM.js";import"./folder-root-DFHtStH4.js";import"./grip-vertical-DsEJvEKj.js";import"./popover-D8goDgz7.js";const W=[{title:"Reports",href:"/reports"},{title:"Plants",href:"/reports/Plants"}];class J extends l.Component{constructor(){super(...arguments);v(this,"state",{hasError:!1,error:null})}static getDerivedStateFromError(s){return{hasError:!0,error:s.message}}componentDidCatch(s,h){console.error("ErrorBoundary caught:",s,h),b.error("An error occurred while rendering the component. Please try again or contact support.")}render(){return this.state.hasError?e.jsxs("div",{className:"p-4",children:[e.jsxs("p",{className:"text-red-600",children:["Error: ",this.state.error]}),e.jsx(x,{onClick:()=>window.location.reload(),className:"mt-2",children:"Retry"})]}):this.props.children}}const f=a=>{const n=a!=null&&typeof a.id=="number"&&a.id>0&&typeof a.name=="string"&&a.name.trim()!=="";return n||console.warn("Invalid item detected:",a),n};function yt({plants:a,institutes:n,regions:s,filters:h}){const[j,Y]=l.useState(h.search||""),[u,g]=l.useState(h.institute_id||""),[y,S]=l.useState(h.region_id||""),[m,w]=l.useState(a),[c,N]=l.useState(n||[]);console.log(s);const C=l.useMemo(()=>Array.isArray(c)?c.filter(f):(console.warn("filteredInstitutes is not an array or is null:",c),[]),[c]),E=l.useMemo(()=>Array.isArray(s)?s.filter(f):(console.warn("regions is not an array or is null:",s),[]),[s]);l.useEffect(()=>{const t={institutes:Array.isArray(c)?c.filter(r=>!f(r)):[],regions:Array.isArray(s)?s.filter(r=>!f(r)):[]};Object.entries(t).forEach(([r,o])=>{o.length>0&&console.warn(`Invalid ${r}:`,o)})},[c,s]);const P=async t=>{try{const r=new URLSearchParams({region_id:t||""}).toString(),o=await fetch(`/reports/getInstitutes?${r}`);if(!o.ok)throw new Error("Failed to fetch institutes");const i=await o.json();console.log("Fetched institutes:",i),N(i),u&&t!=="0"&&!i.some(d=>d.id.toString()===u)&&g("")}catch(r){console.error("Error fetching institutes:",r),b.error("Failed to load institutes"),N([])}},R=t=>{S(t),g(""),P(t)},F=l.useMemo(()=>Q.debounce(()=>{const t=new URLSearchParams({search:j||"",institute_id:u||"",region_id:y||""});fetch(`/reports/plants/getPlants?${t.toString()}`).then(r=>r.json()).then(r=>{console.log("Fetched filtered Plants:",r),w(r)}).catch(r=>{console.error("Error fetching filtered Plants:",r),b.error("Failed to fetch filtered Plants")})},300),[j,u,y]),I=async()=>{const t=new $.Workbook,r=t.addWorksheet("Plants");r.columns=[{header:"Name",key:"name",width:30},{header:"Quantity",key:"qty",width:30},{header:"Institute",key:"institute",width:20},{header:"Region",key:"region",width:20}],m.data.forEach(d=>{var p,k;r.addRow({name:d.name,qty:d.qty,institute:((p=d.institute)==null?void 0:p.name)||"N/A",region:((k=d.region)==null?void 0:k.name)||"N/A"})});const o=await t.xlsx.writeBuffer(),i=new Blob([o],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"});H.saveAs(i,"Plants_Report.xlsx")},_=()=>{const t=new U;t.setFontSize(16),t.text("Plants Report",14,15);const r=["Name","Quantity","Institute","Region"],o=m.data.map(i=>{var d,p;return[i.name,i.qty,((d=i.institute)==null?void 0:d.name)||"N/A",((p=i.region)==null?void 0:p.name)||"N/A"]});V(t,{head:[r],body:o,startY:25,styles:{fontSize:10}}),t.save("plant_Report.pdf")};return e.jsx(J,{children:e.jsxs(z,{breadcrumbs:W,children:[e.jsx(q,{title:"Plants Report"}),e.jsx("div",{className:"flex-1 p-2 md:p-2",children:e.jsxs(T,{children:[e.jsxs(D,{children:[e.jsx(M,{className:"text-xl font-bold",children:"Filters"}),e.jsx("p",{className:"text-muted-foreground text-sm",children:"Refine your plant search"})]}),e.jsxs(O,{className:"space-y-4",children:[e.jsxs("div",{className:"flex flex-row space-y-4",children:[E.length>0&&e.jsx(A,{entity:"region",value:y,onChange:t=>R(t),options:E.map(t=>({id:t.id.toString(),name:t.name.split(" ").pop()||t.name})),includeAllOption:!0}),e.jsx(A,{entity:"institute",value:u,onChange:t=>g(t),options:C.map(t=>({id:t.id.toString(),name:t.name})),includeAllOption:!0}),e.jsxs("div",{className:"flex flex-row space-x-2",children:[e.jsx(x,{onClick:F,className:"w-full md:w-auto",children:"Apply Filters"}),e.jsx(x,{onClick:_,className:"w-full md:w-auto",children:"Export PDF"}),e.jsx(x,{onClick:I,className:"w-full md:w-auto",children:"Export Excel"})]})]}),e.jsxs("table",{className:"w-full border-collapse border-1 rounded-md overflow-hidden shadow-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-primary dark:bg-gray-800 text-center",children:[e.jsx("th",{className:"border p-2 text-sm font-medium text-white dark:text-gray-200",children:"Institute"}),e.jsx("th",{className:"border p-2 text-sm font-medium text-white dark:text-gray-200",children:"Name"}),e.jsx("th",{className:"border p-2 text-sm font-medium text-white dark:text-gray-200",children:"Quantity"})]})}),e.jsx("tbody",{children:m.data.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:4,className:"text-muted-foreground text-center p-4",children:"No Plants found."})}):m.data.map(t=>{var r;return e.jsxs("tr",{className:"hover:bg-primary/10 dark:hover:bg-gray-700 ",children:[e.jsx("td",{className:"border p-2 text-sm md:text-md lg:text-lg border-r-1 font-bold text-gray-900 dark:text-gray-100",children:(r=t.institute)==null?void 0:r.name}),e.jsx("td",{className:"border p-2 text-sm md:text-md lg:text-lg border-r-1 font-bold text-gray-900 dark:text-gray-100",children:t.name}),e.jsx("td",{className:"border p-2 text-sm md:text-md lg:text-lg text-gray-900 dark:text-gray-100",children:t.qty})]},t.id)})})]}),m.links.length>1&&e.jsx("div",{className:"flex justify-center pt-6 flex-wrap gap-2",children:m.links.map((t,r)=>e.jsx(x,{disabled:!t.url,variant:t.active?"default":"outline",size:"sm",onClick:()=>{t.url&&fetch(t.url).then(o=>o.json()).then(o=>{w(o)}).catch(o=>{console.error("Error:",o)})},className:t.active?"bg-blue-600 hover:bg-blue-700":"",children:e.jsx("span",{dangerouslySetInnerHTML:{__html:t.label}})},r))})]})]})})]})})}export{yt as default};
