var Re=Object.defineProperty;var Ie=(l,n,d)=>n in l?Re(l,n,{enumerable:!0,configurable:!0,writable:!0,value:d}):l[n]=d;var pe=(l,n,d)=>Ie(l,typeof n!="symbol"?n+"":n,d);import{r as o,j as t,L as Be}from"./app-DaMpCOaW.js";import{t as c,A as Le,S as ze,B as De}from"./app-layout-DwOJplx5.js";import{B as E}from"./button-DI0eA2eC.js";import{C as ge,a as je,b as ye,c as be}from"./card-DI6x-NLU.js";import{S as V,a as T,b as q,c as O,d as x}from"./select-1nUxm3Bv.js";import{l as Pe}from"./lodash-D_cKEBE0.js";import{E as Me,F as $e,a as Ve,b as Te}from"./jspdf.plugin.autotable-CsPJE3oH.js";import{C as ve}from"./combobox-B--2qwCA.js";import"./index-BqbVY0EQ.js";import"./index-lGnkZazh.js";import"./createLucideIcon-660qNgga.js";import"./index-1A-ArDvk.js";import"./app-logo-icon-eexpgwPh.js";import"./index-dfK1lcCp.js";import"./index-dGtbn8EQ.js";import"./popover-bBUyplgH.js";const qe=[{title:"Reports",href:"/reports"},{title:"Assets",href:"/reports/assets"}];class Oe extends o.Component{constructor(){super(...arguments);pe(this,"state",{hasError:!1,error:null})}static getDerivedStateFromError(d){return{hasError:!0,error:d.message}}componentDidCatch(d,A){console.error("ErrorBoundary caught:",d,A),c.error("An error occurred while rendering the component. Please try again or contact support.")}render(){return this.state.hasError?t.jsxs("div",{className:"p-4",children:[t.jsxs("p",{className:"text-red-600",children:["Error: ",this.state.error]}),t.jsx(E,{onClick:()=>window.location.reload(),className:"mt-2",children:"Retry"})]}):this.props.children}}const a=l=>{const n=l!=null&&typeof l.id=="number"&&l.id>0&&typeof l.name=="string"&&l.name.trim()!=="";return n||console.warn("Invalid item detected:",l),n};function ct({instituteAssets:l,institutes:n,blocks:d,rooms:A,assetCategories:F,assets:Q,regions:_,filters:f}){var he,ue,xe;const[U,Qe]=o.useState(f.search||""),[u,W]=o.useState(f.institute_id||""),[p,J]=o.useState(f.block_id||""),[R,w]=o.useState(f.room_id||""),[g,Ne]=o.useState(f.asset_category_id||""),[I,H]=o.useState(f.asset_id||""),[B,Ae]=o.useState(f.region_id||""),[Y,L]=o.useState(d.filter(a)),[G,y]=o.useState(A.filter(a)),[K,z]=o.useState(Q.filter(a)),[X,Z]=o.useState(!1),[ee,te]=o.useState(!1),[se,re]=o.useState(!1),[D,oe]=o.useState(l),[j,ae]=o.useState(n||[]),[Ue,we]=o.useState([]),Se=async e=>{try{const s=new URLSearchParams({region_id:e||""}).toString(),r=await fetch(`/reports/getInstitutes?${s}`);if(!r.ok)throw new Error("Failed to fetch institutes");const i=await r.json();console.log("Fetched institutes:",i),ae(i),u&&e!=="0"&&!i.some(b=>b.id.toString()===u)&&W("")}catch(s){console.error("Error fetching institutes:",s),c.error("Failed to load institutes"),ae([])}},ke=e=>{Ae(e),Se(e)},le=async()=>{try{const e=new URLSearchParams({search:U||"",institute_id:u||"",block_id:p||"",room_id:R||"",asset_category_id:g||"",asset_id:I||"",region_id:B||"",all:"true"}),s=await fetch(`/reports/assets/institute-assets?${e.toString()}`);if(!s.ok)throw new Error("Failed to fetch all assets for export");const r=await s.json();return we(r),r}catch(e){return console.error("Error fetching all assets for export:",e),c.error("Failed to fetch assets for export"),[]}};o.useEffect(()=>{const e={institutes:Array.isArray(j)?j.filter(s=>!a(s)):[],blocks:d.filter(s=>!a(s)),rooms:A.filter(s=>!a(s)),assetCategories:F.filter(s=>!a(s)),assets:Q.filter(s=>!a(s)),regions:_.filter(s=>!a(s))};Object.entries(e).forEach(([s,r])=>{r.length>0&&console.warn(`Invalid ${s}:`,r)})},[n,d,A,F,Q,_,j]),o.useEffect(()=>{u?(Z(!0),fetch(`/reports/blocks?institute_id=${u}`).then(e=>e.json()).then(e=>{if(console.log("Fetched blocks:",e),Array.isArray(e)){const s=e.filter(a);s.length<e.length&&console.warn("Filtered out invalid blocks:",e.filter(r=>!a(r))),L(s)}else console.warn("Blocks response is not an array:",e),c.error("Invalid blocks data received"),L([])}).catch(e=>{console.error("Error fetching blocks:",e),c.error("Failed to fetch blocks"),L([])}).finally(()=>Z(!1)),J(""),y([]),w("")):(L([]),y([]),w(""))},[u]),o.useEffect(()=>{p?(te(!0),fetch(`/reports/rooms?block_id=${p}`).then(e=>e.json()).then(e=>{if(console.log("Fetched rooms:",e),Array.isArray(e)){const s=e.filter(a);s.length<e.length&&console.warn("Filtered out invalid rooms:",e.filter(r=>!a(r))),y(s)}else console.warn("Rooms response is not an array:",e),c.error("Invalid rooms data received"),y([])}).catch(e=>{console.error("Error fetching rooms:",e),c.error("Failed to fetch rooms"),y([])}).finally(()=>te(!1)),w("")):(y([]),w(""))},[p]),o.useEffect(()=>{g?(re(!0),fetch(`/reports/assets/list?asset_category_id=${g}`).then(e=>e.json()).then(e=>{if(console.log("Fetched assets:",e),Array.isArray(e)){const s=e.filter(a);s.length<e.length&&console.warn("Filtered out invalid assets:",e.filter(r=>!a(r))),z(s)}else console.warn("Assets response is not an array:",e),c.error("Invalid assets data received"),z([])}).catch(e=>{console.error("Error fetching assets:",e),c.error("Failed to fetch assets"),z([])}).finally(()=>re(!1)),H("")):(z([]),H(""))},[g]);const Ce=async()=>{var e;try{const s=await le(),r=new Me.Workbook,i=r.addWorksheet("Assets"),b=s.length>0&&((e=s[0].institute)!=null&&e.name)?s[0].institute.name:"All Institutes";console.log("Institute Name for Excel:",b),i.mergeCells("A1:F1");const S=i.getCell("A1");S.value=`Institute: ${b}`,S.font={size:16,bold:!0},S.alignment={horizontal:"center"},i.mergeCells("A2:F2");const m=i.getCell("A2");m.value="Assets Report",m.font={size:14,bold:!0},m.alignment={horizontal:"center"},i.addRow([]);const P=["Details","Quantity","Block","Room","Category","Asset"],v=i.addRow(P);v.font={bold:!0},v.fill={type:"pattern",pattern:"solid",fgColor:{argb:"FF428BCA"}},v.alignment={horizontal:"center"},s.forEach(h=>{var N,k,C,fe;i.addRow([h.details,h.current_qty,((N=h.block)==null?void 0:N.name)||"N/A",((k=h.room)==null?void 0:k.name)||"N/A",((C=h.assetCategory)==null?void 0:C.name)||"N/A",((fe=h.asset)==null?void 0:fe.name)||"N/A"])}),i.columns.forEach(h=>{if(h.eachCell){let N=0;h.eachCell({includeEmpty:!0},k=>{const C=k.value?k.value.toString().length:5;C>N&&(N=C)}),h.width=Math.min(N+2,15)}});const M=await r.xlsx.writeBuffer(),$=new Blob([M],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"});$e.saveAs($,"Assets_Report.xlsx"),c.success("Excel exported successfully")}catch(s){console.error("Error exporting to Excel:",s),c.error("Failed to export Excel")}},Ee=async()=>{var e;try{const s=await le(),r=new Ve,i=s.length>0&&((e=s[0].institute)!=null&&e.name)?s[0].institute.name:"All Institutes";r.setFontSize(16),r.setFont("helvetica","bold"),r.text(`Institute: ${i}`,14,15),r.setFontSize(14),r.text("Assets Report",14,25);const b=["Details","Qty","Block","Room","Category","Asset"],S=s.map(m=>{var P,v,M,$;return[m.details||"N/A",m.current_qty.toString(),((P=m.block)==null?void 0:P.name)||"N/A",((v=m.room)==null?void 0:v.name)||"N/A",((M=m.assetCategory)==null?void 0:M.name)||"N/A",(($=m.asset)==null?void 0:$.name)||"N/A"]});Te(r,{head:[b],body:S,startY:35,styles:{fontSize:9,cellPadding:2},headStyles:{fillColor:[66,139,202],textColor:255,fontStyle:"bold"},alternateRowStyles:{fillColor:[240,240,240]}}),r.save("Assets_Report.pdf"),c.success("PDF exported successfully")}catch(s){console.error("Error exporting to PDF:",s),c.error("Failed to export PDF")}},Fe=o.useMemo(()=>Pe.debounce(()=>{const e=new URLSearchParams({search:U||"",institute_id:u||"",block_id:p||"",room_id:R||"",asset_category_id:g||"",asset_id:I||"",region_id:B||""});fetch(`/reports/assets/institute-assets?${e.toString()}`).then(s=>s.json()).then(s=>{console.log("Fetched filtered institute assets:",s),oe(s)}).catch(s=>{console.error("Error fetching filtered assets:",s),c.error("Failed to fetch filtered assets")})},300),[U,u,p,R,g,I,B]),_e=o.useMemo(()=>Array.isArray(j)?j.filter(a):(console.warn("filteredInstitutes is not an array or is null:",j),[]),[j]),ne=o.useMemo(()=>Y.filter(a),[Y]),ie=o.useMemo(()=>G.filter(a),[G]),ce=o.useMemo(()=>F.filter(a),[F]),de=o.useMemo(()=>K.filter(a),[K]),me=o.useMemo(()=>_.filter(a),[_]);return t.jsx(Oe,{children:t.jsxs(Le,{breadcrumbs:qe,children:[t.jsx(Be,{title:"Assets Report"}),t.jsx("div",{className:"flex-1 p-2 md:p-2",children:t.jsxs("div",{className:"flex flex-col md:flex-row gap-3",children:[t.jsx("div",{className:"w-full md:w-1/3",children:t.jsxs(ge,{children:[t.jsxs(je,{children:[t.jsx(ye,{className:"text-xl font-bold",children:"Filters"}),t.jsx("p",{className:"text-muted-foreground text-sm",children:"Refine your assets search"})]}),t.jsxs(be,{className:"space-y-4",children:[me.length>0&&t.jsx(ve,{entity:"region",value:B,onChange:e=>ke(e),options:me.map(e=>({id:e.id.toString(),name:e.name})),includeAllOption:!1}),t.jsx(ve,{entity:"institute",value:u,onChange:e=>W(e),options:_e.map(e=>({id:e.id.toString(),name:e.name})),includeAllOption:!0}),t.jsxs(V,{value:p,onValueChange:e=>{J(e)},disabled:X,children:[t.jsx(T,{children:t.jsx(q,{placeholder:"Select Block"})}),t.jsxs(O,{children:[t.jsx(x,{value:"0",children:"All Blocks"}),X?t.jsx("div",{className:"text-muted-foreground text-sm p-2",children:"Loading blocks..."}):ne.length>0?ne.map(e=>t.jsx(x,{value:e.id.toString(),children:e.name},e.id)):t.jsx("div",{className:"text-muted-foreground text-sm p-2",children:"No blocks available"})]})]}),t.jsxs(V,{value:R,onValueChange:e=>{w(e)},disabled:ee,children:[t.jsx(T,{children:t.jsx(q,{placeholder:"Select Room"})}),t.jsxs(O,{children:[t.jsx(x,{value:"0",children:"All Rooms"}),ee?t.jsx("div",{className:"text-muted-foreground text-sm p-2",children:"Loading rooms..."}):ie.length>0?ie.map(e=>t.jsx(x,{value:e.id.toString(),children:e.name},e.id)):t.jsx("div",{className:"text-muted-foreground text-sm p-2",children:"No rooms available"})]})]}),t.jsxs(V,{value:g,onValueChange:e=>{Ne(e)},children:[t.jsx(T,{children:t.jsx(q,{placeholder:"Select Asset Category"})}),t.jsxs(O,{children:[t.jsx(x,{value:"0",children:"All Asset Categories"}),ce.length>0?ce.map(e=>t.jsx(x,{value:e.id.toString(),children:e.name},e.id)):t.jsx("div",{className:"text-muted-foreground text-sm p-2",children:"No asset categories available"})]})]}),t.jsxs(V,{value:I,onValueChange:e=>{H(e)},disabled:se,children:[t.jsx(T,{children:t.jsx(q,{placeholder:"Select Asset"})}),t.jsxs(O,{children:[t.jsx(x,{value:"0",children:"All Assets"}),se?t.jsx("div",{className:"text-muted-foreground text-sm p-2",children:"Loading assets..."}):de.length>0?de.map(e=>t.jsx(x,{value:e.id.toString(),children:e.name},e.id)):t.jsx("div",{className:"text-muted-foreground text-sm p-2",children:"No assets available"})]})]}),t.jsx(E,{onClick:Fe,className:"w-full",children:"Apply Filters"})]})]})}),t.jsx("div",{className:"w-full md:w-2/3",children:t.jsxs(ge,{children:[t.jsxs(je,{className:"pb-3 flex flex-col md:flex-row md:items-center md:justify-between gap-4",children:[t.jsx("div",{children:t.jsx(ye,{className:"text-2xl font-bold",children:"Assets Report"})}),t.jsxs("div",{className:"flex gap-2",children:[t.jsx(E,{onClick:Ee,className:"w-full md:w-auto",children:"Export PDF"}),t.jsx(E,{onClick:Ce,className:"w-full md:w-auto",children:"Export Excel"})]})]}),t.jsx(ze,{}),t.jsxs(be,{className:"pt-6 space-y-6",children:[t.jsxs("table",{className:"w-full border-collapse",children:[t.jsx("thead",{children:t.jsxs("tr",{className:"bg-primary dark:bg-gray-800",children:[t.jsx("th",{className:"border p-2 text-left text-sm font-medium text-white dark:text-gray-200",children:"Asset"}),t.jsx("th",{className:"border p-2 text-left text-sm font-medium text-white dark:text-gray-200",children:"Quantity"}),t.jsx("th",{className:"border p-2 text-left text-sm font-medium text-white dark:text-gray-200",children:"Room"}),t.jsx("th",{className:"border p-2 text-left text-sm font-medium text-white dark:text-gray-200",children:"Description"})]})}),t.jsx("tbody",{children:((he=D.data)==null?void 0:he.length)===0?t.jsx("tr",{children:t.jsx("td",{colSpan:4,className:"border p-2 text-center text-sm text-gray-900 dark:text-gray-100",children:"No assets found."})}):(ue=D.data)==null?void 0:ue.map(e=>{var s,r;return t.jsxs("tr",{className:"hover:bg-gray-50 dark:hover:bg-gray-700",children:[t.jsx("td",{className:"border p-2 text-sm text-gray-900 dark:text-gray-100",children:t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx(De,{className:"h-5 w-5 text-blue-600"}),t.jsx("div",{className:"space-y-1",children:t.jsx("div",{className:"font-medium",children:(s=e.asset)==null?void 0:s.name})})]})}),t.jsx("td",{className:"border p-2 text-sm text-gray-900 dark:text-gray-100",children:e.current_qty}),t.jsx("td",{className:"border p-2 text-sm text-gray-900 dark:text-gray-100",children:((r=e.room)==null?void 0:r.name)||"N/A"}),t.jsx("td",{className:"border p-2 text-sm text-gray-900 dark:text-gray-100",children:e.details||"N/A"})]},e.id)})})]}),((xe=D.links)==null?void 0:xe.length)>1&&t.jsx("div",{className:"flex justify-center pt-6 flex-wrap gap-2",children:D.links.map((e,s)=>t.jsx(E,{disabled:!e.url,variant:e.active?"default":"outline",size:"sm",onClick:()=>{e.url&&fetch(e.url).then(r=>r.json()).then(r=>{oe(r)}).catch(r=>{console.error("Error:",r)})},className:e.active?"bg-blue-600 hover:bg-blue-700":"",children:t.jsx("span",{dangerouslySetInnerHTML:{__html:e.label}})},s))})]})]})})]})})]})})}export{ct as default};
