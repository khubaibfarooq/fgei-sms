var Re=Object.defineProperty;var _e=(a,n,d)=>n in a?Re(a,n,{enumerable:!0,configurable:!0,writable:!0,value:d}):a[n]=d;var pe=(a,n,d)=>_e(a,typeof n!="symbol"?n+"":n,d);import{r as o,j as t,L as Ie}from"./app-CX6Ha1_3.js";import{t as c,A as Be,S as Le,B as ze}from"./app-layout-DCQygxxq.js";import{B as I}from"./button-p2tSS29p.js";import{C as je,a as ye,b as be,c as ve}from"./card-DtT7gmAj.js";import{S as A,a as w,b as S,c as k,d as m}from"./select-KCtJaOJ0.js";import{l as De}from"./lodash-DTBIZEka.js";import{E as Pe,F as Me,a as Ve,b as $e}from"./jspdf.plugin.autotable-DCzoQksb.js";import"./index-DO7KWHTk.js";import"./index-BLuxOCbi.js";import"./createLucideIcon-DKSQ-GId.js";import"./index-Bhr8Mym_.js";import"./app-logo-icon-BOLNiIOz.js";import"./index-Bef7mJkx.js";import"./index-CfZsIyE2.js";const Te=[{title:"Reports",href:"/reports"},{title:"Assets",href:"/reports/assets"}];class qe extends o.Component{constructor(){super(...arguments);pe(this,"state",{hasError:!1,error:null})}static getDerivedStateFromError(d){return{hasError:!0,error:d.message}}componentDidCatch(d,E){console.error("ErrorBoundary caught:",d,E),c.error("An error occurred while rendering the component. Please try again or contact support.")}render(){return this.state.hasError?t.jsxs("div",{className:"p-4",children:[t.jsxs("p",{className:"text-red-600",children:["Error: ",this.state.error]}),t.jsx(I,{onClick:()=>window.location.reload(),className:"mt-2",children:"Retry"})]}):this.props.children}}const l=a=>{const n=a!=null&&typeof a.id=="number"&&a.id>0&&typeof a.name=="string"&&a.name.trim()!=="";return n||console.warn("Invalid item detected:",a),n};function at({instituteAssets:a,institutes:n,blocks:d,rooms:E,assetCategories:B,assets:U,regions:L,filters:f}){var ue,xe,fe;const[H,Qe]=o.useState(f.search||""),[x,O]=o.useState(f.institute_id||""),[g,Y]=o.useState(f.block_id||""),[z,C]=o.useState(f.room_id||""),[p,Ne]=o.useState(f.asset_category_id||""),[D,W]=o.useState(f.asset_id||""),[P,Ae]=o.useState(f.region_id||""),[G,M]=o.useState(d.filter(l)),[K,y]=o.useState(E.filter(l)),[X,V]=o.useState(U.filter(l)),[Z,ee]=o.useState(!1),[te,se]=o.useState(!1),[re,oe]=o.useState(!1),[$,le]=o.useState(a),[j,ae]=o.useState(n||[]),[Ue,we]=o.useState([]),Se=async e=>{try{const s=new URLSearchParams({region_id:e||""}).toString(),r=await fetch(`/reports/getInstitutes?${s}`);if(!r.ok)throw new Error("Failed to fetch institutes");const i=await r.json();console.log("Fetched institutes:",i),ae(i),x&&e!=="0"&&!i.some(b=>b.id.toString()===x)&&O("")}catch(s){console.error("Error fetching institutes:",s),c.error("Failed to load institutes"),ae([])}},ke=e=>{Ae(e),Se(e)},ne=async()=>{try{const e=new URLSearchParams({search:H||"",institute_id:x||"",block_id:g||"",room_id:z||"",asset_category_id:p||"",asset_id:D||"",region_id:P||"",all:"true"}),s=await fetch(`/reports/assets/institute-assets?${e.toString()}`);if(!s.ok)throw new Error("Failed to fetch all assets for export");const r=await s.json();return we(r),r}catch(e){return console.error("Error fetching all assets for export:",e),c.error("Failed to fetch assets for export"),[]}};o.useEffect(()=>{const e={institutes:Array.isArray(j)?j.filter(s=>!l(s)):[],blocks:d.filter(s=>!l(s)),rooms:E.filter(s=>!l(s)),assetCategories:B.filter(s=>!l(s)),assets:U.filter(s=>!l(s)),regions:L.filter(s=>!l(s))};Object.entries(e).forEach(([s,r])=>{r.length>0&&console.warn(`Invalid ${s}:`,r)})},[n,d,E,B,U,L,j]),o.useEffect(()=>{x?(ee(!0),fetch(`/reports/blocks?institute_id=${x}`).then(e=>e.json()).then(e=>{if(console.log("Fetched blocks:",e),Array.isArray(e)){const s=e.filter(l);s.length<e.length&&console.warn("Filtered out invalid blocks:",e.filter(r=>!l(r))),M(s)}else console.warn("Blocks response is not an array:",e),c.error("Invalid blocks data received"),M([])}).catch(e=>{console.error("Error fetching blocks:",e),c.error("Failed to fetch blocks"),M([])}).finally(()=>ee(!1)),Y(""),y([]),C("")):(M([]),y([]),C(""))},[x]),o.useEffect(()=>{g?(se(!0),fetch(`/reports/rooms?block_id=${g}`).then(e=>e.json()).then(e=>{if(console.log("Fetched rooms:",e),Array.isArray(e)){const s=e.filter(l);s.length<e.length&&console.warn("Filtered out invalid rooms:",e.filter(r=>!l(r))),y(s)}else console.warn("Rooms response is not an array:",e),c.error("Invalid rooms data received"),y([])}).catch(e=>{console.error("Error fetching rooms:",e),c.error("Failed to fetch rooms"),y([])}).finally(()=>se(!1)),C("")):(y([]),C(""))},[g]),o.useEffect(()=>{p?(oe(!0),fetch(`/reports/assets/list?asset_category_id=${p}`).then(e=>e.json()).then(e=>{if(console.log("Fetched assets:",e),Array.isArray(e)){const s=e.filter(l);s.length<e.length&&console.warn("Filtered out invalid assets:",e.filter(r=>!l(r))),V(s)}else console.warn("Assets response is not an array:",e),c.error("Invalid assets data received"),V([])}).catch(e=>{console.error("Error fetching assets:",e),c.error("Failed to fetch assets"),V([])}).finally(()=>oe(!1)),W("")):(V([]),W(""))},[p]);const Ee=async()=>{var e;try{const s=await ne(),r=new Pe.Workbook,i=r.addWorksheet("Assets"),b=s.length>0&&((e=s[0].institute)!=null&&e.name)?s[0].institute.name:"All Institutes";console.log("Institute Name for Excel:",b),i.mergeCells("A1:F1");const F=i.getCell("A1");F.value=`Institute: ${b}`,F.font={size:16,bold:!0},F.alignment={horizontal:"center"},i.mergeCells("A2:F2");const h=i.getCell("A2");h.value="Assets Report",h.font={size:14,bold:!0},h.alignment={horizontal:"center"},i.addRow([]);const T=["Details","Quantity","Block","Room","Category","Asset"],v=i.addRow(T);v.font={bold:!0},v.fill={type:"pattern",pattern:"solid",fgColor:{argb:"FF428BCA"}},v.alignment={horizontal:"center"},s.forEach(u=>{var N,R,_,ge;i.addRow([u.details,u.current_qty,((N=u.block)==null?void 0:N.name)||"N/A",((R=u.room)==null?void 0:R.name)||"N/A",((_=u.assetCategory)==null?void 0:_.name)||"N/A",((ge=u.asset)==null?void 0:ge.name)||"N/A"])}),i.columns.forEach(u=>{if(u.eachCell){let N=0;u.eachCell({includeEmpty:!0},R=>{const _=R.value?R.value.toString().length:5;_>N&&(N=_)}),u.width=Math.min(N+2,15)}});const q=await r.xlsx.writeBuffer(),Q=new Blob([q],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"});Me.saveAs(Q,"Assets_Report.xlsx"),c.success("Excel exported successfully")}catch(s){console.error("Error exporting to Excel:",s),c.error("Failed to export Excel")}},Ce=async()=>{var e;try{const s=await ne(),r=new Ve,i=s.length>0&&((e=s[0].institute)!=null&&e.name)?s[0].institute.name:"All Institutes";r.setFontSize(16),r.setFont("helvetica","bold"),r.text(`Institute: ${i}`,14,15),r.setFontSize(14),r.text("Assets Report",14,25);const b=["Details","Qty","Block","Room","Category","Asset"],F=s.map(h=>{var T,v,q,Q;return[h.details||"N/A",h.current_qty.toString(),((T=h.block)==null?void 0:T.name)||"N/A",((v=h.room)==null?void 0:v.name)||"N/A",((q=h.assetCategory)==null?void 0:q.name)||"N/A",((Q=h.asset)==null?void 0:Q.name)||"N/A"]});$e(r,{head:[b],body:F,startY:35,styles:{fontSize:9,cellPadding:2},headStyles:{fillColor:[66,139,202],textColor:255,fontStyle:"bold"},alternateRowStyles:{fillColor:[240,240,240]}}),r.save("Assets_Report.pdf"),c.success("PDF exported successfully")}catch(s){console.error("Error exporting to PDF:",s),c.error("Failed to export PDF")}},Fe=o.useMemo(()=>De.debounce(()=>{const e=new URLSearchParams({search:H||"",institute_id:x||"",block_id:g||"",room_id:z||"",asset_category_id:p||"",asset_id:D||"",region_id:P||""});fetch(`/reports/assets/institute-assets?${e.toString()}`).then(s=>s.json()).then(s=>{console.log("Fetched filtered institute assets:",s),le(s)}).catch(s=>{console.error("Error fetching filtered assets:",s),c.error("Failed to fetch filtered assets")})},300),[H,x,g,z,p,D,P]),ie=o.useMemo(()=>Array.isArray(j)?j.filter(l):(console.warn("filteredInstitutes is not an array or is null:",j),[]),[j]),ce=o.useMemo(()=>G.filter(l),[G]),de=o.useMemo(()=>K.filter(l),[K]),me=o.useMemo(()=>B.filter(l),[B]),he=o.useMemo(()=>X.filter(l),[X]),J=o.useMemo(()=>L.filter(l),[L]);return t.jsx(qe,{children:t.jsxs(Be,{breadcrumbs:Te,children:[t.jsx(Ie,{title:"Assets Report"}),t.jsx("div",{className:"flex-1 p-2 md:p-2",children:t.jsxs("div",{className:"flex flex-col md:flex-row gap-3",children:[t.jsx("div",{className:"w-full md:w-1/3",children:t.jsxs(je,{children:[t.jsxs(ye,{children:[t.jsx(be,{className:"text-xl font-bold",children:"Filters"}),t.jsx("p",{className:"text-muted-foreground text-sm",children:"Refine your assets search"})]}),t.jsxs(ve,{className:"space-y-4",children:[J.length>0&&t.jsxs(A,{value:P,onValueChange:ke,children:[t.jsx(w,{children:t.jsx(S,{placeholder:"Select Region"})}),t.jsxs(k,{children:[t.jsx(m,{value:"0",children:"All Regions"}),J.length>0?J.map(e=>t.jsx(m,{value:e.id.toString(),children:e.name},e.id)):t.jsx("div",{className:"text-muted-foreground text-sm p-2",children:"No regions available"})]})]}),t.jsxs(A,{value:x,onValueChange:e=>{O(e)},children:[t.jsx(w,{children:t.jsx(S,{placeholder:"Select Institute"})}),t.jsxs(k,{children:[t.jsx(m,{value:"0",children:"All Institutes"}),ie.length>0?ie.map(e=>t.jsx(m,{value:e.id.toString(),children:e.name},e.id)):t.jsx("div",{className:"text-muted-foreground text-sm p-2",children:"No institutes available"})]})]}),t.jsxs(A,{value:g,onValueChange:e=>{Y(e)},disabled:Z,children:[t.jsx(w,{children:t.jsx(S,{placeholder:"Select Block"})}),t.jsxs(k,{children:[t.jsx(m,{value:"0",children:"All Blocks"}),Z?t.jsx("div",{className:"text-muted-foreground text-sm p-2",children:"Loading blocks..."}):ce.length>0?ce.map(e=>t.jsx(m,{value:e.id.toString(),children:e.name},e.id)):t.jsx("div",{className:"text-muted-foreground text-sm p-2",children:"No blocks available"})]})]}),t.jsxs(A,{value:z,onValueChange:e=>{C(e)},disabled:te,children:[t.jsx(w,{children:t.jsx(S,{placeholder:"Select Room"})}),t.jsxs(k,{children:[t.jsx(m,{value:"0",children:"All Rooms"}),te?t.jsx("div",{className:"text-muted-foreground text-sm p-2",children:"Loading rooms..."}):de.length>0?de.map(e=>t.jsx(m,{value:e.id.toString(),children:e.name},e.id)):t.jsx("div",{className:"text-muted-foreground text-sm p-2",children:"No rooms available"})]})]}),t.jsxs(A,{value:p,onValueChange:e=>{Ne(e)},children:[t.jsx(w,{children:t.jsx(S,{placeholder:"Select Asset Category"})}),t.jsxs(k,{children:[t.jsx(m,{value:"0",children:"All Asset Categories"}),me.length>0?me.map(e=>t.jsx(m,{value:e.id.toString(),children:e.name},e.id)):t.jsx("div",{className:"text-muted-foreground text-sm p-2",children:"No asset categories available"})]})]}),t.jsxs(A,{value:D,onValueChange:e=>{W(e)},disabled:re,children:[t.jsx(w,{children:t.jsx(S,{placeholder:"Select Asset"})}),t.jsxs(k,{children:[t.jsx(m,{value:"0",children:"All Assets"}),re?t.jsx("div",{className:"text-muted-foreground text-sm p-2",children:"Loading assets..."}):he.length>0?he.map(e=>t.jsx(m,{value:e.id.toString(),children:e.name},e.id)):t.jsx("div",{className:"text-muted-foreground text-sm p-2",children:"No assets available"})]})]}),t.jsx(I,{onClick:Fe,className:"w-full",children:"Apply Filters"})]})]})}),t.jsx("div",{className:"w-full md:w-2/3",children:t.jsxs(je,{children:[t.jsxs(ye,{className:"pb-3 flex flex-col md:flex-row md:items-center md:justify-between gap-4",children:[t.jsx("div",{children:t.jsx(be,{className:"text-2xl font-bold",children:"Assets Report"})}),t.jsxs("div",{className:"flex gap-2",children:[t.jsx(I,{onClick:Ce,className:"w-full md:w-auto",children:"Export PDF"}),t.jsx(I,{onClick:Ee,className:"w-full md:w-auto",children:"Export Excel"})]})]}),t.jsx(Le,{}),t.jsxs(ve,{className:"pt-6 space-y-6",children:[t.jsxs("table",{className:"w-full border-collapse",children:[t.jsx("thead",{children:t.jsxs("tr",{className:"bg-primary dark:bg-gray-800",children:[t.jsx("th",{className:"border p-2 text-left text-sm font-medium text-white dark:text-gray-200",children:"Asset"}),t.jsx("th",{className:"border p-2 text-left text-sm font-medium text-white dark:text-gray-200",children:"Quantity"}),t.jsx("th",{className:"border p-2 text-left text-sm font-medium text-white dark:text-gray-200",children:"Room"}),t.jsx("th",{className:"border p-2 text-left text-sm font-medium text-white dark:text-gray-200",children:"Description"})]})}),t.jsx("tbody",{children:((ue=$.data)==null?void 0:ue.length)===0?t.jsx("tr",{children:t.jsx("td",{colSpan:4,className:"border p-2 text-center text-sm text-gray-900 dark:text-gray-100",children:"No assets found."})}):(xe=$.data)==null?void 0:xe.map(e=>{var s,r;return t.jsxs("tr",{className:"hover:bg-gray-50 dark:hover:bg-gray-700",children:[t.jsx("td",{className:"border p-2 text-sm text-gray-900 dark:text-gray-100",children:t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx(ze,{className:"h-5 w-5 text-blue-600"}),t.jsx("div",{className:"space-y-1",children:t.jsx("div",{className:"font-medium",children:(s=e.asset)==null?void 0:s.name})})]})}),t.jsx("td",{className:"border p-2 text-sm text-gray-900 dark:text-gray-100",children:e.current_qty}),t.jsx("td",{className:"border p-2 text-sm text-gray-900 dark:text-gray-100",children:((r=e.room)==null?void 0:r.name)||"N/A"}),t.jsx("td",{className:"border p-2 text-sm text-gray-900 dark:text-gray-100",children:e.details||"N/A"})]},e.id)})})]}),((fe=$.links)==null?void 0:fe.length)>1&&t.jsx("div",{className:"flex justify-center pt-6 flex-wrap gap-2",children:$.links.map((e,s)=>t.jsx(I,{disabled:!e.url,variant:e.active?"default":"outline",size:"sm",onClick:()=>{e.url&&fetch(e.url).then(r=>r.json()).then(r=>{le(r)}).catch(r=>{console.error("Error:",r)})},className:e.active?"bg-blue-600 hover:bg-blue-700":"",children:t.jsx("span",{dangerouslySetInnerHTML:{__html:e.label}})},s))})]})]})})]})})]})})}export{at as default};
