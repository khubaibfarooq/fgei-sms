var oe=Object.defineProperty;var ae=(o,a,n)=>a in o?oe(o,a,{enumerable:!0,configurable:!0,writable:!0,value:n}):o[a]=n;var M=(o,a,n)=>ae(o,typeof a!="symbol"?a+"":a,n);import{r as i,j as e,L as le}from"./app-CeRn03ZN.js";import{t as d,A as ne,S as ie}from"./app-layout-C_rbwnLT.js";import{B as k}from"./button-CyWu9mW6.js";import{C as $,a as V,b as O,c as U}from"./card-CIREQ4Po.js";import{I as ce}from"./input-CdrZJf1z.js";import{S as de,a as me,b as he,c as xe,d as H}from"./select-BWWVPlsx.js";import{l as pe}from"./lodash-CIKOppIM.js";import{E as ue,F as fe,a as ge,b as ye}from"./jspdf.plugin.autotable-B18Bi6VL.js";import{C as W}from"./combobox-f2j0UR7R.js";import{I as be}from"./image-preview-CQOimEDr.js";import"./index-DYBDZeYe.js";import"./createLucideIcon-DMplht-j.js";import"./index-crS1FDaV.js";import"./app-logo-icon-xNSx-OIy.js";import"./folder-root-DH_I6jPv.js";import"./grip-vertical-BYeYSELo.js";import"./index-CPvuaI2x.js";import"./index-9eVM7Yev.js";import"./popover-DVpmDdZf.js";const je=[{title:"Reports",href:"/reports"},{title:"Blocks",href:"/reports/blocks"}];class ke extends i.Component{constructor(){super(...arguments);M(this,"state",{hasError:!1,error:null})}static getDerivedStateFromError(n){return{hasError:!0,error:n.message}}componentDidCatch(n,x){console.error("ErrorBoundary caught:",n,x),d.error("An error occurred while rendering the component. Please try again or contact support.")}render(){return this.state.hasError?e.jsxs("div",{className:"p-4",children:[e.jsxs("p",{className:"text-red-600",children:["Error: ",this.state.error]}),e.jsx(k,{onClick:()=>window.location.reload(),className:"mt-2",children:"Retry"})]}):this.props.children}}const g=o=>{const a=o!=null&&typeof o.id=="number"&&o.id>0&&typeof o.name=="string"&&o.name.trim()!=="";return a||console.warn("Invalid item detected:",o),a};function Ue({blocks:o,institutes:a,blocktypes:n,regions:x,filters:w}){var z,P,T;const[N,J]=i.useState(w.search||""),[p,B]=i.useState(w.institute_id||""),[S,Y]=i.useState(w.blocktype_id||""),[v,q]=i.useState(w.region_id||""),[E,F]=i.useState(o),[m,A]=i.useState(a||[]),[we,G]=i.useState([]),K=async t=>{try{const r=new URLSearchParams({region_id:t||""}).toString(),s=await fetch(`/reports/getInstitutes?${r}`);if(!s.ok)throw new Error("Failed to fetch institutes");const l=await s.json();console.log("Fetched institutes:",l),A(l),p&&t!=="0"&&!l.some(y=>y.id.toString()===p)&&B("")}catch(r){console.error("Error fetching institutes:",r),d.error("Failed to load institutes"),A([])}},Q=t=>{q(t),K(t)},I=async()=>{try{const t=new URLSearchParams({search:N||"",institute_id:p||"",blocktype_id:S||"",region_id:v||"",all:"true"}),r=await fetch(`/reports/blocks/getBlocks?${t.toString()}`);if(!r.ok)throw new Error("Failed to fetch all blocks for export");const s=await r.json();return G(s),s}catch(t){return console.error("Error fetching all blocks for export:",t),d.error("Failed to fetch blocks for export"),[]}};i.useEffect(()=>{const t={institutes:Array.isArray(m)?m.filter(r=>!g(r)):[],blocktypes:n.filter(r=>!g(r)),regions:x.filter(r=>!g(r))};Object.entries(t).forEach(([r,s])=>{s.length>0&&console.warn(`Invalid ${r}:`,s)})},[a,n,x,m]);const X=async()=>{var t;try{const r=await I(),s=new ue.Workbook,l=s.addWorksheet("Blocks"),y=r.length>0&&((t=r[0].institute)!=null&&t.name)?r[0].institute.name:"All Institutes";l.mergeCells("A1:C1");const b=l.getCell("A1");b.value=`Institute: ${y}`,b.font={size:16,bold:!0},b.alignment={horizontal:"center"},l.mergeCells("A2:C2");const h=l.getCell("A2");h.value="Blocks Report",h.font={size:14,bold:!0},h.alignment={horizontal:"center"},l.addRow([]);const C=["Block Name","Block Type","Institute"],u=l.addRow(C);u.font={bold:!0},u.fill={type:"pattern",pattern:"solid",fgColor:{argb:"FF428BCA"}},u.alignment={horizontal:"center"},r.forEach(c=>{var f,j;l.addRow([c.name||"—",((f=c.block_type)==null?void 0:f.name)||"N/A",((j=c.institute)==null?void 0:j.name)||"N/A"])}),l.columns.forEach(c=>{var j;let f=0;(j=c.eachCell)==null||j.call(c,{includeEmpty:!0},D=>{const L=D.value?D.value.toString().length:10;L>f&&(f=L)}),c.width=Math.min(f+2,50)});const re=await s.xlsx.writeBuffer(),se=new Blob([re],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"});fe.saveAs(se,"Blocks_Report.xlsx"),d.success("Excel exported successfully")}catch(r){console.error("Error exporting to Excel:",r),d.error("Failed to export Excel")}},Z=async()=>{var t;try{const r=await I(),s=new ge,l=r.length>0&&((t=r[0].institute)!=null&&t.name)?r[0].institute.name:"All Institutes";s.setFontSize(16),s.setFont("helvetica","bold"),s.text(`Institute: ${l}`,14,15),s.setFontSize(14),s.text("Blocks Report",14,25);const y=["Block Name","Block Type","Institute"],b=r.map(h=>{var C,u;return[h.name||"—",((C=h.block_type)==null?void 0:C.name)||"N/A",((u=h.institute)==null?void 0:u.name)||"N/A"]});ye(s,{head:[y],body:b,startY:35,styles:{fontSize:9,cellPadding:2},headStyles:{fillColor:[66,139,202],textColor:255,fontStyle:"bold"},alternateRowStyles:{fillColor:[240,240,240]}}),s.save("Blocks_Report.pdf"),d.success("PDF exported successfully")}catch(r){console.error("Error exporting to PDF:",r),d.error("Failed to export PDF")}},ee=i.useMemo(()=>pe.debounce(()=>{const t=new URLSearchParams({search:N||"",institute_id:p||"",blocktype_id:S||"",region_id:v||""});fetch(`/reports/blocks/getBlocks?${t.toString()}`).then(r=>r.json()).then(r=>{console.log("Fetched filtered blocks:",r),F(r)}).catch(r=>{console.error("Error fetching filtered blocks:",r),d.error("Failed to fetch filtered blocks")})},300),[N,p,S,v]),te=i.useMemo(()=>Array.isArray(m)?m.filter(g):(console.warn("filteredInstitutes is not an array or is null:",m),[]),[m]),R=i.useMemo(()=>n.filter(g),[n]),_=i.useMemo(()=>x.filter(g),[x]);return e.jsx(ke,{children:e.jsxs(ne,{breadcrumbs:je,children:[e.jsx(le,{title:"Blocks Report"}),e.jsx("div",{className:"flex-1 p-2 md:p-2",children:e.jsxs("div",{className:"flex flex-col md:flex-row gap-3",children:[e.jsx("div",{className:"w-full md:w-1/3",children:e.jsxs($,{children:[e.jsxs(V,{children:[e.jsx(O,{className:"text-xl font-bold",children:"Filters"}),e.jsx("p",{className:"text-muted-foreground text-sm",children:"Refine your blocks search"})]}),e.jsxs(U,{className:"space-y-4",children:[_.length>0&&e.jsx(W,{entity:"region",value:v,onChange:t=>Q(t),options:_.map(t=>({id:t.id.toString(),name:t.name.split(" ").pop()||t.name})),includeAllOption:!0}),e.jsx(W,{entity:"institute",value:p,onChange:t=>B(t),options:te.map(t=>({id:t.id.toString(),name:t.name})),includeAllOption:!0}),e.jsxs(de,{value:S,onValueChange:t=>{Y(t)},children:[e.jsx(me,{children:e.jsx(he,{placeholder:"Select Block Type"})}),e.jsxs(xe,{children:[e.jsx(H,{value:"0",children:"All Block Types"}),R.length>0?R.map(t=>e.jsx(H,{value:t.id.toString(),children:t.name},t.id)):e.jsx("div",{className:"text-muted-foreground text-sm p-2",children:"No block types available"})]})]}),e.jsx(ce,{type:"text",placeholder:"Search blocks...",value:N,onChange:t=>J(t.target.value)}),e.jsx(k,{onClick:ee,className:"w-full",children:"Apply Filters"})]})]})}),e.jsx("div",{className:"w-full md:w-2/3",children:e.jsxs($,{children:[e.jsxs(V,{className:"pb-3 flex flex-col md:flex-row md:items-center md:justify-between gap-4",children:[e.jsx("div",{children:e.jsx(O,{className:"text-2xl font-bold",children:"Blocks Report"})}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(k,{onClick:Z,className:"w-full md:w-auto",children:"Export PDF"}),e.jsx(k,{onClick:X,className:"w-full md:w-auto",children:"Export Excel"})]})]}),e.jsx(ie,{}),e.jsxs(U,{className:"pt-6 space-y-6",children:[e.jsxs("table",{className:"w-full border-collapse border-1 rounded-md overflow-hidden shadow-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-primary dark:bg-gray-800",children:[e.jsx("th",{className:"border p-2 text-left text-sm font-medium text-white dark:text-gray-200",children:"Block Name"}),e.jsx("th",{className:"border p-2 text-left text-sm font-medium text-white dark:text-gray-200",children:"Block Type"}),e.jsx("th",{className:"border p-2 text-left text-sm font-medium text-white dark:text-gray-200",children:"Area"}),e.jsx("th",{className:"border p-2 text-left text-sm font-medium text-white dark:text-gray-200",children:"Establish Date"}),e.jsx("th",{className:"border p-2 text-left text-sm font-medium text-white dark:text-gray-200",children:"Institute"})]})}),e.jsx("tbody",{children:((z=E.data)==null?void 0:z.length)===0?e.jsx("tr",{children:e.jsx("td",{colSpan:3,className:"border p-2 text-center text-sm text-gray-900 dark:text-gray-100",children:"No blocks found."})}):(P=E.data)==null?void 0:P.map(t=>{var r,s;return e.jsxs("tr",{className:"hover:bg-primary/10 dark:hover:bg-gray-700",children:[e.jsx("td",{className:"border p-2 text-left font-bold dark:text-gray-100",children:e.jsxs("div",{className:"flex flex-column gap-2 align-middle",children:[" ",e.jsx(be,{dataImg:t.img,size:"h-20"}),"  ",e.jsx("span",{className:"font-bold",children:t.name})]})}),e.jsx("td",{className:"border p-2 text-left text-gray-900 dark:text-gray-100",children:((r=t.block_type)==null?void 0:r.name)||"—"}),e.jsx("td",{className:"border p-2 text-left text-gray-900 dark:text-gray-100",children:t.area||"—"}),e.jsx("td",{className:"border p-2 text-left text-gray-900 dark:text-gray-100",children:t.establish_date||"—"}),e.jsx("td",{className:"border p-2 text-left text-gray-900 dark:text-gray-100",children:((s=t.institute)==null?void 0:s.name)||"—"})]},t.id)})})]}),((T=E.links)==null?void 0:T.length)>1&&e.jsx("div",{className:"flex justify-center pt-6 flex-wrap gap-2",children:E.links.map((t,r)=>e.jsx(k,{disabled:!t.url,variant:t.active?"default":"outline",size:"sm",onClick:()=>{t.url&&fetch(t.url).then(s=>s.json()).then(s=>{F(s)}).catch(s=>{console.error("Error:",s)})},className:t.active?"bg-blue-600 hover:bg-blue-700":"",children:e.jsx("span",{dangerouslySetInnerHTML:{__html:t.label}})},r))})]})]})})]})})]})})}export{Ue as default};
