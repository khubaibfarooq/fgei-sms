import{r as i,j as s,L as ce,S as me}from"./app-B1XCA1AV.js";import{A as ue,P as xe,S as ge,T as he}from"./app-layout-DS1pSSx3.js";import{B as $}from"./button-CPIVRm9s.js";import{C as pe,a as be,b as fe,c as ye}from"./card-DawCNtY9.js";import{t as m}from"./index-DPp6nZLO.js";import"./index-B8BI7eIA.js";import"./createLucideIcon-CXTYayE4.js";import"./index-44PmlVrv.js";import"./index-CkAWOamQ.js";import"./index-CQTxrNbM.js";import"./index-Dx_Rpip4.js";import"./input-CltFcp8o.js";import"./app-logo-icon-B2LmKTd7.js";import"./circle-x-oDOpOOzZ.js";import"./folder-root-CMEqMJ-W.js";import"./grip-vertical-CU5y3Coh.js";const je=[{title:"Asset Transactions",href:"/asset-transactions"}],J=u=>{const k=u!=null&&typeof u.id=="number"&&u.id>0&&typeof u.name=="string"&&u.name.trim()!=="";return k||console.warn("Invalid item detected:",u),k};function Pe({fundHeads:u=[],assetCategories:k=[],assets:W=[],blocks:X=[],types:p=[]}){const[P,E]=i.useState(null),[c,H]=i.useState(""),[b,C]=i.useState(""),[S,K]=i.useState(""),[l,N]=i.useState([]),[F,w]=i.useState(W.filter(J).reduce((e,t)=>{const r=t.asset_category_id.toString();return e[r]=[...e[r]||[],t],e},{})),[L,A]=i.useState({}),[Y,M]=i.useState({});i.useMemo(()=>{const e={};return l.forEach(t=>{if(t.fundHeadId&&t.amount&&t.isValid){const r=parseFloat(t.amount)||0;e[t.fundHeadId]=(e[t.fundHeadId]||0)+r}}),e},[l]);const v=i.useMemo(()=>{const e=l.filter(d=>d.isValid).length,t=l.reduce((d,n)=>{if(!n.isValid)return d;const a=parseInt(n.purchaseQty)||0;return d+a},0),r=l.reduce((d,n)=>{if(!n.isValid)return d;const a=parseFloat(n.amount)||0;return d+a},0);return{totalItems:e,totalPurchaseQty:t,totalAmount:r}},[l]),R=i.useMemo(()=>l.length>0&&l.every(e=>e.isValid),[l]),x=i.useMemo(()=>{const e=b||c;return e&&p.find(t=>t.id.toString()===e)||null},[c,b,p]),Z=i.useMemo(()=>c?p.some(e=>e.parent_id&&e.parent_id.toString()===c):!1,[c,p]),T=(x==null?void 0:x.isblock)||!1,y=(x==null?void 0:x.isroom)||!1,Q=(x==null?void 0:x.isasset)||!1,q=()=>{if(Z&&!b){m.error("Please select a sub type before adding rows");return}if(!c){m.error("Please select a transaction type first");return}const e={id:Date.now(),fundHeadId:"",balance:0,blockId:"",roomId:"",assetCategoryId:"",assetId:"",currentQty:0,purchaseQty:"",amount:"",error:"",isValid:!1};N([...l,e])},ee=e=>{N(l.filter(t=>t.id!==e)),m.success("Row removed")},te=(e,t)=>{if(!t){o(e,"balance",0);return}fetch(`/asset-trans/getbalance?id=${t}`).then(r=>r.json()).then(r=>{const d=r.balance||0;M(n=>({...n,[t]:d})),o(e,"balance",d)}).catch(r=>{console.error("Error fetching balance:",r),m.error("Failed to fetch balance"),o(e,"balance",0)})},se=(e,t)=>{if(!t){o(e,"roomId","");return}if(L[t]){o(e,"roomId","");return}fetch(`/asset-trans/getrooms?block_id=${t}`).then(r=>r.json()).then(r=>{const d=(r??[]).filter(n=>n.id&&n.name);console.log("Fetched rooms for block",t,d),A(n=>({...n,[t]:d})),o(e,"roomId","")}).catch(r=>{console.error("Error fetching rooms:",r),m.error("Failed to load rooms"),A(d=>({...d,[t]:[]}))})},re=e=>{requestAnimationFrame(()=>{const t=document.querySelector(`tr[data-row-id="${e}"] select[name="roomId"]`);t&&(t.focus(),t.classList.add("border-red-500","ring-2","ring-red-500"),setTimeout(()=>{t.classList.remove("border-red-500","ring-2","ring-red-500")},2e3))})},ae=(e,t)=>{if(!t){o(e,"assetId",""),o(e,"currentQty",0);return}if(F[t]){o(e,"assetId",""),o(e,"currentQty",0);return}const r=l.find(a=>a.id===e),d=(r==null?void 0:r.roomId)??"";if(!d){m.error("Please select a Room before choosing an Asset Category."),re(e);return}const n=new URLSearchParams({id:t,room_id:d});fetch(`/asset-trans/getassets?${n.toString()}`).then(a=>a.json()).then(a=>{const j=(a.assets??[]).filter(J);w(V=>({...V,[t]:j})),o(e,"assetId",""),o(e,"currentQty",0)}).catch(a=>{console.error("Error fetching assets:",a),m.error("Failed to load assets"),w(j=>({...j,[t]:[]}))})},o=(e,t,r)=>{N(d=>d.map(n=>{var U;if(n.id!==e)return n;const a={...n,[t]:r,error:""};if((t==="blockId"||t==="roomId")&&(a.assetCategoryId="",a.assetId="",a.currentQty=0),t==="blockId"&&r!==n.blockId&&(se(e,r),a.roomId=""),t==="fundHeadId"&&r!==n.fundHeadId&&te(e,r),t==="assetCategoryId"&&(ae(e,r),a.assetId="",a.currentQty=0),t==="assetId"&&r){const h=(F[n.assetCategoryId]||[]).find(_=>_.id.toString()===r);h&&(a.currentQty=h.current_qty??0)}if(t==="amount"||t==="fundHeadId"){const I=a.amount,h=a.fundHeadId,_=parseFloat(I)||0,z=Math.round(_*100);if(a.isValid=!0,a.error="",h&&z>0){const ie=Y[h]||0,O=Math.round(ie*100),G=l.filter(f=>f.id!==n.id&&f.fundHeadId===h&&f.isValid).reduce((f,B)=>{const D=parseFloat(B.amount)||0;return f+Math.round(D*100)},0)+z;if(G>O){const B=((G-O)/100).toFixed(2);a.error=`Exceeds by Rs ${parseFloat(B).toLocaleString()}`,a.isValid=!1,(U=u.find(D=>D.id.toString()===h))!=null&&U.name}}I&&!/^\d+(\.\d{1,2})?$/.test(I)&&(a.error="Max 2 decimal places",a.isValid=!1)}const j=!T||!!a.blockId,V=!y||!!a.roomId,le=!Q||!!a.assetCategoryId&&!!a.assetId&&parseInt(a.purchaseQty)>0;return a.isValid=!!(a.fundHeadId&&j&&V&&le&&parseFloat(a.amount)>0&&!a.error),a}))},g=(e,t)=>{e.key==="Enter"&&e.shiftKey&&(e.preventDefault(),q())},ne=e=>e?F[e]||[]:[],de=e=>e?L[e]||[]:[],oe=()=>{if(!R)return m.error("Fix errors");const e=new FormData;if(e.append("total_amount",v.totalAmount.toFixed(2)),P&&e.append("bill_img",P),c==null||c=="")return m.error("Please select Transaction Type");e.append("type",c),b&&e.append("sub_type",b),S&&e.append("description",S),l.forEach((t,r)=>{e.append(`items[${r}][fund_head_id]`,t.fundHeadId),e.append(`items[${r}][block_id]`,t.blockId),e.append(`items[${r}][room_id]`,t.roomId),e.append(`items[${r}][asset_id]`,t.assetId),e.append(`items[${r}][purchase_qty]`,t.purchaseQty),e.append(`items[${r}][amount]`,t.amount)}),me.post("/asset-transactions",e,{forceFormData:!0,onSuccess:()=>{N([]),E(null),H(""),C(""),K(""),M({}),A({}),w({}),m.success("Transaction created successfully!")},onError:t=>{console.error("Validation errors:",t),m.error("Please fix the highlighted errors.")}})};return s.jsxs(ue,{breadcrumbs:je,children:[s.jsx(ce,{title:"Create Asset Transaction"}),s.jsx("div",{className:"flex-1 p-3",children:s.jsxs(pe,{children:[s.jsx(be,{className:"pb-3",children:s.jsxs("div",{className:"flex justify-between items-center",children:[s.jsx(fe,{children:"Create Asset Transaction"}),s.jsxs($,{onClick:q,children:[s.jsx(xe,{className:"w-4 h-4 mr-2"}),"New Row"]})]})}),s.jsx(ge,{}),s.jsxs(ye,{className:"py-6",children:[s.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6 mb-6",children:[s.jsxs("div",{children:[s.jsxs("label",{className:"block text-sm font-medium mb-2",children:["Transaction Type ",s.jsx("span",{className:"text-red-500",children:"*"})]}),s.jsxs("select",{value:c,onChange:e=>{H(e.target.value),C("")},className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 text-sm dark:bg-gray-800 dark:border-gray-600 dark:text-white",required:!0,children:[s.jsx("option",{value:"",children:"Select Type"}),p.filter(e=>!e.parent_id).map(e=>s.jsx("option",{value:e.id,children:e.name},e.id))]})]}),s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-medium mb-2",children:"Transaction Sub Type"}),s.jsxs("select",{value:b,onChange:e=>C(e.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 text-sm dark:bg-gray-800 dark:border-gray-600 dark:text-white disabled:opacity-50",disabled:!c,children:[s.jsx("option",{value:"",children:"Select Sub Type (Optional)"}),p.filter(e=>e.parent_id&&e.parent_id.toString()===c).map(e=>s.jsx("option",{value:e.id,children:e.name},e.id))]})]})]}),s.jsxs("div",{className:"mb-6",children:[s.jsx("label",{className:"block text-sm font-medium mb-2",children:"Description"}),s.jsx("textarea",{value:S,onChange:e=>K(e.target.value),placeholder:"Enter transaction description (optional)",rows:3,className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 text-sm dark:bg-gray-800 dark:border-gray-600 dark:text-white"})]}),s.jsxs("div",{className:"mb-6",children:[s.jsx("label",{className:"block text-sm font-medium mb-2",children:"Bill Image"}),s.jsx("input",{type:"file",accept:"image/*",onChange:e=>{var t;return E(((t=e.target.files)==null?void 0:t[0])??null)},className:"file-input"})]}),s.jsx("div",{className:"overflow-x-auto border rounded-lg",children:s.jsxs("table",{className:"w-full border-collapse",children:[s.jsx("thead",{children:s.jsxs("tr",{className:"bg-[#0b431b] dark:bg-gray-800",children:[s.jsx("th",{className:"border p-2 text-left text-sm font-medium text-white dark:text-gray-200 w-[150px]",children:"Fund Head"}),s.jsx("th",{className:"border p-2 text-left text-sm font-medium text-white dark:text-gray-200 w-[100px]",children:"Balance"}),T&&s.jsx("th",{className:"border p-2 text-left text-sm font-medium text-white dark:text-gray-200 w-[120px]",children:"Block"}),y&&s.jsx("th",{className:"border p-2 text-left text-sm font-medium text-white dark:text-gray-200 w-[120px]",children:"Room"}),Q&&s.jsxs(s.Fragment,{children:[s.jsx("th",{className:"border p-2 text-left text-sm font-medium text-white dark:text-gray-200 w-[140px]",children:"Asset Category"}),s.jsx("th",{className:"border p-2 text-left text-sm font-medium text-white dark:text-gray-200 w-[160px]",children:"Asset"}),s.jsx("th",{className:"border p-2 text-left text-sm font-medium text-white dark:text-gray-200 w-[90px]",children:"Current Qty"}),s.jsx("th",{className:"border p-2 text-left text-sm font-medium text-white dark:text-gray-200 w-[100px]",children:"Purchase Qty"})]}),s.jsx("th",{className:"border p-2 text-left text-sm font-medium text-white dark:text-gray-200 w-[110px]",children:"Amount"}),s.jsx("th",{className:"border p-2 text-center text-sm font-medium text-white dark:text-gray-200 w-[70px]",children:"Action"})]})}),s.jsx("tbody",{children:l.length===0?s.jsx("tr",{children:s.jsx("td",{colSpan:20,className:"border p-12 text-center text-gray-500 dark:text-gray-400",children:'No transactions added. Click "New Row" to start.'})}):l.map(e=>s.jsxs("tr",{className:"hover:bg-gray-50 dark:hover:bg-gray-700",children:[s.jsx("td",{className:"border p-2",children:s.jsxs("select",{value:e.fundHeadId,onChange:t=>o(e.id,"fundHeadId",t.target.value),onKeyDown:t=>g(t,e.id),className:"w-full px-2 py-1.5 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 text-sm dark:bg-gray-800 dark:border-gray-600 dark:text-white",children:[s.jsx("option",{value:"",children:"Select Fund"}),u.map(t=>s.jsx("option",{value:t.id,children:t.name},t.id))]})}),s.jsx("td",{className:"border p-2",children:s.jsx("input",{type:"text",value:e.balance>0?`Rs ${e.balance.toLocaleString()}`:"-",disabled:!0,className:"w-full px-2 py-1.5 border border-gray-300 rounded-md bg-gray-100 text-gray-700 text-sm dark:bg-gray-700 dark:border-gray-600 dark:text-gray-300"})}),T&&s.jsx("td",{className:"border p-2",children:s.jsxs("select",{value:e.blockId,onChange:t=>o(e.id,"blockId",t.target.value),onKeyDown:t=>g(t,e.id),className:"w-full px-2 py-1.5 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 text-sm dark:bg-gray-800 dark:border-gray-600 dark:text-white",children:[s.jsx("option",{value:"",children:"Select Block"}),X.map(t=>s.jsx("option",{value:t.id,children:t.name},t.id))]})}),y&&s.jsx("td",{className:"border p-2",children:s.jsxs("select",{value:e.roomId,onChange:t=>o(e.id,"roomId",t.target.value),onKeyDown:t=>g(t,e.id),className:"w-full px-2 py-1.5 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 text-sm dark:bg-gray-800 dark:border-gray-600 dark:text-white disabled:opacity-50",disabled:!e.blockId,children:[s.jsx("option",{value:"",children:"Select Room"}),de(e.blockId).map(t=>s.jsx("option",{value:t.id,children:t.name},t.id))]})}),Q&&s.jsxs(s.Fragment,{children:[s.jsx("td",{className:"border p-2",children:s.jsxs("select",{value:e.assetCategoryId,onChange:t=>o(e.id,"assetCategoryId",t.target.value),onKeyDown:t=>g(t,e.id),disabled:y&&!e.roomId,className:`w-full px-2 py-1.5 border rounded-md focus:outline-none focus:ring-2 text-sm dark:bg-gray-800 dark:border-gray-600 dark:text-white disabled:opacity-50 disabled:cursor-not-allowed ${y&&!e.roomId?"border-gray-300":"border-gray-300 focus:ring-green-500"}`,children:[s.jsx("option",{value:"",children:"Select Category"}),k.map(t=>s.jsx("option",{value:t.id,children:t.name},t.id))]})}),s.jsx("td",{className:"border p-2",children:s.jsxs("select",{value:e.assetId,onChange:t=>o(e.id,"assetId",t.target.value),onKeyDown:t=>g(t,e.id),className:"w-full px-2 py-1.5 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 text-sm dark:bg-gray-800 dark:border-gray-600 dark:text-white disabled:opacity-50",disabled:!e.assetCategoryId,children:[s.jsx("option",{value:"",children:"Select Asset"}),ne(e.assetCategoryId).map(t=>s.jsx("option",{value:t.id,children:t.name},t.id))]})}),s.jsx("td",{className:"border p-2",children:s.jsx("input",{type:"text",value:e.currentQty,disabled:!0,className:"w-full px-2 py-1.5 border border-gray-300 rounded-md bg-gray-100 text-gray-700 text-sm dark:bg-gray-700 dark:border-gray-600 dark:text-gray-300"})}),s.jsx("td",{className:"border p-2",children:s.jsx("input",{type:"number",value:e.purchaseQty,onChange:t=>o(e.id,"purchaseQty",t.target.value),onKeyDown:t=>g(t,e.id),placeholder:"0",min:"0",className:"w-full px-2 py-1.5 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 text-sm dark:bg-gray-800 dark:border-gray-600 dark:text-white"})})]}),s.jsx("td",{className:"border p-2",children:s.jsxs("div",{className:"relative",children:[s.jsx("input",{type:"number",value:e.amount,onChange:t=>o(e.id,"amount",t.target.value),onKeyDown:t=>g(t,e.id),placeholder:"0.00",min:"0",step:"0.01",className:`w-full px-2 py-1.5 border rounded-md focus:outline-none focus:ring-2 text-sm dark:bg-gray-800 dark:border-gray-600 dark:text-white ${e.error?"border-red-500 focus:ring-red-500":"border-gray-300 focus:ring-green-500"}`}),e.error&&s.jsx("p",{className:"absolute left-0 -bottom-5 text-xs text-red-600 font-medium",children:e.error})]})}),s.jsx("td",{className:"border p-2 text-center",children:s.jsx($,{variant:"destructive",size:"sm",onClick:()=>ee(e.id),children:s.jsx(he,{className:"w-4 h-4"})})})]},e.id))})]})}),l.length>0&&s.jsxs("div",{className:"mt-10 space-y-4",children:[s.jsxs("div",{className:"flex justify-end gap-8 p-4 bg-muted/50 rounded-lg",children:[s.jsxs("div",{className:"text-right",children:[s.jsx("p",{className:"text-sm text-muted-foreground",children:"Valid Items"}),s.jsx("p",{className:"text-lg font-bold",children:v.totalItems})]}),s.jsxs("div",{className:"text-right",children:[s.jsx("p",{className:"text-sm text-muted-foreground",children:"Total Qty"}),s.jsx("p",{className:"text-lg font-bold",children:v.totalPurchaseQty})]}),s.jsxs("div",{className:"text-right",children:[s.jsx("p",{className:"text-sm text-muted-foreground",children:"Total Amount"}),s.jsxs("p",{className:"text-lg font-bold text-green-600",children:["Rs ",v.totalAmount.toLocaleString("en-PK",{minimumFractionDigits:2})]})]})]}),s.jsx("div",{className:"flex justify-end",children:s.jsx($,{onClick:oe,size:"lg",disabled:!R,className:R?"":"opacity-50 cursor-not-allowed",children:"Create Transaction"})})]}),s.jsx("div",{className:"mt-4 p-3 bg-blue-50 dark:bg-blue-950 border border-blue-200 dark:border-blue-800 rounded-lg",children:s.jsxs("p",{className:"text-sm text-blue-800 dark:text-blue-200",children:["Tip: Press ",s.jsx("kbd",{className:"px-2 py-1 bg-white dark:bg-gray-800 border border-blue-300 dark:border-blue-700 rounded text-xs",children:"Shift"})," +"," ",s.jsx("kbd",{className:"px-2 py-1 bg-white dark:bg-gray-800 border border-blue-300 dark:border-blue-700 rounded text-xs",children:"Enter"})," to add a new row"]})})]})]})})]})}export{Pe as default};
