var ve=Object.defineProperty;var ye=(n,i,d)=>i in n?ve(n,i,{enumerable:!0,configurable:!0,writable:!0,value:d}):n[i]=d;var X=(n,i,d)=>ye(n,typeof i!="symbol"?i+"":i,d);import{r as l,K as we,j as e,L as Se,S as Ce,a as J}from"./app-C_vGv3Mn.js";import{A as Ae,c as K}from"./app-layout-C3DK89xl.js";import{B as u}from"./button-D3ICZUlX.js";import{C as N,a as F,b as Pe,c as b,d as ke}from"./card-D4hKHGA3.js";import{S as Y,a as q,b as G,c as Q,d as p}from"./select-BJlDp5Vp.js";import{t as y,X as _e}from"./index-B7RycKoC.js";import{l as Fe}from"./lodash-CT1klz5U.js";import{E as Ee,F as Re,a as Te,b as De}from"./jspdf.plugin.autotable-CythJp5f.js";import{C as Z}from"./combobox-B8cObMeI.js";import{T as Le,a as ze,b as ee,c as te}from"./tabs-BdtZUb5X.js";import{B as v}from"./badge-BdnvLcZ3.js";import Me from"./ApprovalModal-C6BZF82_.js";import Ie from"./FundHeadSelectModal-DxLWu0ES.js";import{C as He,a as $e}from"./circle-x-DVldkpcR.js";import"./index-C4ULTFvu.js";import"./createLucideIcon-N4voy0hI.js";import"./index-B6M9QBmr.js";import"./index-iuOc_lCk.js";import"./index-Y6ZT9tnY.js";import"./index-DIjeUE5K.js";import"./input-Dh2IztUZ.js";import"./app-logo-icon-D2bEHVg5.js";import"./folder-root-pqswtxXi.js";import"./grip-vertical-BFFqqoG4.js";import"./index-BlEnD_H_.js";import"./index-BAR51-c9.js";import"./popover-CuqEVE5C.js";import"./textarea-BfOnAr29.js";import"./label-DZZSVEoq.js";const Be=[{title:"Reports",href:"/reports"},{title:"Projects",href:"/reports/projects"}];class Ve extends l.Component{constructor(){super(...arguments);X(this,"state",{hasError:!1,error:null})}static getDerivedStateFromError(d){return{hasError:!0,error:d.message}}componentDidCatch(d,j){console.error("ErrorBoundary caught:",d,j),y.error("An error occurred. Please try again or contact support.")}render(){return this.state.hasError?e.jsxs("div",{className:"p-4",children:[e.jsxs("p",{className:"text-red-600",children:["Error: ",this.state.error]}),e.jsx(u,{onClick:()=>window.location.reload(),className:"mt-2",children:"Retry"})]}):this.props.children}}const E=n=>{const i=n!=null&&typeof n.id=="number"&&n.id>0&&typeof n.name=="string"&&n.name.trim()!=="";return i||console.warn("Invalid item:",n),i};function bt({projects:n,institutes:i,regions:d,projectTypes:j,fundHeads:se,filters:f}){var U;const[R,Oe]=l.useState(f.search||""),[x,w]=l.useState(f.institute_id||""),[S,ae]=l.useState(f.project_type_id||""),[C,re]=l.useState(f.status||""),[h,T]=l.useState(n),[A,P]=l.useState(i||[]),[k,le]=l.useState(f.region_id||""),{auth:oe}=we().props,D=oe.user,ne=t=>{var m;const s=(m=t.current_stage)==null?void 0:m.level,a=t.overall_status;if(!s)return!1;const o=(D.roles[0].name||"").toLowerCase(),r=s.toLowerCase();return r==="regional"&&o==="region"&&a!=="approved"||r==="dte"&&(o==="dirhrm"||o==="directorate")&&a!=="approved"},[ie,L]=l.useState(!1),[de,ce]=l.useState(null),[me,z]=l.useState(!1),[ue,xe]=l.useState(null),[c,_]=l.useState(null),[M,I]=l.useState([]),[H,$]=l.useState([]),[B,V]=l.useState(!1),he=l.useMemo(()=>Array.isArray(A)?A.filter(E):[],[A]),O=l.useMemo(()=>Array.isArray(d)?d.filter(E):[],[d]),pe=l.useMemo(()=>Array.isArray(j)?j.filter(E):[],[j]);l.useEffect(()=>{c?(V(!0),(async()=>{try{const[s,a]=await Promise.all([J.get(`/projects/${c.id}/history`),J.get(`/projects/${c.id}/milestones`)]);I(s.data),$(a.data)}catch(s){console.error("Failed to fetch project details",s),y.error("Failed to load project details.")}finally{V(!1)}})()):(I([]),$([]))},[c]);const je=async t=>{if(!t||t==="0"){P(i||[]),x&&w("");return}try{const s=new URLSearchParams({region_id:t}).toString(),a=await fetch(`/reports/getInstitutes?${s}`);if(!a.ok)throw new Error("Failed to fetch institutes");const o=await a.json();P(o),x&&!o.some(r=>r.id.toString()===x)&&w("")}catch(s){console.error("Error fetching institutes:",s),y.error("Failed to load institutes"),P([])}},fe=t=>{le(t),je(t)},ge=async()=>{const t=new Ee.Workbook,s=t.addWorksheet("Projects");s.columns=[{header:"Name",key:"name",width:30},{header:"Budget",key:"budget",width:15},{header:"Status",key:"status",width:15},{header:"Project Type",key:"project_type",width:25},{header:"Institute",key:"institute",width:30},{header:"Region",key:"region",width:25}],h.data.forEach(r=>{var m,g,W;s.addRow({name:r.name,estimated_amount:r.estimated_amount,actual_amount:r.actual_amount,status:r.status,project_type:((m=r.projecttype)==null?void 0:m.name)||"N/A",institute:((g=r.institute)==null?void 0:g.name)||"N/A",region:((W=r.region)==null?void 0:W.name)||"N/A"})});const a=await t.xlsx.writeBuffer(),o=new Blob([a],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"});Re.saveAs(o,"Projects_Report.xlsx")},Ne=()=>{const t=new Te;t.setFontSize(16),t.text("Projects Report",14,15);const s=["Name","Estimated Amount","Actual Amount","Status","Project Type","Institute","Region"],a=h.data.map(o=>{var r,m,g;return[o.name,o.estimated_amount,o.actual_amount,o.status,((r=o.projecttype)==null?void 0:r.name)||"N/A",((m=o.institute)==null?void 0:m.name)||"N/A",((g=o.region)==null?void 0:g.name)||"N/A"]});De(t,{head:[s],body:a,startY:25,styles:{fontSize:9,cellPadding:2},headStyles:{fillColor:[66,139,202],textColor:255,fontStyle:"bold"},alternateRowStyles:{fillColor:[240,240,240]}}),t.save("Projects_Report.pdf")},be=l.useMemo(()=>Fe.debounce(()=>{const t=new URLSearchParams({search:R.trim(),institute_id:x||"",region_id:k||"",project_type_id:S||"",status:C||""});fetch(`/reports/projects/getprojects?${t.toString()}`).then(s=>s.json()).then(s=>{console.log("Filtered projects:",s),T(s)}).catch(s=>{console.error("Fetch error:",s),y.error("Failed to load projects")})},300),[R,x,k,S,C]);return e.jsx(Ve,{children:e.jsxs(Ae,{breadcrumbs:Be,children:[e.jsx(Se,{title:"Projects Report"}),e.jsxs("div",{className:"flex flex-col lg:flex-row h-[calc(100vh-65px)] overflow-hidden",children:[e.jsx("div",{className:`flex-1 p-2 md:p-4 overflow-y-auto ${c?"lg:w-2/3":"w-full"}`,children:e.jsxs("div",{className:"flex flex-col gap-3 h-full",children:[e.jsxs(N,{className:"shrink-0",children:[e.jsx(F,{className:"py-3",children:e.jsx(Pe,{className:"text-xl font-bold",children:"Filters"})}),e.jsxs(b,{className:"py-2 space-y-4",children:[e.jsxs("div",{className:"flex flex-col md:flex-row gap-2",children:[O.length>0&&e.jsx("div",{className:"w-full md:w-1/4",children:e.jsx(Z,{entity:"region",value:k,onChange:t=>fe(t),options:O.map(t=>({id:t.id.toString(),name:t.name.split(" ").pop()||t.name})),includeAllOption:!0})}),e.jsx("div",{className:"w-full md:w-1/4",children:e.jsx(Z,{entity:"institute",value:x,onChange:w,options:he.map(t=>({id:t.id.toString(),name:t.name})),includeAllOption:!1,placeholder:"Select Institute"})}),e.jsx("div",{className:"w-full md:w-1/4",children:e.jsxs(Y,{value:S,onValueChange:t=>ae(t),children:[e.jsx(q,{children:e.jsx(G,{placeholder:"Select Project Type"})}),e.jsxs(Q,{children:[e.jsx(p,{value:"0",children:"All Project Types"}),pe.map(t=>e.jsx(p,{value:t.id.toString(),children:t.name},t.id))]})]})}),e.jsx("div",{className:"w-full md:w-1/4",children:e.jsxs(Y,{value:C,onValueChange:t=>re(t),children:[e.jsx(q,{children:e.jsx(G,{placeholder:"Select Status"})}),e.jsxs(Q,{children:[e.jsx(p,{value:"all",children:"All Status"}),e.jsx(p,{value:"planned",children:"Planned"}),e.jsx(p,{value:"inprogress",children:"In Progress"}),e.jsx(p,{value:"completed",children:"Completed"})]})]})})]}),e.jsxs("div",{className:"flex gap-2 justify-end",children:[e.jsx(u,{onClick:be,size:"sm",children:"Apply Filters"}),e.jsx(u,{onClick:Ne,size:"sm",variant:"outline",children:"Export PDF"}),e.jsx(u,{onClick:ge,size:"sm",variant:"outline",children:"Export Excel"})]})]})]}),e.jsxs(N,{className:"flex-1 min-h-0 flex flex-col",children:[e.jsx(b,{className:"p-0 flex-1 overflow-auto",children:e.jsxs("table",{className:"w-full border-collapse text-sm",children:[e.jsx("thead",{className:"sticky top-0 z-10",children:e.jsxs("tr",{className:"bg-primary text-white text-center",children:[e.jsx("th",{className:"border p-2 font-medium",children:"Name"}),e.jsx("th",{className:"border p-2 font-medium",children:"Estimated Amount"}),e.jsx("th",{className:"border p-2 font-medium",children:"Actual Amount"}),e.jsx("th",{className:"border p-2 font-medium",children:"Status"}),e.jsx("th",{className:"border p-2 font-medium",children:"Type"}),e.jsx("th",{className:"border p-2 font-medium",children:"Institute"}),e.jsx("th",{className:"border p-2 font-medium",children:"Action"})]})}),e.jsx("tbody",{children:h.data.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:6,className:"text-center p-4 text-muted-foreground",children:"No projects found."})}):h.data.map(t=>{var s,a,o;return e.jsxs("tr",{className:`hover:bg-primary/10 dark:hover:bg-gray-700 cursor-pointer transition-colors ${(c==null?void 0:c.id)===t.id?"bg-primary/5 dark:bg-gray-700 border-l-4 border-l-primary":""}`,onClick:()=>_(t),children:[e.jsx("td",{className:"border p-2 font-medium",children:t.name}),e.jsx("td",{className:"border p-2 text-right",children:t.estimated_amount}),e.jsx("td",{className:"border p-2 text-right",children:t.actual_amount}),e.jsx("td",{className:"border p-2 text-center",children:e.jsx("span",{className:`px-2 py-1 rounded-full text-xs font-medium ${t.status==="completed"?"bg-green-100 text-green-800":t.status==="inprogress"?"bg-yellow-100 text-yellow-800":"bg-blue-100 text-blue-800"}`,children:t.status.charAt(0).toUpperCase()+t.status.slice(1)})}),e.jsx("td",{className:"border p-2 text-center",children:((s=t.projecttype)==null?void 0:s.name)||"-"}),e.jsx("td",{className:"border p-2",children:((a=t.institute)==null?void 0:a.name)||"-"}),e.jsxs("td",{className:"border p-2 text-center",onClick:r=>r.stopPropagation(),children:[ne(t)&&e.jsx(u,{variant:"ghost",size:"icon",title:"View/Approve",className:"text-blue-600 hover:text-blue-700",onClick:r=>{r.stopPropagation(),ce(t),L(!0)},children:e.jsx(ke,{className:"h-4 w-4"})}),((o=D.roles[0])==null?void 0:o.name.toLowerCase())==="region"&&!t.fund_head_id&&e.jsx(u,{variant:"ghost",size:"sm",title:"Select Fund Head",className:"text-orange-600 hover:text-orange-700 font-bold",onClick:r=>{r.stopPropagation(),xe(t),z(!0)},children:"Select Head"})]})]},t.id)})})]})}),h.links.length>1&&e.jsx("div",{className:"p-4 border-t flex justify-center flex-wrap gap-2 shrink-0",children:h.links.map((t,s)=>e.jsx(u,{disabled:!t.url,variant:t.active?"default":"outline",size:"sm",onClick:()=>{t.url&&fetch(t.url).then(a=>a.json()).then(a=>{T(a)}).catch(a=>{console.error("Error:",a)})},children:e.jsx("span",{dangerouslySetInnerHTML:{__html:t.label}})},s))})]})]})}),c&&e.jsxs("div",{className:"w-full lg:w-1/3 border-l bg-background p-4 md:p-6 shadow-xl overflow-y-auto flex flex-col h-full transition-all duration-300 ease-in-out z-20 absolute lg:relative right-0 top-0 lg:top-auto bottom-0 lg:bottom-auto",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-bold",children:c.name}),e.jsx("p",{className:"text-sm text-muted-foreground",children:(U=c.institute)==null?void 0:U.name})]}),e.jsx(u,{variant:"ghost",size:"icon",onClick:()=>_(null),children:e.jsx(_e,{className:"h-5 w-5"})})]}),e.jsxs(Le,{defaultValue:"approvals",className:"w-full flex-1 flex flex-col",children:[e.jsxs(ze,{className:"grid w-full grid-cols-2",children:[e.jsx(ee,{value:"approvals",children:"Approvals"}),e.jsx(ee,{value:"milestones",children:"Milestones"})]}),e.jsxs("div",{className:"flex-1 overflow-y-auto mt-4 px-1",children:[e.jsx(te,{value:"approvals",className:"space-y-4 m-0 h-full",children:B?e.jsx("div",{className:"flex justify-center py-8 text-muted-foreground",children:"Loading history..."}):M.length===0?e.jsx("div",{className:"text-center py-8 text-muted-foreground border rounded-lg border-dashed",children:"No approval history found."}):e.jsx("div",{className:"space-y-4",children:M.map(t=>{var s,a;return e.jsxs(N,{className:"overflow-hidden",children:[e.jsx(F,{className:"p-3 bg-muted/50 pb-2",children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsx("div",{className:"font-semibold text-sm",children:((s=t.stage)==null?void 0:s.stage_name)||"Stage"}),t.status==="approved"?e.jsxs(v,{variant:"outline",className:"border-green-500 text-green-600 bg-green-50 gap-1",children:[e.jsx(He,{className:"w-3 h-3"})," Approved"]}):t.status==="rejected"?e.jsxs(v,{variant:"outline",className:"border-red-500 text-red-600 bg-red-50 gap-1",children:[e.jsx($e,{className:"w-3 h-3"})," Rejected"]}):e.jsxs(v,{variant:"outline",className:"border-yellow-500 text-yellow-600 bg-yellow-50 gap-1",children:[e.jsx(K,{className:"w-3 h-3"})," Pending"]})]})}),e.jsxs(b,{className:"p-3 text-sm",children:[e.jsxs("div",{className:"flex items-center text-xs text-muted-foreground mb-2",children:[e.jsx(K,{className:"w-3 h-3 mr-1"}),t.action_date?new Date(t.action_date).toLocaleString():""]}),e.jsxs("div",{className:"mb-2",children:[e.jsx("span",{className:"font-medium text-xs",children:"Approver: "}),(a=t.approver)==null?void 0:a.name]}),t.comments&&e.jsxs("div",{className:"bg-muted/30 p-2 rounded text-xs italic border",children:['"',t.comments,'"']}),t.pdf&&e.jsx("a",{href:`/${t.pdf}`,target:"_blank",className:"mt-1 text-blue-600 underline text-xs flex items-center gap-1",children:"View PDF"}),t.img&&e.jsx("div",{className:"mt-2",children:e.jsx("img",{src:`/${t.img}`,alt:"Evidence",className:"h-20 w-auto rounded border"})})]})]},t.id)})})}),e.jsx(te,{value:"milestones",className:"space-y-4 m-0 h-full",children:B?e.jsx("div",{className:"flex justify-center py-8 text-muted-foreground",children:"Loading milestones..."}):H.length===0?e.jsx("div",{className:"text-center py-8 text-muted-foreground border rounded-lg border-dashed",children:"No milestones found."}):e.jsx("div",{className:"space-y-4",children:H.map(t=>e.jsxs(N,{children:[e.jsx(F,{className:"p-3 pb-1",children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsx("div",{className:"font-semibold text-sm",children:t.name}),e.jsx(v,{variant:t.status==="completed"?"default":t.status==="inprogress"?"secondary":"outline",className:"capitalize text-xs",children:t.status})]})}),e.jsxs(b,{className:"p-3 text-sm space-y-2",children:[t.img&&e.jsx("div",{className:"mb-2",children:e.jsx("img",{src:`/${t.img}`,alt:t.name,className:"w-full h-32 object-cover rounded-md"})}),t.pdf&&e.jsx("a",{href:`/${t.pdf}`,target:"_blank",className:"mb-2 text-blue-600 underline text-xs flex items-center gap-1",children:"View Document (PDF)"}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 text-xs",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-muted-foreground",children:"Due: "}),new Date(t.due_date).toLocaleDateString()]}),t.completed_date&&e.jsxs("div",{children:[e.jsx("span",{className:"text-muted-foreground",children:"Completed: "}),e.jsx("span",{className:"text-green-600 dark:text-green-400",children:new Date(t.completed_date).toLocaleDateString()})]})]}),t.description&&e.jsx("p",{className:"text-muted-foreground text-xs mt-1",children:t.description})]})]},t.id))})})]})]})]})]}),e.jsx(Me,{isOpen:ie,onClose:()=>L(!1),project:de}),e.jsx(Ie,{isOpen:me,onClose:()=>z(!1),project:ue,fundHeads:se,onSuccess:()=>{Ce.reload()}}),c&&e.jsx("div",{className:"fixed inset-0 bg-black/20 lg:hidden z-10",onClick:()=>_(null)})]})})}export{bt as default};
