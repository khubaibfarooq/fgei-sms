var ee=Object.defineProperty;var te=(o,a,n)=>a in o?ee(o,a,{enumerable:!0,configurable:!0,writable:!0,value:n}):o[a]=n;var M=(o,a,n)=>te(o,typeof a!="symbol"?a+"":a,n);import{r as i,j as t,L as re}from"./app-Dmsca3ga.js";import{A as se,S as oe}from"./app-layout-C2xmX1Hb.js";import{B as k}from"./button-Bj6BrUH6.js";import{C as ae,a as le,b as ne,c as ie}from"./card-xvL8uskR.js";import{I as ce}from"./input-BdAOZbtJ.js";import{S as de,a as me,b as he,c as pe,d as $}from"./select-BSxGoh2B.js";import{t as d}from"./index-D6UOAD5w.js";import{l as xe}from"./lodash-ClxTfwnV.js";import{E as ue,F as fe,a as ge,b as ye}from"./jspdf.plugin.autotable-BXBQrXQK.js";import{C as V}from"./combobox-CN3zRdkH.js";import{I as be}from"./image-preview-DszsciiP.js";import"./index-Zg5VAYB9.js";import"./createLucideIcon-DbbURgfX.js";import"./index-zWcryNbA.js";import"./index-CyxareTc.js";import"./index-Ba5aNK9e.js";import"./index-C2LZNCwO.js";import"./app-logo-icon-BrPrkrko.js";import"./circle-x-DVsUFmrb.js";import"./folder-root-DCKUxTuK.js";import"./grip-vertical-lBHA5wj6.js";import"./index-BvGfhB4S.js";import"./index-CtJiXazN.js";import"./popover-Cbhud8Hc.js";const je=[{title:"Reports",href:"/reports"},{title:"Blocks",href:"/reports/blocks"}];class ke extends i.Component{constructor(){super(...arguments);M(this,"state",{hasError:!1,error:null})}static getDerivedStateFromError(n){return{hasError:!0,error:n.message}}componentDidCatch(n,p){console.error("ErrorBoundary caught:",n,p),d.error("An error occurred while rendering the component. Please try again or contact support.")}render(){return this.state.hasError?t.jsxs("div",{className:"p-4",children:[t.jsxs("p",{className:"text-red-600",children:["Error: ",this.state.error]}),t.jsx(k,{onClick:()=>window.location.reload(),className:"mt-2",children:"Retry"})]}):this.props.children}}const g=o=>{const a=o!=null&&typeof o.id=="number"&&o.id>0&&typeof o.name=="string"&&o.name.trim()!=="";return a||console.warn("Invalid item detected:",o),a};function qe({blocks:o,institutes:a,blocktypes:n,regions:p,filters:w}){var z,P,T;const[N,O]=i.useState(w.search||""),[x,B]=i.useState(w.institute_id||""),[S,U]=i.useState(w.blocktype_id||""),[E,H]=i.useState(w.region_id||""),[v,F]=i.useState(o),[m,A]=i.useState(a||[]),[we,W]=i.useState([]),J=async e=>{try{const r=new URLSearchParams({region_id:e||""}).toString(),s=await fetch(`/reports/getInstitutes?${r}`);if(!s.ok)throw new Error("Failed to fetch institutes");const l=await s.json();console.log("Fetched institutes:",l),A(l),x&&e!=="0"&&!l.some(y=>y.id.toString()===x)&&B("")}catch(r){console.error("Error fetching institutes:",r),d.error("Failed to load institutes"),A([])}},Y=e=>{H(e),J(e)},I=async()=>{try{const e=new URLSearchParams({search:N||"",institute_id:x||"",blocktype_id:S||"",region_id:E||"",all:"true"}),r=await fetch(`/reports/blocks/getBlocks?${e.toString()}`);if(!r.ok)throw new Error("Failed to fetch all blocks for export");const s=await r.json();return W(s),s}catch(e){return console.error("Error fetching all blocks for export:",e),d.error("Failed to fetch blocks for export"),[]}};i.useEffect(()=>{const e={institutes:Array.isArray(m)?m.filter(r=>!g(r)):[],blocktypes:n.filter(r=>!g(r)),regions:p.filter(r=>!g(r))};Object.entries(e).forEach(([r,s])=>{s.length>0&&console.warn(`Invalid ${r}:`,s)})},[a,n,p,m]);const q=async()=>{var e;try{const r=await I(),s=new ue.Workbook,l=s.addWorksheet("Blocks"),y=r.length>0&&((e=r[0].institute)!=null&&e.name)?r[0].institute.name:"All Institutes";l.mergeCells("A1:C1");const b=l.getCell("A1");b.value=`Institute: ${y}`,b.font={size:16,bold:!0},b.alignment={horizontal:"center"},l.mergeCells("A2:C2");const h=l.getCell("A2");h.value="Blocks Report",h.font={size:14,bold:!0},h.alignment={horizontal:"center"},l.addRow([]);const C=["Block Name","Block Type","Institute"],u=l.addRow(C);u.font={bold:!0},u.fill={type:"pattern",pattern:"solid",fgColor:{argb:"FF428BCA"}},u.alignment={horizontal:"center"},r.forEach(c=>{var f,j;l.addRow([c.name||"—",((f=c.block_type)==null?void 0:f.name)||"N/A",((j=c.institute)==null?void 0:j.name)||"N/A"])}),l.columns.forEach(c=>{var j;let f=0;(j=c.eachCell)==null||j.call(c,{includeEmpty:!0},D=>{const L=D.value?D.value.toString().length:10;L>f&&(f=L)}),c.width=Math.min(f+2,50)});const X=await s.xlsx.writeBuffer(),Z=new Blob([X],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"});fe.saveAs(Z,"Blocks_Report.xlsx"),d.success("Excel exported successfully")}catch(r){console.error("Error exporting to Excel:",r),d.error("Failed to export Excel")}},G=async()=>{var e;try{const r=await I(),s=new ge,l=r.length>0&&((e=r[0].institute)!=null&&e.name)?r[0].institute.name:"All Institutes";s.setFontSize(16),s.setFont("helvetica","bold"),s.text(`Institute: ${l}`,14,15),s.setFontSize(14),s.text("Blocks Report",14,25);const y=["Block Name","Block Type","Institute"],b=r.map(h=>{var C,u;return[h.name||"—",((C=h.block_type)==null?void 0:C.name)||"N/A",((u=h.institute)==null?void 0:u.name)||"N/A"]});ye(s,{head:[y],body:b,startY:35,styles:{fontSize:9,cellPadding:2},headStyles:{fillColor:[66,139,202],textColor:255,fontStyle:"bold"},alternateRowStyles:{fillColor:[240,240,240]}}),s.save("Blocks_Report.pdf"),d.success("PDF exported successfully")}catch(r){console.error("Error exporting to PDF:",r),d.error("Failed to export PDF")}},K=i.useMemo(()=>xe.debounce(()=>{const e=new URLSearchParams({search:N||"",institute_id:x||"",blocktype_id:S||"",region_id:E||""});fetch(`/reports/blocks/getBlocks?${e.toString()}`).then(r=>r.json()).then(r=>{console.log("Fetched filtered blocks:",r),F(r)}).catch(r=>{console.error("Error fetching filtered blocks:",r),d.error("Failed to fetch filtered blocks")})},300),[N,x,S,E]),Q=i.useMemo(()=>Array.isArray(m)?m.filter(g):(console.warn("filteredInstitutes is not an array or is null:",m),[]),[m]),R=i.useMemo(()=>n.filter(g),[n]),_=i.useMemo(()=>p.filter(g),[p]);return t.jsx(ke,{children:t.jsxs(se,{breadcrumbs:je,children:[t.jsx(re,{title:"Blocks Report"}),t.jsx("div",{className:"flex-1 p-2 md:p-2",children:t.jsxs(ae,{className:"w-full",children:[t.jsx(le,{className:"flex flex-col md:flex-row md:items-center md:justify-between gap-4",children:t.jsx(ne,{className:"text-2xl font-bold",children:"Blocks Report"})}),t.jsx(oe,{}),t.jsxs(ie,{className:"space-y-6 pt-6",children:[t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4",children:[_.length>0&&t.jsx(V,{entity:"region",value:E,onChange:e=>Y(e),options:_.map(e=>({id:e.id.toString(),name:e.name.split(" ").pop()||e.name})),includeAllOption:!0}),t.jsx(V,{entity:"institute",value:x,onChange:e=>B(e),options:Q.map(e=>({id:e.id.toString(),name:e.name})),includeAllOption:!0}),t.jsxs(de,{value:S,onValueChange:e=>{U(e)},children:[t.jsx(me,{children:t.jsx(he,{placeholder:"Select Block Type"})}),t.jsxs(pe,{children:[t.jsx($,{value:"0",children:"All Block Types"}),R.length>0?R.map(e=>t.jsx($,{value:e.id.toString(),children:e.name},e.id)):t.jsx("div",{className:"text-muted-foreground text-sm p-2",children:"No block types available"})]})]}),t.jsx(ce,{type:"text",placeholder:"Search blocks...",value:N,onChange:e=>O(e.target.value)})]}),t.jsxs("div",{className:"flex flex-col md:flex-row gap-2 justify-end",children:[t.jsx(k,{onClick:K,className:"w-full md:w-auto",children:"Apply Filters"}),t.jsx(k,{onClick:G,className:"w-full md:w-auto",children:"Export PDF"}),t.jsx(k,{onClick:q,className:"w-full md:w-auto",children:"Export Excel"})]}),t.jsxs("div",{className:"space-y-3",children:[t.jsxs("table",{className:"w-full border-collapse border-1 rounded-md overflow-hidden shadow-sm",children:[t.jsx("thead",{children:t.jsxs("tr",{className:"bg-primary dark:bg-gray-800",children:[t.jsx("th",{className:"border p-2 text-left text-sm font-medium text-white dark:text-gray-200",children:"Block Name"}),t.jsx("th",{className:"border p-2 text-left text-sm font-medium text-white dark:text-gray-200",children:"Block Type"}),t.jsx("th",{className:"border p-2 text-left text-sm font-medium text-white dark:text-gray-200",children:"Area"}),t.jsx("th",{className:"border p-2 text-left text-sm font-medium text-white dark:text-gray-200",children:"Establish Date"}),t.jsx("th",{className:"border p-2 text-left text-sm font-medium text-white dark:text-gray-200",children:"Institute"})]})}),t.jsx("tbody",{children:((z=v.data)==null?void 0:z.length)===0?t.jsx("tr",{children:t.jsx("td",{colSpan:5,className:"border p-2 text-center text-sm text-gray-900 dark:text-gray-100",children:"No blocks found."})}):(P=v.data)==null?void 0:P.map(e=>{var r,s;return t.jsxs("tr",{className:"hover:bg-primary/10 dark:hover:bg-gray-700",children:[t.jsx("td",{className:"border p-2 text-left font-bold dark:text-gray-100",children:t.jsxs("div",{className:"flex flex-row gap-2 align-middle",children:[" ",t.jsx(be,{dataImg:e.img,size:"h-20 w-20"}),"  ",t.jsx("span",{className:"font-bold",children:e.name})]})}),t.jsx("td",{className:"border p-2 text-left text-gray-900 dark:text-gray-100",children:((r=e.block_type)==null?void 0:r.name)||"—"}),t.jsx("td",{className:"border p-2 text-left text-gray-900 dark:text-gray-100",children:e.area||"—"}),t.jsx("td",{className:"border p-2 text-left text-gray-900 dark:text-gray-100",children:e.establish_date||"—"}),t.jsx("td",{className:"border p-2 text-left text-gray-900 dark:text-gray-100",children:((s=e.institute)==null?void 0:s.name)||"—"})]},e.id)})})]}),((T=v.links)==null?void 0:T.length)>1&&t.jsx("div",{className:"flex justify-center pt-6 flex-wrap gap-2",children:v.links.map((e,r)=>t.jsx(k,{disabled:!e.url,variant:e.active?"default":"outline",size:"sm",onClick:()=>{e.url&&fetch(e.url).then(s=>s.json()).then(s=>{F(s)}).catch(s=>{console.error("Error:",s)})},className:e.active?"bg-blue-600 hover:bg-blue-700":"",children:t.jsx("span",{dangerouslySetInnerHTML:{__html:e.label}})},r))})]})]})]})})]})})}export{qe as default};
