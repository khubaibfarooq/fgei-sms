var Ee=Object.defineProperty;var Be=(d,c,m)=>c in d?Ee(d,c,{enumerable:!0,configurable:!0,writable:!0,value:m}):d[c]=m;var de=(d,c,m)=>Be(d,typeof c!="symbol"?c+"":c,m);import{r as o,j as e,L as Ie,S as Ue}from"./app-0qS973U9.js";import{t as j,A as $e,F as ie,S as ce,C as Le,b as ze,E as Oe,D as Pe}from"./app-layout-78kBIvnS.js";import{B as x}from"./button-CS8Xc8V7.js";import{C as me,a as pe,b as he,c as ue}from"./card-B8QmAbbL.js";import{I as U}from"./index-BA_Xqv3U.js";import{S as $,a as L,b as z,c as O,d as p}from"./select-B4RBnafu.js";import{D as Me,a as Ve,b as He,c as Ye}from"./dialog-DkMKEJy5.js";import{l as qe}from"./lodash-BwdfZu9H.js";import{E as Qe,F as We,a as xe,b as P}from"./jspdf.plugin.autotable-CJiAgvpb.js";import{f as b}from"./dateFormatter-Cn65gwBN.js";import{C as M}from"./combobox-dULMGjRt.js";import{L as Xe}from"./app-logo-icon-DNL6xR8E.js";import"./index-D_t89EOP.js";import"./createLucideIcon-CchlTjX3.js";import"./index-DpYJF6qn.js";import"./index-C1MxKQaq.js";import"./index-A-qRfYC_.js";import"./popover-cQ78Kydu.js";const Ge=[{title:"Reports",href:"/reports"},{title:"Transactions",href:"/reports/transactions"}];class Je extends o.Component{constructor(){super(...arguments);de(this,"state",{hasError:!1,error:null})}static getDerivedStateFromError(m){return{hasError:!0,error:m.message}}componentDidCatch(m,N){console.error("ErrorBoundary:",m,N),j.error("An error occurred. Please try again.")}render(){return this.state.hasError?e.jsxs("div",{className:"p-4",children:[e.jsxs("p",{className:"text-red-600",children:["Error: ",this.state.error]}),e.jsx(x,{onClick:()=>window.location.reload(),className:"mt-2",children:"Retry"})]}):this.props.children}}const V=d=>d!=null&&typeof d.id=="number"&&d.id>0&&typeof d.name=="string"&&d.name.trim()!=="";function ft({transactions:d,institutes:c,regions:m,users:N,filters:h,user_type:je}){var te,se,ae;const[S,fe]=o.useState(h.search||""),[f,w]=o.useState(h.institute_id||""),[A,ye]=o.useState(h.region_id||""),[C,ge]=o.useState(h.added_by||""),[_,be]=o.useState(h.approved_by||""),[F,Ne]=o.useState(h.type||""),[T,ve]=o.useState(h.status||""),[k,Se]=o.useState(h.date_from||""),[D,we]=o.useState(h.date_to||""),[y,Ae]=o.useState(d),[H,R]=o.useState(c||[]),[E,Y]=o.useState(!1),[q,B]=o.useState(!1),[l,Q]=o.useState(null),[I,W]=o.useState([]),[X,G]=o.useState(!1),Ce=async t=>{var s;if(!E){Y(!0);try{if(!(await fetch(`/reports/transactions/approve?tid=${t}`,{method:"GET",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":((s=document.querySelector('meta[name="csrf-token"]'))==null?void 0:s.getAttribute("content"))||""}})).ok)throw new Error("Failed to approve");j.success("Transaction approved successfully"),Z()}catch{j.error("Failed to approve transaction")}finally{Y(!1)}}},_e=o.useMemo(()=>H.filter(V),[H]),J=o.useMemo(()=>m.filter(V),[m]),K=o.useMemo(()=>N.filter(V),[N]),Fe=async t=>{if(!t||t==="0"){R(c||[]),f&&w("");return}try{const s=new URLSearchParams({region_id:t}).toString(),n=await fetch(`/reports/transactions/getinstitutes?${s}`);if(!n.ok)throw new Error("Failed to fetch institutes");const a=await n.json();R(a),f&&!a.some(r=>r.id.toString()===f)&&w("")}catch(s){console.error("Error fetching institutes:",s),j.error("Failed to load institutes"),R([])}},Te=t=>{ye(t),Fe(t)},ke=async()=>{const t=new Qe.Workbook,s=t.addWorksheet("Transactions");s.columns=[{header:"ID",key:"id",width:10},{header:"Amount",key:"amount",width:15},{header:"Type",key:"type",width:12},{header:"Status",key:"status",width:12},{header:"Institute",key:"institute",width:30},{header:"Added By",key:"added_by",width:25},{header:"Approved By",key:"approved_by",width:25},{header:"Date",key:"date",width:18}],y.data.forEach(r=>{var i,u,v;s.addRow({id:r.id,amount:`$${parseFloat(r.total_amount.toString()).toFixed(2)}`,type:r.type.charAt(0).toUpperCase()+r.type.slice(1),status:r.status.charAt(0).toUpperCase()+r.status.slice(1),institute:((i=r.institute)==null?void 0:i.name)||"N/A",added_by:((u=r.added_by)==null?void 0:u.name)||"N/A",approved_by:((v=r.approved_by)==null?void 0:v.name)||"N/A",date:b(r.created_at)})});const n=await t.xlsx.writeBuffer(),a=new Blob([n],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"});We.saveAs(a,"Transactions_Report.xlsx")},De=()=>{const t=new xe;t.setFontSize(16),t.text("Transactions Report",14,15);const s=["ID","Amount","Type","Status","Institute","Added By","Approved By","Date"],n=y.data.map(a=>{var r,i,u;return[a.id.toString(),`$${parseFloat(a.total_amount.toString()).toFixed(2)}`,a.type.charAt(0).toUpperCase()+a.type.slice(1),a.status.charAt(0).toUpperCase()+a.status.slice(1),((r=a.institute)==null?void 0:r.name)||"N/A",((i=a.added_by)==null?void 0:i.name)||"N/A",((u=a.approved_by)==null?void 0:u.name)||"N/A",b(a.created_at)]});P(t,{head:[s],body:n,startY:25,styles:{fontSize:9,cellPadding:2},headStyles:{fillColor:[46,124,196],textColor:255,fontStyle:"bold"},alternateRowStyles:{fillColor:[240,240,240]}}),t.save("Transactions_Report.pdf")},Z=o.useMemo(()=>qe.debounce(()=>{const t=new URLSearchParams({search:S.trim(),institute_id:f||"",region_id:A||"",added_by:C||"",approved_by:_||"",type:F||"",status:T||"",date_from:k||"",date_to:D||""});fetch(`/reports/transactions/gettransactions?${t.toString()}`).then(s=>{if(!s.ok)throw new Error("Network error");return s.json()}).then(s=>{Ae(s)}).catch(s=>{console.error("Fetch error:",s),j.error("Failed to load transactions")})},400),[S,f,A,C,_,F,T,k,D]),Re=async t=>{G(!0);try{const s=await fetch(`/reports/transactions/getbytid?tid=${t}`);if(!s.ok)throw new Error("Failed to load details");const{transaction:n,transdetails:a}=await s.json();Q(n),W(a),B(!0)}catch(s){j.error("Could not load transaction details"),console.error(s)}finally{G(!1)}},ee=(t,s)=>{var r,i,u;const n=new xe;n.setFontSize(16),n.text(`Transaction #${t.id}`,14,15);const a=[["Amount",`RS ${parseFloat(t.total_amount.toString()).toFixed(2)}`],["Type",t.type.charAt(0).toUpperCase()+t.type.slice(1)],["Status",t.status.charAt(0).toUpperCase()+t.status.slice(1)],["Institute",((r=t.institute)==null?void 0:r.name)||"N/A"],["Added By",((i=t.added_by)==null?void 0:i.name)||"N/A"],["Approved By",((u=t.approved_by)==null?void 0:u.name)||"N/A"],["Date",b(t.created_at)]];if(P(n,{head:[["Field","Value"]],body:a,startY:25,styles:{fontSize:10},headStyles:{fillColor:[46,124,196]}}),s.length){const v=s.map(g=>{var re,ne,oe,le;return[((re=g.asset)==null?void 0:re.name)||"-",((ne=g.room)==null?void 0:ne.name)||"-",((oe=g.fund_head)==null?void 0:oe.name)||"-",g.qty??"-",`RS ${parseFloat(((le=g.amount)==null?void 0:le.toString())??"0").toFixed(2)}`]});P(n,{head:[["Asset","Room","Fund Head","Qty","Amount"]],body:v,startY:n.lastAutoTable.finalY+10,styles:{fontSize:9}})}n.save(`Transaction_#${t.id}.pdf`)};return o.useEffect(()=>()=>{B(!1),Q(null),W([])},[]),e.jsx(Je,{children:e.jsxs($e,{breadcrumbs:Ge,children:[e.jsx(Ie,{title:"Transactions Report"}),e.jsx("div",{className:"flex-1 p-1 md:p-1",children:e.jsxs("div",{className:"flex flex-col md:flex-row gap-3",children:[e.jsx("div",{className:"w-full md:w-1/4",children:e.jsxs(me,{children:[e.jsxs(pe,{children:[e.jsx(he,{className:"text-xl font-bold flex items-center gap-2",children:"Filters"}),e.jsx("p",{className:"text-muted-foreground text-sm",children:"Refine transaction search"})]}),e.jsxs(ue,{className:"space-y-4",children:[e.jsx(U,{placeholder:"Search by ID, amount, type...",value:S,onChange:t=>fe(t.target.value)}),je!=="Regional Office"&&J.length>0&&e.jsxs($,{value:A,onValueChange:Te,children:[e.jsx(L,{children:e.jsx(z,{placeholder:"Select Region"})}),e.jsxs(O,{children:[e.jsx(p,{value:"0",children:"All Regions"}),J.map(t=>e.jsx(p,{value:t.id.toString(),children:t.name},t.id))]})]}),e.jsx(M,{entity:"institute",value:f,onChange:w,options:_e.map(t=>({id:t.id.toString(),name:t.name})),includeAllOption:!0,allOptionLabel:"All Institutes",placeholder:"Select Institute"}),e.jsx(M,{entity:"user",value:C,onChange:ge,options:K.map(t=>({id:t.id.toString(),name:t.name})),includeAllOption:!0,allOptionLabel:"All Users",placeholder:"Added By"}),e.jsx(M,{entity:"user",value:_,onChange:be,options:K.map(t=>({id:t.id.toString(),name:t.name})),includeAllOption:!0,allOptionLabel:"All Users",placeholder:"Approved By"}),e.jsxs($,{value:F,onValueChange:Ne,children:[e.jsx(L,{children:e.jsx(z,{placeholder:"Select Type"})}),e.jsxs(O,{children:[e.jsx(p,{value:"0",children:"All Types"}),e.jsx(p,{value:"purchase",children:"Purchase"}),e.jsx(p,{value:"maintenance",children:"Maintenance"}),e.jsx(p,{value:"condemned",children:"Condemned"})]})]}),e.jsxs($,{value:T,onValueChange:ve,children:[e.jsx(L,{children:e.jsx(z,{placeholder:"Select Status"})}),e.jsxs(O,{children:[e.jsx(p,{value:"0",children:"All Status"}),e.jsx(p,{value:"pending",children:"Pending"}),e.jsx(p,{value:"approved",children:"Approved"}),e.jsx(p,{value:"rejected",children:"Rejected"})]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(U,{type:"date",value:k,onChange:t=>Se(t.target.value),className:"flex-1"}),e.jsx(U,{type:"date",value:D,onChange:t=>we(t.target.value),className:"flex-1"})]}),e.jsx(x,{onClick:Z,className:"w-full",children:"Apply Filters"})]})]})}),e.jsx("div",{className:"w-full md:w-full",children:e.jsxs(me,{children:[e.jsxs(pe,{className:"pb-3 flex flex-col md:flex-row md:items-center md:justify-between gap-4",children:[e.jsx("div",{children:e.jsxs(he,{className:"text-2xl font-bold flex items-center gap-2",children:[e.jsx(ie,{className:"w-6 h-6"}),"Transactions Report"]})}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(x,{onClick:De,className:"w-full md:w-auto",children:"Export PDF"}),e.jsx(x,{onClick:ke,className:"w-full md:w-auto",children:"Export Excel"})]})]}),e.jsx(ce,{}),e.jsxs(ue,{className:"pt-6 space-y-6",children:[e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full border-collapse text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-primary text-white text-center",children:[e.jsx("th",{className:"border p-2 font-medium",children:"ID"}),e.jsx("th",{className:"border p-2 font-medium",children:"Amount"}),e.jsx("th",{className:"border p-2 font-medium",children:"Type"}),e.jsx("th",{className:"border p-2 font-medium",children:"Status"}),e.jsx("th",{className:"border p-2 font-medium",children:"Institute"}),e.jsx("th",{className:"border p-2 font-medium",children:"Added By"}),e.jsx("th",{className:"border p-2 font-medium",children:"Approved By"}),e.jsx("th",{className:"border p-2 font-medium",children:"Date"}),e.jsx("th",{className:"border p-2 font-medium",children:"Action"})]})}),e.jsx("tbody",{children:y.data.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:9,className:"text-center p-4 text-muted-foreground",children:"No transactions found."})}):y.data.map(t=>{var s,n,a;return e.jsxs("tr",{className:"hover:bg-gray-50 dark:hover:bg-gray-700 text-center",children:[e.jsxs("td",{className:"border p-2",children:["#",t.id]}),e.jsx("td",{className:"border p-2 font-medium",children:parseFloat(t.total_amount.toString()).toFixed(2)}),e.jsx("td",{className:"border p-2",children:e.jsx("span",{className:`px-2 py-1 rounded text-xs font-medium ${t.type==="income"?"bg-green-100 text-green-800":"bg-red-100 text-red-800"}`,children:t.type.charAt(0).toUpperCase()+t.type.slice(1)})}),e.jsx("td",{className:"border p-2",children:e.jsxs("span",{className:`px-2 py-1 rounded text-xs font-medium flex items-center justify-center gap-1 ${t.status==="approved"?"bg-green-100 text-green-800":t.status==="rejected"?"bg-red-100 text-red-800":"bg-yellow-100 text-yellow-800"}`,children:[t.status==="approved"&&e.jsx(Le,{className:"w-3 h-3"}),t.status==="rejected"&&e.jsx(ze,{className:"w-3 h-3"}),t.status.charAt(0).toUpperCase()+t.status.slice(1)]})}),e.jsx("td",{className:"border p-2",children:((s=t.institute)==null?void 0:s.name)||"N/A"}),e.jsx("td",{className:"border p-2",children:((n=t.added_by)==null?void 0:n.name)||"N/A"}),e.jsx("td",{className:"border p-2",children:((a=t.approved_by)==null?void 0:a.name)||"N/A"}),e.jsx("td",{className:"border p-2 text-xs",children:b(t.created_at)}),e.jsx("td",{className:"border p-2",children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx(x,{size:"icon",variant:"ghost",className:"h-8 w-8",onClick:()=>Re(t.id),disabled:X,title:"View details",children:X?e.jsx(Xe,{className:"h-4 w-4 animate-spin"}):e.jsx(Oe,{className:"h-4 w-4"})}),e.jsx(x,{size:"icon",variant:"ghost",className:"h-8 w-8",onClick:()=>{q&&(l==null?void 0:l.id)===t.id?ee(l,I):fetch(`/reports/transactions/getbytid?tid=${t.id}`).then(r=>r.json()).then(({transaction:r,transdetails:i})=>{ee(r,i)}).catch(()=>j.error("Failed to generate PDF"))},title:"Download PDF",children:e.jsx(Pe,{className:"h-4 w-4"})}),t.status==="pending"&&e.jsx(x,{size:"sm",variant:"default",className:"bg-green-600 hover:bg-green-700",onClick:()=>Ce(t.id),disabled:E,children:E?"Approving...":"Approve"})]})})]},t.id)})})]})}),e.jsx(Me,{open:q,onOpenChange:B,children:e.jsxs(Ve,{className:"max-w-4xl max-h-[90vh] overflow-y-auto",children:[e.jsx(He,{children:e.jsxs(Ye,{className:"flex items-center gap-2",children:[e.jsx(ie,{className:"w-5 h-5"}),"Transaction #",l==null?void 0:l.id]})}),l&&e.jsxs("div",{className:"mt-4 space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Amount:"})," RS ",parseFloat(l.total_amount.toString()).toFixed(2)]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Type:"})," ",l.type.charAt(0).toUpperCase()+l.type.slice(1)]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Status:"})," ",l.status.charAt(0).toUpperCase()+l.status.slice(1)]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Institute:"})," ",((te=l.institute)==null?void 0:te.name)||"N/A"]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Added By:"})," ",((se=l.added_by)==null?void 0:se.name)||"N/A"]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Approved By:"})," ",((ae=l.approved_by)==null?void 0:ae.name)||"N/A"]}),e.jsxs("div",{className:"col-span-2",children:[e.jsx("span",{className:"font-medium",children:"Date:"})," ",b(l.created_at)]})]}),e.jsx(ce,{}),I.length?e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full text-sm border",children:[e.jsx("thead",{className:"bg-muted",children:e.jsxs("tr",{children:[e.jsx("th",{className:"border p-2 text-left",children:"Asset"}),e.jsx("th",{className:"border p-2 text-left",children:"Room"}),e.jsx("th",{className:"border p-2 text-left",children:"Fund Head"}),e.jsx("th",{className:"border p-2 text-left",children:"Qty"}),e.jsx("th",{className:"border p-2 text-left",children:"Amount"})]})}),e.jsx("tbody",{children:I.map((t,s)=>{var n,a,r,i;return e.jsxs("tr",{className:"hover:bg-muted/50",children:[e.jsx("td",{className:"border p-2",children:((n=t.asset)==null?void 0:n.name)||"-"}),e.jsx("td",{className:"border p-2",children:((a=t.room)==null?void 0:a.name)||"-"}),e.jsx("td",{className:"border p-2",children:((r=t.fund_head)==null?void 0:r.name)||"-"}),e.jsx("td",{className:"border p-2",children:t.qty??"-"}),e.jsxs("td",{className:"border p-2",children:["RS ",parseFloat(((i=t.amount)==null?void 0:i.toString())??"0").toFixed(2)]})]},s)})})]})}):e.jsx("p",{className:"text-muted-foreground",children:"No line items."})]})]})}),y.links.length>1&&e.jsx("div",{className:"flex justify-center pt-6 flex-wrap gap-2",children:y.links.map((t,s)=>e.jsx(x,{disabled:!t.url,variant:t.active?"default":"outline",size:"sm",onClick:()=>Ue.visit(t.url||"",{preserveScroll:!0}),children:e.jsx("span",{dangerouslySetInnerHTML:{__html:t.label}})},s))})]})]})})]})})]})})}export{ft as default};
