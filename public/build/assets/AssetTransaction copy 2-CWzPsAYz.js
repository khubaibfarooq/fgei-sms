import{r as x,j as s,L as J}from"./app-C28Ysr6f.js";import{A as O,P as W,S as X,T as Y,t as c}from"./app-layout-baHr3Lg6.js";import{B as C}from"./button-ds1w0PuK.js";import{C as Z,a as ee,b as te,c as se}from"./card-d3SmSHed.js";import"./index-B2FUh1_L.js";import"./createLucideIcon-CCmX3eXl.js";import"./input-BMzvU3hM.js";import"./index-ixlLcOFU.js";import"./app-logo-icon-CQMd1bA1.js";import"./folder-root-B6MEOasQ.js";import"./grip-vertical-DxOP2Es3.js";const re=[{title:"Asset Transactions",href:"/asset-transactions"}],T=i=>{const p=i!=null&&typeof i.id=="number"&&i.id>0&&typeof i.name=="string"&&i.name.trim()!=="";return p||console.warn("Invalid item detected:",i),p};function be({fundHeads:i=[],assetCategories:p=[],assets:w=[],blocks:D=[]}){const[l,f]=x.useState([]),[j,S]=x.useState(w.filter(T).reduce((t,e)=>{const a=e.asset_category_id.toString();return t[a]=[...t[a]||[],e],t},{})),[A,F]=x.useState({}),[H,_]=x.useState({});x.useMemo(()=>{const t={};return l.forEach(e=>{if(e.fundHeadId&&e.amount&&e.isValid){const a=parseFloat(e.amount)||0;t[e.fundHeadId]=(t[e.fundHeadId]||0)+a}}),t},[l]);const y=x.useMemo(()=>{const t=l.filter(n=>n.isValid).length,e=l.reduce((n,d)=>{if(!d.isValid)return n;const r=parseInt(d.purchaseQty)||0;return n+r},0),a=l.reduce((n,d)=>{if(!d.isValid)return n;const r=parseFloat(d.amount)||0;return n+r},0);return{totalItems:t,totalPurchaseQty:e,totalAmount:a}},[l]),N=x.useMemo(()=>l.length>0&&l.every(t=>t.isValid),[l]),R=()=>{const t={id:Date.now(),fundHeadId:"",balance:0,blockId:"",roomId:"",assetCategoryId:"",assetId:"",currentQty:0,purchaseQty:"",amount:"",error:"",isValid:!1};f([...l,t])},K=t=>{f(l.filter(e=>e.id!==t)),c.success("Row removed")},$=(t,e)=>{if(!e){o(t,"balance",0);return}fetch(`/asset-trans/getbalance?id=${e}`).then(a=>a.json()).then(a=>{const n=a.balance||0;_(d=>({...d,[e]:n})),o(t,"balance",n)}).catch(a=>{console.error("Error fetching balance:",a),c.error("Failed to fetch balance"),o(t,"balance",0)})},E=(t,e)=>{if(!e){o(t,"roomId","");return}if(A[e]){o(t,"roomId","");return}fetch(`/asset-trans/getrooms?block_id=${e}`).then(a=>a.json()).then(a=>{const n=(a??[]).filter(d=>d.id&&d.name);console.log("Fetched rooms for block",e,n),F(d=>({...d,[e]:n})),o(t,"roomId","")}).catch(a=>{console.error("Error fetching rooms:",a),c.error("Failed to load rooms"),F(n=>({...n,[e]:[]}))})},L=t=>{requestAnimationFrame(()=>{const e=document.querySelector(`tr[data-row-id="${t}"] select[name="roomId"]`);e&&(e.focus(),e.classList.add("border-red-500","ring-2","ring-red-500"),setTimeout(()=>{e.classList.remove("border-red-500","ring-2","ring-red-500")},2e3))})},P=(t,e)=>{if(!e){o(t,"assetId",""),o(t,"currentQty",0);return}if(j[e]){o(t,"assetId",""),o(t,"currentQty",0);return}const a=l.find(r=>r.id===t),n=(a==null?void 0:a.roomId)??"";if(!n){c.error("Please select a Room before choosing an Asset Category."),L(t);return}const d=new URLSearchParams({id:e,room_id:n});fetch(`/asset-trans/getassets?${d.toString()}`).then(r=>r.json()).then(r=>{const g=(r.assets??[]).filter(T);S(h=>({...h,[e]:g})),o(t,"assetId",""),o(t,"currentQty",0)}).catch(r=>{console.error("Error fetching assets:",r),c.error("Failed to load assets"),S(g=>({...g,[e]:[]}))})},o=(t,e,a)=>{f(n=>n.map(d=>{var g;if(d.id!==t)return d;const r={...d,[e]:a,error:""};if((e==="blockId"||e==="roomId")&&(r.assetCategoryId="",r.assetId="",r.currentQty=0),e==="blockId"&&a!==d.blockId&&(E(t,a),r.roomId=""),e==="fundHeadId"&&a!==d.fundHeadId&&$(t,a),e==="assetCategoryId"&&(P(t,a),r.assetId="",r.currentQty=0),e==="assetId"&&a){const m=(j[d.assetCategoryId]||[]).find(k=>k.id.toString()===a);m&&(r.currentQty=m.current_qty??0)}if(e==="amount"||e==="fundHeadId"){const h=r.amount,m=r.fundHeadId,k=parseFloat(h)||0,Q=Math.round(k*100);if(r.isValid=!0,r.error="",m&&Q>0){const z=H[m]||0,V=Math.round(z*100),B=l.filter(b=>b.id!==d.id&&b.fundHeadId===m&&b.isValid).reduce((b,I)=>{const v=parseFloat(I.amount)||0;return b+Math.round(v*100)},0)+Q;if(B>V){const I=((B-V)/100).toFixed(2);r.error=`Exceeds by Rs ${parseFloat(I).toLocaleString()}`,r.isValid=!1;const v=((g=i.find(G=>G.id.toString()===m))==null?void 0:g.name)||"Fund";c.error(`Insufficient balance in "${v}"`)}}h&&!/^\d+(\.\d{1,2})?$/.test(h)&&(r.error="Max 2 decimal places",r.isValid=!1)}return r.isValid=!!(r.fundHeadId&&r.blockId&&r.roomId&&r.assetCategoryId&&r.assetId&&parseInt(r.purchaseQty)>0&&parseFloat(r.amount)>0&&!r.error),r}))},u=(t,e)=>{t.key==="Enter"&&t.shiftKey&&(t.preventDefault(),R())},q=t=>t?j[t]||[]:[],M=t=>t?A[t]||[]:[],U=()=>{if(l.length===0){c.error("Add at least one row");return}if(!N){c.error("Fix all errors before submitting");return}const t={items:l.map(e=>({fund_head_id:parseInt(e.fundHeadId),block_id:parseInt(e.blockId),room_id:parseInt(e.roomId),asset_id:parseInt(e.assetId),purchase_qty:parseInt(e.purchaseQty),amount:parseFloat(e.amount)})),total_amount:y.totalAmount};console.log("Submitting:",t),c.success("Transaction created!"),f([])};return s.jsxs(O,{breadcrumbs:re,children:[s.jsx(J,{title:"Create Asset Transaction"}),s.jsx("div",{className:"flex-1 p-3",children:s.jsxs(Z,{children:[s.jsx(ee,{className:"pb-3",children:s.jsxs("div",{className:"flex justify-between items-center",children:[s.jsx(te,{children:"Create Asset Transaction"}),s.jsxs(C,{onClick:R,children:[s.jsx(W,{className:"w-4 h-4 mr-2"}),"New Row"]})]})}),s.jsx(X,{}),s.jsxs(se,{className:"py-6",children:[s.jsx("div",{className:"overflow-x-auto border rounded-lg",children:s.jsxs("table",{className:"w-full border-collapse",children:[s.jsx("thead",{children:s.jsxs("tr",{className:"bg-[#0b431b] dark:bg-gray-800",children:[s.jsx("th",{className:"border p-2 text-left text-sm font-medium text-white dark:text-gray-200 w-[150px]",children:"Fund Head"}),s.jsx("th",{className:"border p-2 text-left text-sm font-medium text-white dark:text-gray-200 w-[100px]",children:"Balance"}),s.jsx("th",{className:"border p-2 text-left text-sm font-medium text-white dark:text-gray-200 w-[120px]",children:"Block"}),s.jsx("th",{className:"border p-2 text-left text-sm font-medium text-white dark:text-gray-200 w-[120px]",children:"Room"}),s.jsx("th",{className:"border p-2 text-left text-sm font-medium text-white dark:text-gray-200 w-[140px]",children:"Asset Category"}),s.jsx("th",{className:"border p-2 text-left text-sm font-medium text-white dark:text-gray-200 w-[160px]",children:"Asset"}),s.jsx("th",{className:"border p-2 text-left text-sm font-medium text-white dark:text-gray-200 w-[90px]",children:"Current Qty"}),s.jsx("th",{className:"border p-2 text-left text-sm font-medium text-white dark:text-gray-200 w-[100px]",children:"Purchase Qty"}),s.jsx("th",{className:"border p-2 text-left text-sm font-medium text-white dark:text-gray-200 w-[110px]",children:"Amount"}),s.jsx("th",{className:"border p-2 text-center text-sm font-medium text-white dark:text-gray-200 w-[70px]",children:"Action"})]})}),s.jsx("tbody",{children:l.length===0?s.jsx("tr",{children:s.jsx("td",{colSpan:10,className:"border p-12 text-center text-gray-500 dark:text-gray-400",children:'No transactions added. Click "New Row" to start.'})}):l.map(t=>s.jsxs("tr",{className:"hover:bg-gray-50 dark:hover:bg-gray-700",children:[s.jsx("td",{className:"border p-2",children:s.jsxs("select",{value:t.fundHeadId,onChange:e=>o(t.id,"fundHeadId",e.target.value),onKeyDown:e=>u(e,t.id),className:"w-full px-2 py-1.5 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 text-sm dark:bg-gray-800 dark:border-gray-600 dark:text-white",children:[s.jsx("option",{value:"",children:"Select Fund"}),i.map(e=>s.jsx("option",{value:e.id,children:e.name},e.id))]})}),s.jsx("td",{className:"border p-2",children:s.jsx("input",{type:"text",value:t.balance>0?`Rs ${t.balance.toLocaleString()}`:"-",disabled:!0,className:"w-full px-2 py-1.5 border border-gray-300 rounded-md bg-gray-100 text-gray-700 text-sm dark:bg-gray-700 dark:border-gray-600 dark:text-gray-300"})}),s.jsx("td",{className:"border p-2",children:s.jsxs("select",{value:t.blockId,onChange:e=>o(t.id,"blockId",e.target.value),onKeyDown:e=>u(e,t.id),className:"w-full px-2 py-1.5 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 text-sm dark:bg-gray-800 dark:border-gray-600 dark:text-white",children:[s.jsx("option",{value:"",children:"Select Block"}),D.map(e=>s.jsx("option",{value:e.id,children:e.name},e.id))]})}),s.jsx("td",{className:"border p-2",children:s.jsxs("select",{value:t.roomId,onChange:e=>o(t.id,"roomId",e.target.value),onKeyDown:e=>u(e,t.id),className:"w-full px-2 py-1.5 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 text-sm dark:bg-gray-800 dark:border-gray-600 dark:text-white disabled:opacity-50",disabled:!t.blockId,children:[s.jsx("option",{value:"",children:"Select Room"}),M(t.blockId).map(e=>s.jsx("option",{value:e.id,children:e.name},e.id))]})}),s.jsx("td",{className:"border p-2",children:s.jsxs("select",{value:t.assetCategoryId,onChange:e=>o(t.id,"assetCategoryId",e.target.value),onKeyDown:e=>u(e,t.id),disabled:!t.roomId,className:`w-full px-2 py-1.5 border rounded-md focus:outline-none focus:ring-2 text-sm dark:bg-gray-800 dark:border-gray-600 dark:text-white disabled:opacity-50 disabled:cursor-not-allowed ${t.roomId?"border-gray-300 focus:ring-green-500":"border-gray-300"}`,children:[s.jsx("option",{value:"",children:"Select Category"}),p.map(e=>s.jsx("option",{value:e.id,children:e.name},e.id))]})}),s.jsx("td",{className:"border p-2",children:s.jsxs("select",{value:t.assetId,onChange:e=>o(t.id,"assetId",e.target.value),onKeyDown:e=>u(e,t.id),className:"w-full px-2 py-1.5 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 text-sm dark:bg-gray-800 dark:border-gray-600 dark:text-white disabled:opacity-50",disabled:!t.assetCategoryId,children:[s.jsx("option",{value:"",children:"Select Asset"}),q(t.assetCategoryId).map(e=>s.jsx("option",{value:e.id,children:e.name},e.id))]})}),s.jsx("td",{className:"border p-2",children:s.jsx("input",{type:"text",value:t.currentQty,disabled:!0,className:"w-full px-2 py-1.5 border border-gray-300 rounded-md bg-gray-100 text-gray-700 text-sm dark:bg-gray-700 dark:border-gray-600 dark:text-gray-300"})}),s.jsx("td",{className:"border p-2",children:s.jsx("input",{type:"number",value:t.purchaseQty,onChange:e=>o(t.id,"purchaseQty",e.target.value),onKeyDown:e=>u(e,t.id),placeholder:"0",min:"0",className:"w-full px-2 py-1.5 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 text-sm dark:bg-gray-800 dark:border-gray-600 dark:text-white"})}),s.jsx("td",{className:"border p-2",children:s.jsxs("div",{className:"relative",children:[s.jsx("input",{type:"number",value:t.amount,onChange:e=>o(t.id,"amount",e.target.value),onKeyDown:e=>u(e,t.id),placeholder:"0.00",min:"0",step:"0.01",className:`w-full px-2 py-1.5 border rounded-md focus:outline-none focus:ring-2 text-sm dark:bg-gray-800 dark:border-gray-600 dark:text-white ${t.error?"border-red-500 focus:ring-red-500":"border-gray-300 focus:ring-green-500"}`}),t.error&&s.jsx("p",{className:"absolute left-0 -bottom-5 text-xs text-red-600 font-medium",children:t.error})]})}),s.jsx("td",{className:"border p-2 text-center",children:s.jsx(C,{variant:"destructive",size:"sm",onClick:()=>K(t.id),children:s.jsx(Y,{className:"w-4 h-4"})})})]},t.id))})]})}),l.length>0&&s.jsxs("div",{className:"mt-10 space-y-4",children:[s.jsxs("div",{className:"flex justify-end gap-8 p-4 bg-muted/50 rounded-lg",children:[s.jsxs("div",{className:"text-right",children:[s.jsx("p",{className:"text-sm text-muted-foreground",children:"Valid Items"}),s.jsx("p",{className:"text-lg font-bold",children:y.totalItems})]}),s.jsxs("div",{className:"text-right",children:[s.jsx("p",{className:"text-sm text-muted-foreground",children:"Total Qty"}),s.jsx("p",{className:"text-lg font-bold",children:y.totalPurchaseQty})]}),s.jsxs("div",{className:"text-right",children:[s.jsx("p",{className:"text-sm text-muted-foreground",children:"Total Amount"}),s.jsxs("p",{className:"text-lg font-bold text-green-600",children:["Rs ",y.totalAmount.toLocaleString("en-PK",{minimumFractionDigits:2})]})]})]}),s.jsx("div",{className:"flex justify-end",children:s.jsx(C,{onClick:U,size:"lg",disabled:!N,className:N?"":"opacity-50 cursor-not-allowed",children:"Create Transaction"})})]}),s.jsx("div",{className:"mt-4 p-3 bg-blue-50 dark:bg-blue-950 border border-blue-200 dark:border-blue-800 rounded-lg",children:s.jsxs("p",{className:"text-sm text-blue-800 dark:text-blue-200",children:["Tip: Press ",s.jsx("kbd",{className:"px-2 py-1 bg-white dark:bg-gray-800 border border-blue-300 dark:border-blue-700 rounded text-xs",children:"Shift"})," +"," ",s.jsx("kbd",{className:"px-2 py-1 bg-white dark:bg-gray-800 border border-blue-300 dark:border-blue-700 rounded text-xs",children:"Enter"})," to add a new row"]})})]})]})})]})}export{be as default};
