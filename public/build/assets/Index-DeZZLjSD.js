var se=Object.defineProperty;var te=(i,r,o)=>r in i?se(i,r,{enumerable:!0,configurable:!0,writable:!0,value:o}):i[r]=o;var B=(i,r,o)=>te(i,typeof r!="symbol"?r+"":r,o);import{r as d,j as e,L as ae,S as re}from"./app-BXWdbT3W.js";import{t as S,A as le,F as I,S as L,C as ne,b as de,E as oe}from"./app-layout-Doi0KVTf.js";import{B as p}from"./button-BFkT9mtK.js";import{C as U,a as P,b as M,c as $}from"./card-BDnz_o05.js";import{I as w}from"./input-CCK7i7iJ.js";import{S as H,a as z,b as V,c as q,d as m}from"./select-Da3d1HpX.js";import{D as ce,a as ie,b as me,c as he}from"./dialog-08bPxLgP.js";import{l as pe}from"./lodash-ClSdgtDf.js";import{E as xe,F as ue,a as je,b as fe}from"./jspdf.plugin.autotable-B3FtMoLI.js";import{f as j}from"./dateFormatter-Cn65gwBN.js";import{L as ye}from"./app-logo-icon-C8DOsSBs.js";import"./index-BXO_TbJ_.js";import"./createLucideIcon-Cy-08o9H.js";import"./index-DQwmPEEX.js";import"./folder-root-C0viIaEW.js";import"./grip-vertical-DlxMNeB8.js";import"./index-CSHwwGYQ.js";import"./index-BpVRCxRJ.js";const Ne=[{title:"Transactions",href:"/transactions"},{title:"Transactions",href:"/transactions"}];class be extends d.Component{constructor(){super(...arguments);B(this,"state",{hasError:!1,error:null})}static getDerivedStateFromError(o){return{hasError:!0,error:o.message}}componentDidCatch(o,f){console.error("ErrorBoundary:",o,f),S.error("An error occurred. Please try again.")}render(){return this.state.hasError?e.jsxs("div",{className:"p-4",children:[e.jsxs("p",{className:"text-red-600",children:["Error: ",this.state.error]}),e.jsx(p,{onClick:()=>window.location.reload(),className:"mt-2",children:"Retry"})]}):this.props.children}}function $e({transactions:i,filters:r}){var k,D,E;const[o,f]=d.useState(r.search||""),[y,O]=d.useState(r.type||""),[N,W]=d.useState(r.status||""),[b,X]=d.useState(r.date_from||""),[g,J]=d.useState(r.date_to||""),[h,Q]=d.useState(i),[Y,v]=d.useState(!1),[l,A]=d.useState(null),[C,_]=d.useState([]),[T,F]=d.useState(!1),G=async()=>{const s=new xe.Workbook,t=s.addWorksheet("Transactions");t.columns=[{header:"ID",key:"id",width:10},{header:"Amount",key:"amount",width:15},{header:"Type",key:"type",width:12},{header:"Status",key:"status",width:12},{header:"Institute",key:"institute",width:30},{header:"Added By",key:"added_by",width:25},{header:"Approved By",key:"approved_by",width:25},{header:"Date",key:"date",width:18}],h.data.forEach(n=>{var x,u,R;t.addRow({id:n.id,amount:`${parseFloat(n.total_amount.toString()).toFixed(2)}`,type:n.type.charAt(0).toUpperCase()+n.type.slice(1),status:n.status.charAt(0).toUpperCase()+n.status.slice(1),institute:((x=n.institute)==null?void 0:x.name)||"N/A",added_by:((u=n.added_by)==null?void 0:u.name)||"N/A",approved_by:((R=n.approved_by)==null?void 0:R.name)||"N/A",date:j(n.created_at)})});const c=await s.xlsx.writeBuffer(),a=new Blob([c],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"});ue.saveAs(a,"Transactions_Report.xlsx")},K=()=>{const s=new je;s.setFontSize(16),s.text("Transactions Report",14,15);const t=["ID","Amount","Type","Status","Institute","Added By","Approved By","Date"],c=h.data.map(a=>{var n,x,u;return[a.id.toString(),`${parseFloat(a.total_amount.toString()).toFixed(2)}`,a.type.charAt(0).toUpperCase()+a.type.slice(1),a.status.charAt(0).toUpperCase()+a.status.slice(1),((n=a.institute)==null?void 0:n.name)||"N/A",((x=a.added_by)==null?void 0:x.name)||"N/A",((u=a.approved_by)==null?void 0:u.name)||"N/A",j(a.created_at)]});fe(s,{head:[t],body:c,startY:25,styles:{fontSize:9,cellPadding:2},headStyles:{fillColor:[46,124,196],textColor:255,fontStyle:"bold"},alternateRowStyles:{fillColor:[240,240,240]}}),s.save("Transactions_Report.pdf")},Z=d.useMemo(()=>pe.debounce(()=>{const s=new URLSearchParams({search:o.trim(),type:y||"",status:N||"",date_from:b||"",date_to:g||""});fetch(`/transactions/gettransactions?${s.toString()}`,{headers:{"X-Requested-With":"XMLHttpRequest",Accept:"application/json"}}).then(t=>{if(!t.ok)throw new Error("Network error");return t.json()}).then(t=>{Q(t)}).catch(t=>{console.error("Fetch error:",t),S.error("Failed to load transactions")})},400),[o,,y,N,b,g]),ee=async s=>{F(!0);try{const t=await fetch(`/transactions/getbytid?tid=${s}`);if(!t.ok)throw new Error("Failed to load details");const{transaction:c,transdetails:a}=await t.json();A(c),console.log("Transaction Details:",a),_(a),v(!0)}catch(t){S.error("Could not load transaction details"),console.error(t)}finally{F(!1)}};return d.useEffect(()=>()=>{v(!1),A(null),_([])},[]),e.jsx(be,{children:e.jsxs(le,{breadcrumbs:Ne,children:[e.jsx(ae,{title:"Transactions Report"}),e.jsx("div",{className:"flex-1 p-1 md:p-1",children:e.jsxs("div",{className:"flex flex-col md:flex-row gap-3",children:[e.jsx("div",{className:"w-full md:w-1/4",children:e.jsxs(U,{children:[e.jsxs(P,{children:[e.jsx(M,{className:"text-xl font-bold flex items-center gap-2",children:"Filters"}),e.jsx("p",{className:"text-muted-foreground text-sm",children:"Refine transaction search"})]}),e.jsxs($,{className:"space-y-4",children:[e.jsx(w,{placeholder:"Search by ID, amount, type...",value:o,onChange:s=>f(s.target.value)}),e.jsxs(H,{value:y,onValueChange:O,children:[e.jsx(z,{children:e.jsx(V,{placeholder:"Select Type"})}),e.jsxs(q,{children:[e.jsx(m,{value:"0",children:"All Types"}),e.jsx(m,{value:"purchase",children:"Purchase"}),e.jsx(m,{value:"maintenance",children:"Maintenance"}),e.jsx(m,{value:"condemned",children:"Condemned"})]})]}),e.jsxs(H,{value:N,onValueChange:W,children:[e.jsx(z,{children:e.jsx(V,{placeholder:"Select Status"})}),e.jsxs(q,{children:[e.jsx(m,{value:"0",children:"All Status"}),e.jsx(m,{value:"pending",children:"Pending"}),e.jsx(m,{value:"approved",children:"Approved"}),e.jsx(m,{value:"rejected",children:"Rejected"})]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(w,{type:"date",value:b,onChange:s=>X(s.target.value),className:"flex-1"}),e.jsx(w,{type:"date",value:g,onChange:s=>J(s.target.value),className:"flex-1"})]}),e.jsx(p,{onClick:Z,className:"w-full",children:"Apply Filters"})]})]})}),e.jsx("div",{className:"w-full md:w-full",children:e.jsxs(U,{children:[e.jsxs(P,{className:"pb-3 flex flex-col md:flex-row md:items-center md:justify-between gap-4",children:[e.jsx("div",{children:e.jsxs(M,{className:"text-2xl font-bold flex items-center gap-2",children:[e.jsx(I,{className:"w-6 h-6"}),"Transactions Report"]})}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(p,{onClick:K,className:"w-full md:w-auto",children:"Export PDF"}),e.jsx(p,{onClick:G,className:"w-full md:w-auto",children:"Export Excel"})]})]}),e.jsx(L,{}),e.jsxs($,{className:"pt-6 space-y-6",children:[e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full border-collapse text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-primary text-white text-center",children:[e.jsx("th",{className:"border p-2 font-medium",children:"ID"}),e.jsx("th",{className:"border p-2 font-medium",children:"Amount"}),e.jsx("th",{className:"border p-2 font-medium",children:"Type"}),e.jsx("th",{className:"border p-2 font-medium",children:"Status"}),e.jsx("th",{className:"border p-2 font-medium",children:"Added By"}),e.jsx("th",{className:"border p-2 font-medium",children:"Approved By"}),e.jsx("th",{className:"border p-2 font-medium",children:"Date"})]})}),e.jsx("tbody",{children:h.data.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:9,className:"text-center p-4 text-muted-foreground",children:"No transactions found."})}):h.data.map(s=>{var t,c;return e.jsxs("tr",{className:"hover:bg-gray-50 dark:hover:bg-gray-700 text-center",children:[e.jsxs("td",{className:"border p-2",children:["#",s.id]}),e.jsx("td",{className:"border p-2 font-medium",children:parseFloat(s.total_amount.toString()).toFixed(2)}),e.jsx("td",{className:"border p-2",children:e.jsx("span",{className:`px-2 py-1 rounded text-xs font-medium ${s.type==="income"?"bg-green-100 text-green-800":"bg-red-100 text-red-800"}`,children:s.type.charAt(0).toUpperCase()+s.type.slice(1)})}),e.jsx("td",{className:"border p-2",children:e.jsxs("span",{className:`px-2 py-1 rounded text-xs font-medium flex items-center justify-center gap-1 ${s.status==="approved"?"bg-green-100 text-green-800":s.status==="rejected"?"bg-red-100 text-red-800":"bg-yellow-100 text-yellow-800"}`,children:[s.status==="approved"&&e.jsx(ne,{className:"w-3 h-3"}),s.status==="rejected"&&e.jsx(de,{className:"w-3 h-3"}),s.status.charAt(0).toUpperCase()+s.status.slice(1)]})}),e.jsx("td",{className:"border p-2",children:((t=s.added_by)==null?void 0:t.name)||"N/A"}),e.jsx("td",{className:"border p-2",children:((c=s.approved_by)==null?void 0:c.name)||"N/A"}),e.jsx("td",{className:"border p-2 text-xs",children:j(s.created_at)}),e.jsx("td",{className:"border p-2",children:e.jsx("div",{className:"flex items-center justify-center gap-2",children:e.jsx(p,{size:"icon",variant:"ghost",className:"h-8 w-8",onClick:()=>ee(s.id),disabled:T,title:"View details",children:T?e.jsx(ye,{className:"h-4 w-4 animate-spin"}):e.jsx(oe,{className:"h-4 w-4"})})})})]},s.id)})})]})}),e.jsx(ce,{open:Y,onOpenChange:v,children:e.jsxs(ie,{className:"max-w-4xl max-h-[90vh] overflow-y-auto",children:[e.jsx(me,{children:e.jsxs(he,{className:"flex items-center gap-2",children:[e.jsx(I,{className:"w-5 h-5"}),"Transaction #",l==null?void 0:l.id]})}),l&&e.jsxs("div",{className:"mt-4 space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Amount:"})," RS ",parseFloat(l.total_amount.toString()).toFixed(2)]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Type:"})," ",l.type.charAt(0).toUpperCase()+l.type.slice(1)]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Status:"})," ",l.status.charAt(0).toUpperCase()+l.status.slice(1)]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Institute:"})," ",((k=l.institute)==null?void 0:k.name)||"N/A"]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Added By:"})," ",((D=l.added_by)==null?void 0:D.name)||"N/A"]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Approved By:"})," ",((E=l.approved_by)==null?void 0:E.name)||"N/A"]}),e.jsxs("div",{className:"col-span-2",children:[e.jsx("span",{className:"font-medium",children:"Date:"})," ",j(l.created_at)]})]}),e.jsx(L,{}),C.length?e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full text-sm border",children:[e.jsx("thead",{className:"bg-muted",children:e.jsxs("tr",{children:[e.jsx("th",{className:"border p-2 text-left",children:"Asset"}),e.jsx("th",{className:"border p-2 text-left",children:"Room"}),e.jsx("th",{className:"border p-2 text-left",children:"Fund Head"}),e.jsx("th",{className:"border p-2 text-left",children:"Qty"}),e.jsx("th",{className:"border p-2 text-left",children:"Amount"})]})}),e.jsx("tbody",{children:C.map((s,t)=>{var c;return e.jsxs("tr",{className:"hover:bg-muted/50",children:[e.jsx("td",{className:"border p-2",children:s.asset_name||"-"}),e.jsx("td",{className:"border p-2",children:s.room_name||"-"}),e.jsx("td",{className:"border p-2",children:s.fund_head_name||"-"}),e.jsx("td",{className:"border p-2",children:s.qty??"-"}),e.jsxs("td",{className:"border p-2",children:["RS ",parseFloat(((c=s.amount)==null?void 0:c.toString())??"0").toFixed(2)]})]},t)})})]})}):e.jsx("p",{className:"text-muted-foreground",children:"No line items."})]})]})}),h.links.length>1&&e.jsx("div",{className:"flex justify-center pt-6 flex-wrap gap-2",children:h.links.map((s,t)=>e.jsx(p,{disabled:!s.url,variant:s.active?"default":"outline",size:"sm",onClick:()=>re.visit(s.url||"",{preserveScroll:!0}),children:e.jsx("span",{dangerouslySetInnerHTML:{__html:s.label}})},t))})]})]})})]})})]})})}export{$e as default};
