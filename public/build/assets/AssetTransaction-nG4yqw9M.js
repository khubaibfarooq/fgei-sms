import{r as c,j as s,L as X,S as Y}from"./app-CDVeMlka.js";import{A as Z,P as ee,S as te,T as se,t as m}from"./app-layout-LvVTmpW3.js";import{B as R}from"./button-6jy4ufwO.js";import{C as re,a as ae,b as ne,c as de}from"./card-DMxJn-Ye.js";import"./index-B0Nt-_Tv.js";import"./createLucideIcon-DkXhdVW-.js";import"./input-CGNcfnz8.js";import"./index-DzK4CTqK.js";import"./app-logo-icon-ZDHluetb.js";import"./folder-root-BnSihRkf.js";import"./grip-vertical-DQ0YnvhJ.js";const oe=[{title:"Asset Transactions",href:"/asset-transactions"}],_=i=>{const b=i!=null&&typeof i.id=="number"&&i.id>0&&typeof i.name=="string"&&i.name.trim()!=="";return b||console.warn("Invalid item detected:",i),b};function je({fundHeads:i=[],assetCategories:b=[],assets:H=[],blocks:P=[]}){const[T,N]=c.useState(null),[f,E]=c.useState(""),[l,y]=c.useState([]),[k,v]=c.useState(H.filter(_).reduce((t,e)=>{const r=e.asset_category_id.toString();return t[r]=[...t[r]||[],e],t},{})),[Q,C]=c.useState({}),[K,w]=c.useState({});c.useMemo(()=>{const t={};return l.forEach(e=>{if(e.fundHeadId&&e.amount&&e.isValid){const r=parseFloat(e.amount)||0;t[e.fundHeadId]=(t[e.fundHeadId]||0)+r}}),t},[l]);const j=c.useMemo(()=>{const t=l.filter(d=>d.isValid).length,e=l.reduce((d,n)=>{if(!n.isValid)return d;const a=parseInt(n.purchaseQty)||0;return d+a},0),r=l.reduce((d,n)=>{if(!n.isValid)return d;const a=parseFloat(n.amount)||0;return d+a},0);return{totalItems:t,totalPurchaseQty:e,totalAmount:r}},[l]),I=c.useMemo(()=>l.length>0&&l.every(t=>t.isValid),[l]),B=()=>{const t={id:Date.now(),fundHeadId:"",balance:0,blockId:"",roomId:"",assetCategoryId:"",assetId:"",currentQty:0,purchaseQty:"",amount:"",error:"",isValid:!1};y([...l,t])},L=t=>{y(l.filter(e=>e.id!==t)),m.success("Row removed")},q=(t,e)=>{if(!e){o(t,"balance",0);return}fetch(`/asset-trans/getbalance?id=${e}`).then(r=>r.json()).then(r=>{const d=r.balance||0;w(n=>({...n,[e]:d})),o(t,"balance",d)}).catch(r=>{console.error("Error fetching balance:",r),m.error("Failed to fetch balance"),o(t,"balance",0)})},M=(t,e)=>{if(!e){o(t,"roomId","");return}if(Q[e]){o(t,"roomId","");return}fetch(`/asset-trans/getrooms?block_id=${e}`).then(r=>r.json()).then(r=>{const d=(r??[]).filter(n=>n.id&&n.name);console.log("Fetched rooms for block",e,d),C(n=>({...n,[e]:d})),o(t,"roomId","")}).catch(r=>{console.error("Error fetching rooms:",r),m.error("Failed to load rooms"),C(d=>({...d,[e]:[]}))})},U=t=>{requestAnimationFrame(()=>{const e=document.querySelector(`tr[data-row-id="${t}"] select[name="roomId"]`);e&&(e.focus(),e.classList.add("border-red-500","ring-2","ring-red-500"),setTimeout(()=>{e.classList.remove("border-red-500","ring-2","ring-red-500")},2e3))})},z=(t,e)=>{if(!e){o(t,"assetId",""),o(t,"currentQty",0);return}if(k[e]){o(t,"assetId",""),o(t,"currentQty",0);return}const r=l.find(a=>a.id===t),d=(r==null?void 0:r.roomId)??"";if(!d){m.error("Please select a Room before choosing an Asset Category."),U(t);return}const n=new URLSearchParams({id:e,room_id:d});fetch(`/asset-trans/getassets?${n.toString()}`).then(a=>a.json()).then(a=>{const h=(a.assets??[]).filter(_);v(g=>({...g,[e]:h})),o(t,"assetId",""),o(t,"currentQty",0)}).catch(a=>{console.error("Error fetching assets:",a),m.error("Failed to load assets"),v(h=>({...h,[e]:[]}))})},o=(t,e,r)=>{y(d=>d.map(n=>{var h;if(n.id!==t)return n;const a={...n,[e]:r,error:""};if((e==="blockId"||e==="roomId")&&(a.assetCategoryId="",a.assetId="",a.currentQty=0),e==="blockId"&&r!==n.blockId&&(M(t,r),a.roomId=""),e==="fundHeadId"&&r!==n.fundHeadId&&q(t,r),e==="assetCategoryId"&&(z(t,r),a.assetId="",a.currentQty=0),e==="assetId"&&r){const x=(k[n.assetCategoryId]||[]).find(S=>S.id.toString()===r);x&&(a.currentQty=x.current_qty??0)}if(e==="amount"||e==="fundHeadId"){const g=a.amount,x=a.fundHeadId,S=parseFloat(g)||0,V=Math.round(S*100);if(a.isValid=!0,a.error="",x&&V>0){const W=K[x]||0,$=Math.round(W*100),D=l.filter(p=>p.id!==n.id&&p.fundHeadId===x&&p.isValid).reduce((p,F)=>{const A=parseFloat(F.amount)||0;return p+Math.round(A*100)},0)+V;if(D>$){const F=((D-$)/100).toFixed(2);a.error=`Exceeds by Rs ${parseFloat(F).toLocaleString()}`,a.isValid=!1,(h=i.find(A=>A.id.toString()===x))!=null&&h.name}}g&&!/^\d+(\.\d{1,2})?$/.test(g)&&(a.error="Max 2 decimal places",a.isValid=!1)}return a.isValid=!!(a.fundHeadId&&a.blockId&&a.roomId&&a.assetCategoryId&&a.assetId&&parseInt(a.purchaseQty)>0&&parseFloat(a.amount)>0&&!a.error),a}))},u=(t,e)=>{t.key==="Enter"&&t.shiftKey&&(t.preventDefault(),B())},G=t=>t?k[t]||[]:[],J=t=>t?Q[t]||[]:[],O=()=>{if(!I)return m.error("Fix errors");const t=new FormData;if(t.append("total_amount",j.totalAmount.toFixed(2)),T&&t.append("bill_img",T),f==null||f=="")return m.error("Please select Transaction Type");t.append("type",f),l.forEach((e,r)=>{t.append(`items[${r}][fund_head_id]`,e.fundHeadId),t.append(`items[${r}][block_id]`,e.blockId),t.append(`items[${r}][room_id]`,e.roomId),t.append(`items[${r}][asset_id]`,e.assetId),t.append(`items[${r}][purchase_qty]`,e.purchaseQty),t.append(`items[${r}][amount]`,e.amount)}),Y.post("/asset-transactions",t,{forceFormData:!0,onSuccess:()=>{y([]),N(null),w({}),C({}),v({}),N(null),m.success("Transaction created successfully!")},onError:e=>{console.error("Validation errors:",e),m.error("Please fix the highlighted errors.")}})};return s.jsxs(Z,{breadcrumbs:oe,children:[s.jsx(X,{title:"Create Asset Transaction"}),s.jsx("div",{className:"flex-1 p-3",children:s.jsxs(re,{children:[s.jsx(ae,{className:"pb-3",children:s.jsxs("div",{className:"flex justify-between items-center",children:[s.jsx(ne,{children:"Create Asset Transaction"}),s.jsxs(R,{onClick:B,children:[s.jsx(ee,{className:"w-4 h-4 mr-2"}),"New Row"]})]})}),s.jsx(te,{}),s.jsxs(de,{className:"py-6",children:[s.jsxs("div",{className:"mb-6",children:[s.jsxs("label",{className:"block text-sm font-medium mb-2",children:["Transaction Type ",s.jsx("span",{className:"text-red-500",children:"*"})]}),s.jsxs("select",{value:f,onChange:t=>E(t.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 text-sm",required:!0,children:[s.jsx("option",{value:"",children:"Select Type"}),s.jsx("option",{value:"purchase",children:"Purchase"}),s.jsx("option",{value:"maintenance",children:"Maintenance"}),s.jsx("option",{value:"condemned",children:"Condemned"})]})]}),s.jsxs("div",{className:"mb-6",children:[s.jsx("label",{className:"block text-sm font-medium mb-2",children:"Bill Image"}),s.jsx("input",{type:"file",accept:"image/*",onChange:t=>{var e;return N(((e=t.target.files)==null?void 0:e[0])??null)},className:"file-input"})]}),s.jsx("div",{className:"overflow-x-auto border rounded-lg",children:s.jsxs("table",{className:"w-full border-collapse",children:[s.jsx("thead",{children:s.jsxs("tr",{className:"bg-[#0b431b] dark:bg-gray-800",children:[s.jsx("th",{className:"border p-2 text-left text-sm font-medium text-white dark:text-gray-200 w-[150px]",children:"Fund Head"}),s.jsx("th",{className:"border p-2 text-left text-sm font-medium text-white dark:text-gray-200 w-[100px]",children:"Balance"}),s.jsx("th",{className:"border p-2 text-left text-sm font-medium text-white dark:text-gray-200 w-[120px]",children:"Block"}),s.jsx("th",{className:"border p-2 text-left text-sm font-medium text-white dark:text-gray-200 w-[120px]",children:"Room"}),s.jsx("th",{className:"border p-2 text-left text-sm font-medium text-white dark:text-gray-200 w-[140px]",children:"Asset Category"}),s.jsx("th",{className:"border p-2 text-left text-sm font-medium text-white dark:text-gray-200 w-[160px]",children:"Asset"}),s.jsx("th",{className:"border p-2 text-left text-sm font-medium text-white dark:text-gray-200 w-[90px]",children:"Current Qty"}),s.jsx("th",{className:"border p-2 text-left text-sm font-medium text-white dark:text-gray-200 w-[100px]",children:"Purchase Qty"}),s.jsx("th",{className:"border p-2 text-left text-sm font-medium text-white dark:text-gray-200 w-[110px]",children:"Amount"}),s.jsx("th",{className:"border p-2 text-center text-sm font-medium text-white dark:text-gray-200 w-[70px]",children:"Action"})]})}),s.jsx("tbody",{children:l.length===0?s.jsx("tr",{children:s.jsx("td",{colSpan:10,className:"border p-12 text-center text-gray-500 dark:text-gray-400",children:'No transactions added. Click "New Row" to start.'})}):l.map(t=>s.jsxs("tr",{className:"hover:bg-gray-50 dark:hover:bg-gray-700",children:[s.jsx("td",{className:"border p-2",children:s.jsxs("select",{value:t.fundHeadId,onChange:e=>o(t.id,"fundHeadId",e.target.value),onKeyDown:e=>u(e,t.id),className:"w-full px-2 py-1.5 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 text-sm dark:bg-gray-800 dark:border-gray-600 dark:text-white",children:[s.jsx("option",{value:"",children:"Select Fund"}),i.map(e=>s.jsx("option",{value:e.id,children:e.name},e.id))]})}),s.jsx("td",{className:"border p-2",children:s.jsx("input",{type:"text",value:t.balance>0?`Rs ${t.balance.toLocaleString()}`:"-",disabled:!0,className:"w-full px-2 py-1.5 border border-gray-300 rounded-md bg-gray-100 text-gray-700 text-sm dark:bg-gray-700 dark:border-gray-600 dark:text-gray-300"})}),s.jsx("td",{className:"border p-2",children:s.jsxs("select",{value:t.blockId,onChange:e=>o(t.id,"blockId",e.target.value),onKeyDown:e=>u(e,t.id),className:"w-full px-2 py-1.5 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 text-sm dark:bg-gray-800 dark:border-gray-600 dark:text-white",children:[s.jsx("option",{value:"",children:"Select Block"}),P.map(e=>s.jsx("option",{value:e.id,children:e.name},e.id))]})}),s.jsx("td",{className:"border p-2",children:s.jsxs("select",{value:t.roomId,onChange:e=>o(t.id,"roomId",e.target.value),onKeyDown:e=>u(e,t.id),className:"w-full px-2 py-1.5 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 text-sm dark:bg-gray-800 dark:border-gray-600 dark:text-white disabled:opacity-50",disabled:!t.blockId,children:[s.jsx("option",{value:"",children:"Select Room"}),J(t.blockId).map(e=>s.jsx("option",{value:e.id,children:e.name},e.id))]})}),s.jsx("td",{className:"border p-2",children:s.jsxs("select",{value:t.assetCategoryId,onChange:e=>o(t.id,"assetCategoryId",e.target.value),onKeyDown:e=>u(e,t.id),disabled:!t.roomId,className:`w-full px-2 py-1.5 border rounded-md focus:outline-none focus:ring-2 text-sm dark:bg-gray-800 dark:border-gray-600 dark:text-white disabled:opacity-50 disabled:cursor-not-allowed ${t.roomId?"border-gray-300 focus:ring-green-500":"border-gray-300"}`,children:[s.jsx("option",{value:"",children:"Select Category"}),b.map(e=>s.jsx("option",{value:e.id,children:e.name},e.id))]})}),s.jsx("td",{className:"border p-2",children:s.jsxs("select",{value:t.assetId,onChange:e=>o(t.id,"assetId",e.target.value),onKeyDown:e=>u(e,t.id),className:"w-full px-2 py-1.5 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 text-sm dark:bg-gray-800 dark:border-gray-600 dark:text-white disabled:opacity-50",disabled:!t.assetCategoryId,children:[s.jsx("option",{value:"",children:"Select Asset"}),G(t.assetCategoryId).map(e=>s.jsx("option",{value:e.id,children:e.name},e.id))]})}),s.jsx("td",{className:"border p-2",children:s.jsx("input",{type:"text",value:t.currentQty,disabled:!0,className:"w-full px-2 py-1.5 border border-gray-300 rounded-md bg-gray-100 text-gray-700 text-sm dark:bg-gray-700 dark:border-gray-600 dark:text-gray-300"})}),s.jsx("td",{className:"border p-2",children:s.jsx("input",{type:"number",value:t.purchaseQty,onChange:e=>o(t.id,"purchaseQty",e.target.value),onKeyDown:e=>u(e,t.id),placeholder:"0",min:"0",className:"w-full px-2 py-1.5 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 text-sm dark:bg-gray-800 dark:border-gray-600 dark:text-white"})}),s.jsx("td",{className:"border p-2",children:s.jsxs("div",{className:"relative",children:[s.jsx("input",{type:"number",value:t.amount,onChange:e=>o(t.id,"amount",e.target.value),onKeyDown:e=>u(e,t.id),placeholder:"0.00",min:"0",step:"0.01",className:`w-full px-2 py-1.5 border rounded-md focus:outline-none focus:ring-2 text-sm dark:bg-gray-800 dark:border-gray-600 dark:text-white ${t.error?"border-red-500 focus:ring-red-500":"border-gray-300 focus:ring-green-500"}`}),t.error&&s.jsx("p",{className:"absolute left-0 -bottom-5 text-xs text-red-600 font-medium",children:t.error})]})}),s.jsx("td",{className:"border p-2 text-center",children:s.jsx(R,{variant:"destructive",size:"sm",onClick:()=>L(t.id),children:s.jsx(se,{className:"w-4 h-4"})})})]},t.id))})]})}),l.length>0&&s.jsxs("div",{className:"mt-10 space-y-4",children:[s.jsxs("div",{className:"flex justify-end gap-8 p-4 bg-muted/50 rounded-lg",children:[s.jsxs("div",{className:"text-right",children:[s.jsx("p",{className:"text-sm text-muted-foreground",children:"Valid Items"}),s.jsx("p",{className:"text-lg font-bold",children:j.totalItems})]}),s.jsxs("div",{className:"text-right",children:[s.jsx("p",{className:"text-sm text-muted-foreground",children:"Total Qty"}),s.jsx("p",{className:"text-lg font-bold",children:j.totalPurchaseQty})]}),s.jsxs("div",{className:"text-right",children:[s.jsx("p",{className:"text-sm text-muted-foreground",children:"Total Amount"}),s.jsxs("p",{className:"text-lg font-bold text-green-600",children:["Rs ",j.totalAmount.toLocaleString("en-PK",{minimumFractionDigits:2})]})]})]}),s.jsx("div",{className:"flex justify-end",children:s.jsx(R,{onClick:O,size:"lg",disabled:!I,className:I?"":"opacity-50 cursor-not-allowed",children:"Create Transaction"})})]}),s.jsx("div",{className:"mt-4 p-3 bg-blue-50 dark:bg-blue-950 border border-blue-200 dark:border-blue-800 rounded-lg",children:s.jsxs("p",{className:"text-sm text-blue-800 dark:text-blue-200",children:["Tip: Press ",s.jsx("kbd",{className:"px-2 py-1 bg-white dark:bg-gray-800 border border-blue-300 dark:border-blue-700 rounded text-xs",children:"Shift"})," +"," ",s.jsx("kbd",{className:"px-2 py-1 bg-white dark:bg-gray-800 border border-blue-300 dark:border-blue-700 rounded text-xs",children:"Enter"})," to add a new row"]})})]})]})})]})}export{je as default};
