var K=Object.defineProperty;var Q=(r,a,n)=>a in r?K(r,a,{enumerable:!0,configurable:!0,writable:!0,value:n}):r[a]=n;var k=(r,a,n)=>Q(r,typeof a!="symbol"?a+"":a,n);import{r as l,j as e,L as X,S as Z}from"./app-B3MVY4nA.js";import{t as A,A as ee,S as te}from"./app-layout-hCn9MT3e.js";import{B as f}from"./button-BbIHWR5o.js";import{C as _,a as F,b as I,c as T}from"./card-CojowgcM.js";import{S as z,a as B,b as L,c as M,d as h}from"./select-D2zZbXPp.js";import{l as se}from"./lodash-lh-GMIbX.js";import{E as re,F as ae,a as oe,b as ne}from"./jspdf.plugin.autotable-DQ3UGJrG.js";import{C as V}from"./combobox-BldHj5IN.js";import"./index-BTPcSof1.js";import"./index-BMur1Qek.js";import"./createLucideIcon-bGg6PY1_.js";import"./index-9rEhpgcf.js";import"./app-logo-icon-C2XjI3GH.js";import"./index-BSZ22cHv.js";import"./index-B2gRcpXj.js";import"./popover-BacG6oP_.js";const le=[{title:"Reports",href:"/reports"},{title:"Projects",href:"/reports/projects"}];class ie extends l.Component{constructor(){super(...arguments);k(this,"state",{hasError:!1,error:null})}static getDerivedStateFromError(n){return{hasError:!0,error:n.message}}componentDidCatch(n,u){console.error("ErrorBoundary caught:",n,u),A.error("An error occurred. Please try again or contact support.")}render(){return this.state.hasError?e.jsxs("div",{className:"p-4",children:[e.jsxs("p",{className:"text-red-600",children:["Error: ",this.state.error]}),e.jsx(f,{onClick:()=>window.location.reload(),className:"mt-2",children:"Retry"})]}):this.props.children}}const C=r=>{const a=r!=null&&typeof r.id=="number"&&r.id>0&&typeof r.name=="string"&&r.name.trim()!=="";return a||console.warn("Invalid item:",r),a};function Pe({projects:r,institutes:a,regions:n,projectTypes:u,filters:p}){const[P,ce]=l.useState(p.search||""),[d,y]=l.useState(p.institute_id||""),[g,D]=l.useState(p.project_type_id||""),[N,U]=l.useState(p.status||""),[m,$]=l.useState(r),[b,S]=l.useState(a||[]),[w,H]=l.useState(p.region_id||""),O=l.useMemo(()=>Array.isArray(b)?b.filter(C):[],[b]),E=l.useMemo(()=>Array.isArray(n)?n.filter(C):[],[n]),W=l.useMemo(()=>Array.isArray(u)?u.filter(C):[],[u]),J=async t=>{if(!t||t==="0"){S(a||[]),d&&y("");return}try{const s=new URLSearchParams({region_id:t}).toString(),c=await fetch(`/reports/getInstitutes?${s}`);if(!c.ok)throw new Error("Failed to fetch institutes");const o=await c.json();S(o),d&&!o.some(i=>i.id.toString()===d)&&y("")}catch(s){console.error("Error fetching institutes:",s),A.error("Failed to load institutes"),S([])}},Y=t=>{H(t),J(t)},q=async()=>{const t=new re.Workbook,s=t.addWorksheet("Projects");s.columns=[{header:"Name",key:"name",width:30},{header:"Cost",key:"cost",width:15},{header:"Status",key:"status",width:15},{header:"Project Type",key:"project_type",width:25},{header:"Institute",key:"institute",width:30},{header:"Region",key:"region",width:25}],m.data.forEach(i=>{var x,j,R;s.addRow({name:i.name,cost:i.cost,status:i.status,project_type:((x=i.project_type)==null?void 0:x.name)||"N/A",institute:((j=i.institute)==null?void 0:j.name)||"N/A",region:((R=i.region)==null?void 0:R.name)||"N/A"})});const c=await t.xlsx.writeBuffer(),o=new Blob([c],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"});ae.saveAs(o,"Projects_Report.xlsx")},G=()=>{const t=new oe;t.setFontSize(16),t.text("Projects Report",14,15);const s=["Name","Cost","Status","Project Type","Institute","Region"],c=m.data.map(o=>{var i,x,j;return[o.name,o.cost,o.status,((i=o.project_type)==null?void 0:i.name)||"N/A",((x=o.institute)==null?void 0:x.name)||"N/A",((j=o.region)==null?void 0:j.name)||"N/A"]});ne(t,{head:[s],body:c,startY:25,styles:{fontSize:9,cellPadding:2},headStyles:{fillColor:[66,139,202],textColor:255,fontStyle:"bold"},alternateRowStyles:{fillColor:[240,240,240]}}),t.save("Projects_Report.pdf")},v=l.useMemo(()=>se.debounce(()=>{const t=new URLSearchParams({search:P.trim(),institute_id:d||"",region_id:w||"",project_type_id:g||"",status:N||""});fetch(`/reports/projects/getprojects?${t.toString()}`).then(s=>s.json()).then(s=>{console.log("Filtered projects:",s),$(s)}).catch(s=>{console.error("Fetch error:",s),A.error("Failed to load projects")})},300),[P,d,w,g,N]);return e.jsx(ie,{children:e.jsxs(ee,{breadcrumbs:le,children:[e.jsx(X,{title:"Projects Report"}),e.jsx("div",{className:"flex-1 p-1 md:p-1",children:e.jsxs("div",{className:"flex flex-col md:flex-row gap-3",children:[e.jsx("div",{className:"w-full md:w-1/3",children:e.jsxs(_,{children:[e.jsxs(F,{children:[e.jsx(I,{className:"text-xl font-bold",children:"Filters"}),e.jsx("p",{className:"text-muted-foreground text-sm",children:"Refine your project search"})]}),e.jsxs(T,{className:"space-y-4",children:[E.length>0&&e.jsx(V,{entity:"region",value:w,onChange:t=>Y(t),options:E.map(t=>({id:t.id.toString(),name:t.name})),includeAllOption:!1}),e.jsx(V,{entity:"institute",value:d,onChange:y,options:O.map(t=>({id:t.id.toString(),name:t.name})),includeAllOption:!1,placeholder:"Select Institute"}),e.jsxs(z,{value:g,onValueChange:t=>{D(t),v()},children:[e.jsx(B,{children:e.jsx(L,{placeholder:"Select Project Type"})}),e.jsxs(M,{children:[e.jsx(h,{value:"0",children:"All Project Types"}),W.map(t=>e.jsx(h,{value:t.id.toString(),children:t.name},t.id))]})]}),e.jsxs(z,{value:N,onValueChange:t=>{U(t),v()},children:[e.jsx(B,{children:e.jsx(L,{placeholder:"Select Status"})}),e.jsxs(M,{children:[e.jsx(h,{value:"all",children:"All Status"}),e.jsx(h,{value:"planned",children:"Planned"}),e.jsx(h,{value:"inprogress",children:"In Progress"}),e.jsx(h,{value:"completed",children:"Completed"})]})]}),e.jsx(f,{onClick:v,className:"w-full",children:"Apply Filters"})]})]})}),e.jsx("div",{className:"w-full md:w-2/3",children:e.jsxs(_,{children:[e.jsxs(F,{className:"pb-3 flex flex-col md:flex-row md:items-center md:justify-between gap-4",children:[e.jsx("div",{children:e.jsx(I,{className:"text-2xl font-bold",children:"Projects Report"})}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(f,{onClick:G,className:"w-full md:w-auto",children:"Export PDF"}),e.jsx(f,{onClick:q,className:"w-full md:w-auto",children:"Export Excel"})]})]}),e.jsx(te,{}),e.jsxs(T,{className:"pt-6 space-y-6",children:[e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full border-collapse text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-primary text-white text-center",children:[e.jsx("th",{className:"border p-2 font-medium",children:"Name"}),e.jsx("th",{className:"border p-2 font-medium",children:"Cost"}),e.jsx("th",{className:"border p-2 font-medium",children:"Status"}),e.jsx("th",{className:"border p-2 font-medium",children:"Project Type"}),e.jsx("th",{className:"border p-2 font-medium",children:"Institute"}),e.jsx("th",{className:"border p-2 font-medium",children:"Region"})]})}),e.jsx("tbody",{children:m.data.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:6,className:"text-center p-4 text-muted-foreground",children:"No projects found."})}):m.data.map(t=>{var s,c,o;return e.jsxs("tr",{className:"hover:bg-gray-50 dark:hover:bg-gray-700 text-center",children:[e.jsx("td",{className:"border p-2",children:t.name}),e.jsx("td",{className:"border p-2",children:t.cost}),e.jsx("td",{className:"border p-2",children:e.jsx("span",{className:`px-2 py-1 rounded text-xs font-medium ${t.status==="completed"?"bg-green-100 text-green-800":t.status==="inprogress"?"bg-yellow-100 text-yellow-800":"bg-blue-100 text-blue-800"}`,children:t.status.charAt(0).toUpperCase()+t.status.slice(1)})}),e.jsx("td",{className:"border p-2",children:((s=t.project_type)==null?void 0:s.name)||"N/A"}),e.jsx("td",{className:"border p-2",children:((c=t.institute)==null?void 0:c.name)||"N/A"}),e.jsx("td",{className:"border p-2",children:((o=t.region)==null?void 0:o.name)||"N/A"})]},t.id)})})]})}),m.links.length>1&&e.jsx("div",{className:"flex justify-center pt-6 flex-wrap gap-2",children:m.links.map((t,s)=>e.jsx(f,{disabled:!t.url,variant:t.active?"default":"outline",size:"sm",onClick:()=>Z.visit(t.url||"",{preserveScroll:!0}),children:e.jsx("span",{dangerouslySetInnerHTML:{__html:t.label}})},s))})]})]})})]})})]})})}export{Pe as default};
