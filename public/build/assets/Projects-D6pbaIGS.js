var K=Object.defineProperty;var Q=(r,o,a)=>o in r?K(r,o,{enumerable:!0,configurable:!0,writable:!0,value:a}):r[o]=a;var k=(r,o,a)=>Q(r,typeof o!="symbol"?o+"":o,a);import{r as n,j as e,L as X,S as Z}from"./app-DGys_uxz.js";import{t as C,A as ee,S as te}from"./app-layout-DzofqTeW.js";import{B as f}from"./button-DBxFEbgT.js";import{C as R,a as F,b as _,c as I}from"./card-DpSSBtd2.js";import{S as T,a as z,b as B,c as L,d as h}from"./select-CYW4oChB.js";import{l as se}from"./lodash-C2cvmKzP.js";import{E as re,F as oe,a as ae,b as ne}from"./jspdf.plugin.autotable-DxCLr3yW.js";import{C as M}from"./combobox-fCjdkClG.js";import"./index-Ck-1wWul.js";import"./createLucideIcon-D8dv39iF.js";import"./input-2q_9h39u.js";import"./index-CfxS7XWY.js";import"./app-logo-icon-Djb7WYPQ.js";import"./folder-root-C5aI_SS6.js";import"./grip-vertical-xo-4X-H5.js";import"./index-N1_97FP_.js";import"./index-DX5_bVQ-.js";import"./popover-pFnFdlTL.js";const le=[{title:"Reports",href:"/reports"},{title:"Projects",href:"/reports/projects"}];class ie extends n.Component{constructor(){super(...arguments);k(this,"state",{hasError:!1,error:null})}static getDerivedStateFromError(a){return{hasError:!0,error:a.message}}componentDidCatch(a,u){console.error("ErrorBoundary caught:",a,u),C.error("An error occurred. Please try again or contact support.")}render(){return this.state.hasError?e.jsxs("div",{className:"p-4",children:[e.jsxs("p",{className:"text-red-600",children:["Error: ",this.state.error]}),e.jsx(f,{onClick:()=>window.location.reload(),className:"mt-2",children:"Retry"})]}):this.props.children}}const v=r=>{const o=r!=null&&typeof r.id=="number"&&r.id>0&&typeof r.name=="string"&&r.name.trim()!=="";return o||console.warn("Invalid item:",r),o};function ke({projects:r,institutes:o,regions:a,projectTypes:u,filters:p}){const[A,ce]=n.useState(p.search||""),[d,y]=n.useState(p.institute_id||""),[g,V]=n.useState(p.project_type_id||""),[b,D]=n.useState(p.status||""),[m,U]=n.useState(r),[N,S]=n.useState(o||[]),[w,$]=n.useState(p.region_id||""),H=n.useMemo(()=>Array.isArray(N)?N.filter(v):[],[N]),P=n.useMemo(()=>Array.isArray(a)?a.filter(v):[],[a]),O=n.useMemo(()=>Array.isArray(u)?u.filter(v):[],[u]),W=async t=>{if(!t||t==="0"){S(o||[]),d&&y("");return}try{const s=new URLSearchParams({region_id:t}).toString(),c=await fetch(`/reports/getInstitutes?${s}`);if(!c.ok)throw new Error("Failed to fetch institutes");const l=await c.json();S(l),d&&!l.some(i=>i.id.toString()===d)&&y("")}catch(s){console.error("Error fetching institutes:",s),C.error("Failed to load institutes"),S([])}},J=t=>{$(t),W(t)},Y=async()=>{const t=new re.Workbook,s=t.addWorksheet("Projects");s.columns=[{header:"Name",key:"name",width:30},{header:"Cost",key:"cost",width:15},{header:"Status",key:"status",width:15},{header:"Project Type",key:"project_type",width:25},{header:"Institute",key:"institute",width:30},{header:"Region",key:"region",width:25}],m.data.forEach(i=>{var x,j,E;s.addRow({name:i.name,cost:i.cost,status:i.status,project_type:((x=i.projecttype)==null?void 0:x.name)||"N/A",institute:((j=i.institute)==null?void 0:j.name)||"N/A",region:((E=i.region)==null?void 0:E.name)||"N/A"})});const c=await t.xlsx.writeBuffer(),l=new Blob([c],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"});oe.saveAs(l,"Projects_Report.xlsx")},q=()=>{const t=new ae;t.setFontSize(16),t.text("Projects Report",14,15);const s=["Name","Cost","Status","Project Type","Institute","Region"],c=m.data.map(l=>{var i,x,j;return[l.name,l.cost,l.status,((i=l.projecttype)==null?void 0:i.name)||"N/A",((x=l.institute)==null?void 0:x.name)||"N/A",((j=l.region)==null?void 0:j.name)||"N/A"]});ne(t,{head:[s],body:c,startY:25,styles:{fontSize:9,cellPadding:2},headStyles:{fillColor:[66,139,202],textColor:255,fontStyle:"bold"},alternateRowStyles:{fillColor:[240,240,240]}}),t.save("Projects_Report.pdf")},G=n.useMemo(()=>se.debounce(()=>{const t=new URLSearchParams({search:A.trim(),institute_id:d||"",region_id:w||"",project_type_id:g||"",status:b||""});fetch(`/reports/projects/getprojects?${t.toString()}`).then(s=>s.json()).then(s=>{console.log("Filtered projects:",s),U(s)}).catch(s=>{console.error("Fetch error:",s),C.error("Failed to load projects")})},300),[A,d,w,g,b]);return e.jsx(ie,{children:e.jsxs(ee,{breadcrumbs:le,children:[e.jsx(X,{title:"Projects Report"}),e.jsx("div",{className:"flex-1 p-1 md:p-1",children:e.jsxs("div",{className:"flex flex-col md:flex-row gap-3",children:[e.jsx("div",{className:"w-full md:w-1/3",children:e.jsxs(R,{children:[e.jsxs(F,{children:[e.jsx(_,{className:"text-xl font-bold",children:"Filters"}),e.jsx("p",{className:"text-muted-foreground text-sm",children:"Refine your project search"})]}),e.jsxs(I,{className:"space-y-4",children:[P.length>0&&e.jsx(M,{entity:"region",value:w,onChange:t=>J(t),options:P.map(t=>({id:t.id.toString(),name:t.name.split(" ").pop()||t.name})),includeAllOption:!0}),e.jsx(M,{entity:"institute",value:d,onChange:y,options:H.map(t=>({id:t.id.toString(),name:t.name})),includeAllOption:!1,placeholder:"Select Institute"}),e.jsxs(T,{value:g,onValueChange:t=>V(t),children:[e.jsx(z,{children:e.jsx(B,{placeholder:"Select Project Type"})}),e.jsxs(L,{children:[e.jsx(h,{value:"0",children:"All Project Types"}),O.map(t=>e.jsx(h,{value:t.id.toString(),children:t.name},t.id))]})]}),e.jsxs(T,{value:b,onValueChange:t=>D(t),children:[e.jsx(z,{children:e.jsx(B,{placeholder:"Select Status"})}),e.jsxs(L,{children:[e.jsx(h,{value:"all",children:"All Status"}),e.jsx(h,{value:"planned",children:"Planned"}),e.jsx(h,{value:"inprogress",children:"In Progress"}),e.jsx(h,{value:"completed",children:"Completed"})]})]}),e.jsx(f,{onClick:G,className:"w-full",children:"Apply Filters"})]})]})}),e.jsx("div",{className:"w-full md:w-2/3",children:e.jsxs(R,{children:[e.jsxs(F,{className:"pb-3 flex flex-col md:flex-row md:items-center md:justify-between gap-4",children:[e.jsx("div",{children:e.jsx(_,{className:"text-2xl font-bold",children:"Projects Report"})}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(f,{onClick:q,className:"w-full md:w-auto",children:"Export PDF"}),e.jsx(f,{onClick:Y,className:"w-full md:w-auto",children:"Export Excel"})]})]}),e.jsx(te,{}),e.jsxs(I,{className:"pt-6 space-y-6",children:[e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full border-collapse border-1 rounded-md overflow-hidden shadow-sm  text-sm md:text-md lg:text-lg",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-primary text-white text-center",children:[e.jsx("th",{className:"border p-2 font-medium",children:"Name"}),e.jsx("th",{className:"border p-2 font-medium",children:"Cost"}),e.jsx("th",{className:"border p-2 font-medium",children:"Status"}),e.jsx("th",{className:"border p-2 font-medium",children:"Project Type"}),e.jsx("th",{className:"border p-2 font-medium",children:"Institute"})]})}),e.jsx("tbody",{children:m.data.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:6,className:"text-center p-4 text-muted-foreground",children:"No projects found."})}):m.data.map(t=>{var s,c;return e.jsxs("tr",{className:"hover:bg-primary/10 dark:hover:bg-gray-700",children:[e.jsx("td",{className:"border p-2  font-bold text-left",children:t.name}),e.jsx("td",{className:"border p-2 text-right",children:t.cost}),e.jsx("td",{className:"border p-2",children:e.jsx("span",{className:`px-2 py-1 rounded text-xs font-medium ${t.status==="completed"?"bg-green-100 text-green-800":t.status==="inprogress"?"bg-yellow-100 text-yellow-800":"bg-blue-100 text-blue-800"}`,children:t.status.charAt(0).toUpperCase()+t.status.slice(1)})}),e.jsx("td",{className:"border p-2",children:((s=t.projecttype)==null?void 0:s.name)||"N/A"}),e.jsx("td",{className:"border p-2",children:((c=t.institute)==null?void 0:c.name)||"N/A"})]},t.id)})})]})}),m.links.length>1&&e.jsx("div",{className:"flex justify-center pt-6 flex-wrap gap-2",children:m.links.map((t,s)=>e.jsx(f,{disabled:!t.url,variant:t.active?"default":"outline",size:"sm",onClick:()=>Z.visit(t.url||"",{preserveScroll:!0}),children:e.jsx("span",{dangerouslySetInnerHTML:{__html:t.label}})},s))})]})]})})]})})]})})}export{ke as default};
