import{r as o,j as e,L as z,S as M}from"./app-PN96EFAL.js";import{t as C,A as G,P as J,S as O,T as W}from"./app-layout-klt3crRG.js";import{B as k}from"./button-hsIfUBa3.js";import{C as X,a as Y,b as Z,c as U}from"./card-Gmh10H9r.js";import"./index-B9RzbVZ9.js";import"./createLucideIcon-9S9Sdm6s.js";import"./input-CjbdXEUj.js";import"./index-WlrkuAFp.js";import"./app-logo-icon-CxPFK5EQ.js";import"./folder-root-DPP9e2Iv.js";import"./grip-vertical-CEgG-fdz.js";const w=[{title:"Asset Transactions",href:"/asset-transactions"}],H=a=>(a==null?void 0:a.id)>0&&typeof a.name=="string"&&a.name.trim()!=="",ee=o.memo(({row:a,onUpdate:i,onDelete:g,onKeyDown:m,fundHeads:j,blocks:y,assetCategories:c,getRooms:x,getAssets:p})=>{const f=()=>{requestAnimationFrame(()=>{const s=document.querySelector(`tr[data-row-id="${a.id}"] select[name="roomId"]`);s&&(s.focus(),s.classList.add("border-red-500","ring-2","ring-red-500"),setTimeout(()=>s.classList.remove("border-red-500","ring-2","ring-red-500"),2e3))})};return e.jsxs("tr",{"data-row-id":a.id,className:"hover:bg-gray-50",children:[e.jsx("td",{className:"border p-2",children:e.jsxs("select",{value:a.fundHeadId,onChange:s=>i(a.id,"fundHeadId",s.target.value),onKeyDown:s=>m(s,a.id),className:"w-full px-2 py-1.5 border rounded-md text-sm focus:ring-2 focus:ring-green-500",children:[e.jsx("option",{value:"",children:"Select Fund"}),j.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))]})}),e.jsx("td",{className:"border p-2",children:e.jsx("input",{type:"text",value:a.balance>0?`Rs ${a.balance.toLocaleString()}`:"-",disabled:!0,className:"w-full px-2 py-1.5 bg-gray-100 text-sm"})}),e.jsx("td",{className:"border p-2",children:e.jsxs("select",{value:a.blockId,onChange:s=>i(a.id,"blockId",s.target.value),onKeyDown:s=>m(s,a.id),className:"w-full px-2 py-1.5 border rounded-md text-sm focus:ring-2 focus:ring-green-500",children:[e.jsx("option",{value:"",children:"Select Block"}),y.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))]})}),e.jsx("td",{className:"border p-2",children:e.jsxs("select",{value:a.roomId,onChange:s=>i(a.id,"roomId",s.target.value),onKeyDown:s=>m(s,a.id),disabled:!a.blockId,className:"w-full px-2 py-1.5 border rounded-md text-sm focus:ring-2 focus:ring-green-500 disabled:opacity-50",children:[e.jsx("option",{value:"",children:"Select Room"}),x(a.blockId).map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))]})}),e.jsx("td",{className:"border p-2",children:e.jsxs("select",{value:a.assetCategoryId,onChange:s=>{if(!a.roomId){C.error("Select Room first"),f();return}i(a.id,"assetCategoryId",s.target.value)},onKeyDown:s=>m(s,a.id),disabled:!a.roomId,className:"w-full px-2 py-1.5 border rounded-md text-sm focus:ring-2 focus:ring-green-500 disabled:opacity-50",children:[e.jsx("option",{value:"",children:"Select Category"}),c.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))]})}),e.jsx("td",{className:"border p-2",children:e.jsxs("select",{value:a.assetId,onChange:s=>i(a.id,"assetId",s.target.value),onKeyDown:s=>m(s,a.id),disabled:!a.assetCategoryId,className:"w-full px-2 py-1.5 border rounded-md text-sm focus:ring-2 focus:ring-green-500 disabled:opacity-50",children:[e.jsx("option",{value:"",children:"Select Asset"}),p(a.assetCategoryId).map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))]})}),e.jsx("td",{className:"border p-2",children:e.jsx("input",{type:"text",value:a.currentQty,disabled:!0,className:"w-full px-2 py-1.5 bg-gray-100 text-sm"})}),e.jsx("td",{className:"border p-2",children:e.jsx("input",{type:"number",value:a.purchaseQty,onChange:s=>i(a.id,"purchaseQty",s.target.value),onKeyDown:s=>m(s,a.id),min:"1",className:"w-full px-2 py-1.5 border rounded-md text-sm focus:ring-2 focus:ring-green-500"})}),e.jsx("td",{className:"border p-2",children:e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"number",value:a.amount,onChange:s=>i(a.id,"amount",s.target.value),onKeyDown:s=>m(s,a.id),step:"0.01",className:`w-full px-2 py-1.5 border rounded-md text-sm focus:ring-2 ${a.error?"border-red-500 focus:ring-red-500":"focus:ring-green-500"}`}),a.error&&e.jsx("p",{className:"absolute left-0 -bottom-5 text-xs text-red-600",children:a.error})]})}),e.jsx("td",{className:"border p-2 text-center",children:e.jsx(k,{variant:"destructive",size:"sm",onClick:()=>g(a.id),children:e.jsx(W,{className:"w-4 h-4"})})})]})});function ue({fundHeads:a=[],assetCategories:i=[],assets:g=[],blocks:m=[],institute_id:j,user_id:y}){const[c,x]=o.useState([]),[p,f]=o.useState({}),[s,_]=o.useState({}),[S,$]=o.useState({}),[R,T]=o.useState(null),I=o.useRef(S);I.current=S,o.useEffect(()=>{const t=g.filter(H).reduce((d,l)=>{const r=l.asset_category_id.toString();return d[r]=[...d[r]||[],l],d},{});f(t)},[g]);const V=o.useCallback((t,d,l)=>{x(r=>r.map(u=>{if(u.id!==t)return u;const n={...u,[d]:l,error:""};if((d==="blockId"||d==="roomId")&&(n.assetCategoryId="",n.assetId="",n.currentQty=0),d==="assetCategoryId"&&(n.assetId="",n.currentQty=0),d==="amount"||d==="fundHeadId"){const A=parseFloat(n.amount)||0,v=n.fundHeadId,B=I.current[v]||0,Q=r.filter(h=>h.id!==t&&h.fundHeadId===v&&h.isValid).reduce((h,K)=>h+(parseFloat(K.amount)||0),0);v&&A+Q>B?(n.error=`Exceeds by Rs ${(A+Q-B).toFixed(2)}`,n.isValid=!1):n.amount&&!/^\d+(\.\d{1,2})?$/.test(n.amount)?(n.error="Max 2 decimals",n.isValid=!1):n.error=""}return n.isValid=!!(n.fundHeadId&&n.blockId&&n.roomId&&n.assetCategoryId&&n.assetId&&parseInt(n.purchaseQty)>0&&parseFloat(n.amount)>0&&!n.error),n}))},[]),N=o.useCallback(()=>{x(t=>[...t,{id:Date.now(),fundHeadId:"",balance:0,blockId:"",roomId:"",assetCategoryId:"",assetId:"",currentQty:0,purchaseQty:"",amount:"",isValid:!1}])},[]),E=o.useCallback(t=>{x(d=>d.filter(l=>l.id!==t)),C.success("Row removed")},[]),D=o.useCallback((t,d)=>{t.key==="Enter"&&t.shiftKey&&(t.preventDefault(),N())},[N]);o.useEffect(()=>{c.forEach(t=>{if(t.fundHeadId&&I.current[t.fundHeadId]===void 0&&fetch(`/asset-trans/getbalance?id=${t.fundHeadId}`).then(d=>d.json()).then(d=>{const l=d.balance||0;$(r=>({...r,[t.fundHeadId]:l})),x(r=>r.map(u=>u.id===t.id?{...u,balance:l}:u))}),t.blockId&&!s[t.blockId]&&fetch(`/asset-trans/getrooms?block_id=${t.blockId}`).then(d=>d.json()).then(d=>{const l=(d??[]).filter(r=>r.id&&r.name);_(r=>({...r,[t.blockId]:l}))}),t.assetCategoryId&&t.roomId&&!p[t.assetCategoryId]){const d=new URLSearchParams({id:t.assetCategoryId,room_id:t.roomId});fetch(`/asset-trans/getassets?${d}`).then(l=>l.json()).then(l=>{const r=(l.assets??[]).filter(H);f(u=>({...u,[t.assetCategoryId]:r}))})}})},[c]);const L=o.useCallback(t=>s[t]||[],[s]),P=o.useCallback(t=>p[t]||[],[p]),b=o.useMemo(()=>{const t=c.filter(d=>d.isValid);return{totalItems:t.length,totalPurchaseQty:t.reduce((d,l)=>d+(parseInt(l.purchaseQty)||0),0),totalAmount:t.reduce((d,l)=>d+(parseFloat(l.amount)||0),0)}},[c]),F=c.length>0&&c.every(t=>t.isValid),q=()=>{if(!F)return C.error("Fix errors");const t=new FormData;t.append("institute_id",j.toString()),t.append("added_by",y.toString()),t.append("total_amount",b.totalAmount.toFixed(2)),R&&t.append("bill_img",R),c.forEach((d,l)=>{t.append(`items[${l}][fund_head_id]`,d.fundHeadId),t.append(`items[${l}][block_id]`,d.blockId),t.append(`items[${l}][room_id]`,d.roomId),t.append(`items[${l}][asset_id]`,d.assetId),t.append(`items[${l}][purchase_qty]`,d.purchaseQty),t.append(`items[${l}][amount]`,d.amount)}),M.post("/asset-transactions",t,{forceFormData:!0})};return e.jsxs(G,{breadcrumbs:w,children:[e.jsx(z,{title:"Create Asset Transaction"}),e.jsx("div",{className:"flex-1 p-3",children:e.jsxs(X,{children:[e.jsx(Y,{children:e.jsxs("div",{className:"flex justify-between",children:[e.jsx(Z,{children:"Create Asset Transaction"}),e.jsxs(k,{onClick:N,children:[e.jsx(J,{className:"w-4 h-4 mr-2"}),"New Row"]})]})}),e.jsx(O,{}),e.jsxs(U,{className:"py-6",children:[e.jsxs("div",{className:"mb-6",children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"Bill Image"}),e.jsx("input",{type:"file",accept:"image/*",onChange:t=>{var d;return T(((d=t.target.files)==null?void 0:d[0])??null)},className:"file-input"})]}),e.jsx("div",{className:"overflow-x-auto border rounded-lg",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-[#0b431b] text-white text-sm",children:[e.jsx("th",{className:"p-2",children:"Fund Head"}),e.jsx("th",{className:"p-2",children:"Balance"}),e.jsx("th",{className:"p-2",children:"Block"}),e.jsx("th",{className:"p-2",children:"Room"}),e.jsx("th",{className:"p-2",children:"Category"}),e.jsx("th",{className:"p-2",children:"Asset"}),e.jsx("th",{className:"p-2",children:"Curr Qty"}),e.jsx("th",{className:"p-2",children:"Pur Qty"}),e.jsx("th",{className:"p-2",children:"Amount"}),e.jsx("th",{className:"p-2",children:"Action"})]})}),e.jsx("tbody",{children:c.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:10,className:"text-center p-8 text-gray-500",children:'Click "New Row"'})}):c.map(t=>e.jsx(ee,{row:t,onUpdate:V,onDelete:E,onKeyDown:D,fundHeads:a,blocks:m,assetCategories:i,getRooms:L,getAssets:P},t.id))})]})}),c.length>0&&e.jsxs("div",{className:"mt-8 flex justify-end gap-6",children:[e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Valid Items"}),e.jsx("p",{className:"text-lg font-bold",children:b.totalItems})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Total Qty"}),e.jsx("p",{className:"text-lg font-bold",children:b.totalPurchaseQty})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Total Amount"}),e.jsxs("p",{className:"text-lg font-bold text-green-600",children:["Rs ",b.totalAmount.toFixed(2)]})]})]}),e.jsx("div",{className:"mt-6 flex justify-end",children:e.jsx(k,{onClick:q,disabled:!F,size:"lg",children:"Create Transaction"})}),e.jsxs("div",{className:"mt-4 p-3 bg-blue-50 rounded-lg text-sm",children:["Tip: Press ",e.jsx("kbd",{children:"Shift"})," + ",e.jsx("kbd",{children:"Enter"})," to add row"]})]})]})})]})}export{ue as default};
