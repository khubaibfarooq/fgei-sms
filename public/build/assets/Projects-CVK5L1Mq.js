var G=Object.defineProperty;var K=(r,a,n)=>a in r?G(r,a,{enumerable:!0,configurable:!0,writable:!0,value:n}):r[a]=n;var T=(r,a,n)=>K(r,typeof a!="symbol"?a+"":a,n);import{r as l,j as e,L as Q,S as X}from"./app-ByKPX2XO.js";import{t as k,A as Z,S as ee}from"./app-layout-RRRlyzbz.js";import{B as f}from"./button-BwmPM0Nx.js";import{C as z,a as B,b as L,c as V}from"./card-CfspnTPR.js";import{S as C,a as A,b as P,c as R,d}from"./select-B-mDFtwB.js";import{l as te,E as se,a as re}from"./jspdf.plugin.autotable-Dfvv_uev.js";import{E as ae,F as oe}from"./FileSaver.min-BLeFGrZp.js";import{C as ne}from"./combobox-DLFCbgPD.js";import"./index-Cr_dv8W6.js";import"./index-Clv3n1kh.js";import"./createLucideIcon-CoHYTla-.js";import"./index-PMmi5g-R.js";import"./app-logo-icon-CSjt0-nz.js";import"./index-COALVFOl.js";import"./index-BrU2gIRe.js";import"./popover-DjC8FABO.js";const le=[{title:"Reports",href:"/reports"},{title:"Projects",href:"/reports/projects"}];class ie extends l.Component{constructor(){super(...arguments);T(this,"state",{hasError:!1,error:null})}static getDerivedStateFromError(n){return{hasError:!0,error:n.message}}componentDidCatch(n,u){console.error("ErrorBoundary caught:",n,u),k.error("An error occurred. Please try again or contact support.")}render(){return this.state.hasError?e.jsxs("div",{className:"p-4",children:[e.jsxs("p",{className:"text-red-600",children:["Error: ",this.state.error]}),e.jsx(f,{onClick:()=>window.location.reload(),className:"mt-2",children:"Retry"})]}):this.props.children}}const E=r=>{const a=r!=null&&typeof r.id=="number"&&r.id>0&&typeof r.name=="string"&&r.name.trim()!=="";return a||console.warn("Invalid item:",r),a};function Pe({projects:r,institutes:a,regions:n,projectTypes:u,filters:p}){const[_,ce]=l.useState(p.search||""),[m,y]=l.useState(p.institute_id||""),[N,M]=l.useState(p.region_id||""),[b,D]=l.useState(p.project_type_id||""),[S,U]=l.useState(p.status||""),[h,$]=l.useState(r),[w,v]=l.useState(a||[]),H=l.useMemo(()=>Array.isArray(w)?w.filter(E):[],[w]),F=l.useMemo(()=>Array.isArray(n)?n.filter(E):[],[n]),W=l.useMemo(()=>Array.isArray(u)?u.filter(E):[],[u]),J=async t=>{if(!t||t==="0"){v(a||[]),m&&y("");return}try{const s=new URLSearchParams({region_id:t}).toString(),c=await fetch(`/reports/getInstitutes?${s}`);if(!c.ok)throw new Error("Failed to fetch institutes");const o=await c.json();v(o),m&&!o.some(i=>i.id.toString()===m)&&y("")}catch(s){console.error("Error fetching institutes:",s),k.error("Failed to load institutes"),v([])}},O=t=>{M(t),J(t),g()},Y=async()=>{const t=new ae.Workbook,s=t.addWorksheet("Projects");s.columns=[{header:"Name",key:"name",width:30},{header:"Cost",key:"cost",width:15},{header:"Status",key:"status",width:15},{header:"Project Type",key:"project_type",width:25},{header:"Institute",key:"institute",width:30},{header:"Region",key:"region",width:25}],h.data.forEach(i=>{var x,j,I;s.addRow({name:i.name,cost:i.cost,status:i.status,project_type:((x=i.project_type)==null?void 0:x.name)||"N/A",institute:((j=i.institute)==null?void 0:j.name)||"N/A",region:((I=i.region)==null?void 0:I.name)||"N/A"})});const c=await t.xlsx.writeBuffer(),o=new Blob([c],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"});oe.saveAs(o,"Projects_Report.xlsx")},q=()=>{const t=new se;t.setFontSize(16),t.text("Projects Report",14,15);const s=["Name","Cost","Status","Project Type","Institute","Region"],c=h.data.map(o=>{var i,x,j;return[o.name,o.cost,o.status,((i=o.project_type)==null?void 0:i.name)||"N/A",((x=o.institute)==null?void 0:x.name)||"N/A",((j=o.region)==null?void 0:j.name)||"N/A"]});re(t,{head:[s],body:c,startY:25,styles:{fontSize:9,cellPadding:2},headStyles:{fillColor:[66,139,202],textColor:255,fontStyle:"bold"},alternateRowStyles:{fillColor:[240,240,240]}}),t.save("Projects_Report.pdf")},g=l.useMemo(()=>te.debounce(()=>{const t=new URLSearchParams({search:_.trim(),institute_id:m||"",region_id:N||"",project_type_id:b||"",status:S||""});fetch(`/reports/projects/getprojects?${t.toString()}`).then(s=>s.json()).then(s=>{console.log("Filtered projects:",s),$(s)}).catch(s=>{console.error("Fetch error:",s),k.error("Failed to load projects")})},300),[_,m,N,b,S]);return e.jsx(ie,{children:e.jsxs(Z,{breadcrumbs:le,children:[e.jsx(Q,{title:"Projects Report"}),e.jsx("div",{className:"flex-1 p-1 md:p-1",children:e.jsxs("div",{className:"flex flex-col md:flex-row gap-3",children:[e.jsx("div",{className:"w-full md:w-1/3",children:e.jsxs(z,{children:[e.jsxs(B,{children:[e.jsx(L,{className:"text-xl font-bold",children:"Filters"}),e.jsx("p",{className:"text-muted-foreground text-sm",children:"Refine your project search"})]}),e.jsxs(V,{className:"space-y-4",children:[F.length>0&&e.jsxs(C,{value:N,onValueChange:O,children:[e.jsx(A,{children:e.jsx(P,{placeholder:"Select Region"})}),e.jsxs(R,{children:[e.jsx(d,{value:"0",children:"All Regions"}),F.map(t=>e.jsx(d,{value:t.id.toString(),children:t.name},t.id))]})]}),e.jsx(ne,{entity:"institute",value:m,onChange:y,options:H.map(t=>({id:t.id.toString(),name:t.name})),includeAllOption:!1,placeholder:"Select Institute"}),e.jsxs(C,{value:b,onValueChange:t=>{D(t),g()},children:[e.jsx(A,{children:e.jsx(P,{placeholder:"Select Project Type"})}),e.jsxs(R,{children:[e.jsx(d,{value:"0",children:"All Project Types"}),W.map(t=>e.jsx(d,{value:t.id.toString(),children:t.name},t.id))]})]}),e.jsxs(C,{value:S,onValueChange:t=>{U(t),g()},children:[e.jsx(A,{children:e.jsx(P,{placeholder:"Select Status"})}),e.jsxs(R,{children:[e.jsx(d,{value:"all",children:"All Status"}),e.jsx(d,{value:"planned",children:"Planned"}),e.jsx(d,{value:"inprogress",children:"In Progress"}),e.jsx(d,{value:"completed",children:"Completed"})]})]}),e.jsx(f,{onClick:g,className:"w-full",children:"Apply Filters"})]})]})}),e.jsx("div",{className:"w-full md:w-2/3",children:e.jsxs(z,{children:[e.jsxs(B,{className:"pb-3 flex flex-col md:flex-row md:items-center md:justify-between gap-4",children:[e.jsx("div",{children:e.jsx(L,{className:"text-2xl font-bold",children:"Projects Report"})}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(f,{onClick:q,className:"w-full md:w-auto",children:"Export PDF"}),e.jsx(f,{onClick:Y,className:"w-full md:w-auto",children:"Export Excel"})]})]}),e.jsx(ee,{}),e.jsxs(V,{className:"pt-6 space-y-6",children:[e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full border-collapse text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-primary text-white text-center",children:[e.jsx("th",{className:"border p-2 font-medium",children:"Name"}),e.jsx("th",{className:"border p-2 font-medium",children:"Cost"}),e.jsx("th",{className:"border p-2 font-medium",children:"Status"}),e.jsx("th",{className:"border p-2 font-medium",children:"Project Type"}),e.jsx("th",{className:"border p-2 font-medium",children:"Institute"}),e.jsx("th",{className:"border p-2 font-medium",children:"Region"})]})}),e.jsx("tbody",{children:h.data.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:6,className:"text-center p-4 text-muted-foreground",children:"No projects found."})}):h.data.map(t=>{var s,c,o;return e.jsxs("tr",{className:"hover:bg-gray-50 dark:hover:bg-gray-700 text-center",children:[e.jsx("td",{className:"border p-2",children:t.name}),e.jsx("td",{className:"border p-2",children:t.cost}),e.jsx("td",{className:"border p-2",children:e.jsx("span",{className:`px-2 py-1 rounded text-xs font-medium ${t.status==="completed"?"bg-green-100 text-green-800":t.status==="inprogress"?"bg-yellow-100 text-yellow-800":"bg-blue-100 text-blue-800"}`,children:t.status.charAt(0).toUpperCase()+t.status.slice(1)})}),e.jsx("td",{className:"border p-2",children:((s=t.project_type)==null?void 0:s.name)||"N/A"}),e.jsx("td",{className:"border p-2",children:((c=t.institute)==null?void 0:c.name)||"N/A"}),e.jsx("td",{className:"border p-2",children:((o=t.region)==null?void 0:o.name)||"N/A"})]},t.id)})})]})}),h.links.length>1&&e.jsx("div",{className:"flex justify-center pt-6 flex-wrap gap-2",children:h.links.map((t,s)=>e.jsx(f,{disabled:!t.url,variant:t.active?"default":"outline",size:"sm",onClick:()=>X.visit(t.url||"",{preserveScroll:!0}),children:e.jsx("span",{dangerouslySetInnerHTML:{__html:t.label}})},s))})]})]})})]})})]})})}export{Pe as default};
