var ke=Object.defineProperty;var De=(l,c,m)=>c in l?ke(l,c,{enumerable:!0,configurable:!0,writable:!0,value:m}):l[c]=m;var le=(l,c,m)=>De(l,typeof c!="symbol"?c+"":c,m);import{r as o,j as e,L as Be}from"./app-D__0VHow.js";import{t as j,A as Ie,F as ie,S as ce,C as Ue,a as $e,E as Le,D as ze}from"./app-layout-Calk8GMv.js";import{B as x}from"./button-D8RgBs_y.js";import{C as me,a as pe,b as he,c as ue}from"./card-DDoS3KWP.js";import{I as xe}from"./input-BlBCiF6U.js";import{S as I,a as U,b as $,c as L,d as p}from"./select-B4Z0plgJ.js";import{D as Oe,a as Pe,b as Me,c as Ve}from"./dialog-Bun6as6j.js";import{l as He}from"./lodash-CplZL0jX.js";import{E as Ye,F as qe,a as je,b as z}from"./jspdf.plugin.autotable-Bvrobmux.js";import{f as b}from"./dateFormatter-Cn65gwBN.js";import{C as O}from"./combobox-DiFugv9B.js";import{L as Qe}from"./app-logo-icon-AaVYm7Xs.js";import"./index-Dcfc_DHO.js";import"./createLucideIcon-BAwY0WCQ.js";import"./index-EuFIlxIt.js";import"./folder-root-DK5R0d4X.js";import"./grip-vertical-_A5uhDjw.js";import"./index-BB46QfKY.js";import"./index-DXXkL_fu.js";import"./popover-Dm3zXIoX.js";const We=[{title:"Reports",href:"/reports"},{title:"Transactions",href:"/reports/transactions"}];class Xe extends o.Component{constructor(){super(...arguments);le(this,"state",{hasError:!1,error:null})}static getDerivedStateFromError(m){return{hasError:!0,error:m.message}}componentDidCatch(m,N){console.error("ErrorBoundary:",m,N),j.error("An error occurred. Please try again.")}render(){return this.state.hasError?e.jsxs("div",{className:"p-4",children:[e.jsxs("p",{className:"text-red-600",children:["Error: ",this.state.error]}),e.jsx(x,{onClick:()=>window.location.reload(),className:"mt-2",children:"Retry"})]}):this.props.children}}const P=l=>l!=null&&typeof l.id=="number"&&l.id>0&&typeof l.name=="string"&&l.name.trim()!=="";function yt({transactions:l,institutes:c,regions:m,users:N,filters:h,user_type:fe}){var te,se,ae;const[M,Ge]=o.useState(h.search||""),[f,w]=o.useState(h.institute_id||""),[S,ye]=o.useState(h.region_id||""),[A,ge]=o.useState(h.added_by||""),[C,be]=o.useState(h.approved_by||""),[_,Ne]=o.useState(h.type||""),[F,ve]=o.useState(h.status||""),[T,we]=o.useState(h.date_from||""),[E,Se]=o.useState(h.date_to||""),[y,V]=o.useState(l),[H,R]=o.useState(c||[]),[k,Y]=o.useState(!1),[q,D]=o.useState(!1),[d,Q]=o.useState(null),[B,W]=o.useState([]),[X,G]=o.useState(!1),Ae=async t=>{var s;if(!k){Y(!0);try{if(!(await fetch(`/reports/transactions/approve?tid=${t}`,{method:"GET",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":((s=document.querySelector('meta[name="csrf-token"]'))==null?void 0:s.getAttribute("content"))||""}})).ok)throw new Error("Failed to approve");j.success("Transaction approved successfully"),Z()}catch{j.error("Failed to approve transaction")}finally{Y(!1)}}},Ce=o.useMemo(()=>H.filter(P),[H]),J=o.useMemo(()=>m.filter(P),[m]),K=o.useMemo(()=>N.filter(P),[N]),_e=async t=>{if(!t||t==="0"){R(c||[]),f&&w("");return}try{const s=new URLSearchParams({region_id:t}).toString(),a=await fetch(`/reports/transactions/getinstitutes?${s}`);if(!a.ok)throw new Error("Failed to fetch institutes");const r=await a.json();R(r),f&&!r.some(n=>n.id.toString()===f)&&w("")}catch(s){console.error("Error fetching institutes:",s),j.error("Failed to load institutes"),R([])}},Fe=t=>{ye(t),_e(t)},Te=async()=>{const t=new Ye.Workbook,s=t.addWorksheet("Transactions");s.columns=[{header:"ID",key:"id",width:10},{header:"Amount",key:"amount",width:15},{header:"Type",key:"type",width:12},{header:"Status",key:"status",width:12},{header:"Institute",key:"institute",width:30},{header:"Added By",key:"added_by",width:25},{header:"Approved By",key:"approved_by",width:25},{header:"Date",key:"date",width:18}],y.data.forEach(n=>{var i,u,v;s.addRow({id:n.id,amount:`$${parseFloat(n.total_amount.toString()).toFixed(2)}`,type:n.type.charAt(0).toUpperCase()+n.type.slice(1),status:n.status.charAt(0).toUpperCase()+n.status.slice(1),institute:((i=n.institute)==null?void 0:i.name)||"N/A",added_by:((u=n.added_by)==null?void 0:u.name)||"N/A",approved_by:((v=n.approved_by)==null?void 0:v.name)||"N/A",date:b(n.created_at)})});const a=await t.xlsx.writeBuffer(),r=new Blob([a],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"});qe.saveAs(r,"Transactions_Report.xlsx")},Ee=()=>{const t=new je;t.setFontSize(16),t.text("Transactions Report",14,15);const s=["ID","Amount","Type","Status","Institute","Added By","Approved By","Date"],a=y.data.map(r=>{var n,i,u;return[r.id.toString(),`$${parseFloat(r.total_amount.toString()).toFixed(2)}`,r.type.charAt(0).toUpperCase()+r.type.slice(1),r.status.charAt(0).toUpperCase()+r.status.slice(1),((n=r.institute)==null?void 0:n.name)||"N/A",((i=r.added_by)==null?void 0:i.name)||"N/A",((u=r.approved_by)==null?void 0:u.name)||"N/A",b(r.created_at)]});z(t,{head:[s],body:a,startY:25,styles:{fontSize:9,cellPadding:2},headStyles:{fillColor:[46,124,196],textColor:255,fontStyle:"bold"},alternateRowStyles:{fillColor:[240,240,240]}}),t.save("Transactions_Report.pdf")},Z=o.useMemo(()=>He.debounce(()=>{const t=new URLSearchParams({search:M.trim(),institute_id:f||"",region_id:S||"",added_by:A||"",approved_by:C||"",type:_||"",status:F||"",date_from:T||"",date_to:E||""});fetch(`/reports/transactions/gettransactions?${t.toString()}`).then(s=>{if(!s.ok)throw new Error("Network error");return s.json()}).then(s=>{V(s)}).catch(s=>{console.error("Fetch error:",s),j.error("Failed to load transactions")})},400),[M,f,S,A,C,_,F,T,E]),Re=async t=>{G(!0);try{const s=await fetch(`/reports/transactions/getbytid?tid=${t}`);if(!s.ok)throw new Error("Failed to load details");const{transaction:a,transdetails:r}=await s.json();Q(a),W(r),D(!0)}catch(s){j.error("Could not load transaction details"),console.error(s)}finally{G(!1)}},ee=(t,s)=>{var n,i,u;const a=new je;a.setFontSize(16),a.text(`Transaction #${t.id}`,14,15);const r=[["Amount",`RS ${parseFloat(t.total_amount.toString()).toFixed(2)}`],["Type",t.type.charAt(0).toUpperCase()+t.type.slice(1)],["Status",t.status.charAt(0).toUpperCase()+t.status.slice(1)],["Institute",((n=t.institute)==null?void 0:n.name)||"N/A"],["Added By",((i=t.added_by)==null?void 0:i.name)||"N/A"],["Approved By",((u=t.approved_by)==null?void 0:u.name)||"N/A"],["Date",b(t.created_at)]];if(z(a,{head:[["Field","Value"]],body:r,startY:25,styles:{fontSize:10},headStyles:{fillColor:[46,124,196]}}),s.length){const v=s.map(g=>{var re,ne,oe,de;return[((re=g.asset)==null?void 0:re.name)||"-",((ne=g.room)==null?void 0:ne.name)||"-",((oe=g.fund_head)==null?void 0:oe.name)||"-",g.qty??"-",`RS ${parseFloat(((de=g.amount)==null?void 0:de.toString())??"0").toFixed(2)}`]});z(a,{head:[["Asset","Room","Fund Head","Qty","Amount"]],body:v,startY:a.lastAutoTable.finalY+10,styles:{fontSize:9}})}a.save(`Transaction_#${t.id}.pdf`)};return o.useEffect(()=>()=>{D(!1),Q(null),W([])},[]),e.jsx(Xe,{children:e.jsxs(Ie,{breadcrumbs:We,children:[e.jsx(Be,{title:"Transactions Report"}),e.jsx("div",{className:"flex-1 p-1 md:p-1",children:e.jsxs("div",{className:"flex flex-col md:flex-row gap-3",children:[e.jsx("div",{className:"w-full md:w-1/4",children:e.jsxs(me,{children:[e.jsxs(pe,{children:[e.jsx(he,{className:"text-xl font-bold flex items-center gap-2",children:"Filters"}),e.jsx("p",{className:"text-muted-foreground text-sm",children:"Refine transaction search"})]}),e.jsxs(ue,{className:"space-y-4",children:[fe!=="Regional Office"&&J.length>0&&e.jsxs(I,{value:S,onValueChange:Fe,children:[e.jsx(U,{children:e.jsx($,{placeholder:"Select Region"})}),e.jsxs(L,{children:[e.jsx(p,{value:"0",children:"All Regions"}),J.map(t=>e.jsx(p,{value:t.id.toString(),children:t.name.split(" ").pop()||t.name},t.id))]})]}),e.jsx(O,{entity:"institute",value:f,onChange:w,options:Ce.map(t=>({id:t.id.toString(),name:t.name})),includeAllOption:!0,allOptionLabel:"All Institutes",placeholder:"Select Institute"}),e.jsx(O,{entity:"user",value:A,onChange:ge,options:K.map(t=>({id:t.id.toString(),name:t.name})),includeAllOption:!0,allOptionLabel:"All Users",placeholder:"Added By"}),e.jsx(O,{entity:"user",value:C,onChange:be,options:K.map(t=>({id:t.id.toString(),name:t.name})),includeAllOption:!0,allOptionLabel:"All Users",placeholder:"Approved By"}),e.jsxs(I,{value:_,onValueChange:Ne,children:[e.jsx(U,{children:e.jsx($,{placeholder:"Select Type"})}),e.jsxs(L,{children:[e.jsx(p,{value:"0",children:"All Types"}),e.jsx(p,{value:"purchase",children:"Purchase"}),e.jsx(p,{value:"maintenance",children:"Maintenance"}),e.jsx(p,{value:"condemned",children:"Condemned"})]})]}),e.jsxs(I,{value:F,onValueChange:ve,children:[e.jsx(U,{children:e.jsx($,{placeholder:"Select Status"})}),e.jsxs(L,{children:[e.jsx(p,{value:"0",children:"All Status"}),e.jsx(p,{value:"pending",children:"Pending"}),e.jsx(p,{value:"approved",children:"Approved"}),e.jsx(p,{value:"rejected",children:"Rejected"})]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(xe,{type:"date",value:T,onChange:t=>we(t.target.value),className:"flex-1"}),e.jsx(xe,{type:"date",value:E,onChange:t=>Se(t.target.value),className:"flex-1"})]}),e.jsx(x,{onClick:Z,className:"w-full",children:"Apply Filters"})]})]})}),e.jsx("div",{className:"w-full md:w-full",children:e.jsxs(me,{children:[e.jsxs(pe,{className:"pb-3 flex flex-col md:flex-row md:items-center md:justify-between gap-4",children:[e.jsx("div",{children:e.jsxs(he,{className:"text-2xl font-bold flex items-center gap-2",children:[e.jsx(ie,{className:"w-6 h-6"}),"Transactions Report"]})}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(x,{onClick:Ee,className:"w-full md:w-auto",children:"Export PDF"}),e.jsx(x,{onClick:Te,className:"w-full md:w-auto",children:"Export Excel"})]})]}),e.jsx(ce,{}),e.jsxs(ue,{className:"pt-6 space-y-6",children:[e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full border-collapse border-1 rounded-md overflow-hidden shadow-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-primary text-white text-center",children:[e.jsx("th",{className:"border p-2 font-medium",children:"ID"}),e.jsx("th",{className:"border p-2 font-medium",children:"Institute"}),e.jsx("th",{className:"border p-2 font-medium",children:"Amount"}),e.jsx("th",{className:"border p-2 font-medium",children:"Type"}),e.jsx("th",{className:"border p-2 font-medium",children:"Status"}),e.jsx("th",{className:"border p-2 font-medium",children:"Added By"}),e.jsx("th",{className:"border p-2 font-medium",children:"Approved By"}),e.jsx("th",{className:"border p-2 font-medium",children:"Date"}),e.jsx("th",{className:"border p-2 font-medium",children:"Action"})]})}),e.jsx("tbody",{children:y.data.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:9,className:"text-center p-4 text-muted-foreground",children:"No transactions found."})}):y.data.map(t=>{var s,a,r;return e.jsxs("tr",{className:"hover:bg-gray-50 dark:hover:bg-gray-700 text-center",children:[e.jsxs("td",{className:"border p-2",children:["#",t.id]}),e.jsx("td",{className:"border p-2 md:text-md lg:text-lg border-r-1 ",children:((s=t.institute)==null?void 0:s.name)||"N/A"}),e.jsx("td",{className:"border p-2 font-bold md:text-md lg:text-lg",children:parseFloat(t.total_amount.toString()).toFixed(2)}),e.jsx("td",{className:"border p-2",children:e.jsx("span",{className:`px-2 py-1 rounded text-xs font-medium ${t.type==="income"?"bg-green-100 text-green-800":"bg-red-100 text-red-800"}`,children:t.type.charAt(0).toUpperCase()+t.type.slice(1)})}),e.jsx("td",{className:"border p-2",children:e.jsxs("span",{className:`px-2 py-1 rounded text-xs font-medium flex items-center justify-center gap-1 ${t.status==="approved"?"bg-green-100 text-green-800":t.status==="rejected"?"bg-red-100 text-red-800":"bg-yellow-100 text-yellow-800"}`,children:[t.status==="approved"&&e.jsx(Ue,{className:"w-3 h-3"}),t.status==="rejected"&&e.jsx($e,{className:"w-3 h-3"}),t.status.charAt(0).toUpperCase()+t.status.slice(1)]})}),e.jsx("td",{className:"border p-2 md:text-md lg:text-lg border-r-1 ",children:((a=t.added_by)==null?void 0:a.name)||"N/A"}),e.jsx("td",{className:"border p-2 md:text-md lg:text-lg border-r-1 ",children:((r=t.approved_by)==null?void 0:r.name)||"N/A"}),e.jsx("td",{className:"border p-2 md:text-md lg:text-lg border-r-1",children:b(t.created_at)}),e.jsx("td",{className:"border p-2",children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx(x,{size:"icon",variant:"ghost",className:"h-8 w-8",onClick:()=>Re(t.id),disabled:X,title:"View details",children:X?e.jsx(Qe,{className:"h-4 w-4 animate-spin"}):e.jsx(Le,{className:"h-4 w-4"})}),e.jsx(x,{size:"icon",variant:"ghost",className:"h-8 w-8",onClick:()=>{q&&(d==null?void 0:d.id)===t.id?ee(d,B):fetch(`/reports/transactions/getbytid?tid=${t.id}`).then(n=>n.json()).then(({transaction:n,transdetails:i})=>{ee(n,i)}).catch(()=>j.error("Failed to generate PDF"))},title:"Download PDF",children:e.jsx(ze,{className:"h-4 w-4"})}),t.status==="pending"&&e.jsx(x,{size:"sm",variant:"default",className:"bg-green-600 hover:bg-green-700",onClick:()=>Ae(t.id),disabled:k,children:k?"Approving...":"Approve"})]})})]},t.id)})})]})}),e.jsx(Oe,{open:q,onOpenChange:D,children:e.jsxs(Pe,{className:"max-w-4xl max-h-[90vh] overflow-y-auto",children:[e.jsx(Me,{children:e.jsxs(Ve,{className:"flex items-center gap-2",children:[e.jsx(ie,{className:"w-5 h-5"}),"Transaction #",d==null?void 0:d.id]})}),d&&e.jsxs("div",{className:"mt-4 space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Amount:"})," RS ",parseFloat(d.total_amount.toString()).toFixed(2)]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Type:"})," ",d.type.charAt(0).toUpperCase()+d.type.slice(1)]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Status:"})," ",d.status.charAt(0).toUpperCase()+d.status.slice(1)]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Institute:"})," ",((te=d.institute)==null?void 0:te.name)||"N/A"]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Added By:"})," ",((se=d.added_by)==null?void 0:se.name)||"N/A"]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Approved By:"})," ",((ae=d.approved_by)==null?void 0:ae.name)||"N/A"]}),e.jsxs("div",{className:"col-span-2",children:[e.jsx("span",{className:"font-medium",children:"Date:"})," ",b(d.created_at)]})]}),e.jsx(ce,{}),B.length?e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full text-sm border",children:[e.jsx("thead",{className:"bg-muted",children:e.jsxs("tr",{children:[e.jsx("th",{className:"border p-2 text-left",children:"Asset"}),e.jsx("th",{className:"border p-2 text-left",children:"Room"}),e.jsx("th",{className:"border p-2 text-left",children:"Fund Head"}),e.jsx("th",{className:"border p-2 text-left",children:"Qty"}),e.jsx("th",{className:"border p-2 text-left",children:"Amount"})]})}),e.jsx("tbody",{children:B.map((t,s)=>{var a,r,n,i;return e.jsxs("tr",{className:"hover:bg-muted/50",children:[e.jsx("td",{className:"border p-2",children:((a=t.asset)==null?void 0:a.name)||"-"}),e.jsx("td",{className:"border p-2",children:((r=t.room)==null?void 0:r.name)||"-"}),e.jsx("td",{className:"border p-2",children:((n=t.fund_head)==null?void 0:n.name)||"-"}),e.jsx("td",{className:"border p-2",children:t.qty??"-"}),e.jsxs("td",{className:"border p-2",children:["RS ",parseFloat(((i=t.amount)==null?void 0:i.toString())??"0").toFixed(2)]})]},s)})})]})}):e.jsx("p",{className:"text-muted-foreground",children:"No line items."})]})]})}),y.links.length>1&&e.jsx("div",{className:"flex justify-center pt-6 flex-wrap gap-2",children:y.links.map((t,s)=>e.jsx(x,{disabled:!t.url,variant:t.active?"default":"outline",size:"sm",onClick:()=>{t.url&&fetch(t.url).then(a=>a.json()).then(a=>{V(a)}).catch(a=>{console.error("Error:",a)})},children:e.jsx("span",{dangerouslySetInnerHTML:{__html:t.label}})},s))})]})]})})]})})]})})}export{yt as default};
