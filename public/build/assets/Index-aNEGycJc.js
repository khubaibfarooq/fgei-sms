import{r as l,j as e,L as he,$ as B,S as x,a as f}from"./app-DndAw-cj.js";import{A as je,P as R,S as fe,e as ve,T as Ne,c as V}from"./app-layout-CUtuJ9IB.js";import{B as i}from"./button-D7beTIdL.js";import{C as k,a as D,b as be,c as A,d as ye}from"./card-DuVoY6UD.js";import{I as o}from"./input-_mw0L_ns.js";import{A as we,a as Ce,b as _e,c as Se,d as ke,e as De,f as Ae,g as Pe,h as Fe}from"./alert-dialog-Bi8frlY8.js";import{X as Me,D as q,a as K,b as W,c as X,d as G,e as J,t as m}from"./index-CBWTPZE2.js";import{T as Te,a as $e,b as Q,c as Y}from"./tabs-BO9WHWpR.js";import{B as v}from"./badge-CdyspmJQ.js";import{L as c}from"./label-BGsT_4en.js";import{T as Le}from"./textarea-DzDw4SJu.js";import Ee from"./ApprovalModal-BLdOgJgX.js";import{C as ze,a as Ie}from"./circle-x-Xqd7LKdH.js";import"./index-5ST579Yb.js";import"./createLucideIcon-Zftdm0RY.js";import"./index-BHjiyRYI.js";import"./index-B7HPx22p.js";import"./index-CUOWXGhR.js";import"./index-CuUs_T8F.js";import"./app-logo-icon-DVjb_-tR.js";import"./folder-root-CsVmuN8T.js";import"./grip-vertical-BvD8MxWn.js";const Oe=[{title:"Projects",href:"/projects"}];function nt({projects:g,filters:h,permissions:N}){var H;const[b,Z]=l.useState(h.search||""),[ee,te]=l.useState(h.status||""),[r,y]=l.useState(null),[P,F]=l.useState([]),[M,w]=l.useState([]),[T,$]=l.useState(!1),[se,L]=l.useState(!1),[ae,le]=l.useState(null),[re,C]=l.useState(!1),[p,de]=l.useState(null),[E,_]=l.useState(!1),[z,I]=l.useState({actual_cost:""}),ie=t=>{var a,d;return((d=(a=t.current_stage)==null?void 0:a.level)==null?void 0:d.toLowerCase())==="institutional"&&t.overall_status!=="approved"},[S,j]=l.useState(null),[s,n]=l.useState({name:"",description:"",due_date:"",status:"",completed_date:"",img:null,pdf:null}),[O,U]=l.useState(!1),ne=t=>{j(t),n({name:t.name,description:t.description||"",due_date:t.due_date?t.due_date.split("T")[0]:"",status:t.status,completed_date:t.completed_date?t.completed_date.split("T")[0]:"",img:null,pdf:null})},ce=async()=>{if(!S)return;U(!0);const t=new FormData;t.append("_method","PUT"),t.append("name",s.name),t.append("due_date",s.due_date),t.append("status",s.status),t.append("description",s.description),s.status==="completed"&&s.completed_date?t.append("completed_date",s.completed_date):t.append("completed_date",""),s.img&&t.append("img",s.img),s.pdf&&t.append("pdf",s.pdf);try{if(await f.post(`/milestones/${S.id}`,t,{headers:{"Content-Type":"multipart/form-data"}}),m.success("Milestone updated successfully"),j(null),r){const a=await f.get(`/projects/${r.id}/milestones`);w(a.data)}}catch(a){console.error(a),m.error("Failed to update milestone")}finally{U(!1)}},oe=t=>{x.delete(`/projects/${t}`,{onSuccess:()=>m.success("Project deleted successfully"),onError:()=>m.error("Failed to delete project")})},me=t=>{t.key==="Enter"&&x.get("/projects",{...h,search:b},{preserveScroll:!0})},xe=t=>{const a=t.target.value;te(a),pe({search:b,status:a})},pe=t=>{x.get("/projects",{...h,...t},{preserveScroll:!0,preserveState:!0,replace:!0,only:["projects","filters"]})};l.useEffect(()=>{r?($(!0),(async()=>{try{const[a,d]=await Promise.all([f.get(`/projects/${r.id}/history`),f.get(`/projects/${r.id}/milestones`)]);F(a.data),w(d.data)}catch(a){console.error("Failed to fetch project details",a),m.error("Failed to load project details.")}finally{$(!1)}})()):(F([]),w([]))},[r]);const ue=t=>{t.preventDefault(),p&&(_(!0),x.post(`/projects/${p.id}/update-cost`,ge(),{onSuccess:()=>{m.success("Actual cost updated successfully"),C(!1),_(!1)},onError:a=>{m.error("Failed to update cost"),_(!1)}}))},ge=()=>({actual_cost:z.actual_cost});return e.jsxs(je,{breadcrumbs:Oe,children:[e.jsx(he,{title:"Project Management"}),e.jsxs("div",{className:"flex flex-col lg:flex-row h-[calc(100vh-65px)] overflow-hidden",children:[e.jsx("div",{className:`flex-1 p-4 md:p-6 overflow-y-auto ${r?"lg:w-2/3":"w-full"}`,children:e.jsxs(k,{className:"h-full flex flex-col",children:[e.jsxs(D,{className:"pb-3 flex flex-col md:flex-row md:items-center md:justify-between gap-4 shrink-0",children:[e.jsxs("div",{children:[e.jsx(be,{className:"text-2xl font-bold",children:"Projects"}),e.jsx("p",{className:"text-muted-foreground text-sm md:text-md lg:text-lg",children:"Manage institutional projects"})]}),N.can_add&&e.jsx(B,{href:"/projects/create",children:e.jsxs(i,{children:[e.jsx(R,{className:"h-4 w-4 mr-2"}),"Add Project"]})})]}),e.jsx(fe,{}),e.jsxs(A,{className:"pt-6 space-y-6 flex-1 flex flex-col min-h-0",children:[e.jsxs("div",{className:"flex flex-col md:flex-row md:items-center gap-4 shrink-0",children:[e.jsx(o,{type:"text",placeholder:"Search projects... (press Enter)",value:b,onChange:t=>Z(t.target.value),onKeyDown:me}),e.jsxs("select",{value:ee,onChange:xe,className:"px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500",children:[e.jsx("option",{value:"",children:"All"}),e.jsx("option",{value:"inprogress",children:"InProgress"}),e.jsx("option",{value:"completed",children:"Completed"}),e.jsx("option",{value:"planned",children:"Planned"}),e.jsx("option",{value:"waiting",children:"Waiting"})]})]}),e.jsx("div",{className:"space-y-3 flex-1 overflow-auto",children:e.jsxs("table",{className:"w-full border-collapse border-1 rounded-md overflow-hidden shadow-sm",children:[e.jsx("thead",{className:"sticky top-0 z-10",children:e.jsxs("tr",{className:"bg-primary dark:bg-gray-800 text-center",children:[e.jsx("th",{className:"border p-2 text-sm md:text-md lg:text-lg font-medium text-white dark:text-gray-200",children:"Name"}),e.jsx("th",{className:"border p-2 text-sm md:text-md lg:text-lg font-medium text-white dark:text-gray-200",children:"Estimated Cost"}),e.jsx("th",{className:"border p-2 text-sm md:text-md lg:text-lg font-medium text-white dark:text-gray-200",children:"Actual Cost"}),e.jsx("th",{className:"border p-2 text-sm md:text-md lg:text-lg font-medium text-white dark:text-gray-200",children:"Priority"}),e.jsx("th",{className:"border p-2 text-sm md:text-md lg:text-lg font-medium text-white dark:text-gray-200",children:"Overall Status"}),e.jsx("th",{className:"border p-2 text-sm md:text-md lg:text-lg font-medium text-white dark:text-gray-200",children:"Approval Status"}),e.jsx("th",{className:"border p-2 text-sm md:text-md lg:text-lg font-medium text-white dark:text-gray-200",children:"Current Stage"}),e.jsx("th",{className:"border p-2 text-sm md:text-md lg:text-lg font-medium text-white dark:text-gray-200",children:"Action"})]})}),e.jsx("tbody",{children:g.data.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:6,className:"text-muted-foreground text-center p-4",children:"No projects found."})}):g.data.map(t=>{var a,d;return e.jsxs("tr",{className:`hover:bg-primary/10 dark:hover:bg-gray-700 text-center cursor-pointer transition-colors ${(r==null?void 0:r.id)===t.id?"bg-primary/5 dark:bg-gray-700 border-l-4 border-l-primary":""}`,onClick:()=>y(t),children:[e.jsx("td",{className:"border  text-sm md:text-md lg:text-lg text-gray-900 dark:text-gray-100",children:t.name}),e.jsx("td",{className:"border  text-sm md:text-md lg:text-lg text-gray-900 dark:text-gray-100",children:t.estimated_cost}),e.jsx("td",{className:"border text-sm md:text-md lg:text-lg text-gray-900 dark:text-gray-100",children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[t.actual_cost||"-",((a=t.current_stage)==null?void 0:a.can_change_cost)&&e.jsx(i,{variant:"ghost",size:"icon",className:"h-6 w-6 text-blue-600 hover:text-blue-700",title:"Add/Update Actual Cost",onClick:u=>{u.stopPropagation(),de(t),I({actual_cost:(t.actual_cost||"").toString()}),C(!0)},children:e.jsx(R,{className:"h-3 w-3"})})]})}),e.jsx("td",{className:"border  text-sm md:text-md lg:text-lg text-gray-900 dark:text-gray-100",children:t.priority||"-"}),e.jsx("td",{className:"border  text-sm md:text-md lg:text-lg text-gray-900 dark:text-gray-100",children:t.status}),e.jsx("td",{className:"border  text-sm md:text-md lg:text-lg text-gray-900 dark:text-gray-100",children:t.overall_status}),e.jsx("td",{className:"border  text-sm md:text-md lg:text-lg text-gray-900 dark:text-gray-100",children:((d=t.current_stage)==null?void 0:d.stage_name)||"Waiting"}),e.jsxs("td",{className:"border text-sm md:text-md lg:text-lg text-gray-900 dark:text-gray-100",onClick:u=>u.stopPropagation(),children:[N.can_edit&&e.jsx(B,{href:`/projects/${t.id}/edit`,children:e.jsx(i,{variant:"ghost",size:"icon",children:e.jsx(ve,{className:"h-4 w-4"})})}),N.can_delete&&e.jsxs(we,{children:[e.jsx(Ce,{asChild:!0,children:e.jsx(i,{variant:"ghost",size:"icon",className:"text-destructive hover:text-red-600",children:e.jsx(Ne,{className:"h-4 w-4"})})}),e.jsxs(_e,{children:[e.jsxs(Se,{children:[e.jsx(ke,{children:"Delete this project?"}),e.jsxs(De,{children:["Project ",e.jsx("strong",{children:t.name})," will be permanently deleted."]})]}),e.jsxs(Ae,{children:[e.jsx(Pe,{children:"Cancel"}),e.jsx(Fe,{className:"bg-destructive hover:bg-destructive/90",onClick:()=>oe(t.id),children:"Delete"})]})]})]}),ie(t)&&e.jsx(i,{variant:"ghost",size:"icon",title:"View/Approve",className:"text-blue-600 hover:text-blue-700",onClick:u=>{u.stopPropagation(),le(t),L(!0)},children:e.jsx(ye,{className:"h-4 w-4"})})]})]},t.id)})})]})}),g.links.length>1&&e.jsx("div",{className:"flex justify-center pt-6 flex-wrap gap-2 shrink-0",children:g.links.map((t,a)=>e.jsx(i,{disabled:!t.url,variant:t.active?"default":"outline",size:"sm",onClick:()=>x.visit(t.url||"",{preserveScroll:!0}),children:e.jsx("span",{dangerouslySetInnerHTML:{__html:t.label}})},a))})]})]})}),r&&e.jsxs("div",{className:"w-full lg:w-1/3 border-l bg-background p-4 md:p-6 shadow-xl overflow-y-auto flex flex-col h-full transition-all duration-300 ease-in-out z-20 absolute lg:relative right-0 top-0 lg:top-auto bottom-0 lg:bottom-auto",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-bold",children:r.name}),e.jsx("p",{className:"text-sm text-muted-foreground",children:(H=r.institute)==null?void 0:H.name})]}),e.jsx(i,{variant:"ghost",size:"icon",onClick:()=>y(null),children:e.jsx(Me,{className:"h-5 w-5"})})]}),e.jsxs(Te,{defaultValue:"approvals",className:"w-full flex-1 flex flex-col",children:[e.jsxs($e,{className:"grid w-full grid-cols-2",children:[e.jsx(Q,{value:"approvals",children:"Approvals"}),e.jsx(Q,{value:"milestones",children:"Milestones"})]}),e.jsxs("div",{className:"flex-1 overflow-y-auto mt-4 px-1",children:[e.jsx(Y,{value:"approvals",className:"space-y-4 m-0 h-full",children:T?e.jsx("div",{className:"flex justify-center py-8 text-muted-foreground",children:"Loading history..."}):P.length===0?e.jsx("div",{className:"text-center py-8 text-muted-foreground border rounded-lg border-dashed",children:"No approval history found."}):e.jsx("div",{className:"space-y-4",children:P.map(t=>{var a,d;return e.jsxs(k,{className:"overflow-hidden",children:[e.jsx(D,{className:"p-3 bg-muted/50 pb-2",children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsx("div",{className:"font-semibold text-sm",children:((a=t.stage)==null?void 0:a.stage_name)||"Stage"}),t.status==="approved"?e.jsxs(v,{variant:"outline",className:"border-green-500 text-green-600 bg-green-50 gap-1",children:[e.jsx(ze,{className:"w-3 h-3"})," Approved"]}):t.status==="rejected"?e.jsxs(v,{variant:"outline",className:"border-red-500 text-red-600 bg-red-50 gap-1",children:[e.jsx(Ie,{className:"w-3 h-3"})," Rejected"]}):e.jsxs(v,{variant:"outline",className:"border-yellow-500 text-yellow-600 bg-yellow-50 gap-1",children:[e.jsx(V,{className:"w-3 h-3"})," Pending"]})]})}),e.jsxs(A,{className:"p-3 text-sm",children:[e.jsxs("div",{className:"flex items-center text-xs text-muted-foreground mb-2",children:[e.jsx(V,{className:"w-3 h-3 mr-1"}),t.action_date?new Date(t.action_date).toLocaleString():""]}),e.jsxs("div",{className:"mb-2",children:[e.jsx("span",{className:"font-medium text-xs",children:"Approver: "}),(d=t.approver)==null?void 0:d.name]}),t.comments&&e.jsxs("div",{className:"bg-muted/30 p-2 rounded text-xs italic border",children:['"',t.comments,'"']}),t.pdf&&e.jsx("a",{href:`/${t.pdf}`,target:"_blank",className:"mt-1 text-blue-600 underline text-xs flex items-center gap-1",children:"View PDF"}),t.img&&e.jsx("div",{className:"mt-2",children:e.jsx("img",{src:`/${t.img}`,alt:"Evidence",className:"h-20 w-auto rounded border"})})]})]},t.id)})})}),e.jsx(Y,{value:"milestones",className:"space-y-4 m-0 h-full",children:T?e.jsx("div",{className:"flex justify-center py-8 text-muted-foreground",children:"Loading milestones..."}):M.length===0?e.jsx("div",{className:"text-center py-8 text-muted-foreground border rounded-lg border-dashed",children:"No milestones found."}):e.jsx("div",{className:"space-y-4",children:M.map(t=>e.jsxs(k,{className:"cursor-pointer hover:bg-muted/50 transition-colors",onClick:()=>ne(t),children:[e.jsx(D,{className:"p-3 pb-1",children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsx("div",{className:"font-semibold text-sm",children:t.name}),e.jsx(v,{variant:t.status==="completed"?"default":t.status==="inprogress"?"secondary":"outline",className:"capitalize text-xs",children:t.status})]})}),e.jsxs(A,{className:"p-3 text-sm space-y-2",children:[t.img&&e.jsx("div",{className:"mb-2",children:e.jsx("img",{src:`/${t.img}`,alt:t.name,className:"w-full h-32 object-cover rounded-md"})}),t.pdf&&e.jsx("a",{href:`/${t.pdf}`,target:"_blank",className:"mb-2 text-blue-600 underline text-xs flex items-center gap-1",children:"View Document (PDF)"}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 text-xs",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-muted-foreground",children:"Due: "}),new Date(t.due_date).toLocaleDateString()]}),t.completed_date&&e.jsxs("div",{children:[e.jsx("span",{className:"text-muted-foreground",children:"Completed: "}),e.jsx("span",{className:"text-green-600 dark:text-green-400",children:new Date(t.completed_date).toLocaleDateString()})]})]}),t.description&&e.jsx("p",{className:"text-muted-foreground text-xs mt-1",children:t.description})]})]},t.id))})})]})]})]})]}),r&&e.jsx("div",{className:"fixed inset-0 bg-black/20 lg:hidden z-10",onClick:()=>y(null)}),e.jsx(q,{open:!!S,onOpenChange:t=>!t&&j(null),children:e.jsxs(K,{className:"sm:max-w-[500px]",children:[e.jsxs(W,{children:[e.jsx(X,{children:"Edit Milestone"}),e.jsx(G,{children:"Update the details of the milestone. Click save when you're done."})]}),e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(c,{htmlFor:"name",className:"text-right",children:"Name"}),e.jsx(o,{id:"name",value:s.name,onChange:t=>n({...s,name:t.target.value}),className:"col-span-3"})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(c,{htmlFor:"status",className:"text-right",children:"Status"}),e.jsxs("select",{id:"status",value:s.status,onChange:t=>n({...s,status:t.target.value}),className:"col-span-3 flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",children:[e.jsx("option",{value:"pending",children:"Pending"}),e.jsx("option",{value:"inprogress",children:"In Progress"}),e.jsx("option",{value:"completed",children:"Completed"})]})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(c,{htmlFor:"due_date",className:"text-right",children:"Due Date"}),e.jsx(o,{id:"due_date",type:"date",value:s.due_date,onChange:t=>n({...s,due_date:t.target.value}),className:"col-span-3"})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(c,{htmlFor:"img",className:"text-right",children:"Image"}),e.jsx(o,{id:"img",type:"file",accept:"image/*",onChange:t=>{t.target.files&&t.target.files[0]&&n({...s,img:t.target.files[0]})},className:"col-span-3"})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(c,{htmlFor:"pdf",className:"text-right",children:"PDF"}),e.jsx(o,{id:"pdf",type:"file",accept:".pdf",onChange:t=>{t.target.files&&t.target.files[0]&&n({...s,pdf:t.target.files[0]})},className:"col-span-3"})]}),s.status==="completed"&&e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(c,{htmlFor:"completed_date",className:"text-right",children:"Completed"}),e.jsx(o,{id:"completed_date",type:"date",value:s.completed_date,onChange:t=>n({...s,completed_date:t.target.value}),className:"col-span-3"})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(c,{htmlFor:"description",className:"text-right",children:"Description"}),e.jsx(Le,{id:"description",value:s.description,onChange:t=>n({...s,description:t.target.value}),className:"col-span-3"})]})]}),e.jsxs(J,{children:[e.jsx(i,{type:"button",variant:"secondary",onClick:()=>j(null),children:"Cancel"}),e.jsx(i,{type:"submit",onClick:ce,disabled:O,children:O?"Saving...":"Save changes"})]})]})}),e.jsx(Ee,{isOpen:se,onClose:()=>L(!1),project:ae,onSuccess:()=>{x.reload({only:["projects"]})}}),e.jsx(q,{open:re,onOpenChange:C,children:e.jsxs(K,{className:"sm:max-w-[425px]",children:[e.jsxs(W,{children:[e.jsx(X,{children:"Update Actual Cost"}),e.jsxs(G,{children:["Enter the actual cost for ",e.jsx("strong",{children:p==null?void 0:p.name}),"."]})]}),e.jsxs("form",{onSubmit:ue,children:[e.jsx("div",{className:"grid gap-4 py-4",children:e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(c,{htmlFor:"actual_cost",className:"text-right",children:"Cost"}),e.jsx(o,{id:"actual_cost",type:"number",step:"0.01",className:"col-span-3",value:z.actual_cost,onChange:t=>I({actual_cost:t.target.value}),required:!0})]})}),e.jsx(J,{children:e.jsx(i,{type:"submit",disabled:E,children:E?"Updating...":"Save changes"})})]})]})})]})}export{nt as default};
