var $e=Object.defineProperty;var Le=(l,m,p)=>m in l?$e(l,m,{enumerable:!0,configurable:!0,writable:!0,value:p}):l[m]=p;var pe=(l,m,p)=>Le(l,typeof m!="symbol"?m+"":m,p);import{r as o,j as e,L as ze}from"./app-DimJN_WS.js";import{A as Oe,F as he,S as ue,b as Pe,E as Me,D as Ve}from"./app-layout-DK0DdOkt.js";import{B as j}from"./button-BwXTY4S-.js";import{C as xe,a as ye,b as je,c as fe}from"./card-BKCo--uN.js";import{I as be}from"./input-CdmvllK4.js";import{S as $,a as L,b as z,c as O,d as y}from"./select-JZoKuH9l.js";import{t as f,D as He,a as Ye,b as qe,c as Qe}from"./index-BVSErxBm.js";import{l as We}from"./lodash-CDNFmzsL.js";import{E as Xe,F as Ge,a as ge,b as P}from"./jspdf.plugin.autotable-Do88dWUL.js";import{f as v}from"./dateFormatter-Cn65gwBN.js";import{C as M}from"./combobox-C8enO5_7.js";import{a as Je}from"./circle-x-BcJA8Xk1.js";import{L as Ke}from"./app-logo-icon-DYfe2kzh.js";import"./index-DtaU_tud.js";import"./createLucideIcon-BauaUMKI.js";import"./index-Dll_kG58.js";import"./index-DPYtuGH9.js";import"./index-D5HUFt8e.js";import"./index-CLMamIW4.js";import"./folder-root-pkDpAmRA.js";import"./grip-vertical-BEMVS-6X.js";import"./index-DZT4mcNh.js";import"./index-Cg50APP6.js";import"./popover-8JECl8lU.js";const Ze=[{title:"Reports",href:"/reports"},{title:"Transactions",href:"/reports/transactions"}];class et extends o.Component{constructor(){super(...arguments);pe(this,"state",{hasError:!1,error:null})}static getDerivedStateFromError(p){return{hasError:!0,error:p.message}}componentDidCatch(p,A){console.error("ErrorBoundary:",p,A),f.error("An error occurred. Please try again.")}render(){return this.state.hasError?e.jsxs("div",{className:"p-4",children:[e.jsxs("p",{className:"text-red-600",children:["Error: ",this.state.error]}),e.jsx(j,{onClick:()=>window.location.reload(),className:"mt-2",children:"Retry"})]}):this.props.children}}const V=l=>l!=null&&typeof l.id=="number"&&l.id>0&&typeof l.name=="string"&&l.name.trim()!=="";function Ct({transactions:l,institutes:m,regions:p,users:A,types:Ne,filters:u,user_type:ve}){var ae,re,ne,oe,de;const[H,tt]=o.useState(u.search||""),[b,w]=o.useState(u.institute_id||""),[_,Ae]=o.useState(u.region_id||""),[C,Se]=o.useState(u.added_by||""),[F,we]=o.useState(u.approved_by||""),[T,_e]=o.useState(u.type||""),[k,Ce]=o.useState(u.status||""),[E,Fe]=o.useState(u.date_from||""),[R,Te]=o.useState(u.date_to||""),[g,Y]=o.useState(l),[q,D]=o.useState(m||[]),[B,Q]=o.useState(!1),[W,U]=o.useState(!1),[d,X]=o.useState(null),[I,G]=o.useState([]),[J,K]=o.useState(!1),ke=async t=>{var s;if(!B){Q(!0);try{if(!(await fetch(`/reports/transactions/approve?tid=${t}`,{method:"GET",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":((s=document.querySelector('meta[name="csrf-token"]'))==null?void 0:s.getAttribute("content"))||""}})).ok)throw new Error("Failed to approve");f.success("Transaction approved successfully"),te()}catch{f.error("Failed to approve transaction")}finally{Q(!1)}}},Ee=o.useMemo(()=>q.filter(V),[q]),Z=o.useMemo(()=>p.filter(V),[p]),ee=o.useMemo(()=>A.filter(V),[A]),Re=async t=>{if(!t||t==="0"){D(m||[]),b&&w("");return}try{const s=new URLSearchParams({region_id:t}).toString(),a=await fetch(`/reports/transactions/getinstitutes?${s}`);if(!a.ok)throw new Error("Failed to fetch institutes");const r=await a.json();D(r),b&&!r.some(n=>n.id.toString()===b)&&w("")}catch(s){console.error("Error fetching institutes:",s),f.error("Failed to load institutes"),D([])}},De=t=>{Ae(t),Re(t)},Be=async()=>{const t=new Xe.Workbook,s=t.addWorksheet("Transactions");s.columns=[{header:"ID",key:"id",width:10},{header:"Amount",key:"amount",width:15},{header:"Type",key:"type",width:15},{header:"Sub Type",key:"sub_type",width:15},{header:"Status",key:"status",width:12},{header:"Institute",key:"institute",width:30},{header:"Added By",key:"added_by",width:25},{header:"Approved By",key:"approved_by",width:25},{header:"Date",key:"date",width:18}],g.data.forEach(n=>{var i,c,h,x,S;s.addRow({id:n.id,amount:`$${parseFloat(n.total_amount.toString()).toFixed(2)}`,type:(i=n.type)!=null&&i.name?n.type.name.charAt(0).toUpperCase()+n.type.name.slice(1):"N/A",sub_type:(c=n.sub_type)!=null&&c.name?n.sub_type.name.charAt(0).toUpperCase()+n.sub_type.name.slice(1):"N/A",status:n.status.charAt(0).toUpperCase()+n.status.slice(1),institute:((h=n.institute)==null?void 0:h.name)||"N/A",added_by:((x=n.added_by)==null?void 0:x.name)||"N/A",approved_by:((S=n.approved_by)==null?void 0:S.name)||"N/A",date:v(n.created_at)})});const a=await t.xlsx.writeBuffer(),r=new Blob([a],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"});Ge.saveAs(r,"Transactions_Report.xlsx")},Ue=()=>{const t=new ge;t.setFontSize(16),t.text("Transactions Report",14,15);const s=["ID","Amount","Type","Sub Type","Status","Institute","Added By","Approved By","Date"],a=g.data.map(r=>{var n,i,c,h,x;return[r.id.toString(),`$${parseFloat(r.total_amount.toString()).toFixed(2)}`,(n=r.type)!=null&&n.name?r.type.name.charAt(0).toUpperCase()+r.type.name.slice(1):"N/A",(i=r.sub_type)!=null&&i.name?r.sub_type.name.charAt(0).toUpperCase()+r.sub_type.name.slice(1):"N/A",r.status.charAt(0).toUpperCase()+r.status.slice(1),((c=r.institute)==null?void 0:c.name)||"N/A",((h=r.added_by)==null?void 0:h.name)||"N/A",((x=r.approved_by)==null?void 0:x.name)||"N/A",v(r.created_at)]});P(t,{head:[s],body:a,startY:25,styles:{fontSize:9,cellPadding:2},headStyles:{fillColor:[46,124,196],textColor:255,fontStyle:"bold"},alternateRowStyles:{fillColor:[240,240,240]}}),t.save("Transactions_Report.pdf")},te=o.useMemo(()=>We.debounce(()=>{const t=new URLSearchParams({search:H.trim(),institute_id:b||"",region_id:_||"",added_by:C||"",approved_by:F||"",type:T||"",status:k||"",date_from:E||"",date_to:R||""});fetch(`/reports/transactions/gettransactions?${t.toString()}`).then(s=>{if(!s.ok)throw new Error("Network error");return s.json()}).then(s=>{Y(s)}).catch(s=>{console.error("Fetch error:",s),f.error("Failed to load transactions")})},400),[H,b,_,C,F,T,k,E,R]),Ie=async t=>{K(!0);try{const s=await fetch(`/reports/transactions/getbytid?tid=${t}`);if(!s.ok)throw new Error("Failed to load details");const{transaction:a,transdetails:r}=await s.json();X(a),G(r),U(!0)}catch(s){f.error("Could not load transaction details"),console.error(s)}finally{K(!1)}},se=(t,s)=>{var n,i,c,h,x;const a=new ge;a.setFontSize(16),a.text(`Transaction #${t.id}`,14,15);const r=[["Amount",`RS ${parseFloat(t.total_amount.toString()).toFixed(2)}`],["Type",(n=t.type)!=null&&n.name?t.type.name.charAt(0).toUpperCase()+t.type.name.slice(1):"N/A"],["Sub Type",(i=t.sub_type)!=null&&i.name?t.sub_type.name.charAt(0).toUpperCase()+t.sub_type.name.slice(1):"N/A"],["Status",t.status.charAt(0).toUpperCase()+t.status.slice(1)],["Institute",((c=t.institute)==null?void 0:c.name)||"N/A"],["Added By",((h=t.added_by)==null?void 0:h.name)||"N/A"],["Approved By",((x=t.approved_by)==null?void 0:x.name)||"N/A"],["Date",v(t.created_at)]];if(P(a,{head:[["Field","Value"]],body:r,startY:25,styles:{fontSize:10},headStyles:{fillColor:[46,124,196]}}),s.length){const S=s.map(N=>{var le,ie,ce,me;return[((le=N.asset)==null?void 0:le.name)||"-",((ie=N.room)==null?void 0:ie.name)||"-",((ce=N.fund_head)==null?void 0:ce.name)||"-",N.qty??"-",`RS ${parseFloat(((me=N.amount)==null?void 0:me.toString())??"0").toFixed(2)}`]});P(a,{head:[["Asset","Room","Fund Head","Qty","Amount"]],body:S,startY:a.lastAutoTable.finalY+10,styles:{fontSize:9}})}a.save(`Transaction_#${t.id}.pdf`)};return o.useEffect(()=>()=>{U(!1),X(null),G([])},[]),e.jsx(et,{children:e.jsxs(Oe,{breadcrumbs:Ze,children:[e.jsx(ze,{title:"Transactions Report"}),e.jsx("div",{className:"flex-1 p-1 md:p-1",children:e.jsxs("div",{className:"flex flex-col md:flex-row gap-3",children:[e.jsx("div",{className:"w-full md:w-1/4",children:e.jsxs(xe,{children:[e.jsxs(ye,{children:[e.jsx(je,{className:"text-xl font-bold flex items-center gap-2",children:"Filters"}),e.jsx("p",{className:"text-muted-foreground text-sm",children:"Refine transaction search"})]}),e.jsxs(fe,{className:"space-y-4",children:[ve!=="Regional Office"&&Z.length>0&&e.jsxs($,{value:_,onValueChange:De,children:[e.jsx(L,{children:e.jsx(z,{placeholder:"Select Region"})}),e.jsxs(O,{children:[e.jsx(y,{value:"0",children:"All Regions"}),Z.map(t=>e.jsx(y,{value:t.id.toString(),children:t.name.split(" ").pop()||t.name},t.id))]})]}),e.jsx(M,{entity:"institute",value:b,onChange:w,options:Ee.map(t=>({id:t.id.toString(),name:t.name})),includeAllOption:!0,allOptionLabel:"All Institutes",placeholder:"Select Institute"}),e.jsx(M,{entity:"user",value:C,onChange:Se,options:ee.map(t=>({id:t.id.toString(),name:t.name})),includeAllOption:!0,allOptionLabel:"All Users",placeholder:"Added By"}),e.jsx(M,{entity:"user",value:F,onChange:we,options:ee.map(t=>({id:t.id.toString(),name:t.name})),includeAllOption:!0,allOptionLabel:"All Users",placeholder:"Approved By"}),e.jsxs($,{value:T,onValueChange:_e,children:[e.jsx(L,{children:e.jsx(z,{placeholder:"Select Type"})}),e.jsxs(O,{children:[e.jsx(y,{value:"0",children:"All Types"}),Ne.map(t=>e.jsx(y,{value:t.id.toString(),children:t.name},t.id))]})]}),e.jsxs($,{value:k,onValueChange:Ce,children:[e.jsx(L,{children:e.jsx(z,{placeholder:"Select Status"})}),e.jsxs(O,{children:[e.jsx(y,{value:"0",children:"All Status"}),e.jsx(y,{value:"pending",children:"Pending"}),e.jsx(y,{value:"approved",children:"Approved"}),e.jsx(y,{value:"rejected",children:"Rejected"})]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(be,{type:"date",value:E,onChange:t=>Fe(t.target.value),className:"flex-1"}),e.jsx(be,{type:"date",value:R,onChange:t=>Te(t.target.value),className:"flex-1"})]}),e.jsx(j,{onClick:te,className:"w-full",children:"Apply Filters"})]})]})}),e.jsx("div",{className:"w-full md:w-full",children:e.jsxs(xe,{children:[e.jsxs(ye,{className:"pb-3 flex flex-col md:flex-row md:items-center md:justify-between gap-4",children:[e.jsx("div",{children:e.jsxs(je,{className:"text-2xl font-bold flex items-center gap-2",children:[e.jsx(he,{className:"w-6 h-6"}),"Transactions Report"]})}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(j,{onClick:Ue,className:"w-full md:w-auto",children:"Export PDF"}),e.jsx(j,{onClick:Be,className:"w-full md:w-auto",children:"Export Excel"})]})]}),e.jsx(ue,{}),e.jsxs(fe,{className:"pt-6 space-y-6",children:[e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full border-collapse border-1 rounded-md overflow-hidden shadow-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-primary text-white text-center",children:[e.jsx("th",{className:"border p-2 font-medium",children:"ID"}),e.jsx("th",{className:"border p-2 font-medium",children:"Institute"}),e.jsx("th",{className:"border p-2 font-medium",children:"Amount"}),e.jsx("th",{className:"border p-2 font-medium",children:"Type"}),e.jsx("th",{className:"border p-2 font-medium",children:"Sub Type"}),e.jsx("th",{className:"border p-2 font-medium",children:"Status"}),e.jsx("th",{className:"border p-2 font-medium",children:"Added By"}),e.jsx("th",{className:"border p-2 font-medium",children:"Approved By"}),e.jsx("th",{className:"border p-2 font-medium",children:"Date"}),e.jsx("th",{className:"border p-2 font-medium",children:"Action"})]})}),e.jsx("tbody",{children:g.data.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:9,className:"text-center p-4 text-muted-foreground",children:"No transactions found."})}):g.data.map(t=>{var s,a,r,n,i;return e.jsxs("tr",{className:"hover:bg-gray-50 dark:hover:bg-gray-700 text-center",children:[e.jsxs("td",{className:"border p-2",children:["#",t.id]}),e.jsx("td",{className:"border p-2 md:text-md lg:text-lg border-r-1 ",children:((s=t.institute)==null?void 0:s.name)||"N/A"}),e.jsx("td",{className:"border p-2 font-bold md:text-md lg:text-lg",children:parseFloat(t.total_amount.toString()).toFixed(2)}),e.jsx("td",{className:"border p-2",children:e.jsx("span",{className:"px-2 py-1 rounded text-xs font-medium bg-blue-100 text-blue-800",children:(a=t.type)!=null&&a.name?t.type.name.charAt(0).toUpperCase()+t.type.name.slice(1):"N/A"})}),e.jsx("td",{className:"border p-2",children:e.jsx("span",{className:"px-2 py-1 rounded text-xs font-medium bg-gray-100 text-gray-800",children:(r=t.sub_type)!=null&&r.name?t.sub_type.name.charAt(0).toUpperCase()+t.sub_type.name.slice(1):"N/A"})}),e.jsx("td",{className:"border p-2",children:e.jsxs("span",{className:`px-2 py-1 rounded text-xs font-medium flex items-center justify-center gap-1 ${t.status==="approved"?"bg-green-100 text-green-800":t.status==="rejected"?"bg-red-100 text-red-800":"bg-yellow-100 text-yellow-800"}`,children:[t.status==="approved"&&e.jsx(Pe,{className:"w-3 h-3"}),t.status==="rejected"&&e.jsx(Je,{className:"w-3 h-3"}),t.status.charAt(0).toUpperCase()+t.status.slice(1)]})}),e.jsx("td",{className:"border p-2 md:text-md lg:text-lg border-r-1 ",children:((n=t.added_by)==null?void 0:n.name)||"N/A"}),e.jsx("td",{className:"border p-2 md:text-md lg:text-lg border-r-1 ",children:((i=t.approved_by)==null?void 0:i.name)||"N/A"}),e.jsx("td",{className:"border p-2 md:text-md lg:text-lg border-r-1",children:v(t.created_at)}),e.jsx("td",{className:"border p-2",children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx(j,{size:"icon",variant:"ghost",className:"h-8 w-8",onClick:()=>Ie(t.id),disabled:J,title:"View details",children:J?e.jsx(Ke,{className:"h-4 w-4 animate-spin"}):e.jsx(Me,{className:"h-4 w-4"})}),e.jsx(j,{size:"icon",variant:"ghost",className:"h-8 w-8",onClick:()=>{W&&(d==null?void 0:d.id)===t.id?se(d,I):fetch(`/reports/transactions/getbytid?tid=${t.id}`).then(c=>c.json()).then(({transaction:c,transdetails:h})=>{se(c,h)}).catch(()=>f.error("Failed to generate PDF"))},title:"Download PDF",children:e.jsx(Ve,{className:"h-4 w-4"})}),t.status==="pending"&&e.jsx(j,{size:"sm",variant:"default",className:"bg-green-600 hover:bg-green-700",onClick:()=>ke(t.id),disabled:B,children:B?"Approving...":"Approve"})]})})]},t.id)})})]})}),e.jsx(He,{open:W,onOpenChange:U,children:e.jsxs(Ye,{className:"max-w-4xl max-h-[90vh] overflow-y-auto",children:[e.jsx(qe,{children:e.jsxs(Qe,{className:"flex items-center gap-2",children:[e.jsx(he,{className:"w-5 h-5"}),"Transaction #",d==null?void 0:d.id]})}),d&&e.jsxs("div",{className:"mt-4 space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Amount:"})," RS ",parseFloat(d.total_amount.toString()).toFixed(2)]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Type:"})," ",(ae=d.type)!=null&&ae.name?d.type.name.charAt(0).toUpperCase()+d.type.name.slice(1):"N/A"]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Sub Type:"})," ",(re=d.sub_type)!=null&&re.name?d.sub_type.name.charAt(0).toUpperCase()+d.sub_type.name.slice(1):"N/A"]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Status:"})," ",d.status.charAt(0).toUpperCase()+d.status.slice(1)]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Institute:"})," ",((ne=d.institute)==null?void 0:ne.name)||"N/A"]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Added By:"})," ",((oe=d.added_by)==null?void 0:oe.name)||"N/A"]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Approved By:"})," ",((de=d.approved_by)==null?void 0:de.name)||"N/A"]}),e.jsxs("div",{className:"col-span-2",children:[e.jsx("span",{className:"font-medium",children:"Date:"})," ",v(d.created_at)]})]}),e.jsx(ue,{}),I.length?e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full text-sm border",children:[e.jsx("thead",{className:"bg-muted",children:e.jsxs("tr",{children:[e.jsx("th",{className:"border p-2 text-left",children:"Asset"}),e.jsx("th",{className:"border p-2 text-left",children:"Room"}),e.jsx("th",{className:"border p-2 text-left",children:"Fund Head"}),e.jsx("th",{className:"border p-2 text-left",children:"Qty"}),e.jsx("th",{className:"border p-2 text-left",children:"Amount"})]})}),e.jsx("tbody",{children:I.map((t,s)=>{var a,r,n,i;return e.jsxs("tr",{className:"hover:bg-muted/50",children:[e.jsx("td",{className:"border p-2",children:((a=t.asset)==null?void 0:a.name)||"-"}),e.jsx("td",{className:"border p-2",children:((r=t.room)==null?void 0:r.name)||"-"}),e.jsx("td",{className:"border p-2",children:((n=t.fund_head)==null?void 0:n.name)||"-"}),e.jsx("td",{className:"border p-2",children:t.qty??"-"}),e.jsxs("td",{className:"border p-2",children:["RS ",parseFloat(((i=t.amount)==null?void 0:i.toString())??"0").toFixed(2)]})]},s)})})]})}):e.jsx("p",{className:"text-muted-foreground",children:"No line items."})]})]})}),g.links.length>1&&e.jsx("div",{className:"flex justify-center pt-6 flex-wrap gap-2",children:g.links.map((t,s)=>e.jsx(j,{disabled:!t.url,variant:t.active?"default":"outline",size:"sm",onClick:()=>{t.url&&fetch(t.url).then(a=>a.json()).then(a=>{Y(a)}).catch(a=>{console.error("Error:",a)})},children:e.jsx("span",{dangerouslySetInnerHTML:{__html:t.label}})},s))})]})]})})]})})]})})}export{Ct as default};
