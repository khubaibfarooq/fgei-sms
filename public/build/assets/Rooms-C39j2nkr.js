var fe=Object.defineProperty;var ge=(l,i,c)=>i in l?fe(l,i,{enumerable:!0,configurable:!0,writable:!0,value:c}):l[i]=c;var q=(l,i,c)=>ge(l,typeof i!="symbol"?i+"":i,c);import{r as o,j as t,L as ye}from"./app-CsRabZIE.js";import{t as m,A as be,S as je}from"./app-layout-AmNCWhto.js";import{B as k}from"./button-DKUJQQbh.js";import{C as G,a as K,b as Q,c as X}from"./card-hbcu5ndH.js";import{I as we}from"./input-Bg9HEyWP.js";import{S as Z,a as ee,b as te,c as re,d as F}from"./select-DUo2en-W.js";import{l as ke}from"./lodash-Bqz_eeyQ.js";import{E as Ne,F as Re,a as ve,b as Se}from"./jspdf.plugin.autotable-Bud6PxqA.js";import{C as se}from"./combobox-BDv0sKLd.js";import{I as Ee}from"./image-preview-D5te-kk7.js";import"./index-DB1ngrAf.js";import"./createLucideIcon-D1E5yMEV.js";import"./index-DPeRmpZB.js";import"./app-logo-icon-mJQ_HioP.js";import"./folder-root-UxgFfGbj.js";import"./grip-vertical-DQLhSE1M.js";import"./index-ByiDLiKL.js";import"./index-BarukBXI.js";import"./popover-Cod8jqd9.js";const Ce=[{title:"Reports",href:"/reports"},{title:"Rooms",href:"/reports/rooms"}];class Ae extends o.Component{constructor(){super(...arguments);q(this,"state",{hasError:!1,error:null})}static getDerivedStateFromError(c){return{hasError:!0,error:c.message}}componentDidCatch(c,f){console.error("ErrorBoundary caught:",c,f),m.error("An error occurred while rendering the component. Please try again or contact support.")}render(){return this.state.hasError?t.jsxs("div",{className:"p-4",children:[t.jsxs("p",{className:"text-red-600",children:["Error: ",this.state.error]}),t.jsx(k,{onClick:()=>window.location.reload(),className:"mt-2",children:"Retry"})]}):this.props.children}}const p=l=>{const i=l!=null&&typeof l.id=="number"&&l.id>0&&typeof l.name=="string"&&l.name.trim()!=="";return i||console.warn("Invalid item detected:",l),i};function Qe({rooms:l,institutes:i,roomtypes:c,regions:f,filters:b}){var U,H,W;const[N,oe]=o.useState(b.search||""),[h,_]=o.useState(b.institute_id||""),[R,I]=o.useState(b.block_id||""),[v,ae]=o.useState(b.roomtype_id||""),[S,le]=o.useState(b.region_id||""),[E,z]=o.useState(l),[u,L]=o.useState(i||[]),[P,C]=o.useState([]),[T,D]=o.useState(!1),[Fe,ne]=o.useState([]),ie=async e=>{try{const r=new URLSearchParams({region_id:e||""}).toString(),s=await fetch(`/reports/getInstitutes?${r}`);if(!s.ok)throw new Error("Failed to fetch institutes");const a=await s.json();console.log("Fetched institutes:",a),L(a),h&&e!=="0"&&!a.some(n=>n.id.toString()===h)&&_("")}catch(r){console.error("Error fetching institutes:",r),m.error("Failed to load institutes"),L([])}},ce=e=>{le(e),ie(e)};o.useEffect(()=>{h?(D(!0),fetch(`/reports/rooms/getInstituteBlocks?institute_id=${h}`).then(e=>e.json()).then(e=>{if(console.log("Fetched blocks:",e),Array.isArray(e)){const r=e.filter(p);C(r)}else console.warn("Blocks response is not an array:",e),m.error("Invalid blocks data received"),C([])}).catch(e=>{console.error("Error fetching blocks:",e),m.error("Failed to fetch blocks"),C([])}).finally(()=>D(!1)),I("")):(C([]),I(""))},[h]);const M=async()=>{try{const e=new URLSearchParams({search:N||"",institute_id:h||"",block_id:R||"",roomtype_id:v||"",region_id:S||"",all:"true"}),r=await fetch(`/reports/rooms/getRoomsReport?${e.toString()}`);if(!r.ok)throw new Error("Failed to fetch all rooms for export");const s=await r.json();return ne(s),s}catch(e){return console.error("Error fetching all rooms for export:",e),m.error("Failed to fetch rooms for export"),[]}};o.useEffect(()=>{const e={institutes:Array.isArray(u)?u.filter(r=>!p(r)):[],roomtypes:c.filter(r=>!p(r)),regions:f.filter(r=>!p(r))};Object.entries(e).forEach(([r,s])=>{s.length>0&&console.warn(`Invalid ${r}:`,s)})},[i,c,f,u]);const de=async()=>{var e,r;try{const s=await M(),a=new Ne.Workbook,n=a.addWorksheet("Rooms"),B=s.length>0&&((r=(e=s[0].block)==null?void 0:e.institute)!=null&&r.name)?s[0].block.institute.name:"All Institutes";n.mergeCells("A1:E1");const j=n.getCell("A1");j.value=`Institute: ${B}`,j.font={size:16,bold:!0},j.alignment={horizontal:"center"},n.mergeCells("A2:E2");const x=n.getCell("A2");x.value="Rooms Report",x.font={size:14,bold:!0},x.alignment={horizontal:"center"},n.addRow([]);const A=["Room Name","Room Type","Block","Area","Capacity"],g=n.addRow(A);g.font={bold:!0},g.fill={type:"pattern",pattern:"solid",fgColor:{argb:"FF428BCA"}},g.alignment={horizontal:"center"},s.forEach(d=>{var y,w;n.addRow([d.name||"—",((y=d.room_type)==null?void 0:y.name)||"N/A",((w=d.block)==null?void 0:w.name)||"N/A",d.area||"N/A",d.capacity||"N/A"])}),n.columns.forEach(d=>{var w;let y=0;(w=d.eachCell)==null||w.call(d,{includeEmpty:!0},J=>{const Y=J.value?J.value.toString().length:10;Y>y&&(y=Y)}),d.width=Math.min(y+2,50)});const pe=await a.xlsx.writeBuffer(),ue=new Blob([pe],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"});Re.saveAs(ue,"Rooms_Report.xlsx"),m.success("Excel exported successfully")}catch(s){console.error("Error exporting to Excel:",s),m.error("Failed to export Excel")}},me=async()=>{var e,r;try{const s=await M(),a=new ve,n=s.length>0&&((r=(e=s[0].block)==null?void 0:e.institute)!=null&&r.name)?s[0].block.institute.name:"All Institutes";a.setFontSize(16),a.setFont("helvetica","bold"),a.text(`Institute: ${n}`,14,15),a.setFontSize(14),a.text("Rooms Report",14,25);const B=["Room Name","Room Type","Block","Area","Capacity"],j=s.map(x=>{var A,g;return[x.name||"—",((A=x.room_type)==null?void 0:A.name)||"N/A",((g=x.block)==null?void 0:g.name)||"N/A",x.area||"N/A",x.capacity||"N/A"]});Se(a,{head:[B],body:j,startY:35,styles:{fontSize:9,cellPadding:2},headStyles:{fillColor:[66,139,202],textColor:255,fontStyle:"bold"},alternateRowStyles:{fillColor:[240,240,240]}}),a.save("Rooms_Report.pdf"),m.success("PDF exported successfully")}catch(s){console.error("Error exporting to PDF:",s),m.error("Failed to export PDF")}},he=o.useMemo(()=>ke.debounce(()=>{const e=new URLSearchParams({search:N||"",institute_id:h||"",block_id:R||"",roomtype_id:v||"",region_id:S||""});fetch(`/reports/rooms/getRoomsReport?${e.toString()}`).then(r=>r.json()).then(r=>{console.log("Fetched filtered rooms:",r),z(r)}).catch(r=>{console.error("Error fetching filtered rooms:",r),m.error("Failed to fetch filtered rooms")})},300),[N,h,R,v,S]),xe=o.useMemo(()=>Array.isArray(u)?u.filter(p):(console.warn("filteredInstitutes is not an array or is null:",u),[]),[u]),$=o.useMemo(()=>P.filter(p),[P]),V=o.useMemo(()=>c.filter(p),[c]),O=o.useMemo(()=>f.filter(p),[f]);return t.jsx(Ae,{children:t.jsxs(be,{breadcrumbs:Ce,children:[t.jsx(ye,{title:"Rooms Report"}),t.jsx("div",{className:"flex-1 p-2 md:p-2",children:t.jsxs("div",{className:"flex flex-col md:flex-row gap-3",children:[t.jsx("div",{className:"w-full md:w-1/3",children:t.jsxs(G,{children:[t.jsxs(K,{children:[t.jsx(Q,{className:"text-xl font-bold",children:"Filters"}),t.jsx("p",{className:"text-muted-foreground text-sm",children:"Refine your rooms search"})]}),t.jsxs(X,{className:"space-y-4",children:[O.length>0&&t.jsx(se,{entity:"region",value:S,onChange:e=>ce(e),options:O.map(e=>({id:e.id.toString(),name:e.name.split(" ").pop()||e.name})),includeAllOption:!0}),t.jsx(se,{entity:"institute",value:h,onChange:e=>_(e),options:xe.map(e=>({id:e.id.toString(),name:e.name})),includeAllOption:!0}),t.jsxs(Z,{value:R,onValueChange:e=>{I(e)},disabled:T,children:[t.jsx(ee,{children:t.jsx(te,{placeholder:"Select Block"})}),t.jsxs(re,{children:[t.jsx(F,{value:"0",children:"All Blocks"}),T?t.jsx("div",{className:"text-muted-foreground text-sm p-2",children:"Loading blocks..."}):$.length>0?$.map(e=>t.jsx(F,{value:e.id.toString(),children:e.name},e.id)):t.jsx("div",{className:"text-muted-foreground text-sm p-2",children:"No blocks available"})]})]}),t.jsxs(Z,{value:v,onValueChange:e=>{ae(e)},children:[t.jsx(ee,{children:t.jsx(te,{placeholder:"Select Room Type"})}),t.jsxs(re,{children:[t.jsx(F,{value:"0",children:"All Room Types"}),V.length>0?V.map(e=>t.jsx(F,{value:e.id.toString(),children:e.name},e.id)):t.jsx("div",{className:"text-muted-foreground text-sm p-2",children:"No room types available"})]})]}),t.jsx(we,{type:"text",placeholder:"Search rooms...",value:N,onChange:e=>oe(e.target.value)}),t.jsx(k,{onClick:he,className:"w-full",children:"Apply Filters"})]})]})}),t.jsx("div",{className:"w-full md:w-2/3",children:t.jsxs(G,{children:[t.jsxs(K,{className:"pb-3 flex flex-col md:flex-row md:items-center md:justify-between gap-4",children:[t.jsx("div",{children:t.jsx(Q,{className:"text-2xl font-bold",children:"Rooms Report"})}),t.jsxs("div",{className:"flex gap-2",children:[t.jsx(k,{onClick:me,className:"w-full md:w-auto",children:"Export PDF"}),t.jsx(k,{onClick:de,className:"w-full md:w-auto",children:"Export Excel"})]})]}),t.jsx(je,{}),t.jsxs(X,{className:"pt-6 space-y-6",children:[t.jsxs("table",{className:"w-full border-collapse border-1 rounded-md overflow-hidden shadow-sm",children:[t.jsx("thead",{children:t.jsxs("tr",{className:"bg-primary dark:bg-gray-800",children:[t.jsx("th",{className:"border p-2 text-left text-sm font-medium text-white dark:text-gray-200",children:"Room Name"}),t.jsx("th",{className:"border p-2 text-left text-sm font-medium text-white dark:text-gray-200",children:"Room Type"}),t.jsx("th",{className:"border p-2 text-left text-sm font-medium text-white dark:text-gray-200",children:"Block"}),t.jsx("th",{className:"border p-2 text-left text-sm font-medium text-white dark:text-gray-200",children:"Area"}),"  ",t.jsx("th",{className:"border p-2 text-left text-sm font-medium text-white dark:text-gray-200",children:"Institute"})]})}),t.jsx("tbody",{children:((U=E.data)==null?void 0:U.length)===0?t.jsx("tr",{children:t.jsx("td",{colSpan:5,className:"border p-2 text-center text-sm text-gray-900 dark:text-gray-100",children:"No rooms found."})}):(H=E.data)==null?void 0:H.map(e=>{var r,s,a,n;return t.jsxs("tr",{className:"hover:bg-primary/10 dark:hover:bg-gray-700",children:[t.jsx("td",{className:"border p-2 text-left font-bold dark:text-gray-100",children:t.jsxs("div",{className:"flex flex-column gap-2 align-middle",children:[" ",t.jsx(Ee,{dataImg:e.img,size:"h-20"}),"  ",t.jsx("span",{className:"font-bold",children:e.name})]})}),t.jsx("td",{className:"border p-2 text-left text-gray-900 dark:text-gray-100",children:((r=e.type)==null?void 0:r.name)||"—"}),t.jsx("td",{className:"border p-2 text-left text-gray-900 dark:text-gray-100",children:((s=e.block)==null?void 0:s.name)||"—"}),t.jsx("td",{className:"border p-2 text-left text-gray-900 dark:text-gray-100",children:e.area||"—"}),t.jsx("td",{className:"border p-2 text-left text-gray-900 dark:text-gray-100",children:((n=(a=e.block)==null?void 0:a.institute)==null?void 0:n.name)||"—"})]},e.id)})})]}),((W=E.links)==null?void 0:W.length)>1&&t.jsx("div",{className:"flex justify-center pt-6 flex-wrap gap-2",children:E.links.map((e,r)=>t.jsx(k,{disabled:!e.url,variant:e.active?"default":"outline",size:"sm",onClick:()=>{e.url&&fetch(e.url).then(s=>s.json()).then(s=>{z(s)}).catch(s=>{console.error("Error:",s)})},className:e.active?"bg-blue-600 hover:bg-blue-700":"",children:t.jsx("span",{dangerouslySetInnerHTML:{__html:e.label}})},r))})]})]})})]})})]})})}export{Qe as default};
