var Ie=Object.defineProperty;var Le=(c,h,x)=>h in c?Ie(c,h,{enumerable:!0,configurable:!0,writable:!0,value:x}):c[h]=x;var pe=(c,h,x)=>Le(c,typeof h!="symbol"?h+"":h,x);import{r as o,j as t,L as Be}from"./app-D0XCGo6K.js";import{t as i,A as ze,S as De}from"./app-layout-ZFB9N5y8.js";import{B as z}from"./button-Ds3k49oq.js";import{C as je,a as ye,b as be,c as we}from"./card-Cq-zI5Aj.js";import{I as $e}from"./input-D1690gyV.js";import{S as O,a as H,b as J,c as Y,d as b}from"./select-B0GxlyOS.js";import{l as Pe}from"./lodash-DpfOmCEF.js";import{E as Te,F as Me,a as Ve,b as qe}from"./jspdf.plugin.autotable-COVAgtd4.js";import{C as Se}from"./combobox-DZHr6_pv.js";import"./index-FhISw8Lz.js";import"./createLucideIcon-DT9J98xU.js";import"./index-BMGgBE6f.js";import"./app-logo-icon-DlSFNQ9x.js";import"./folder-root-DG5YQKeL.js";import"./grip-vertical-n__iThbr.js";import"./index-DtGqD42w.js";import"./index-C5FOUGHJ.js";import"./popover-ByFysPNe.js";const Qe=[{title:"Reports",href:"/reports"},{title:"Assets",href:"/reports/assets"}];class We extends o.Component{constructor(){super(...arguments);pe(this,"state",{hasError:!1,error:null})}static getDerivedStateFromError(x){return{hasError:!0,error:x.message}}componentDidCatch(x,C){console.error("ErrorBoundary caught:",x,C),i.error("An error occurred while rendering the component. Please try again or contact support.")}render(){return this.state.hasError?t.jsxs("div",{className:"p-4",children:[t.jsxs("p",{className:"text-red-600",children:["Error: ",this.state.error]}),t.jsx(z,{onClick:()=>window.location.reload(),className:"mt-2",children:"Retry"})]}):this.props.children}}const a=c=>{const h=c!=null&&typeof c.id=="number"&&c.id>0&&typeof c.name=="string"&&c.name.trim()!=="";return h||console.warn("Invalid item detected:",c),h};function xt({instituteAssets:c,institutes:h,blocks:x,rooms:C,assetCategories:D,assets:$,regions:P,filters:w}){var ue,fe,ge;const[E,Ue]=o.useState(w.search||""),[u,K]=o.useState(w.institute_id||""),[g,X]=o.useState(w.block_id||""),[N,A]=o.useState(w.room_id||""),[p,ve]=o.useState(w.asset_category_id||""),[R,T]=o.useState(w.asset_id||""),[k,Ne]=o.useState(w.region_id||""),[Z,M]=o.useState(x.filter(a)),[ee,_]=o.useState(C.filter(a)),[G,V]=o.useState($.filter(a)),[te,se]=o.useState(!1),[re,oe]=o.useState(!1),[Oe,ae]=o.useState(!1),[q,Q]=o.useState(c),[S,le]=o.useState(h||[]),[He,ke]=o.useState([]),[d,ne]=o.useState(!1);console.log("assets",G);const _e=async e=>{try{const s=new URLSearchParams({region_id:e||""}).toString(),r=await fetch(`/reports/getInstitutes?${s}`);if(!r.ok)throw new Error("Failed to fetch institutes");const l=await r.json();console.log("Fetched institutes:",l),le(l),u&&e!=="0"&&!l.some(v=>v.id.toString()===u)&&K("")}catch(s){console.error("Error fetching institutes:",s),i.error("Failed to load institutes"),le([])}},Fe=e=>{Ne(e),_e(e)},ie=async()=>{try{const e=new URLSearchParams({search:E||"",institute_id:u||"",block_id:g||"",room_id:N||"",asset_category_id:p||"",asset_id:R||"",region_id:k||"",details:d?"true":"false",all:"true"}),s=await fetch(`/reports/assets/institute-assets?${e.toString()}`);if(!s.ok)throw new Error("Failed to fetch all assets for export");const r=await s.json();return ke(r),r}catch(e){return console.error("Error fetching all assets for export:",e),i.error("Failed to fetch assets for export"),[]}};o.useEffect(()=>{const e={institutes:Array.isArray(S)?S.filter(s=>!a(s)):[],blocks:x.filter(s=>!a(s)),rooms:C.filter(s=>!a(s)),assetCategories:D.filter(s=>!a(s)),assets:$.filter(s=>!a(s)),regions:P.filter(s=>!a(s))};Object.entries(e).forEach(([s,r])=>{r.length>0&&console.warn(`Invalid ${s}:`,r)})},[h,x,C,D,$,P,S]),o.useEffect(()=>{u?(se(!0),fetch(`/reports/blocks?institute_id=${u}`).then(e=>e.json()).then(e=>{if(console.log("Fetched blocks:",e),Array.isArray(e)){const s=e.filter(a);s.length<e.length&&console.warn("Filtered out invalid blocks:",e.filter(r=>!a(r))),M(s)}else console.warn("Blocks response is not an array:",e),i.error("Invalid blocks data received"),M([])}).catch(e=>{console.error("Error fetching blocks:",e),i.error("Failed to fetch blocks"),M([])}).finally(()=>se(!1)),X(""),_([]),A("")):(M([]),_([]),A(""))},[u]),o.useEffect(()=>{g?(oe(!0),fetch(`/reports/rooms?block_id=${g}`).then(e=>e.json()).then(e=>{if(console.log("Fetched rooms:",e),Array.isArray(e)){const s=e.filter(a);s.length<e.length&&console.warn("Filtered out invalid rooms:",e.filter(r=>!a(r))),_(s)}else console.warn("Rooms response is not an array:",e),i.error("Invalid rooms data received"),_([])}).catch(e=>{console.error("Error fetching rooms:",e),i.error("Failed to fetch rooms"),_([])}).finally(()=>oe(!1)),A("")):(_([]),A(""))},[g]),o.useEffect(()=>{p?(ae(!0),fetch(`/reports/assets/list?asset_category_id=${p}`).then(e=>e.json()).then(e=>{if(console.log("Fetched assets:",e),Array.isArray(e)){const s=e.filter(a);s.length<e.length&&console.warn("Filtered out invalid assets:",e.filter(r=>!a(r))),V(s)}else console.warn("Assets response is not an array:",e),i.error("Invalid assets data received"),V([])}).catch(e=>{console.error("Error fetching assets:",e),i.error("Failed to fetch assets"),V([])}).finally(()=>ae(!1)),T("")):(V($.filter(a)),T(""))},[p]),o.useEffect(()=>{const e=new URLSearchParams({search:E||"",institute_id:u||"",block_id:g||"",room_id:N||"",asset_category_id:p||"",asset_id:R||"",region_id:k||"",details:d?"true":"false"});fetch(`/reports/assets/institute-assets?${e.toString()}`).then(s=>s.json()).then(s=>{console.log("Fetched institute assets after details toggle:",s),Q(s)}).catch(s=>{console.error("Error fetching assets after details toggle:",s),i.error("Failed to fetch assets")})},[d]);const Ce=async()=>{var e;try{const s=await ie(),r=new Te.Workbook,l=r.addWorksheet("Assets"),v=s.length>0&&((e=s[0].institute)!=null&&e.name)?s[0].institute.name:"All Institutes";l.mergeCells("A1:F1");const y=l.getCell("A1");y.value=`Institute: ${v}`,y.font={size:16,bold:!0},y.alignment={horizontal:"center"},l.mergeCells("A2:F2");const m=l.getCell("A2");m.value="Assets Report",m.font={size:14,bold:!0},m.alignment={horizontal:"center"},l.addRow([]);const f=d?["Details","Quantity","Block","Room","Category","Asset"]:["Asset","Total Quantity","Rooms"],F=l.addRow(f);F.font={bold:!0},F.fill={type:"pattern",pattern:"solid",fgColor:{argb:"FF428BCA"}},F.alignment={horizontal:"center"},s.forEach(n=>{var j,I,L,B;d?l.addRow([n.details||"N/A",n.current_qty||0,((j=n.room.block)==null?void 0:j.name)||"N/A",((I=n.room)==null?void 0:I.name)||"N/A",((L=n.asset.category)==null?void 0:L.name)||"N/A",((B=n.asset)==null?void 0:B.name)||"N/A"]):l.addRow([n.name||"—",n.total_qty||0,n.locations_count||0])}),l.columns.forEach(n=>{var I;let j=0;(I=n.eachCell)==null||I.call(n,{includeEmpty:!0},L=>{const B=L.value?L.value.toString().length:10;B>j&&(j=B)}),n.width=Math.min(j+2,50)});const W=await r.xlsx.writeBuffer(),U=new Blob([W],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"});Me.saveAs(U,"Assets_Report.xlsx"),i.success("Excel exported successfully")}catch(s){console.error("Error exporting to Excel:",s),i.error("Failed to export Excel")}},Ee=async()=>{var e;try{const s=await ie(),r=new Ve,l=s.length>0&&((e=s[0].institute)!=null&&e.name)?s[0].institute.name:"All Institutes";r.setFontSize(16),r.setFont("helvetica","bold"),r.text(`Institute: ${l}`,14,15),r.setFontSize(14),r.text("Assets Report",14,25);const v=d?["Details","Qty","Block","Room","Category","Asset"]:["Asset","Total Quantity","Rooms"],y=s.map(m=>{var f,F,W,U,n,j;return d?[m.details||"N/A",((f=m.current_qty)==null?void 0:f.toString())||"0",((F=m.room)==null?void 0:F.block.name)||"N/A",((W=m.room)==null?void 0:W.name)||"N/A",((n=(U=m.asset)==null?void 0:U.category)==null?void 0:n.name)||"N/A",((j=m.asset)==null?void 0:j.name)||"N/A"]:[m.name||"—",(m.total_qty||0).toString(),(m.locations_count||0).toString()]});qe(r,{head:[v],body:y,startY:35,styles:{fontSize:9,cellPadding:2},headStyles:{fillColor:[66,139,202],textColor:255,fontStyle:"bold"},alternateRowStyles:{fillColor:[240,240,240]},columnStyles:d?{0:{cellWidth:50},1:{halign:"center",cellWidth:20},5:{cellWidth:50}}:{0:{cellWidth:80},1:{halign:"center"},2:{halign:"center"}}}),r.save("Assets_Report.pdf"),i.success("PDF exported successfully")}catch(s){console.error("Error exporting to PDF:",s),i.error("Failed to export PDF")}},Ae=o.useMemo(()=>Pe.debounce(()=>{const e=new URLSearchParams({search:E||"",institute_id:u||"",block_id:g||"",room_id:N||"",asset_category_id:p||"",asset_id:R||"",region_id:k||"",details:d?"true":"false"});fetch(`/reports/assets/institute-assets?${e.toString()}`).then(s=>s.json()).then(s=>{console.log("Fetched filtered institute assets:",s),Q(s)}).catch(s=>{console.error("Error fetching filtered assets:",s),i.error("Failed to fetch filtered assets")})},300),[E,u,g,N,p,R,k,d]),Re=o.useMemo(()=>Array.isArray(S)?S.filter(a):(console.warn("filteredInstitutes is not an array or is null:",S),[]),[S]),ce=o.useMemo(()=>Z.filter(a),[Z]),de=o.useMemo(()=>ee.filter(a),[ee]),me=o.useMemo(()=>D.filter(a),[D]),he=o.useMemo(()=>G.filter(a),[G]),xe=o.useMemo(()=>P.filter(a),[P]);return t.jsx(We,{children:t.jsxs(ze,{breadcrumbs:Qe,children:[t.jsx(Be,{title:"Assets Report"}),t.jsx("div",{className:"flex-1 p-2 md:p-2",children:t.jsxs("div",{className:"flex flex-col md:flex-row gap-3",children:[t.jsx("div",{className:"w-full md:w-1/3",children:t.jsxs(je,{children:[t.jsxs(ye,{children:[t.jsx(be,{className:"text-xl font-bold",children:"Filters"}),t.jsx("p",{className:"text-muted-foreground text-sm",children:"Refine your assets search"})]}),t.jsxs(we,{className:"space-y-4",children:[xe.length>0&&t.jsx(Se,{entity:"region",value:k,onChange:e=>Fe(e),options:xe.map(e=>({id:e.id.toString(),name:e.name.split(" ").pop()||e.name})),includeAllOption:!0}),t.jsx(Se,{entity:"institute",value:u,onChange:e=>K(e),options:Re.map(e=>({id:e.id.toString(),name:e.name})),includeAllOption:!0}),t.jsxs(O,{value:g,onValueChange:e=>{X(e)},disabled:te,children:[t.jsx(H,{children:t.jsx(J,{placeholder:"Select Block"})}),t.jsxs(Y,{children:[t.jsx(b,{value:"0",children:"All Blocks"}),te?t.jsx("div",{className:"text-muted-foreground text-sm p-2",children:"Loading blocks..."}):ce.length>0?ce.map(e=>t.jsx(b,{value:e.id.toString(),children:e.name},e.id)):t.jsx("div",{className:"text-muted-foreground text-sm p-2",children:"No blocks available"})]})]}),t.jsxs(O,{value:N,onValueChange:e=>{A(e)},disabled:re,children:[t.jsx(H,{children:t.jsx(J,{placeholder:"Select Room"})}),t.jsxs(Y,{children:[t.jsx(b,{value:"0",children:"All Rooms"}),re?t.jsx("div",{className:"text-muted-foreground text-sm p-2",children:"Loading rooms..."}):de.length>0?de.map(e=>t.jsx(b,{value:e.id.toString(),children:e.name.split(" ").pop()||e.name},e.id)):t.jsx("div",{className:"text-muted-foreground text-sm p-2",children:"No rooms available"})]})]}),t.jsxs(O,{value:p,onValueChange:e=>{ve(e)},children:[t.jsx(H,{children:t.jsx(J,{placeholder:"Select Asset Category"})}),t.jsxs(Y,{children:[t.jsx(b,{value:"0",children:"All Asset Categories"}),me.length>0?me.map(e=>t.jsx(b,{value:e.id.toString(),children:e.name},e.id)):t.jsx("div",{className:"text-muted-foreground text-sm p-2",children:"No asset categories available"})]})]}),t.jsxs(O,{value:R,onValueChange:e=>{T(e)},children:[t.jsx(H,{children:t.jsx(J,{placeholder:"Select Asset"})}),t.jsxs(Y,{children:[t.jsx(b,{value:"0",children:"All Assets"}),he.length>0?he.map(e=>t.jsx(b,{value:e.id.toString(),children:e.name},e.id)):t.jsx("div",{className:"text-muted-foreground text-sm p-2",children:"No assets available"})]})]}),t.jsxs("div",{className:"flex items-center gap-3 py-2",children:[t.jsx($e,{type:"checkbox",id:"details-mode",checked:d,onChange:e=>ne(e.target.checked)}),t.jsxs("label",{htmlFor:"details-mode",className:"cursor-pointer select-none font-medium text-sm",children:[d?"Detailed View":"Summary View"," — Show individual entries"]})]}),t.jsx(z,{onClick:Ae,className:"w-full",children:"Apply Filters"})]})]})}),t.jsx("div",{className:"w-full md:w-2/3",children:t.jsxs(je,{children:[t.jsxs(ye,{className:"pb-3 flex flex-col md:flex-row md:items-center md:justify-between gap-4",children:[t.jsx("div",{children:t.jsx(be,{className:"text-2xl font-bold",children:"Assets Report"})}),t.jsxs("div",{className:"flex gap-2",children:[t.jsx(z,{onClick:Ee,className:"w-full md:w-auto",children:"Export PDF"}),t.jsx(z,{onClick:Ce,className:"w-full md:w-auto",children:"Export Excel"})]})]}),t.jsx(De,{}),t.jsxs(we,{className:"pt-6 space-y-6",children:[t.jsxs("table",{className:"w-full border-collapse border-1 rounded-md overflow-hidden shadow-sm",children:[t.jsx("thead",{children:t.jsx("tr",{className:"bg-primary dark:bg-gray-800",children:d?t.jsxs(t.Fragment,{children:[t.jsx("th",{className:"border p-2 text-left text-sm font-medium text-white dark:text-gray-200",children:"Category"}),t.jsx("th",{className:"border p-2 text-left text-sm font-medium text-white dark:text-gray-200",children:"Asset"}),t.jsx("th",{className:"border p-2 text-center text-sm font-medium text-white dark:text-gray-200",children:"Quantity"}),t.jsx("th",{className:"border p-2 text-left text-sm font-medium text-white dark:text-gray-200",children:"Room / Block"}),t.jsx("th",{className:"border p-2 text-left text-sm font-medium text-white dark:text-gray-200",children:"Added Date"})]}):t.jsxs(t.Fragment,{children:["   ",t.jsx("th",{className:"border p-2 text-left text-sm font-medium text-white dark:text-gray-200",children:"Asset"}),t.jsx("th",{className:"border p-2 text-center text-sm font-medium text-white dark:text-gray-200",children:"Total Quantity"}),t.jsx("th",{className:"border p-2 text-center text-sm font-medium text-white dark:text-gray-200",children:"Rooms"})]})})}),t.jsx("tbody",{children:((ue=q.data)==null?void 0:ue.length)===0?t.jsx("tr",{children:t.jsx("td",{colSpan:d?5:3,className:"border p-2 text-center text-sm text-gray-900 dark:text-gray-100",children:"No assets found."})}):(fe=q.data)==null?void 0:fe.map((e,s)=>{var r,l;if(!d){const v=y=>{ne(!0),T(y.toString()),setTimeout(()=>{const m=new URLSearchParams({search:E||"",institute_id:u||"",block_id:g||"",room_id:N||"",asset_category_id:p||"",asset_id:y.toString(),region_id:k||"",details:"true"});fetch(`/reports/assets/institute-assets?${m.toString()}`).then(f=>f.json()).then(f=>{console.log("Fetched asset details:",f),Q(f)}).catch(f=>{console.error("Error fetching asset details:",f),i.error("Failed to fetch asset details")})},0)};return t.jsxs("tr",{className:"hover:bg-primary/10 dark:hover:bg-gray-700 cursor-pointer",onClick:()=>v(e.id),children:[t.jsx("td",{className:"border p-2 text-left font-bold dark:text-gray-100",children:e.name}),t.jsx("td",{className:"border p-2 text-center text-lg font-bold text-green-600",children:e.total_qty}),t.jsx("td",{className:"border p-2 text-center text-amber-600",children:e.locations_count||"-"})]},`${e.name}-${s}`)}return e.asset?t.jsxs("tr",{className:"hover:bg-primary/10 dark:hover:bg-gray-700",children:[t.jsx("td",{className:"border p-2 text-left font-bold dark:text-gray-100",children:(r=e.asset)==null?void 0:r.category.name}),t.jsx("td",{className:"border p-2 text-left font-bold dark:text-gray-100",children:(l=e.asset)==null?void 0:l.name}),t.jsx("td",{className:"border p-2 text-center font-bold text-lg text-green-600",children:e.current_qty}),t.jsx("td",{className:"border p-2 text-sm text-gray-900 dark:text-gray-100",children:e.room?t.jsxs(t.Fragment,{children:[e.room.name,e.room.block&&t.jsxs("span",{className:"text-muted-foreground",children:[" (",e.room.block.name,")"]})]}):"—"}),t.jsx("td",{className:"border p-2 text-sm text-gray-900 dark:text-gray-100",children:e.added_date?new Date(e.added_date).toLocaleDateString():"—"})]},e.id):t.jsx("tr",{children:t.jsx("td",{colSpan:5,className:"text-center text-muted-foreground py-4",children:"Loading details..."})},s)})})]}),((ge=q.links)==null?void 0:ge.length)>1&&t.jsx("div",{className:"flex justify-center pt-6 flex-wrap gap-2",children:q.links.map((e,s)=>t.jsx(z,{disabled:!e.url,variant:e.active?"default":"outline",size:"sm",onClick:()=>{e.url&&fetch(e.url).then(r=>r.json()).then(r=>{Q(r)}).catch(r=>{console.error("Error:",r)})},className:e.active?"bg-blue-600 hover:bg-blue-700":"",children:t.jsx("span",{dangerouslySetInnerHTML:{__html:e.label}})},s))})]})]})})]})})]})})}export{xt as default};
