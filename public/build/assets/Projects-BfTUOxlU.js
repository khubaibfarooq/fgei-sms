var K=Object.defineProperty;var Q=(r,o,n)=>o in r?K(r,o,{enumerable:!0,configurable:!0,writable:!0,value:n}):r[o]=n;var k=(r,o,n)=>Q(r,typeof o!="symbol"?o+"":o,n);import{r as l,j as e,L as X,S as Z}from"./app-DP9dkHX6.js";import{t as A,A as ee,S as te}from"./app-layout-Bjqdg_aF.js";import{B as f}from"./button-D9YN_eAK.js";import{C as _,a as F,b as I,c as T}from"./card-BVe_l3G1.js";import{S as z,a as B,b as L,c as M,d as h}from"./select-DlePk8t0.js";import{l as se}from"./lodash-CC82JFO7.js";import{E as re,F as oe,a as ae,b as ne}from"./jspdf.plugin.autotable-CxvmLWwh.js";import{C as V}from"./combobox-BYsp3_Pb.js";import"./index-UKHHs9Zt.js";import"./createLucideIcon-BDpQS6v7.js";import"./input-D2cWxQ17.js";import"./index-Dlmi4Jgv.js";import"./app-logo-icon-CN-McaLz.js";import"./folder-root-CeDQ0Pc3.js";import"./grip-vertical-r4wb2W3f.js";import"./index-Dy-BYE7o.js";import"./index-C-bBHB_2.js";import"./popover-COBg33Nd.js";const le=[{title:"Reports",href:"/reports"},{title:"Projects",href:"/reports/projects"}];class ie extends l.Component{constructor(){super(...arguments);k(this,"state",{hasError:!1,error:null})}static getDerivedStateFromError(n){return{hasError:!0,error:n.message}}componentDidCatch(n,u){console.error("ErrorBoundary caught:",n,u),A.error("An error occurred. Please try again or contact support.")}render(){return this.state.hasError?e.jsxs("div",{className:"p-4",children:[e.jsxs("p",{className:"text-red-600",children:["Error: ",this.state.error]}),e.jsx(f,{onClick:()=>window.location.reload(),className:"mt-2",children:"Retry"})]}):this.props.children}}const C=r=>{const o=r!=null&&typeof r.id=="number"&&r.id>0&&typeof r.name=="string"&&r.name.trim()!=="";return o||console.warn("Invalid item:",r),o};function Re({projects:r,institutes:o,regions:n,projectTypes:u,filters:p}){const[P,ce]=l.useState(p.search||""),[d,g]=l.useState(p.institute_id||""),[y,D]=l.useState(p.project_type_id||""),[b,U]=l.useState(p.status||""),[m,$]=l.useState(r),[N,S]=l.useState(o||[]),[w,H]=l.useState(p.region_id||""),O=l.useMemo(()=>Array.isArray(N)?N.filter(C):[],[N]),E=l.useMemo(()=>Array.isArray(n)?n.filter(C):[],[n]),W=l.useMemo(()=>Array.isArray(u)?u.filter(C):[],[u]),J=async t=>{if(!t||t==="0"){S(o||[]),d&&g("");return}try{const s=new URLSearchParams({region_id:t}).toString(),c=await fetch(`/reports/getInstitutes?${s}`);if(!c.ok)throw new Error("Failed to fetch institutes");const a=await c.json();S(a),d&&!a.some(i=>i.id.toString()===d)&&g("")}catch(s){console.error("Error fetching institutes:",s),A.error("Failed to load institutes"),S([])}},Y=t=>{H(t),J(t)},q=async()=>{const t=new re.Workbook,s=t.addWorksheet("Projects");s.columns=[{header:"Name",key:"name",width:30},{header:"Cost",key:"cost",width:15},{header:"Status",key:"status",width:15},{header:"Project Type",key:"project_type",width:25},{header:"Institute",key:"institute",width:30},{header:"Region",key:"region",width:25}],m.data.forEach(i=>{var x,j,R;s.addRow({name:i.name,cost:i.cost,status:i.status,project_type:((x=i.project_type)==null?void 0:x.name)||"N/A",institute:((j=i.institute)==null?void 0:j.name)||"N/A",region:((R=i.region)==null?void 0:R.name)||"N/A"})});const c=await t.xlsx.writeBuffer(),a=new Blob([c],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"});oe.saveAs(a,"Projects_Report.xlsx")},G=()=>{const t=new ae;t.setFontSize(16),t.text("Projects Report",14,15);const s=["Name","Cost","Status","Project Type","Institute","Region"],c=m.data.map(a=>{var i,x,j;return[a.name,a.cost,a.status,((i=a.project_type)==null?void 0:i.name)||"N/A",((x=a.institute)==null?void 0:x.name)||"N/A",((j=a.region)==null?void 0:j.name)||"N/A"]});ne(t,{head:[s],body:c,startY:25,styles:{fontSize:9,cellPadding:2},headStyles:{fillColor:[66,139,202],textColor:255,fontStyle:"bold"},alternateRowStyles:{fillColor:[240,240,240]}}),t.save("Projects_Report.pdf")},v=l.useMemo(()=>se.debounce(()=>{const t=new URLSearchParams({search:P.trim(),institute_id:d||"",region_id:w||"",project_type_id:y||"",status:b||""});fetch(`/reports/projects/getprojects?${t.toString()}`).then(s=>s.json()).then(s=>{console.log("Filtered projects:",s),$(s)}).catch(s=>{console.error("Fetch error:",s),A.error("Failed to load projects")})},300),[P,d,w,y,b]);return e.jsx(ie,{children:e.jsxs(ee,{breadcrumbs:le,children:[e.jsx(X,{title:"Projects Report"}),e.jsx("div",{className:"flex-1 p-1 md:p-1",children:e.jsxs("div",{className:"flex flex-col md:flex-row gap-3",children:[e.jsx("div",{className:"w-full md:w-1/3",children:e.jsxs(_,{children:[e.jsxs(F,{children:[e.jsx(I,{className:"text-xl font-bold",children:"Filters"}),e.jsx("p",{className:"text-muted-foreground text-sm",children:"Refine your project search"})]}),e.jsxs(T,{className:"space-y-4",children:[E.length>0&&e.jsx(V,{entity:"region",value:w,onChange:t=>Y(t),options:E.map(t=>({id:t.id.toString(),name:t.name.split(" ").pop()||t.name})),includeAllOption:!0}),e.jsx(V,{entity:"institute",value:d,onChange:g,options:O.map(t=>({id:t.id.toString(),name:t.name})),includeAllOption:!1,placeholder:"Select Institute"}),e.jsxs(z,{value:y,onValueChange:t=>{D(t),v()},children:[e.jsx(B,{children:e.jsx(L,{placeholder:"Select Project Type"})}),e.jsxs(M,{children:[e.jsx(h,{value:"0",children:"All Project Types"}),W.map(t=>e.jsx(h,{value:t.id.toString(),children:t.name},t.id))]})]}),e.jsxs(z,{value:b,onValueChange:t=>{U(t),v()},children:[e.jsx(B,{children:e.jsx(L,{placeholder:"Select Status"})}),e.jsxs(M,{children:[e.jsx(h,{value:"all",children:"All Status"}),e.jsx(h,{value:"planned",children:"Planned"}),e.jsx(h,{value:"inprogress",children:"In Progress"}),e.jsx(h,{value:"completed",children:"Completed"})]})]}),e.jsx(f,{onClick:v,className:"w-full",children:"Apply Filters"})]})]})}),e.jsx("div",{className:"w-full md:w-2/3",children:e.jsxs(_,{children:[e.jsxs(F,{className:"pb-3 flex flex-col md:flex-row md:items-center md:justify-between gap-4",children:[e.jsx("div",{children:e.jsx(I,{className:"text-2xl font-bold",children:"Projects Report"})}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(f,{onClick:G,className:"w-full md:w-auto",children:"Export PDF"}),e.jsx(f,{onClick:q,className:"w-full md:w-auto",children:"Export Excel"})]})]}),e.jsx(te,{}),e.jsxs(T,{className:"pt-6 space-y-6",children:[e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full border-collapse border-1 rounded-md overflow-hidden shadow-sm  text-sm md:text-md lg:text-lg",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-primary text-white text-center",children:[e.jsx("th",{className:"border p-2 font-medium",children:"Name"}),e.jsx("th",{className:"border p-2 font-medium",children:"Cost"}),e.jsx("th",{className:"border p-2 font-medium",children:"Status"}),e.jsx("th",{className:"border p-2 font-medium",children:"Project Type"}),e.jsx("th",{className:"border p-2 font-medium",children:"Institute"}),e.jsx("th",{className:"border p-2 font-medium",children:"Region"})]})}),e.jsx("tbody",{children:m.data.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:6,className:"text-center p-4 text-muted-foreground",children:"No projects found."})}):m.data.map(t=>{var s,c,a;return e.jsxs("tr",{className:"hover:bg-primary/10 dark:hover:bg-gray-700",children:[e.jsx("td",{className:"border p-2  font-bold text-left",children:t.name}),e.jsx("td",{className:"border p-2 text-right",children:t.cost}),e.jsx("td",{className:"border p-2",children:e.jsx("span",{className:`px-2 py-1 rounded text-xs font-medium ${t.status==="completed"?"bg-green-100 text-green-800":t.status==="inprogress"?"bg-yellow-100 text-yellow-800":"bg-blue-100 text-blue-800"}`,children:t.status.charAt(0).toUpperCase()+t.status.slice(1)})}),e.jsx("td",{className:"border p-2",children:((s=t.project_type)==null?void 0:s.name)||"N/A"}),e.jsx("td",{className:"border p-2",children:((c=t.institute)==null?void 0:c.name)||"N/A"}),e.jsx("td",{className:"border p-2",children:((a=t.region)==null?void 0:a.name)||"N/A"})]},t.id)})})]})}),m.links.length>1&&e.jsx("div",{className:"flex justify-center pt-6 flex-wrap gap-2",children:m.links.map((t,s)=>e.jsx(f,{disabled:!t.url,variant:t.active?"default":"outline",size:"sm",onClick:()=>Z.visit(t.url||"",{preserveScroll:!0}),children:e.jsx("span",{dangerouslySetInnerHTML:{__html:t.label}})},s))})]})]})})]})})]})})}export{Re as default};
