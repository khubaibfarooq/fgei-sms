var B=Object.defineProperty;var L=(a,o,s)=>o in a?B(a,o,{enumerable:!0,configurable:!0,writable:!0,value:s}):a[o]=s;var v=(a,o,s)=>L(a,typeof o!="symbol"?o+"":o,s);import{r as l,j as t,L as q}from"./app-C6CARr3D.js";import{t as b,A as z}from"./app-layout-BI9mSViY.js";import{B as p}from"./button-3nLpZ-ZW.js";import{C as T,a as D,b as M,c as O}from"./card-3EA8-CgN.js";import{l as Q}from"./lodash-B-fgfIrf.js";import{E as $,F as H,a as U,b as V}from"./jspdf.plugin.autotable-fedCm7fb.js";import{C as A}from"./combobox-DOoqtFXB.js";import"./index-Bsk09trE.js";import"./createLucideIcon-C8c_Ozgo.js";import"./input-BdGk7F5v.js";import"./index-dTMHUYce.js";import"./app-logo-icon-CE4NT81T.js";import"./folder-root-mJUCB6-B.js";import"./grip-vertical-DQquq90H.js";import"./popover-KnckI0Us.js";const W=[{title:"Reports",href:"/reports"},{title:"Plants",href:"/reports/Plants"}];class J extends l.Component{constructor(){super(...arguments);v(this,"state",{hasError:!1,error:null})}static getDerivedStateFromError(s){return{hasError:!0,error:s.message}}componentDidCatch(s,h){console.error("ErrorBoundary caught:",s,h),b.error("An error occurred while rendering the component. Please try again or contact support.")}render(){return this.state.hasError?t.jsxs("div",{className:"p-4",children:[t.jsxs("p",{className:"text-red-600",children:["Error: ",this.state.error]}),t.jsx(p,{onClick:()=>window.location.reload(),className:"mt-2",children:"Retry"})]}):this.props.children}}const f=a=>{const o=a!=null&&typeof a.id=="number"&&a.id>0&&typeof a.name=="string"&&a.name.trim()!=="";return o||console.warn("Invalid item detected:",a),o};function he({plants:a,institutes:o,regions:s,filters:h}){const[j,Y]=l.useState(h.search||""),[u,g]=l.useState(h.institute_id||""),[y,S]=l.useState(h.region_id||""),[m,w]=l.useState(a),[c,N]=l.useState(o||[]);console.log(s);const C=l.useMemo(()=>Array.isArray(c)?c.filter(f):(console.warn("filteredInstitutes is not an array or is null:",c),[]),[c]),E=l.useMemo(()=>Array.isArray(s)?s.filter(f):(console.warn("regions is not an array or is null:",s),[]),[s]);l.useEffect(()=>{const e={institutes:Array.isArray(c)?c.filter(r=>!f(r)):[],regions:Array.isArray(s)?s.filter(r=>!f(r)):[]};Object.entries(e).forEach(([r,n])=>{n.length>0&&console.warn(`Invalid ${r}:`,n)})},[c,s]);const P=async e=>{try{const r=new URLSearchParams({region_id:e||""}).toString(),n=await fetch(`/reports/getInstitutes?${r}`);if(!n.ok)throw new Error("Failed to fetch institutes");const i=await n.json();console.log("Fetched institutes:",i),N(i),u&&e!=="0"&&!i.some(d=>d.id.toString()===u)&&g("")}catch(r){console.error("Error fetching institutes:",r),b.error("Failed to load institutes"),N([])}},R=e=>{S(e),g(""),P(e)},F=l.useMemo(()=>Q.debounce(()=>{const e=new URLSearchParams({search:j||"",institute_id:u||"",region_id:y||""});fetch(`/reports/plants/getPlants?${e.toString()}`).then(r=>r.json()).then(r=>{console.log("Fetched filtered Plants:",r),w(r)}).catch(r=>{console.error("Error fetching filtered Plants:",r),b.error("Failed to fetch filtered Plants")})},300),[j,u,y]),I=async()=>{const e=new $.Workbook,r=e.addWorksheet("Plants");r.columns=[{header:"Name",key:"name",width:30},{header:"Quantity",key:"qty",width:30},{header:"Institute",key:"institute",width:20},{header:"Region",key:"region",width:20}],m.data.forEach(d=>{var x,k;r.addRow({name:d.name,qty:d.qty,institute:((x=d.institute)==null?void 0:x.name)||"N/A",region:((k=d.region)==null?void 0:k.name)||"N/A"})});const n=await e.xlsx.writeBuffer(),i=new Blob([n],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"});H.saveAs(i,"Plants_Report.xlsx")},_=()=>{const e=new U;e.setFontSize(16),e.text("Plants Report",14,15);const r=["Name","Quantity","Institute","Region"],n=m.data.map(i=>{var d,x;return[i.name,i.qty,((d=i.institute)==null?void 0:d.name)||"N/A",((x=i.region)==null?void 0:x.name)||"N/A"]});V(e,{head:[r],body:n,startY:25,styles:{fontSize:10}}),e.save("plant_Report.pdf")};return t.jsx(J,{children:t.jsxs(z,{breadcrumbs:W,children:[t.jsx(q,{title:"Plants Report"}),t.jsx("div",{className:"flex-1 p-2 md:p-2",children:t.jsxs(T,{children:[t.jsxs(D,{children:[t.jsx(M,{className:"text-xl font-bold",children:"Filters"}),t.jsx("p",{className:"text-muted-foreground text-sm",children:"Refine your plant search"})]}),t.jsxs(O,{className:"space-y-4",children:[t.jsxs("div",{className:"flex flex-row space-y-4",children:[E.length>0&&t.jsx(A,{entity:"region",value:y,onChange:e=>R(e),options:E.map(e=>({id:e.id.toString(),name:e.name.split(" ").pop()||e.name})),includeAllOption:!0}),t.jsx(A,{entity:"institute",value:u,onChange:e=>g(e),options:C.map(e=>({id:e.id.toString(),name:e.name})),includeAllOption:!0}),t.jsxs("div",{className:"flex flex-row space-x-2",children:[t.jsx(p,{onClick:F,className:"w-full md:w-auto",children:"Apply Filters"}),t.jsx(p,{onClick:_,className:"w-full md:w-auto",children:"Export PDF"}),t.jsx(p,{onClick:I,className:"w-full md:w-auto",children:"Export Excel"})]})]}),t.jsxs("table",{className:"w-full border-collapse border-1 rounded-md overflow-hidden shadow-sm",children:[t.jsx("thead",{children:t.jsxs("tr",{className:"bg-primary dark:bg-gray-800 text-center",children:[t.jsx("th",{className:"border p-2 text-sm font-medium text-white dark:text-gray-200",children:"Institute"}),t.jsx("th",{className:"border p-2 text-sm font-medium text-white dark:text-gray-200",children:"Name"}),t.jsx("th",{className:"border p-2 text-sm font-medium text-white dark:text-gray-200",children:"Quantity"})]})}),t.jsx("tbody",{children:m.data.length===0?t.jsx("tr",{children:t.jsx("td",{colSpan:4,className:"text-muted-foreground text-center p-4",children:"No Plants found."})}):m.data.map(e=>{var r;return t.jsxs("tr",{className:"hover:bg-primary/10 dark:hover:bg-gray-700 ",children:[t.jsx("td",{className:"border p-2 text-sm md:text-md lg:text-lg border-r-1 font-bold text-gray-900 dark:text-gray-100",children:(r=e.institute)==null?void 0:r.name}),t.jsx("td",{className:"border p-2 text-sm md:text-md lg:text-lg border-r-1 font-bold text-gray-900 dark:text-gray-100",children:e.name}),t.jsx("td",{className:"border p-2 text-sm md:text-md lg:text-lg text-gray-900 dark:text-gray-100",children:e.qty})]},e.id)})})]}),m.links.length>1&&t.jsx("div",{className:"flex justify-center pt-6 flex-wrap gap-2",children:m.links.map((e,r)=>t.jsx(p,{disabled:!e.url,variant:e.active?"default":"outline",size:"sm",onClick:()=>{e.url&&fetch(e.url).then(n=>n.json()).then(n=>{w(n)}).catch(n=>{console.error("Error:",n)})},className:e.active?"bg-blue-600 hover:bg-blue-700":"",children:t.jsx("span",{dangerouslySetInnerHTML:{__html:e.label}})},r))})]})]})})]})})}export{he as default};
